define(["jquery","base1/cockpit","kubernetes/config"],function(e,n,t){"use strict";var a={};var r=n.gettext;var i="/api";var s="/oapi";var o={nodes:{is_namespaced:false},namespaces:{is_namespaced:false},images:{endpoint:s,is_namespaced:false},imagestreams:{endpoint:s},deploymentconfigs:{endpoint:s},routes:{endpoint:s}};function f(e,n,t){var a=o[e]||{};var r=a[n];if(r===undefined)r=t;return r}function c(){if(window.debugging=="all"||window.debugging=="kubernetes")console.debug.apply(console,arguments)}function u(e){var n,t,a,r;if(e.length===0)return 0;for(n=0,t=0,r=e.length;t<r;t++){a=e.charCodeAt(t);n=(n<<5)-n+a;n|=0}return Math.abs(n)}function l(e,n){var t=0;var a=e.length-1;var r,i;while(t<=a){r=(t+a)/2|0;i=e[r];if(i<n)t=r+1;else if(i>n)a=r-1;else return r}return t}function d(e){var n=this;var t=[];n.add=function a(n,r){var i,s,o,f,c=n.length;for(s=0;s<c;s++){i=u(""+n[s])%e;o=t[i];if(o===undefined)o=t[i]=[];f=l(o,r);if(o[f]!=r)o.splice(f,0,r)}};n.all=function r(n){var a,r,i,s,o;var f,c,l,d,v;for(r=0,o=n.length;r<o;r++){a=u(""+n[r])%e;i=t[a];if(!i){s=[];break}if(!s){s=i.slice()}else{for(d=0,v=0,f=s.length;d<f;){c=s[d];l=i[d+v];if(l<c){v+=1}else if(c!==l){s.splice(d,1);f-=1}else{d+=1}}}}return s||[]};n.any=function i(n){var a,r,i=[],s=n.length;for(r=0;r<s;r++){a=u(""+n[r])%e;i.push.apply(i,t[a]||[])}var o=[];i.sort();s=i.length;for(r=0;r<s;r++){if(i[r-1]!==i[r])o.push(i[r])}return o}}function v(e,n){if(!n)return;var t;try{t=JSON.parse(n)}catch(a){return}if(t&&t.message)e.message=t.message}function p(n,t,a){var r=this;var s;var o=false;var u=null;var l=null;var d=null;var p=f(n,"endpoint",i);var m=e.Deferred();var h={};var g;var b;function w(e){if(e){g=h;h={}}else{g=null}k(true)}function k(e){if(e||b!==undefined){window.clearTimeout(b);b=window.setTimeout(y,100)}}function y(){var e,t;if(b!==undefined){window.clearTimeout(b);b=undefined;t=g;g=null;if(t){for(e in t){if(!(e in h)){a(t[e],n)}}}}if(!m.called){m.called=true;if(m.state()=="pending")m.resolve()}}var j;function O(e){if(j)e=j+e;var r=e.split("\n");var i,o=r.length-1;j=r[o];var f,c;for(i=0;i<o;i++){try{f=JSON.parse(r[i])}catch(l){console.warn(l);u.close();continue}c=f.object;if(!c){console.warn("invalid watch without object");continue}if(f.type=="ERROR"){if(s){s=null;N()}continue}var d=c.metadata;if(!d||!d.uid||c.apiVersion!="v1"||!c.kind){console.warn("invalid kubernetes object: ",c);continue}s=d.resourceVersion;var v=d.uid;if(f.type=="ADDED"){h[v]=c;t(c,n)}else if(f.type=="MODIFIED"){y();h[v]=c;t(c,n)}else if(f.type=="DELETED"){y();delete h[v];a(c,n)}else{console.warn("invalid watch action type: "+f.type)}}k()}function N(){if(u)return;var e=true;var t=p+"/v1/watch";var a={};if(d)t+="/namespaces/"+d;t+="/"+n;if(s){a["resourceVersion"]=s;e=false}var r=false;window.setTimeout(function(){r=true},1e3);u=l.get(t,a).stream(O).response(function(){w(e)}).always(function(){u=null}).fail(function(e,t){if(o)return;v(e,t);var a="watching kubernetes "+n+" failed: "+e.message;if(e.problem!=="disconnected"&&e.status!==404)console.warn(a);else c(a);if(m.state()=="pending")m.reject(e);if(e.status!=404)T()}).done(function(e){if(o)return;if(!r){console.warn("watching kubernetes "+n+" didn't block");T()}else{N()}})}var S=null;function T(){if(!S){S=window.setTimeout(function(){S=null;N()},5e3)}}r.start=function D(n){o=false;if(m.state()!="pending")m=e.Deferred();l=n;N()};r.change_namespace=function J(e){if(e===d)return;o=true;if(u){u.close("disconnected");u=null}d=e;s=null;window.clearTimeout(S);S=null;if(l!==null)r.start(l)};r.wait=function E(){return m.promise()};r.stop=function V(e){o=true;var n;if(u){if(e)n=e.problem;u.close(n||"disconnected");u=null}if(m.state()=="pending")m.reject(e);window.clearTimeout(S);S=null;l=null}}function m(){var a=e.Deferred();var o;var f;var u=[{port:8080},{port:8443,tls:{},capabilities:["tls-certificates"]},{port:6443,tls:{},capabilities:["tls-certificates"]}];function l(){var e=u.shift();var t=null;if(!e){var d=new Error(r("Couldn't find running kube-apiserver"));d.problem="not-found";a.reject(d);return}if(e.kubeconfig){t=e.kubeconfig;e.kubeconfig=null}var v=n.http(e.port,e);var p=null;f=v.get(s).always(function(){p=this.state()=="resolved"});o=v.get(i).done(function(n){o=null;var r;try{r=JSON.parse(n)}catch(i){c("not an api endpoint without JSON data on:",e);l();return}if(r&&r.versions){f.always(function(){r.flavor=p?"openshift":"kubernetes";r.kubeconfig=t;a.resolve(v,r)})}else{c("not a kube-apiserver endpoint on:",e);l()}}).fail(function(n,t){o=null;if(n.problem==="not-found"){c("api endpoint not found on:",e);l()}else{if(n.problem!=="cancelled")c("connecting to endpoint failed:",e,n);a.reject(n,t)}})}n.spawn(["/usr/bin/kubectl","config","view","--output=json","--raw"]).fail(function(e,n){if(n)console.warn(n);else console.warn(e)}).done(function(e){var n=t.parse_scheme(e);c("kube config scheme:",n);u.unshift(n)}).always(l);var d=a.promise();d.cancel=function v(){if(o)o.close("cancelled");return d};return d}function h(n,t,a){var r=this;Object.defineProperty(r,"data",{enumerable:false,writable:false,value:{}});Object.defineProperty(r,e.expando,{enumerable:false,writable:false,value:r.data});r.data.matcher=n;if(a){var i,s,o,f;for(i=0,s=a.length;i<s;i++){f=a[i];o=t.objects[f];if(n(o))r[f]=o}}}Object.defineProperties(h.prototype,{items:{enumerable:false,get:function O(){var e=this;var n,t,a,r=e.data.flat;if(!r){a=Object.keys(e).sort();for(n=0,t=a.length,r=[];n<t;n++)r.push(e[a[n]]);e.data.flat=r}return r}},count:{enumerable:false,get:function N(){var e=this;return Object.keys(e).length}}});function g(e,n,t){var a=e[n];if(a){delete e[n];w(e,"removed",[a,n])}}function b(e,n,t){var a=e.data.matcher(t);var r=e[n];if(!r&&a){e[n]=t;w(e,"added",[t,n])}else if(r&&!a){delete e[n];w(e,"removed",[r,n])}else if(r&&a){e[n]=t;w(e,"updated",[t,n,r])}}function w(n,t,a){n.data.flat=null;var r=e(n);r.triggerHandler(t,a);if(!n.data.timer){n.data.timer=window.setTimeout(function(){n.data.timer=null;r.triggerHandler("changed")},100)}}function k(){var n=this;n.objects={};n.resourceVersion=null;n.flavor=null;n.config=null;var t;var a;var s=null;n.connect=function I(e){if(e||!t){t=m().done(function(e,t){n.flavor=t.flavor;n.config=t.kubeconfig;for(var a in n.watches)n.watches[a].start(e)}).fail(function(e,t){v(e,t);console.warn("Couldn't connect to kubernetes:",e);for(var a in n.watches)n.watches[a].stop(e)})}return t};n.namespace=function q(t){if(t!==undefined){if(!t)t=null;s=t;for(var a in n.watches){if(V(a))n.watches[a].change_namespace(s)}e(n).triggerHandler("namespace",[t])}return s};n.include=function _(e){if(!n.watches[e]){n.watches[e]=new p(e,l,w);if(s&&V(e))n.watches[e].change_namespace(s);if(t){t.done(function(t){n.watches[e].start(t)})}}};n.watches={events:new p("events",N,w)};["nodes","pods","services","replicationcontrollers","namespaces","endpoints"].forEach(n.include);n.request=function L(t){var a=e.Deferred();var r=n.connect();r.done(function(e){r=e.request(t).done(function(){a.resolve.apply(a,arguments)}).fail(function(){a.reject.apply(a,arguments)})}).fail(function(){a.reject.apply(a,arguments)});var i=a.promise();i.cancel=function s(){if(r.cancel)r.cancel();else r.close("cancelled");return i};return i};n.close=function R(){for(var e in n.watches)n.watches[e].stop();o=[];if(t){t.cancel();t=null}};var o=[];var u=new d(262139);function l(e,t){var a=e.metadata;var r=e.kind+":"+a.uid;c("item",r,e);var i=n.objects[r];if(i&&i.metadata.resourceVersion===s)return;Object.defineProperty(e,"key",{enumerable:false,configurable:false,value:r});var s=a.resourceVersion;if(s&&s>n.resourceVersion)n.resourceVersion=s;n.objects[r]=e;var f=[e.kind,a.name,a.namespace];var l,d;if(a.labels){l=a.labels;for(d in l)f.push(d+l[d])}var v=e.spec;if(v){if(v.selector){l=v.selector;for(d in l)f.push(d+l[d])}if(v.template&&v.template.metadata&&v.template.metadata.labels){l=v.template.metadata.labels;for(d in l)f.push(d+l[d])}}var p=e.status;if(v&&v.nodeName)f.push(v.nodeName);u.add(f,r);var m;for(d=0,m=o.length;d<m;d++)b(o[d],r,e)}function w(e,t){var a=e.metadata;var r=e.kind+":"+a.uid;c("remove",r,e);delete n.objects[r];var i,s=o.length;for(i=0;i<s;i++)g(o[i],r,e)}var k={};var y;function j(e){var n=e.kind+":"+e.uid;k[n]=e;if(!y){y=window.setTimeout(function(){var e=Object.keys(k).map(function(e){return k[n]});k={};y=null;e.forEach(function(e){O(e)})},500)}}function O(e){var t=e.kind+":"+e.uid;var a=n.objects[t];if(a&&e.resourceVersion<a.metadata.resourceVersion)return;var r=e.kind.toLowerCase()+"s";var s=f(r,"endpoint",i);var o=s+"/v1";if(e.namespace)o+="/namespaces/"+encodeURIComponent(e.namespace);o+="/"+r+"/"+e.name;c("pulling",o);n.request({method:"GET",body:"",path:o}).fail(function(i){if(i.status==404){a=n.objects[t];if(a){w(a,r)}}else{console.warn("couldn't get involved object",o,e.name,i)}}).done(function(e){var n,a,i;try{i=JSON.parse(e)}catch(s){i=null}if(!i||typeof i!=="object"){console.log("got invalid JSON response from kubernetes");return}if(i){n=i.metadata;if(n){a=i.kind+":"+n.uid;if(a==t)l(i,r)}}})}function N(e,n){var t=e.involvedObject;if(t)j(t);l(e,n)}function S(e){return false}function T(e){return true}this.lookup=function U(e,t,a){var r=[];if(e!==undefined)r.push(e);if(t!==undefined)r.push(t);if(a!==undefined)r.push(a);var i=u.all(r);var s,o=i.length;for(var f=0;f<o;f++){s=n.objects[i[f]];if(s&&s.metadata&&(e===undefined||e===s.kind)&&(t===undefined||t===s.metadata.name)&&(a===undefined||a===s.metadata.namespace)){return s}}return null};this.select=function A(e,t,a,r){var i,s,o=[];if(a){for(i in a)o.push(i+a[i]);if(i===undefined)return new h(S,n)}if(e)o.push(e);if(t)o.push(t);if(o.length)s=u.all(o);else s=Object.keys(n.objects);function f(n){if(!n||!n.metadata)return false;if(e&&n.kind!==e)return false;var i=n.metadata;if(t&&i.namespace!==t)return false;var s,o;if(r){o=n.spec;if(o&&o.template&&o.template.metadata)s=o.template.metadata.labels}else{s=i.labels}if(a&&!s)return false;for(var f in a){if(s[f]!==a[f])return false}return true}return new h(f,n,s)};this.infer=function H(e,t,a){var r,i,s=[];if(a){for(r in a)s.push(r+a[r])}if(s.length)i=u.any(s);else i=Object.keys(n.objects);function o(n){if(!n||!n.metadata||!n.spec||!n.spec.selector)return false;if(t&&n.metadata.namespace!==t)return false;if(e&&n.kind!==e)return false;var r;if(a){for(r in n.spec.selector){if(a[r]!==n.spec.selector[r])return false}}return true}return new h(o,n,i)};this.hosting=function M(e,t){var a=u.all([t]);function r(n){if(!n||!n.spec||n.spec.nodeName!=t)return false;if(e&&n.kind!==e)return false;return true}return new h(r,n,a)};function D(e){var n={};var t,a;if(e){for(t=0,a=e.length;t<a;t++)n[e[t].name]=e[t]}return n}this.containers=function x(e){var n=e.containers;var t,a;if(!n){if(e.spec)t=D(e.spec.containers);else t={};if(e.status)a=D(e.status.containerStatuses);else a={};n=Object.keys(t).map(function(e){return{spec:t[e],status:a[e]}});Object.defineProperty(e,"containers",{enumerable:false,value:n})}return n};n.track=function G(e,n){if(n===false){o=o.filter(function(n){return e!==n});return null}else{o.push(e)}};function J(e,n){this.problem="invalid-data";this.message=e;this.cause=n}function E(e){return e!="Node"&&e!="Namespace"}function V(e){return f(e,"is_namespaced",true)}function P(e){switch(e){case"Namespace":return 0;case"Service":return 1;case"Pod":return 2;default:return 5}}function C(e,n){return P(e.kind)-P(n.kind)}this.create=function F(t,a){var i=e.Deferred();var s=null;var o=i.promise();if(typeof t=="string"){try{t=JSON.parse(t)}catch(f){console.warn(f);i.reject(new J(r("Invalid kubernetes application manifest"),f));return o}}if(!e.isArray(t)){if(t.kind=="List")t=t.items;else t=[t]}var u=true;var d=false;var v=false;if(!a)a="default";t.forEach(function(e){if(u){if(!e.kind||!e.metadata||e.apiVersion!="v1"||typeof e.kind!=="string"){i.reject(new J(r("Unsupported kubernetes object in data")));u=false}}if(e.metadata)delete e.metadata.namespace;if(E(e.kind))d=true;if(e.kind=="Namespace"&&e.metadata&&e.metadata.name==a)v=true});if(!u)return o;t=t.slice();if(!v&&d){t.unshift({apiVersion:"v1",kind:"Namespace",metadata:{name:a}})}t.sort(C);function p(){var e=t.shift();if(!e){i.resolve();return}var o=e.kind;var f=e.metadata.name||"";i.notify(o+" "+f,e);var u=o.toLowerCase()+"s";var d="/api/v1";if(E(o))d+="/namespaces/"+encodeURIComponent(a);d+="/"+u;c("create item:",d,e);s=n.request({method:"POST",path:d,body:JSON.stringify(e)}).done(function(e){s=null;var n;try{n=JSON.parse(e)}catch(t){console.log("received invalid JSON response from kubernetes",t);return}c("created item:",d,n);l(n,u);p()}).fail(function(e,n){var t=null;s=null;if(n){try{t=JSON.parse(n)}catch(a){}}if(o=="Namespace"&&t&&t.code===409){c("skipping namespace creation");p()}else{c("create failed:",d,e,t);if(e.problem=="not-found"){if(e.status==404)e.message=r("Unsupported or incompatible kubernetes API server.");else e.message=r("Could not connect to kubernetes API server.")}i.reject(e,t)}})}p();o.cancel=function m(){if(s)s.cancel()};return o};this.modify=function z(t,a){var r=e.Deferred();if(t.metadata)t=t.metadata.selfLink;var i=n.request({method:"GET",path:t,body:""}).fail(function(e){r.reject(e)}).done(function(e){var s=JSON.parse(e);if(a(s)===false){r.resolve();return}i=n.request({method:"PUT",body:JSON.stringify(s),path:t}).fail(function(e){r.reject(e)}).done(function(){r.resolve()})});var s=r.promise();s.cancel=function o(){i.cancel()};return s};n.remove=function B(e){if(e.metadata)e=e.metadata.selfLink;return n.request({method:"DELETE",path:e,body:""})};n.connect()}function y(e){var n={};return function(t){var a=t+"";var r=n[a];if(r){r.refs+=1;return r.obj}r={refs:1,obj:new e(t)};var i=r.obj.close;r.obj.close=function s(){r.refs-=1;if(r.refs===0){delete n[a];if(i)i.apply(r.obj)}};n[a]=r;return r.obj}}a.k8client=y(k);function j(t){var r=this;var i=1e3;var s=a.k8client();var o={};var f=0;var c={};r.specs={};function u(n){var t,a,s,f,c;var u,l,d,v,p;var m=null;for(t in n){v=n[t];if(v.stats){c=v.stats.length;for(f=0;f<c;f++){d=v.stats[f].timestamp;if(d){if(m===null||d<m)m=d}}}}if(m===null)return;var h=Math.floor(new Date(m).getTime()/i);var g=[];var b,w={};var k,y;var j={};for(t in n){v=n[t];b=v.name;if(!b)continue;j[b]=b;w[b]={"":b};y=b;if(v.aliases){s=v.aliases.length;for(a=0;a<s;a++){w[v.aliases[a]]={"":b};if(v.aliases[a].length===64)y=v.aliases[a]}}if(y&&v.spec){k=!(y in r.specs);r.specs[y]=v.spec;if(k){e(r).triggerHandler("container",[y])}}if(v.stats){c=v.stats.length;for(f=0;f<c;f++){p=v.stats[f];if(!p.timestamp)continue;l=Math.floor(new Date(p.timestamp).getTime()/i);u=g[l-h];if(!u)u=g[l-h]={};u[b]=p}}}c=g.length;for(f=0;f<c;f++){if(g[f]===undefined)g[f]={}}for(b in j){c=g.length;for(f=0;f<c;f++){if(g[f][b]===undefined)g[f][b]=o[b];else o[b]=g[f][b]}}r.series.input(h,g,w)}function l(e){var n=JSON.stringify(e);if(!s||n in c)return;var a=s.request({method:"POST",path:"/api/v1/proxy/nodes/"+encodeURIComponent(t)+":4194/api/v1.2/docker",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});c[n]=a;a.always(function(){delete c[n]}).done(function(e){u(JSON.parse(e))}).fail(function(e){if(e.status!=503)console.warn(e)})}r.fetch=function v(e,n){var t;if(!e||!n){t={num_stats:60}}else{t={start:new Date((e-1)*i).toISOString(),end:new Date(n*i).toISOString()}}l(t)};r.close=function p(){var e,n;for(n in c){e=c[n];if(e&&e.close)e.close()}s.close();s=null};var d="cadv1-"+(t||null);r.series=n.series(i,d,r.fetch)}a.cadvisor=y(j);return a});
