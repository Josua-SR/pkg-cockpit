define(["jquery","base1/cockpit","base1/angular","kubernetes/app"],function(e,t,n){"use strict";var r=r||function(){};var i=t.gettext;return n.module("kubernetes.images",["ngRoute"]).config(["$routeProvider",function(e){e.when("/images",{templateUrl:"views/images-page.html",controller:"ImagesCtrl"})}]).provider("ImageRegistry",function(){var t=0;var r=null;var i={};var a=null;var u={};function s(e){var t=this;t.repo=e;t.images={};t.imagestreams={};var r=e.split("/");if(r.length==3){t.name=r.slice(1).join("/");t.source=r[0]}else{t.name=e;t.source="registry.hub.docker.com"}t.tags=function i(e){var r={};if(e){r[e.metadata.name]=null}else{n.forEach(t.images,function(e){r[e.metadata.name]=null})}n.forEach(t.imagestreams,function(e){if(e.status&&e.status.tags){e.status.tags.forEach(function(e){if(e.items){e.items.forEach(function(t){if(t.image in r)r[t.image]=e.tag})}})}});return r};t.latest=function a(){var e=null;n.forEach(t.images,function(t){var n=t.dockerImageMetadata||{};var r=n.Created||null;if(r&&(!e||r>e))e=r});return e}}function o(){a=null;for(var e in i)i[e].$digest()}function f(){if(a===null)a=window.setTimeout(o,100)}function l(e){if(e&&e.indexOf("/")===-1)return"library/"+e;return e}function c(e){var t=e.dockerImageReference||"";return l(t.split(":")[0].split("@")[0])}function m(e,t,n){var r=c(t);if(r){var i=u[r];if(!i)i=u[r]=new s(r);i.images[n]=t}f()}function g(e,t,n){var r=c(t);if(r){var i=u[r];if(i){delete i.images[n];if(w(i))delete u[r]}}f()}function v(e,t,n,r){g(e,r,n);m(e,t,n)}function d(e){var t=e.spec||{};return l(t.dockerImageRepository||"")}function p(e,t,n){var r=d(t);if(r){var i=u[r];if(!i)i=u[r]=new s(r);i.imagestreams[n]=t}f()}function h(e,t,n){var r=d(t);if(r){var i=u[r];if(i){delete i.imagestreams[n];if(w(i))delete u[r]}}f()}function k(e,t,n,r){h(e,r,n);p(e,t,n)}function w(e){var t;for(t in e.images)return false;for(t in e.imagestreams)return false;return true}var $,y;function b(a){var u;if(t===0){r.include("images");r.include("imagestreams")}if(n.equals({},i)){$=r.select("Image");r.track($);e($).on("added",m);e($).on("removed",g);e($).on("updated",v);for(u in $)m(null,$[u],u);y=r.select("ImageStream");r.track(y);e(y).on("added",p);e(y).on("removed",h);e(y).on("updated",k);for(u in y)p(null,y[u],u)}var s=t++;i[s]=a;return s}function I(t){delete i[t];for(t in i)return;r.track($,false);e($).off();$=null;r.track(y,false);e(y).off();y=null;window.clearTimeout(a);a=null}function E(e){var t=this;t.repositories=u;var n=b(e);e.$on("$destroy",function(){I(n)})}return{$get:["kubernetesClient",function(e){if(!r)r=e;return E}]}}).controller("ImagesCtrl",["$scope","$timeout","kubernetesClient","kubernetesFilter","ImageRegistry",function(e,t,n,i,a){e.registry=new a(e);e.items=e.registry.repositories;e.failure=null;e.state=null;e.is_visible=function(e){if(!i.namespace)return true;for(var t in e.imagestreams)return true;return false};e.client.watches.images.wait().fail(function(t){e.failure=t.message;e.state="fail"}).done(function(t){e.state="ready"}).always(s);var u=null;function s(){if(u===null){u=window.setTimeout(function(){u=null;e.$digest();r()})}}}]).filter("imagesTags",function(){return function(e,n){var r=0;var a=[];var u,s;for(u in e){s=e[u];if(s)a.push(s);else r+=1}a.sort();if(a.length>5){r+=a.length-5;a=a.slice(0,5)}var o=a.join(", ");var f;if(!n&&r){if(o)f=t.ngettext("more images",i(" + $0 more"),i(" + $0 more"),r);else f=t.ngettext(i("$0 image"),i("$0 images"),r);o+=t.format(f,r)}return o}}).filter("imagesNamespaces",function(){return function(e){var t=[];n.forEach(e,function(e){var n=e.metadata||{};if(n.namespace)t.push(n.namespace)});return t.join(", ")}})});
