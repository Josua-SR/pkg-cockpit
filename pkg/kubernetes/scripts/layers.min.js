(function(){"use strict";function t(t,e){var n=d3.select(t);var a=[];var i={height:125,width:null,bar:14,gap:2,max:90,title:"Image layers"};var r;var l=null;var s;var u;var o=n.append("svg").attr("class","image-layers").on("click",function(){var t=d3.select(d3.event.target).datum()||{id:null};p(t.id)});var c=o.append("text").attr("class","label");var d=o.append("text").attr("text-anchor","end").attr("y","1em");var f=o.append("polyline").attr("class","line");function p(t){if(t===null)return;s=t;var e="";var n=null;o.selectAll("g").classed("selected",function(a,i){if(a.id===t){e=a.label;n=i;return true}return false});c.text(e).attr("y",i.height);var a=i.max+15;var r=[];r.push("0,"+a);if(n!==null){r.push(n*i.bar+","+a);r.push(n*i.bar+i.bar/2+","+(a-5));r.push((n+1)*i.bar+","+a)}r.push(u+","+a);f.attr("points",r.join(" "))}function v(){r=null;u=i.width;if(u===null)u=n.node().clientWidth;o.attr("width",u).attr("height",i.height);var t=d3.max(a,function(t){return t.size});l=d3.scale.linear().domain([0,t]).range([2,i.max]);var e=o.selectAll("g").data(a).enter().append("g").attr("transform",function(t,e){return"translate("+e*i.bar+",0)"});e.append("rect").attr("class","layer").attr("x",i.gap).attr("y",function(e){return l(t-e.size)}).attr("width",i.bar-i.gap*2).attr("height",function(t){return l(t.size)});e.append("rect").attr("class","column").attr("width",i.bar).attr("height",l(t)+15);d.text(i.title).attr("x",u-5);p(s)}function g(){window.clearTimeout(r);r=window.setTimeout(v,150)}window.addEventListener("resize",g);v();g();return{data:function(t,e){if(!t)t=[];a=t.slice();a.reverse();if(s===undefined&&a.length)s=a[0].id;angular.extend(i,e);v()},close:function(){window.removeEventListener("resize",g);window.clearTimeout(r)}}}function e(t,e){var n,a={};for(n in t){if(!angular.equals(t[n],e[n]))a[n]=t[n]}return a}function n(t,e){var n,a;if(t.v1Compatibility.container_config){n=t.v1Compatibility.container_config.Cmd;if(n){a=n[n.length-1];if(a.indexOf("#(nop)")===0)return a.substring(6)}}return t.v1Compatibility.id}function a(t,e,a){if(t.v1Compatibility){return{id:t.v1Compatibility.id,size:t.v1Compatibility.Size||0,label:n(t,a[e+1])}}else if(t.name&&t.size){return{id:t.name,size:t.size||0,label:t.name}}else{return{size:0,id:e,label:"Unknown layer"}}}return angular.module("registry.layers",[]).directive("imageLayers",[function(){return{restrict:"E",scope:{layers:"=",settings:"=",prevent:"="},link:function(e,n,i){n.css("display","block");var r=angular.element("<div/>");n.append(r);var l;function s(t,e){if(t&&t.length)t=t.map(a);l.data(t,e)}e.$watchCollection("[layers, settings]",function(t){if(l)s(t[0],t[1]||{})});e.$watch("prevent",function(n){if(!n&&!l){l=t(r[0]);s(e.layers,e.settings||{})}});n.on("$destroy",function(){l.close()})}}}])})();
