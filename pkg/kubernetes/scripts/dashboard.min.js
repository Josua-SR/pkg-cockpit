(function(){"use strict";angular.module("kubernetes.dashboard",["ngRoute","ui.cockpit","kubernetes.details","kubernetes.app","kubernetes.graph"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/dashboard-page.html",controller:"DashboardCtrl",reloadOnSearch:false})}]).controller("DashboardCtrl",["$scope","kubeLoader","kubeSelect","dashboardActions","itemActions","$location",function(e,t,a,n,r,i){var o=t.listen(function(){e.services=a().kind("Service");e.nodes=a().kind("Node");e.pods=a().kind("Pod")});e.$on("$destroy",function(){o.cancel()});t.watch("Node");t.watch("Service");t.watch("ReplicationController");t.watch("Pod");e.editServices=false;e.toggleServiceChange=function s(){e.editServices=!e.editServices};e.serviceContainers=function c(e){var t=e.spec||{};var n=e.metadata||{};var r=0;var i=0;var o=a().kind("Pod").namespace(n.namespace||"").label(t.selector||{});angular.forEach(o,function(e){if(!e.status||!e.status.phase)return;var t=e.spec||{};var a=1;if(t.containers)a=t.containers.length;switch(e.status.phase){case"Pending":i+=a;break;case"Running":r+=a;i+=a;break;case"Succeeded":break;case"Unknown":i+=a;break;case"Failed":default:i+=a;break}});if(r!=i)return r+" of "+i;else return""+r};e.serviceStatus=function l(e){var t=e.spec||{};var n=e.metadata||{};var r="";var i=a().kind("Pod").namespace(n.namespace||"").label(t.selector||{});angular.forEach(i,function(e){if(!e.status||!e.status.phase)return;switch(e.status.phase){case"Pending":if(!r)r="wait";break;case"Running":break;case"Succeeded":break;case"Unknown":break;case"Failed":default:r="fail";break}});return r};e.nodeContainers=function d(e){var t=0;var n=e.metadata||{};angular.forEach(a().kind("Pod").host(n.name),function(e){var a=e.spec||{};var n=1;if(a.containers)n=a.containers.length;t+=n});return t};e.nodeStatus=function f(e){var t=e.status||{};var a=t.conditions;var n="";if(!a){n="wait"}else{a.forEach(function(e){if(e.type=="Ready"){if(e.status!="True")n="fail"}})}return n};e.jumpService=function u(t,a){if(e.editServices)return;var n=a.metadata||{};var r=a.spec||{};if(r.selector&&!angular.equals({},r.selector)&&n.namespace)i.path("/pods/"+encodeURIComponent(n.namespace)).search(r.selector)};angular.extend(e,n);e.modifyService=r.modifyService;e.highlighted=null;e.$on("highlight",function(t,a){e.highlighted=a});e.highlight=function p(t){e.$broadcast("highlight",t)};e.servicesState=function m(){if(e.failure)return"failed";var t;for(t in e.services)break;return t?"ready":"empty"}}]).directive("kubernetesStatusIcon",function(){return{restrict:"A",link:function(e,t,a){e.$watch(a["status"],function(e){t.toggleClass("spinner spinner-sm",e=="wait").toggleClass("fa fa-exclamation-triangle fa-failed",e=="fail")})}}}).directive("kubernetesAddress",function(){return{restrict:"E",link:function(e,t,a){e.$watchGroup(["item.spec.clusterIP","item.spec.ports"],function(e){var a=e[0];var n=e[1];var r=null;var i=null;if(!n||!n.length){i=a}else if(n.length==1){i=a+":"+n[0].port;if(n[0].protocol==="TCP"){if(n[0].port===80)r="http://"+encodeURIComponent(a);else if(n[0].port===443)r="https://"+encodeURIComponent(a)}else{i+="/"+n[0].protocol}}else{i=" "+a+" "+n.map(function(e){if(e.protocol==="TCP")return e.port;else return e.port+"/"+e.protocol}).join(" ")}var o;t.empty();if(r){o=angular.element("<a>").attr("href",r).attr("target","_blank").on("click",function(e){e.stopPropagation()});t.append(o)}else{o=t}o.text(i)})}}}).factory("dashboardActions",["$modal",function(e){function t(){return e.open({animation:false,controller:"DeployCtrl",templateUrl:"views/deploy.html",resolve:{}}).result}function a(){return e.open({animation:false,controller:"AddNodeCtrl",templateUrl:"views/node-add.html",resolve:{}}).result}return{addNode:a,deploy:t}}]).controller("AddNodeCtrl",["$q","$scope","$modalInstance","kubeMethods","KubeTranslate",function(e,t,a,n,r){var i=r.gettext;var o={address:"",name:""};var s=false;t.fields=o;function c(){var t=/^[a-z0-9.-]+$/i;var a=e.defer();var n=o.address.trim();var r=o.name.trim();var s;var c=[];var l;if(!n)s=new Error(i("Please type an address"));else if(!t.test(n))s=new Error(i("The address contains invalid characters"));if(s){s.target="#node-address";c.push(s)}if(r&&!t.test(r)){s=new Error(i("The name contains invalid characters"));s.target="#node-name";c.push(s)}if(c.length>0){a.reject(c)}else{l={kind:"Node",apiVersion:"v1",metadata:{name:r?r:n},spec:{externalID:n}};a.resolve(l)}return a.promise}t.nameKeyUp=function l(e){s=true;if(e.keyCode==13)t.performAdd()};t.addressKeyUp=function d(e){if(e.keyCode==13)t.performAdd();else if(!s)o.name=e.target.value};t.performAdd=function f(){return c().then(function(e){return n.create(e)})}}]).controller("DeployCtrl",["$q","$scope","$timeout","$modalInstance","filterService","kubeMethods","KubeFormat","KubeTranslate",function(e,t,a,n,r,i,o,s){var c=s.gettext;var l;var d={filename:"",namespace:r.namespace()};function f(){var t=e.defer();var a,n,r=[];var i=d.namespace;if(!i)a=new Error(c("Namespace cannot be empty."));else if(!/^[a-z0-9]+$/i.test(i))a=new Error(c("Please provide a valid namespace."));if(a){a.target="#deploy-app-namespace-group";r.push(a);a=null}if(!l)a=new Error(c("No metadata file was selected. Please select a Kubernetes metadata file."));else if(l.type&&!l.type.match("json.*"))a=new Error(c("The selected file is not a valid Kubernetes application manifest."));if(a){a.target="#deploy-app-manifest-file-button";r.push(a);a=null}var s;if(r.length){t.reject(r)}else{s=new window.FileReader;s.onerror=function(e){a=new Error(o.format(c("Unable to read the Kubernetes application manifest. Code $0."),e.target.error.code));a.target="#deploy-app-manifest-file-button";t.reject(a)};s.onload=function(){try{t.resolve({objects:JSON.parse(s.result),namespace:i})}catch(e){a=new Error(o.format(c("Unable to decode Kubernetes application manifest.")));a.target="#deploy-app-manifest-file-button";t.reject(a)}};s.readAsText(l)}return t.promise}function u(){var a=e.defer();f().then(function(e){i.create(e.objects,e.namespace).then(function(){if(t.namespace&&e.namespace!=t.namespace)r.namespace(e.namespace);a.resolve()}).catch(function(e){var t;var n;var r=e.data;if(e&&e.code===409){n=new Error(o.format(c('Please create another namespace for $0 "$1"'),e.details.kind,e.details.id));n.target="#deploy-app-namespace-field"}else{n=r?r:e}a.reject(n)})},function(e){a.reject(e)});return a.promise}t.types=[{name:c("Manifest"),type:"manifest"}];t.selected=t.types[0];t.fields=d;t.namespaces=r.namespaces();t.namespace=r.namespace();t.$on("file",function(e,a){t.$applyAsync(function(){l=a;d.filename=l?l.name:""})});t.performDeploy=function p(){if(t.selected.type=="manifest"){return u()}};t.select=function(e){t.selected=e}}]).directive("fileButton",function(){return{templateUrl:"views/file-button.html",restrict:"A",link:function(e,t,a){var n,r;if(t[0].children.length==2){n=t[0].children[1];r=t[0].children[0];n.onclick=function(){r.click()};r.onchange=function(){var t=r.files||[];e.$emit("file",t[0])}}t.on("$destroy",function(){if(r)r.onchange=null;if(n)n.onclick=null})}}})})();
