(function(){"use strict";function e(){if(window.debugging=="all"||window.debugging=="kube")console.debug.apply(console,arguments)}function n(e){if(!e)return;var n;try{n=JSON.parse(e.data)}catch(t){return}if(n&&n.message)e.message=e.statusText=n.message}function t(e,n){var t,r,o=e[n+"-data"];if(o!==undefined)return{data:window.atob(o)};var i=e[n];if(i!==undefined)return{file:i};return undefined}function r(e,n){return window.btoa(window.unescape(encodeURIComponent(e+":"+n)))}function o(n,o){var i,a,c;var s={port:8080,headers:{}};try{i=JSON.parse(n)}catch(u){console.warn("received invalid kubectl config",u);return null}if(!o)o=i["current-context"];var l=i["contexts"]||[];var f,v;l.forEach(function(e){if(e.name===o){var n=e.context||{};f=n.user;v=n.cluster}});var d,p=i["users"]||[];p.forEach(function(e){if(e.name===f)d=e.user});var m,b=i["clusters"]||[];b.forEach(function(e){if(e.name==v)m=e.cluster});if(m){if(m.server){c=document.createElement("a");c.href=m.server;if(c.hostname)s.address=c.hostname;if(c.port)s.port=parseInt(c.port,10);if(c.protocol=="https:"){if(!c.port||c.port==="0")s.port=c.href==m.server?6443:443;s.tls={};s.tls.authority=t(m,"certificate-authority");s.tls.validate=!m["insecure-skip-tls-verify"]}}}if(d){if(d.token)s.headers["Authorization"]="Bearer "+d.token;if(d.username)s.headers["Authorization"]="Basic "+r(d.username,d.password||"");if(s.tls){s.tls.certificate=t(d,"client-certificate");s.tls.key=t(d,"client-key")}}e("parsed kube config",s);return s}angular.module("kubeClient.cockpit",["kubeClient","kubeUtils"]).factory("CockpitKubeWatch",["$q","KUBE_SCHEMA","cockpitKubeDiscover",function(t,r,o){return function i(r,a){e("creating watch:",r);var c;var s=false;var u=null;var l=null;var f=null;var v=t.defer();var d=v.promise;var p=false;var m={};var b;var h;function g(e){if(e){b=m;m={}}else{b=null}k(true)}function k(e){if(e||h!==undefined){window.clearTimeout(h);h=window.setTimeout(w,100)}}function w(e){if(p)return;p=true;var n,t,r=[];t=b;b=null;for(n in t){if(!(n in m))r.push({type:"DELETED",object:t[n]})}if(r.length)a(r);a([]);if(e)v.reject(e);else v.resolve()}var E;function y(n){if(E)n=E+n;var t=n.split("\n");var r,o=t.length-1;E=t[o];var i=[];var s,l;for(r=0;r<o;r++){try{s=JSON.parse(t[r])}catch(f){console.warn(t[r],f);u.close();continue}l=s.object;if(!l){console.warn("invalid watch without object",s);continue}if(s.type=="ERROR"){if(c){c=null;C()}continue}var v=l.metadata;if(!v||!v.uid||!l.kind){console.warn("invalid kube object: ",l);continue}c=v.resourceVersion;var d=v.uid;if(s.type=="DELETED")delete m[d];else m[d]=l;e(s.type,l.kind,v.uid);i.push(s)}a(i);k()}function C(){if(u)return;var t=true;var o=r+"?watch=true";if(c){o+="&resourceVersion="+encodeURIComponent(c);t=false}var i=false;window.setTimeout(function(){i=true},1e3);var a=angular.extend({},l,{path:o,method:"GET"});u=cockpit.channel(a);var f={};var v=false;u.addEventListener("control",function(e,n){if(n.command=="response"){f=n;if(f.status>299)v=true;g(t)}});u.addEventListener("message",function(e,n){if(v)f.data=(f.data||"")+n;else y(n)});u.addEventListener("close",function(t,o){u=null;h=false;if(s)return;var a="watching "+r+" failed: ";var c=o.problem;var l=f.status;if(c){a+=c;if(c=="disconnected")e(a);else console.warn(a);f.problem=c;f.status=999;w(f)}else if(v){n(f);a+=f.message||f.reason||l;if(l===404||l===410||l===403){e(a);w(f);return}else{console.warn(a)}w(f)}else if(!i){console.warn("watching kube "+r+" didn't block")}else{C();return}S()});u.control({command:"done"})}function S(){if(!f){f=window.setTimeout(function(){f=null;C()},5e3)}}t.when(o(),function(e){l=e;C()},function(e){w(e)});d.cancel=function T(e){s=true;var n;if(u){if(e)n=e.problem;u.close(n||"disconnected");u=null}window.clearTimeout(f);f=null;l=null;w(e)};return d}}]).factory("CockpitKubectlWebSocket",[function(){function e(e,n){var t=e.indexOf("?");var r=e;var o;if(t===-1)r=e;else r=e.substr(0,t);o=r.split("/").map(decodeURIComponent);if(t!==-1){angular.forEach(e.substring(t+1).split("&"),function(e){var t,r=e.split("=");var o=decodeURIComponent(r[0]);var i=decodeURIComponent(r[1]);if(n.hasOwnProperty(o)){t=n[o];if(!angular.isArray(t))t=n[o]=[t];t.push(i)}else{n[o]=i}})}return o}function n(n){var t={};var r=e(n,t);var o=[];var i=[];var a="default";var c=null;var s="log";var u="";var l,f;for(l=0,f=r.length;l<f;l++){if(r[l]==="namespaces"){a=r[++l]}else if(r[l]==="pods"){u=r[++l];if(r[l+1]=="exec")s="exec";else if(r[l+1]=="log")s="logs"}}for(l in t){if(l=="container"){c=t[l]}else if(l=="command"){if(angular.isArray(t[l]))o=t[l];else o.push(t[l])}else if(l=="stdin"||l=="tty"||l=="follow"){i.push("--"+l)}}var v=["kubectl",s,"--namespace="+a];if(c)v.push("--container="+c);v.push.apply(v,i);v.push(u,"--");v.push.apply(v,o);return v}return function t(e,r){var o=n(e);var i=false;var a;var c=0;var s={};cockpit.event_target(s);function u(){a=cockpit.channel({payload:"stream",spawn:o,pty:true});a.addEventListener("close",function(e,n){var t=n.problem||"";a=null;c=3;var r=document.createEvent("Event");r.initEvent("close",false,false,!!t,1e3,t);s.dispatchEvent(r)});a.addEventListener("message",function(e,n){if(i)n="1"+window.btoa(n);var t=document.createEvent("MessageEvent");if(!t.initMessageEvent)t=new window.MessageEvent("message",{data:n});else t.initMessageEvent("message",false,false,n,null,null,window,null);s.dispatchEvent(t)});c=1;var e=document.createEvent("Event");e.initEvent("open",false,false);s.dispatchEvent(e)}function l(){var e=document.createEvent("Event");e.initEvent("close",false,false,false,1002,"protocol-error");s.dispatchEvent(e)}function f(e,n){if(a)a.close(n)}function v(e){if(i)e=window.atob(e.slice(1));if(a)a.send(e)}Object.defineProperties(s,{binaryType:{value:"arraybuffer"},bufferedAmount:{value:0},extensions:{value:""},protocol:{value:i?"base64.channel.k8s.io":""},readyState:{get:function(){return c}},url:{value:e},close:{value:f},send:{value:v}});var d=true;if(r){if(angular.isArray(r))d=i=r.indexOf("base64.channel.k8s.io")!==-1;else d=i="base64.channel.k8s.io"}if(d){window.setTimeout(u)}else{console.warn("Unsupported kubernetes container WebSocket subprotocol: "+r);window.setTimeout(l)}return s}}]).factory("CockpitKubeSocket",["$q","$injector",function(e,n){return function t(r,o){var i;var a=0;var c={};var s;var u=[];if(o&&o.protocols){u=o.protocols;if(!angular.isArray(u))u=[String(o.protocols)]}if(o&&o.port)i=o;else i=n.get("cockpitKubeDiscover")();function l(){var e=document.createEvent("Event");e.initEvent("close",false,false,false,1002,"protocol-error");c.dispatchEvent(e)}function f(e,n){if(s)s.close(n)}function v(e){if(s)s.send(e)}Object.defineProperties(c,{binaryType:{value:"arraybuffer"},bufferedAmount:{value:0},extensions:{value:""},protocol:{value:u[0]},readyState:{get:function(){return a}},url:{value:r},close:{value:f},send:{value:v}});e.when(i,function d(e){cockpit.event_target(c);s=cockpit.channel(angular.extend({},e,{payload:"websocket-stream1",path:r,protocols:u}));s.addEventListener("close",function(e,n){var t=n.problem||"";s=null;a=3;var r=document.createEvent("Event");r.initEvent("close",false,false,!!t,1e3,t);c.dispatchEvent(r)});s.addEventListener("message",function(e,n){var t=document.createEvent("MessageEvent");if(!t.initMessageEvent)t=new window.MessageEvent("message",{data:n});else t.initMessageEvent("message",false,false,n,null,null,window,null);c.dispatchEvent(t)});a=1;var n=document.createEvent("Event");n.initEvent("open",false,false);c.dispatchEvent(n)});return c}}]).factory("CockpitKubeRequest",["$q","$injector",function(e,t){var r="Content-Type";var o="application/json";return function i(a,c,s,u){var l=e.defer();var f=l.promise;var v,d;var p={};if(s&&typeof s=="object"){s=JSON.stringify(s);p[r]=o}if(!u)u={};if(u&&u.port)v=u;else v=t.get("cockpitKubeDiscover")();e.when(v,function m(e){var t=angular.extend({},u,e,{path:c,method:a,payload:"http-stream2"});t.headers=angular.extend(p,u.headers||{},e.headers||{});d=cockpit.channel(t);var i={};d.addEventListener("control",function(e,n){if(n.command=="response"){i=n;i.statusText=i.reason}});d.addEventListener("message",function(e,n){i.data=(i.data||"")+n});d.addEventListener("close",function(e,t){var a;d=null;if(t.problem){i.problem=i.statusText=t.problem;i.status=999}var c=i.headers||{};if(c[r]==o){try{i.data=JSON.parse(i.data)}catch(s){}}if(i.status>299){n(i);l.reject(i)}else{l.resolve(i)}});if(s)d.send(s);d.control({command:"done"})},function b(e){l.reject(e)});f.cancel=function h(){if(v.cancel)v.cancel();if(d)d.close("cancelled")};return f}}]).factory("cockpitKubectlConfig",["$q",function(e){return function n(){var n=e.defer();var t=n.promise;var r=cockpit.channel({payload:"stream",spawn:["kubectl","config","view","--output=json","--raw"],err:"message"});var o="";r.addEventListener("message",function(e,n){o+=n});r.addEventListener("close",function(e,t){r=null;if(t.problem)n.reject(t);else n.resolve(o)});t.cancel=function i(e){if(r)r.close(e||"cancelled")};return t}}]).factory("cockpitKubeDiscover",["$q","CockpitKubeRequest","cockpitKubectlConfig","cockpitConnectionInfo",function(n,t,r,i){var a=null;return function c(s){if(!s&&a)return a.promise;var u,l,f,v;var d=window.sessionStorage.getItem("login-data");a=n.defer();var p=[{port:8080},{port:8443,tls:{}},{port:6443,tls:{}}];function m(n,r){if(!n)n=p.shift();if(!n){u.statusText="Couldn't find running API server";u.problem="not-found";a.reject(u);return}if(typeof n==="function"){n();return}n.payload="http-stream2";e("trying kube at:",n);l=new t("GET","/api","",n);l.then(function(t){l=null;var o=t.data;if(o&&o.versions){e("discovered kube api",o);if(r){i.kubeConfig=r;if(f)i.type="kubectl";else i.type="sessionData"}else{i.type="open"}a.resolve(n)}else{e("not an api endpoint:",n);u=t;f=null;m()}}).catch(function(t){l=null;f=null;u=t;if(t.problem==="not-found"){e("api endpoint not found on:",n);m()}else{e("connecting to kube failed:",t);a.reject(t)}})}function b(){f=r().then(function(e){var n=o(e);m(n,n?e:null)}).catch(function(e){console.warn("kubectl failed: "+(e.message||e.problem));m()})}p.unshift(b);if(d)v=o(d);m(v,v?d:null);a.promise.cancel=function h(){if(f&&f.cancel)f.cancel("cancelled");if(l)l.close("cancelled")};return a.promise}}]).factory("CockpitEnvironment",["$q",function(e){var n=e.defer();var t=null;return function r(){if(t!==null)return n.promise;var e=cockpit.channel({payload:"dbus-json3",bus:"internal"});e.addEventListener("close",function(e,r){if(r.problem){console.warn("couldn't retrieve environment:",r.problem);n.reject(r)}else{n.resolve(t)}});e.addEventListener("message",function(n,r){var o=JSON.parse(r);if(o.reply){t=o.reply[0][0].Variables.v;e.close(null)}else if(o.error){console.warn("error retrieving environment:",o.error);e.close("internal-error")}});e.send(JSON.stringify({id:"cookie",call:["/environment","org.freedesktop.DBus.Properties","GetAll",["cockpit.Environment"]]}));return n.promise}}]).factory("cockpitKubeDiscoverSettings",["$q","CockpitKubeRequest","cockpitKubeDiscover","CockpitEnvironment","kubeLoader",function(e,n,t,r,o){var i=null;return function a(c){if(!c&&i)return i;var s={registry:{},flavor:"kubernetes",isAdmin:false};var u=r().then(function(e){var n=e["REGISTRY_HOST"];if(n)s.registry.host=n},function(e){});var l=t(c).then(function(t){var r=new n("GET","/oapi","",t).then(function(){s.flavor="openshift"},function(){s.flavor="kubernetes"});var i=o.watch("namespaces").then(function(){s.isAdmin=true},function(){s.isAdmin=false});var a;if(t.headers){a=(t.headers["Authorization"]||"").trim();if(a.toLowerCase().indexOf("bearer ")===0)s.registry.password=a.substr(7).trim()}return e.all([i,r])});i=e.all([l,u]).then(function(){return s});return i}}]).factory("cockpitConnectionInfo",function(){return{type:null,kubeConfig:null}}).factory("cockpitContainerWebSocket",["CockpitKubeSocket","CockpitKubectlWebSocket","cockpitConnectionInfo",function(e,n,t){return function(r,o){if(t.type=="kubectl")return n(r,o);else return e(r,o)}}]).factory("CockpitFormat",function(){return{formatBytes:cockpit.format_bytes,formatBitsPerSec:cockpit.format_bits_per_sec,format:cockpit.format}}).factory("CockpitMetrics",function(){return{grid:cockpit.grid,series:cockpit.series}}).factory("CockpitTranslate",function(){return{gettext:function(e,n){if(arguments.length>1)return n;else return e}}})})();
