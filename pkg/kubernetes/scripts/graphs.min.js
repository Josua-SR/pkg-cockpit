(function(){"use strict";angular.module("kubernetes.graph",["kubeClient","kubeClient.cockpit","kubeUtils"]).factory("CAdvisorSeries",["KubeRequest","CockpitMetrics","$exceptionHandler","$timeout",function(e,t,n,r){function a(a){var i=this;var o=[];var u=1e3;var c={};var f=0;var s={};i.specs={};function l(e){var t,n,r,a,o;var f,s,l,v,m;var h=null;for(t in e){v=e[t];if(v.stats){o=v.stats.length;for(a=0;a<o;a++){l=v.stats[a].timestamp;if(l){if(h===null||l<h)h=l}}}}if(h===null)return;var p=Math.floor(new Date(h).getTime()/u);var g=[];var w,k={};var y=[];var b;var x={};for(t in e){v=e[t];w=v.name;if(!w)continue;x[w]=w;k[w]={"":w};b=w;if(v.aliases){r=v.aliases.length;for(n=0;n<r;n++){k[v.aliases[n]]={"":w};if(v.aliases[n].length===64)b=v.aliases[n]}}if(b&&v.spec){if(!i.specs[b]){i.specs[b]=v.spec;y.push(b)}}if(v.stats){o=v.stats.length;for(a=0;a<o;a++){m=v.stats[a];if(!m.timestamp)continue;s=Math.floor(new Date(m.timestamp).getTime()/u);f=g[s-p];if(!f)f=g[s-p]={};f[w]=m}}}if(y.length>0)d(y);o=g.length;for(a=0;a<o;a++){if(g[a]===undefined)g[a]={}}for(w in x){o=g.length;for(a=0;a<o;a++){if(g[a][w]===undefined)g[a][w]=c[w];else c[w]=g[a][w]}}i.series.input(p,g,k)}function v(t){var n=JSON.stringify(t);if(n in s)return;var r="/api/v1/proxy/nodes/"+encodeURIComponent(a)+":4194/api/v1.2/docker";var i=e("POST",r,t);s[n]=i;i.then(function(e){delete s[n];l(e.data)}).catch(function(e){delete s[n];if(e.status!=503)console.warn(e)})}function d(){var e,t,r;for(e=0,t=o.length;e<t;e++){r=o[e];try{if(r)r.apply(i,arguments)}catch(a){n(a)}}}i.fetch=function h(e,t){var n;if(!e||!t){n={num_stats:60}}else{n={start:new Date((e-1)*u).toISOString(),end:new Date(t*u).toISOString()}}v(n)};i.close=function p(){var e,t;for(t in s){e=s[t];if(e&&e.cancel)e.cancel()}};i.watch=function g(e){var t;var n;o.push(e);if(i.specs){t=Object.keys(i.specs);if(t.length>0){n=r(function(){n=null;e.call(i,t)},0)}}return{cancel:function(){var t,a;r.cancel(n);n=null;for(t=0,a=o.length;t<a;t++){if(o[t]===e)o[t]=null}}}};var m="cadv1-"+(a||null);i.series=t.series(u,m,i.fetch)}return{new_cadvisor:function(e){return new a(e)}}}]).factory("ServiceGrid",["CAdvisorSeries","CockpitMetrics","kubeSelect","kubeLoader",function e(t,n,r,a){function i(){var e=n.grid(1e3,0,0);var i={};var o={};e.rows=[];e.events=[];var u=false;var c=null;var f={cpu:{},memory:{},network:{}};var s={};var l={};var v={};var d={};var m=a.listen(function(){var t=false;var n={};var a={};angular.forEach(r().kind("Service"),function(e){var u=e.spec;var c=e.metadata;var f=c.name;if(!u||!u.selector||f==="kubernetes"||f==="kubernetes-ro")return;var s=c.uid;var l=r().kind("Pod").namespace(c.namespace||"").label(u.selector||{});n[s]=true;if(!o[s])w(s);angular.forEach(l,function(e){var n=e.status||{};var r=e.spec||{};var u=r.nodeName;var c={};var f=n.containerStatuses||[];var l;var v=o[s];a[u]=true;if(u&&!i[u]){p(u)}for(l=0;l<f.length;l++){var d=f[l];var m=d.containerID;if(m&&m.indexOf("docker://")===0){c[m]=m;m=m.substring(9);c[m]=m;if(!v||!v[m])t=true}}o[s]=c})});var u;for(u in o){if(!n[u]){k(u);t=true}}for(u in i){if(!a[u]){g(u);t=true}}if(t)e.sync()});a.watch("Pod");a.watch("Service");function h(t,n){var r=e.add(t,[n,"cpu","usage","total"]);s[n]=e.add(function(e,t,n){b(r,e,t,n)},true);l[n]=e.add(t,[n,"memory","usage"]);var a=e.add(t,[n,"network","rx_bytes"]);v[n]=e.add(function(e,t,n){b(a,e,t,n)},true);var i=e.add(t,[n,"network","tx_bytes"]);d[n]=e.add(function(e,t,n){b(i,e,t,n)},true);e.sync()}function p(n){var r=t.new_cadvisor(n);r.watch(function(e){var t;for(t=0;t<e.length;t++)h(r,e[t])});e.add(r,["unused-dummy"]);i[n]=r}function g(e){var t=i[e];if(t){delete i[e];t.close();t=null;u=true}}function w(t){f.cpu[t]=e.add(function(e,n,r){x(t,s,e,n,r)});f.memory[t]=e.add(function(e,n,r){x(t,l,e,n,r)});var n=e.add(function(e,n,r){x(t,d,e,n,r)});var r=e.add(function(e,n,r){x(t,v,e,n,r)});f.network[t]=e.add(function(e,t,a){y([n,r],e,t,a)});u=true}function k(e){delete o[e];delete f.network[e];delete f.cpu[e];delete f.memory[e];u=true}function y(e,t,n,r){var a=t.maximum||0;var i,o,c,f,s=e.length;for(o=0;o<r;o++){i=undefined;for(f=0;f<s;f++){c=e[f][n+o];if(c!==undefined){if(i===undefined)i=c;else i+=c}}if(i!==undefined&&i>a){t.maximum=a=i;u=true}t[n+o]=i}}function b(e,t,n,r){var a,i,o,c;if(n>0)i=e[n-1];var f=t.maximum||1;for(a=0;a<r;a++){c=e[n+a];if(i===undefined||c===undefined){o=undefined}else{o=c-i;if(o<0){o=undefined}else if(o>f){t.maximum=f=o;u=true}}t[n+a]=o;i=c}}function x(e,t,n,r,a){var i,u,c=[];var f=o[e];if(f){for(i in f){u=t[i];if(u)c.push(u)}}y(c,n,r,a)}e.metric=function E(t){if(t===undefined)return c;if(f[t]===undefined)throw"unsupported metric type";e.rows=[];c=t;var n=Object.keys(o);var r,a,i=n.length;for(a=0;a<i;a++){r=f[t][n[a]];if(r!==undefined){e.rows.push(r);r.uid=n[a]}}var u=document.createEvent("CustomEvent");u.initCustomEvent("changed",false,false,null);e.dispatchEvent(u,null)};var S=e.close;e.close=function M(){var t=Object.keys(i);var n;for(n=0;n<t.length;n++){var r=t[n];var a=i[r];if(a){delete i[r];a.close();a=null}}m.cancel();S.apply(e)};e.addEventListener("notify",function(){if(u){u=false;e.metric(c)}});return e}return{new_grid:function(){return new i}}}]).directive("kubernetesServiceGraph",["ServiceGrid","KubeTranslate","KubeFormat",function t(e,n,r){var a=n.gettext;function i(t,n){var i=e.new_grid();var o=d3.select(t);var u=null;var c={cpu:{label:a("CPU"),step:1e3*1e3*1e3,formatter:function(e){return e/(10*1e3*1e3)+"%"}},memory:{label:a("Memory"),step:1024*1024*64,formatter:function(e){return r.formatBytes(e)}},network:{label:a("Network"),step:1e3*1e3,formatter:function(e){return r.formatBitsPerSec(e,"Mbps")}}};o.append("ul").attr("class","nav nav-tabs").selectAll("li").data(Object.keys(c)).enter().append("li").attr("data-metric",function(e){return e}).append("a").text(function(e){return c[e].label});function f(e){o.selectAll("ul li").attr("class",function(t){return e===t?"active":null});i.metric(e)}o.selectAll("ul li").on("click",function(){f(d3.select(this).attr("data-metric"))});f("cpu");var s={top:12,right:15,bottom:40,left:60};var l=d3.scale.category20();var v=d3.select(t).append("svg");var d=v.append("g").attr("transform","translate("+s.left+","+s.top+")");var m=d3.scale.linear();var h=d3.svg.axis().scale(m).ticks(5).orient("left");var p=d.append("g").attr("class","y axis");var g=d3.scale.linear();var w=d3.svg.axis().scale(g).orient("bottom");var k=d.append("g").attr("class","x axis");var y=0;var b=d3.svg.line().defined(function(e){return e!==undefined}).x(function(e,t){return g(i.beg+t-y)}).y(function(e,t){return m(e)});var x=3e5/1024;var S=300;var E=300;var M=false;var C=false;window.setTimeout(function(){C=true;L()},1);function O(e,t){var n=e%t;if(e===0||n!==0)e+=t-n;return e}function A(){var e=i.interval;var t=S-s.right-s.left;var n=(new Date).getTime();var r=Math.floor(n/e);var a=r-Math.floor(x*t/e);y=a;i.move(a,r)}function L(){if(!C)return;v.attr("width",S).attr("height",E);var e=S-s.right-s.left;var t=E-s.top-s.bottom;var n=i.metric();var r=i.interval;var a=i.rows,o=0;var u,f,l=a.length;for(u=0;u<l;u++){if(a[u].maximum!==undefined)f=a[u].maximum;else f=d3.max(a[u]);if(f>o)o=Math.ceil(f)}var d=Math.floor(x*e/r);g.domain([0,d]).range([0,e]);m.domain([0,O(o,c[n].step)]).range([t,0]);var y=d3.scale.linear().domain([0,d]).range([d,0]);var b=[];for(u=60;u<d;u+=60)b.push(Math.round(y(u)));w.tickValues(b).tickSize(-t,-t).tickFormat(function(e){e=Math.round(y.invert(e));return e/60+" min"});k.attr("transform","translate(0,"+t+")").call(w).selectAll("text").attr("y","10px");h.tickSize(-e,-e).tickFormat(c[n].formatter);p.call(h).selectAll("text").attr("x","-10px");A()}function _(){var e=i.rows;var t=d.selectAll("path.line").data(e,function(e,t){return t});var r=t.style("stroke",function(e,t){return l(t)}).attr("d",function(e){return b(e)}).classed("highlight",function(e){return e.uid===u});t.enter().append("path").attr("class","line").on("mouseover",function(){n(d3.select(this).datum().uid)}).on("mouseout",function(){n(null)});t.exit().remove()}i.addEventListener("notify",_);function D(){L();_()}i.addEventListener("changed",D);function T(){S=t.offsetWidth-10;if(S<0)S=0;L()}window.addEventListener("resize",T);T();var $=window.setInterval(A,i.interval);return{highlight:function I(e){u=e;_()},close:function P(){window.removeEventListener("resize",T);i.removeEventListener("notify",_);i.removeEventListener("changed",D);i.close()}}}return{restrict:"E",link:function(e,t,n){var r=i(t[0],function(t){e.$broadcast("highlight",t);e.$digest()});e.$on("highlight",function(e,t){r.highlight(t)});t.on("$destroy",function(){r.close();r=null})}}}])})();
