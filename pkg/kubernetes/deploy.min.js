define(["jquery","base1/cockpit","kubernetes/client","kubernetes/nulecule","base1/mustache"],function(e,a,l,p,n){"use strict";var r=a.gettext;var i;var o;var t;var s=false;function f(){var a=i.namespace();var l=e("#deploy-app-namespace").val();if(a&&a!=l)i.namespace(l);e("#deploy-app-dialog").modal("hide")}function d(){var l=h().fail(function(a){e("#deploy-app-dialog").dialog("failure",a)}).done(function(p){e("#deploy-app-dialog").dialog("failure",null);l=i.create(p.manifest,p.namespace).done(function(){f()}).fail(function(l,p){var n;var i;if(p){if(p.code===409){i=a.format(r('Please create another namespace for $0 "$1"'),p.details.kind,p.details.id);n="#deploy-app-namespace-field"}else if(p.message){i=p.message}}l=new Error(i||l.message);l.target=n;e("#deploy-app-dialog").dialog("failure",l)});e("#deploy-app-dialog").dialog("wait",l)});e("#deploy-app-dialog").dialog("wait",l)}function c(){var a=e.Deferred();e("#deploy-app-dialog").dialog("failure",null);e("#deploy-app-dialog").dialog("wait",a.promise());y().fail(function(l){a.reject(l);e("#deploy-app-dialog").dialog("failure",l)}).done(function(l){o.run(l.nulecule_image).progress(function(e){a.notify(e)}).done(function(){a.resolve();f()}).fail(function(l){a.reject(l);e("#deploy-app-dialog").dialog("failure",l)})})}function u(){var a=e.Deferred();e("#deploy-app-dialog").dialog("failure",null);e("#deploy-app-dialog").dialog("wait",a.promise());h().fail(function(l){a.reject(l);e("#deploy-app-dialog").dialog("failure",l)}).done(function(l){o.install(l.nulecule_image).progress(function(e){a.notify(e)}).done(function(l){var p=e("#deploy-app-appentity-template").html();n.parse(p);var r=n.render(p,e.extend({apps:g(l)}));e("#deploy-app-dialog").find(".cockpit-form-table").append(r);a.resolve();e("#deploy-app-dialog").find("#deploy-app-type").prop("disabled",true);e("#deploy-app-dialog").find("#deploy-app-type").selectpicker("refresh");e("#deploy-app-dialog").find("#deploy-app-nulecule-image").prop("disabled",true);s=true}).fail(function(l,p){a.reject(l);e("#deploy-app-dialog").dialog("failure",l)})})}function m(e){var a=[];for(var l in e){var p=e[l];var n=p.app_name;var r="label";var i="text";for(var o in p.app_params){var t=p.app_params[o];var s=n+"-"+t.param_key+"-"+r;var f=n+"-"+t.param_key+"-"+i;var d={label_val:s,input_val:f};a.push(d)}}return a}function v(e){var a="";var l=e.split("-label")[0].split("-");l=l[l.length-1];a=e.split("-label")[0].split("-"+l)[0];return{app_name:a,key:l}}function g(e){var a=[];for(var l in e){var p={app_name:"",app_params:[]};if(l==="general")continue;p.app_name=l;for(var n in e[l]){var r={param_key:"",param_value:""};r.param_key=n;if(e[l][n])r.param_value=e[l][n];else r.param_value="";p.app_params.push(r)}a.push(p)}return a}function y(){var a=e.Deferred();var l,p=[];var n=o.answers;var i=m(g(n));var t={};for(var s in i){var f=i[s];var d="#"+f.input_val;var c=f.label_val;var u=v(c);var y=e(d).val();n[u.app_name][u.key]=y;var h=e("#deploy-app-dialog").find('label[for="'+c+'"]').text().trim();if(!y)l=new Error(h+" cannot be empty.");if(l){l.target=d;p.push(l);l=null}}var b=e("#deploy-app-namespace").val();if(!b)l=new Error(r("Namespace cannot be empty."));else if(!/^[a-z0-9]+$/i.test(b))l=new Error(r("Please provide a valid namespace."));if(l){l.target="#deploy-app-namespace-group";p.push(l);l=null}else{n.general.namespace=b}var _=e("#deploy-app-nulecule-image");t.nulecule_image=_.val().trim();if(p.length){a.reject(p)}else{a.resolve(t)}o.answers=n;return a.promise()}function h(){var l=e.Deferred();var p,n=[];var i={};var o=e("#deploy-app-type");var t=e("#deploy-app-namespace").val();if(!t)p=new Error(r("Namespace cannot be empty."));else if(!/^[a-z0-9]+$/i.test(t))p=new Error(r("Please provide a valid namespace."));if(p){p.target="#deploy-app-namespace-group";n.push(p);p=null}else{i.namespace=t}if(o.val().trim()==="manifest"){var s=e("#deploy-app-manifest-file")[0].files;if(s.length!=1)p=new Error(r("No metadata file was selected. Please select a Kubernetes metadata file."));else if(s[0].type&&!s[0].type.match("json.*"))p=new Error(r("The selected file is not a valid Kubernetes application manifest."));if(p){p.target="#deploy-app-manifest-file-button";n.push(p);p=null}var f;if(n.length){l.reject(n)}else{f=new window.FileReader;f.onerror=function(e){p=new Error(a.format(r("Unable to read the Kubernetes application manifest. Code $0."),e.target.error.code));p.target="#deploy-app-manifest-file-button";n.push(p);p=null;l.reject(n)};f.onload=function(){i.manifest=f.result;l.resolve(i)};f.readAsText(s[0])}}else{var d=e("#deploy-app-nulecule-image").val();if(!d)p=new Error(r("Nulecule field cannot be empty."));if(p){p.target="#deploy-app-nulecule-image";n.push(p);p=null}else{i.nulecule_image=d.trim()}if(n.length){l.reject(n)}else{l.resolve(i)}}return l.promise()}function b(){var a=e("#deploy-app-dialog");var n=e("#deploy-app-start");var f=e("#deploy-app-manifest-file");var m=e("#deploy-app-manifest-file-button");var v=e("#deploy-app-type-label");var g=e("#deploy-app-nulecule-image");var y=e("#deploy-app-type");n.on("click",function(){if(y.val().trim()==="manifest"){d()}else{if(s)c();else u()}});m.on("click",function(){f.val("");f.trigger("click");m.triggerHandler("change")});y.on("change",function(){if(y.val().trim()==="manifest"){g.hide();e('label[for="deploy-app-nulecule"]').hide();m.show();e('label[for="deploy-app-manifest"]').show()}else{g.show();e('label[for="deploy-app-nulecule"]').show();m.hide();e('label[for="deploy-app-manifest"]').hide();g.prop("disabled",false)}});y.selectpicker("refresh");a.on("show.bs.modal",function(){var a=r("Namespace");if(e("#content").data("flavor")=="openshift")a=r("Project");e("#deploy-app-namespace-label").text(a);m.text(r("Select Manifest File...")).addClass("manifest_file_default");e(".appentity").remove();g.prop("disabled",false);g.val("");y.prop("disabled",false);y.val("manifest");y.selectpicker("refresh");g.hide();e('label[for="deploy-app-nulecule"]').hide();m.show();e('label[for="deploy-app-manifest"]').show();i=l.k8client();o=p.nuleculeclient();var n=i.namespace();e("#deploy-app-namespace").val(n);t=i.select("Namespace");i.track(t);e(t).on("changed",b);b()});a.on("hide.bs.modal",function(){s=false;if(t){e(t).off("changed",b);i.track(t,false);t=null}if(i){i.close();i=null}if(o){o.close();o=null}});a.on("keypress",function(e){if(e.keyCode===13)n.trigger("click")});f.on("change",function(){var e=f[0].files||[];var a=e[0];var l=a?a.name:r("Select Manifest File...");m.text(l).toggleClass("manifest_file_default",!a).toggleClass("manifest_file",!!a).triggerHandler("change")});var h=e("#deploy-app-namespace-group");e("button",h).on("click",function(){e("ul",h).outerWidth(h.width())});h.on("click","a",function(){e("input",h).val(e(this).text());e("ul",h).parent().removeClass("open");return false});function b(){var a=e("ul",h).empty();t.items.forEach(function(l){a.append(e("<li>").append(e("<a>").text(l.metadata.name)))})}}b()});
