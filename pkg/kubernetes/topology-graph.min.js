(function(e,t){if(typeof define==="function"&&define.amd)define(["base1/angular","./d3"],t);else t(e.angular,e.d3)})(this,function(e,t){"use strict";var n={};function i(e,i,r){var a=t.select(e);var o=null;var c={};var s=[];var u;var l;var d=20;var f;var v=[];var k=[];var m={};var x=null;if(!i){i=t.layout.force().charge(-800).gravity(.2).linkDistance(80)}var p=i.drag();var g=a.append("svg").attr("viewBox","0 0 1600 1200").attr("preserveAspectRatio","xMidYMid meet").attr("class","kube-topology");var h=t.select();var y=t.select();i.on("tick",function(){y.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y});h.attr("cx",function(e){e.x=e.fixed?e.x:Math.max(d,Math.min(u-d,e.x));return e.x}).attr("cy",function(e){e.y=e.fixed?e.y:Math.max(d,Math.min(l-d,e.y));return e.y}).attr("transform",function(e){return"translate("+e.x+","+e.y+")"})});p.on("dragstart",function(e){r(e.item);if(e.fixed!==true)e.floatpoint=[e.x,e.y];e.fixed=true;t.select(this).classed("fixed",true)}).on("dragend",function(e){var n=true;if(e.floatpoint){n=e.x<e.floatpoint[0]-5||e.x>e.floatpoint[0]+5||(e.y<e.floatpoint[1]-5||e.y>e.floatpoint[1]+5);delete e.floatpoint}e.fixed=n&&e.x>3&&e.x<u-3&&e.y>=3&&e.y<l-3;t.select(this).classed("fixed",e.fixed)});g.on("dblclick",function(){g.selectAll("g").classed("fixed",false).each(function(e){e.fixed=false});i.start()}).on("click",function(e){if(!t.select(t.event.target).datum()){r(null)}});function w(e){x=e;g.selectAll("g").classed("selected",function(t){return t.item===e})}function $(){f=null;u=a.node().clientWidth;l=a.node().clientHeight;i.size([u,l]);g.attr("viewBox","0 0 "+u+" "+l);b()}function b(){y=g.selectAll("line").data(k);y.exit().remove();y.enter().insert("line",":first-child");y.attr("class",function(e){return e.kinds});h=g.selectAll("g").data(v,function(e){return e.id});h.exit().remove();var e=h.enter().append("g").call(p);w(x);i.nodes(v).links(k).start();return e}function A(){var e=v;var i=m;v=[];k=[];m={};var r,a,d,f;for(a in c){r=c[a];d=r.kind;if(o&&!o[d])continue;f=e[i[a]];if(!f){f=n[a];delete n[a];if(!f)f={}}f.id=a;f.item=r;m[a]=v.length;v.push(f)}var x,p,g,h,y;for(x=0,p=s.length;x<p;x++){g=s[x];h=m[g.source];y=m[g.target];if(h===undefined||y===undefined)continue;k.push({source:h,target:y,kinds:v[h].item.kind+v[y].item.kind})}if(u&&l)return b();else return t.select()}function M(){window.clearTimeout(f);f=window.setTimeout($,150)}window.addEventListener("resize",M);$();M();return{select:w,kinds:function(e){o=e;var t=A();return[h,t]},data:function(e,t){c=e||{};s=t||[];var n=A();return[h,n]},close:function(){window.removeEventListener("resize",M);window.clearTimeout(f);var e,t;n={};for(e in m){t=v[m[e]];delete t.item;n[e]=t}v=[];m={}}}}try{e.module("kubernetesUI")}catch(r){e.module("kubernetesUI",[])}return e.module("kubernetesUI").directive("kubernetesTopologyGraph",[function(){return{restrict:"E",scope:{items:"=",relations:"=",kinds:"=",selection:"=",force:"="},link:function(e,t,n){t.css("display","block");function r(t){var i=e.$emit("select",t);if(n["selection"]===undefined&&!i.defaultPrevented)u.select(t)}function a(t){var n;var i=e.kinds;if(i)n=i[t.item.kind];return n||""}function o(e){var t=e.item.status;if(t&&t.phase&&t.phase!=="Running")return true;return false}function c(e){return e.item.metadata.name}function s(t){var n=t[0];var i=t[1];var r=e.$emit("render",n,i);if(!r.defaultPrevented){i.attr("class",function(e){return e.item.kind});i.append("use").attr("xlink:href",a);i.append("title");n.selectAll("title").text(function(e){return e.item.metadata.name});n.classed("weak",o)}}var u=i(t[0],e.force,r);e.$watchCollection("kinds",function(e){s(u.kinds(e))});e.$watchCollection("[items, relations]",function(e){s(u.data(e[0],e[1]))});e.$watch("selection",function(e){u.select(e)});t.on("$destroy",function(){u.close()})}}}]).directive("kubernetesTopologyIcon",function(){return{restrict:"E",transclude:true,template:"<ng-transclude></ng-transclude>",link:function(e,t,n){var i=n.kind;var r=e.kinds[i];e.$watchCollection("kinds",function(){t.toggleClass("active",i in e.kinds)});t.on("click",function(){if(i in e.kinds){r=e.kinds[i];delete e.kinds[i]}else{e.kinds[i]=r}if(e.$parent)e.$parent.$digest();e.$digest()})}}})});
