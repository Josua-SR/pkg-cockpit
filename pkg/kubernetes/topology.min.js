define(["jquery","base1/angular","kubernetes/d3","kubernetes/topology-graph"],function(e,t,o){"use strict";var n={Pod:"#vertex-Pod",ReplicationController:"#vertex-ReplicationController",Node:"#vertex-Node",Service:"#vertex-Service",DeploymentConfig:"#vertex-DeploymentConfig",Route:"#vertex-Route"};return t.module("kubernetes.topology",["ngRoute","kubernetesUI"]).config(["$routeProvider",function(e){e.when("/topology",{templateUrl:"views/topology-page.html",controller:"TopologyCtrl"})}]).controller("TopologyCtrl",["$scope",function(o){o.items={};o.relations=[];o.selected=null;var i=o.client;var r=false;i.include("deploymentconfigs");i.include("routes");var a=i.select();i.track(a);e(a).on("changed",d);e(a).on("updated",l);e(a).on("removed",c);d();function l(e,t,n,i){if(o.selected&&o.selected.kind===i.kind&&o.selected.key===i.key){o.selected=t}}function c(e,t,n){if(o.selected===t){o.selected=null}}function s(e){var t={};var o,n;if(e.kind==="Node"){t=i.hosting("Pod",e.metadata.name)}else if(e.kind==="Service"){o=i.lookup("Endpoints",e.metadata.name,e.metadata.namespace)||{};n=o.subsets||[];n.forEach(function(e){var o=e.addresses||[];o.forEach(function(e){if(e.targetRef&&e.targetRef.kind=="Pod")t["Pod:"+e.targetRef.uid]={}})})}else if(e.kind==="ReplicationController"){t=i.select("Pod",e.metadata.namespace,e.spec.selector||{})}else if(e.kind==="DeploymentConfig"){t=i.select("ReplicationController",e.metadata.namespace,{"openshift.io/deployment-config.name":e.metadata.name})}else if(e.kind==="Route"&&e.spec.to){var r=i.lookup(e.spec.to.kind,e.spec.to.name,e.metadata.namespace);if(r)t[r.key]=r}return t}function d(){var e={};var t=[];var n={Service:{},Node:{},ReplicationController:{},DeploymentConfig:{},Route:{}};var i,l,c,d;for(l in a){i=a[l];d=i.kind;c=n[d];if(c)c[l]=i;else if(d!=="Pod")continue;e[l]=i}var f,u;for(d in n){c=n[d];for(l in c){i=c[l];f=s(i);for(u in f)t.push({source:l,target:u})}}o.items=e;o.relations=t;if(r)o.$digest()}o.selected=null;o.$on("select",function(e,t){o.selected=t;o.$digest()});o.kinds=t.copy(n);function f(){o.height={height:window.innerHeight-55+"px"};if(r)o.$digest()}e(window).on("resize",f);f();o.$on("$destroy",function(){e(window).off("resize",f);i.track(a,false);e(a).off()});a=i.select();i.track(a);e(a).on("changed",d);d();r=true}])});
