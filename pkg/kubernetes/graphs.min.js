define(["jquery","base1/cockpit","base1/angular","kubernetes/d3","kubernetes/client"],function(e,t,r,n,a){"use strict";var i=t.gettext;var o={};function c(t){var n=this;n.hosts={};n.services={};var a=t.select("Service");t.track(a);var i=t.select("Pod");t.track(i);e([a,i]).on("changed",o);function o(){var i=false;r.forEach(a,function(r){var a=r.spec;var o=r.metadata;var c=o.name;if(!a||!a.selector||c==="kubernetes"||c==="kubernetes-ro")return;var u=o.uid;t.select("Pod",o.namespace,a.selector).items.forEach(function(t){var r=t.status||{};var a=t.spec||{};var o=a.nodeName;var c=r.containerStatuses||[];if(o&&!n.hosts[o]){n.hosts[o]=o;e(n).triggerHandler("host",o)}c.forEach(function(t){var r=t.containerID;if(r&&r.indexOf("docker://")===0){r=r.substring(9);var a=n.services[u];if(!a){a=n.services[u]={};e(n).triggerHandler("service",u)}if(!a[r]){a[r]=r;i=true}}})})});if(i)e(n).triggerHandler("changed")}o();n.close=function c(){t.track(a,false);t.track(i,false)}}function u(){var r=t.grid(1e3,0,0);r.rows=[];r.events=[];var n=a.k8client();var i=false;var o=null;var u=[];var s={cpu:{},memory:{},network:{}};var f={};var l={};var d={};var v={};var m=[];var h=new c(n);e(h).on("host",function(e,t){p(t)}).on("service",function(e,t){k(t)}).on("changed",function(e){r.sync()});e(r).on("notify",function(){if(i){i=false;r.metric(o)}});function g(e,t){var n=r.add(e,[t,"cpu","usage","total"]);f[t]=r.add(function(e,t,r){x(n,e,t,r)},true);l[t]=r.add(e,[t,"memory","usage"]);var a=r.add(e,[t,"network","rx_bytes"]);d[t]=r.add(function(e,t,r){x(a,e,t,r)},true);var i=r.add(e,[t,"network","tx_bytes"]);v[t]=r.add(function(e,t,r){x(i,e,t,r)},true);r.sync()}function p(t){var n=a.cadvisor(t);e(n).on("container",function(e,t){g(this,t)});var i;for(i in n.specs)g(n,i);r.add(n,["unused-dummy"]);m.push(n)}function k(e){u.push(e);s.cpu[e]=r.add(function(t,r,n){y(e,f,t,r,n)});s.memory[e]=r.add(function(t,r,n){y(e,l,t,r,n)});var t=r.add(function(t,r,n){y(e,v,t,r,n)});var n=r.add(function(t,r,n){y(e,d,t,r,n)});s.network[e]=r.add(function(e,r,a){w([t,n],e,r,a)});i=true}function b(){var e,t;for(e in h.hosts)p(e);for(t in h.services)k(t)}function w(e,t,r,n){var a=t.maximum||0;var o,c,u,s,f=e.length;for(c=0;c<n;c++){o=undefined;for(s=0;s<f;s++){u=e[s][r+c];if(u!==undefined){if(o===undefined)o=u;else o+=u}}if(o!==undefined&&o>a){t.maximum=a=o;i=true}t[r+c]=o}}function x(e,t,r,n){var a,o,c,u;if(r>0)o=e[r-1];var s=t.maximum||1;for(a=0;a<n;a++){u=e[r+a];if(o===undefined||u===undefined){c=undefined}else{c=u-o;if(c<0){c=undefined}else if(c>s){t.maximum=s=c;i=true}}t[r+a]=c;o=u}}function y(e,t,r,n,a){var i,o,c=[];var u=h.services[e];if(u){for(i in u){o=t[i];if(o)c.push(o)}}w(c,r,n,a)}r.metric=function A(t){if(t===undefined)return o;if(s[t]===undefined)throw"unsupported metric type";r.rows=[];o=t;var n,a,i=u.length;for(a=0;a<i;a++){n=s[t][u[a]];if(n!==undefined){r.rows.push(n);n.uid=u[a]}}e(r).triggerHandler("changed")};var M=r.close;r.close=function _(){m.forEach(function(e){e.close()});h.close();n.close();M.apply(r)};b();return r}function s(r,a){var o=u();var c=n.select(r);var s=null;var f={cpu:{label:i("CPU"),step:1e3*1e3*1e3,formatter:function(e){return e/(10*1e3*1e3)+"%"}},memory:{label:i("Memory"),step:1024*1024*64,formatter:function(e){return t.format_bytes(e)}},network:{label:i("Network"),step:1e3*1e3,formatter:function(e){return t.format_bits_per_sec(e,"Mbps")}}};c.append("ul").attr("class","nav nav-tabs").selectAll("li").data(Object.keys(f)).enter().append("li").attr("data-metric",function(e){return e}).append("a").text(function(e){return f[e].label});function l(e){c.selectAll("ul li").attr("class",function(t){return e===t?"active":null});o.metric(e)}c.selectAll("ul li").on("click",function(){l(n.select(this).attr("data-metric"))});l("cpu");var d={top:12,right:15,bottom:40,left:60};var v=n.scale.category20();var m=n.select(r).append("svg");var h=m.append("g").attr("transform","translate("+d.left+","+d.top+")");var g=n.scale.linear();var p=n.svg.axis().scale(g).ticks(5).orient("left");var k=h.append("g").attr("class","y axis");var b=n.scale.linear();var w=n.svg.axis().scale(b).orient("bottom");var x=h.append("g").attr("class","x axis");var y=0;var M=n.svg.line().defined(function(e){return e!==undefined}).x(function(e,t){return b(o.beg+t-y)}).y(function(e,t){return g(e)});var A=3e5/1024;var _=300;var E=300;var S=false;var z=false;window.setTimeout(function(){z=true;I()},1);function H(e,t){var r=e%t;if(e===0||r!==0)e+=t-r;return e}function $(){var t=o.interval;var r=_-d.right-d.left;var n=Math.floor(e.now()/t);var a=n-Math.floor(A*r/t);y=a;o.move(a,n)}function I(){if(!z)return;m.attr("width",_).attr("height",E);var e=_-d.right-d.left;var t=E-d.top-d.bottom;var r=o.metric();var a=o.interval;var i=o.rows,c=0;var u,s,l=i.length;for(u=0;u<l;u++){if(i[u].maximum!==undefined)s=i[u].maximum;else s=n.max(i[u]);if(s>c)c=Math.ceil(s)}var v=Math.floor(A*e/a);b.domain([0,v]).range([0,e]);g.domain([0,H(c,f[r].step)]).range([t,0]);var h=n.scale.linear().domain([0,v]).range([v,0]);var y=[];for(u=60;u<v;u+=60)y.push(Math.round(h(u)));w.tickValues(y).tickSize(-t,-t).tickFormat(function(e){e=Math.round(h.invert(e));return e/60+" min"});x.attr("transform","translate(0,"+t+")").call(w).selectAll("text").attr("y","10px");p.tickSize(-e,-e).tickFormat(f[r].formatter);k.call(p).selectAll("text").attr("x","-10px");$()}function P(){var e=o.rows;var t=h.selectAll("path.line").data(e,function(e,t){return t});var r=t.style("stroke",function(e,t){return v(t)}).attr("d",function(e){return M(e)}).classed("highlight",function(e){return e.uid===s});t.enter().append("path").attr("class","line").on("mouseover",function(){a(n.select(this).datum().uid)}).on("mouseout",function(){a(null)});t.exit().remove()}e(o).on("changed",I);e(o).on("notify changed",P);function j(){_=e(r).outerWidth()-10;if(_<0)_=0;I()}e(window).on("resize",j);j();var F=window.setInterval($,o.interval);return{highlight:function N(e){s=e;P()},close:function O(){e(window).off("resize",j);window.clearInterval(F);o.close()}}}return r.module("kubernetes.graph",[]).directive("kubernetesServiceGraph",function(){return{restrict:"E",link:function(e,t,r){var n=s(t[0],function(t){e.$broadcast("highlight",t);e.$digest()});e.$on("highlight",function(e,t){n.highlight(t)});t.on("$destroy",function(){n.close()})}}})});
