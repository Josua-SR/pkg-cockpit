define(["jquery","base1/cockpit","shell/controls","data!./operation.html","base1/bootstrap-select"],function(e,r,a,o){var s={};var n=r.gettext;var i="/org/freedesktop/realmd";var t="org.freedesktop.realmd.Service";var l="org.freedesktop.realmd.Provider";var d="org.freedesktop.realmd.KerberosMembership";var m="org.freedesktop.realmd.Realm";function p(a,s,p,u){var c=e.parseHTML(o)[0];var f=function(r,a){return new e.fn.init(r,a||c)};f.fn=f.prototype=e.fn;e.extend(f,e);var v=null;var w=null;var h=null;var g=null;f(".realms-op-cancel").on("click",function(){if(!J())f(c).modal("hide")});f(c).on("hide.bs.modal",function(){J()});f(".realms-op-apply").on("click",_);f(".realms-op-field").on("keydown",function(e){if(e.which==13)_()});f(c).on("click",".realms-op-more-diagnostics",function(){f(".realms-op-error").hide();f(".realms-op-diagnostics").show()});var b=null;f(".realms-op-address").on("keyup change",function(){if(f(".realms-op-address").val()!=h){f(".realms-op-address-error").hide();window.clearTimeout(b);b=window.setTimeout(j,1e3)}});f("select.realms-op-auth").selectpicker().on("change",function(){var e=(f("select.realms-op-auth").val()||"").split("/");var r=e[0];var a=e[1];f(".realms-op-admin-row").hide();f(".realms-op-admin-password-row").hide();f(".realms-op-user-row").hide();f(".realms-op-user-password-row").hide();f(".realms-op-otp-row").hide();if(r=="password"&&a=="administrator"){f(".realms-op-admin-row").show();f(".realms-op-admin-password-row").show()}else if(r=="password"&&a=="user"){f(".realms-op-user-row").show();f(".realms-op-user-password-row").show()}else if(r=="secret"){f(".realms-op-otp-row").show()}});var y,k;if(s=="join"){y=n("page-title","Join a Domain");k=n("Join");f(".realms-op-join-only-row").show();j("")}else{y=n("page-title","Leave Domain");k=n("Leave");f(".realms-op-join-only-row").hide()}f(".realms-op-title").text(y);f(".realms-op-apply").text(k);f(".realms-op-field").val("");function j(e){var o=f.Deferred();if(e===undefined)e=f(".realms-op-address").val();if(e)f(".realms-op-address-spinner").show();o.always(function(){if(e)f(".realms-op-address-spinner").hide()});a.call(i,l,"Discover",[e,{}]).always(function(){if(f(".realms-op-address").val()!=e){o.reject();j();return}var s,i=[],t;if(this.state()=="rejected"){s=arguments[0];f(".realms-op-error").empty().text(s.message);o.reject(s)}var l;if(arguments[0][1])i=arguments[0][1];t=i[0];if(!t){if(e){l=r.format(n("Domain $0 could not be contacted"),e);f(".realms-op-address-error").show().attr("title",l)}p=null;g=null;o.reject(new Error(l))}else{g=a.proxy(d,t);f(g).on("changed",D);p=a.proxy(m,t);f(p).on("changed",D);p.wait(function(){o.resolve(p)})}D()});w=o.promise();h=e;return w}function x(){if(s!="join"){var e=f.Deferred();e.resolve(p);return e.promise()}if(f(".realms-op-address").val()===h){if(w)return w}return j()}function D(){var e=0;f(".realms-op-spinner").toggle(!!v);f(".realms-op-wait-message").toggle(!!v);f(".realms-op-field").prop("disabled",!!v);f(".realms-op-apply").prop("disabled",!!v);if(v)u.attr("disabled","disabled");else u.removeAttr("disabled");if(s!="join")return;if(p&&p.Name&&!f(".realms-op-address")[0].placeholder){f(".realms-op-address")[0].placeholder=r.format(n('e.g. "$0"'),p.Name)}var a="";if(g){if(g.SuggestedAdministrator)a=r.format(n('e.g. "$0"'),g.SuggestedAdministrator)}f(".realms-op-admin")[0].placeholder=a;var o=f("select.realms-op-auth");var i=g&&g.SupportedJoinCredentials||[];i.push(["password","administrator"]);var t=null;var l=0;function d(e,r,a){var s,n,d=i.length;for(n=0;n<d;n++){if((!e||e==i[n][1])&&r==i[n][0]){s=r+"/"+i[n][1];o.append(f("<option>").attr("value",s).text(a));if(!t)t=s;l+=1;break}}}o.empty();d("administrator","password",n("Administrator Password"));d("user","password",n("User Password"));d(null,"secret",n("One Time Password"));d(null,"automatic",n("Automatic"));f(".realms-authentification-row").toggle(l>1);o.prop("disabled",!!v).val(t);o.triggerHandler("change");o.selectpicker("refresh")}function C(){var e,a;var o=(f("select.realms-op-auth").val()||"").split("/");var s=o[0];var n=o[1];if(n=="user"&&s=="password"){e=[s,n,r.variant("(ss)",[f(".realms-op-user").val(),f(".realms-op-user-password").val()])]}else if(n=="administrator"&&s=="password"){e=[s,n,r.variant("(ss)",[f(".realms-op-admin").val(),f(".realms-op-admin-password").val()])]}else if(s=="secret"){a=f(".realms-op-ot-password").val();e=[s,n,r.variant("ay",r.utf8_encoder().encode(a))]}else{e=["automatic",n,r.variant("s","")]}return e}var T=1;function _(){var e="cockpit-"+T;T+=1;A(e);x().fail(function(){A(null)}).done(function(o){var i={operation:r.variant("s",e)};f(".realms-op-error").empty().show();f(".realms-op-diagnostics").empty().hide();var t="";var l=a.subscribe({member:"Diagnostics"},function(r,a,o,s){if(s[1]===e){console.log(String(s[0]).trim());t+=s[0]}});var d,m;if(s=="join"){m=f(".realms-join-computer-ou").val();if(m)i["computer-ou"]=r.variant("s",m);d=g.call("Join",[C(),i])}else if(s=="leave"){d=o.Deconfigure(i)}if(!d){l.remove();return}d.fail(function(e){A(null);if(e.name!="com.redhat.Cockpit.Error.Cancelled"){console.log("Failed to join domain: "+o.Name+": "+e);f(".realms-op-error").empty().text(e+" ").show();if(t){f(".realms-op-error").append('<a class="realms-op-more-diagnostics">'+n("More")+"</a>");f(".realms-op-diagnostics").text(t)}}}).done(function(){A(null);f(c).modal("hide")}).always(function(){l.remove()})})}function A(e){v=e;D()}function J(){if(v){a.call(t,i,"Cancel",[v]);A(null);return true}return false}D();return c}s.button=function u(){var o=e;var s=r.dbus("org.freedesktop.realmd");s.watch(i);var t=s.proxies("org.freedesktop.realmd.Realm");var l=null;var d=null;var m=o("<button>").addClass("btn btn-default").attr("id","system_information_realms_button");o(s).on("close",function(e,a){var o;if(a.problem=="not-found")o=n("Cannot join a domain because realmd is not available on this system");else o=r.message(a);m.addClass("disabled").attr("title",o).tooltip({container:"body"}).tooltip("fixTitle");s=null});t.wait(function(){if(!s)return;d=r.permission({group:"wheel"});function e(){a.update_privileged_ui(d,m,r.format(n("The user <b>$0</b> is not permitted to modify realms"),r.user.name))}o(d).on("changed",e)});function u(){var e,r,a;l=[];for(r in t){a=t[r];if(a.Configured)l.push(a)}if(!l||!l.length)e=n("Join Domain");else e=l.map(function(e){return e.Name}).join(", ");m.text(e)}o(t).on("changed",u);u();var c=null;m.on("click",function(){if(c)o(c).remove();if(l&&l.length)c=p(s,"leave",l[0],m);else c=p(s,"join",null,m);o(c).attr("id","realms-op").appendTo("body").modal("show")});m.close=function f(){if(c)c.cancel();m.remove();if(s)s.close();if(d)d.close()};return m};return s});
