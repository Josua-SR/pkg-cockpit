define(["jquery","base1/cockpit","translated!base1/po","base1/mustache","base1/patterns","base1/bootstrap-select"],function(e,r,s,t){"use strict";r.locale(s);r.translate();var i=r.gettext;function n(){if(window.debugging=="all"||window.debugging=="subscriptions")console.debug.apply(console,arguments)}var a={};function o(){var r=null;var s,t=[];if(e("#subscription-register-url").val()==="Custom URL")r=e("#subscription-register-url-custom").val().trim();var n=e("#subscription-register-username").val();if(n===""){s=new Error(i("Login cannot be empty"));s.target="#subscription-register-username";t.push(s)}var o=e("#subscription-register-password").val();if(o===""){s=new Error(i("Password cannot be empty"));s.target="#subscription-register-password";t.push(s)}e("#subscriptions-register-dialog").dialog("failure",t);if(!t.length)a.manager.register_system(r,n,o)}function u(){var r=e("#subscriptions-register-dialog");var s=e("#account-register-start");s.on("click",function(){o()});r.dialog("failure",null);r.on("show.bs.modal",function(){e("#subscription-register-password").val("");e("#subscriptions-register-password-note-details").hide()});r.on("shown.bs.modal",function(){e("#subscription-register-username").focus()});r.on("keypress",function(e){if(e.keyCode===13)s.trigger("click")})}function c(s,n){var a=e("#subscription-template").html();t.parse(a);var o=r.dbus("com.redhat.SubscriptionManager");var u=e("#subscriptions-subscribed");var c=e("#subscriptions-unregistered");var l=e("#subscriptions-updating");var d=e("#subscription-notification-success-template").html();var f=e("#subscription-notification-failure-template").html();t.parse(d);t.parse(f);var p=false;var g=null;var b=n;var m;var v;function h(){if(m!==null)e("#subscription-manager-not-found").show();m=null}function w(){return g}function y(r){u.empty();if(r.length>0){u.show();for(var s=0;s<r.length;++s)u.append(e(t.render(a,r[s])))}else{u.hide()}}function k(r){var s={};e.each(r.split("\n"),function(e,r){var t=r.indexOf(":");if(t!==-1)s[r.substring(0,t)]=r.substring(t+1).trim()});return s}function _(e){var r=[];var s=e.split("\n\n");for(var t=0;t<s.length;++t){var i=s[t];if(i.indexOf("Product Name:")===-1)continue;var n=k(i);var a=n["Status"];if(n["Status Details"]!=="")a=a+" ("+n["Status Details"]+")";r.push({product_name:n["Product Name"],product_id:n["Product ID"],version:n["Version"],arch:n["Arch"],status:a,starts:n["Starts"],ends:n["Ends"]})}return r}var x=false;function S(r){l.show();e("#subscriptions-update-message").text(r)}function E(){l.hide()}function L(){return l.is(":visible")||v&&v.state()=="pending"}function O(){if(L()){p=true;return}p=false;e("#subscription-manager-not-found").hide();e("#subscription-manager-not-accessible").hide();S("Retrieving current subscription details.");r.spawn(["subscription-manager","list"],{directory:"/",superuser:"try",environ:["LC_ALL=C"]}).done(function(r){E();var s=_(r);if(s.length>0&&r.indexOf("Subscribed")>-1)y(s);else u.hide();if(u.children().length===0)e("#subscriptions-system-status").show();else e("#subscriptions-system-status").hide();if(p)R()}).fail(function(r){E();if(p)R();e("#subscription-manager-not-found").show();console.warn("Subscriptions [get_subscription_details]: couldn't get details: "+r)})}function C(){e("div.container-fluid.alert").remove()}function D(r,s){E();if(s.problem==="access-denied"){e("#subscription-manager-not-found").hide();e("#subscription-manager-not-accessible").show();return}if(r.indexOf("Overall Status:")===-1){e("#subscription-manager-not-found").show();e("#subscription-manager-not-accessible").hide();return}u.empty();var i=k(r);var n=i["Overall Status"];if(g!==null&&n!==g){C();if(n==="Current")c.parent().prepend(e(t.render(d)));if(typeof b===typeof Function)b(g)}g=n;e("#subscriptions-system-status").hide();if(g!=="Unknown"){c.hide()}else{u.hide();c.show()}if(p)R();else if(n!=="Unknown")O()}function P(){if(L()){p=true;return}p=false;S("Retrieving current system subscription status.");var e="";r.spawn(["subscription-manager","status"],{directory:"/",superuser:"try",environ:["LC_ALL=C"],err:"out"}).stream(function(r){e+=r;return r.length}).done(function(r){D(e+r,"")}).fail(function(r){D(e,r)})}function R(){p=false;var e=o.call("/EntitlementStatus","com.redhat.SubscriptionManager.EntitlementStatus","check_status",[]);m=window.setTimeout(h,1e4)}function U(e){var r=new RegExp("(https?:\\/\\/)[\\w_/?%:;@&=+$,\\\\\\-\\.!~*'#|]+");var s=r.exec(e);if(s){var i=e.indexOf(s[0]);var n={pre:e.substring(0,i),link:s[0],post:e.substring(i+s[0].length)};return t.render('{{pre}} <a target="_blank" href="{{{link}}}">{{link}}</a>{{post}}',n)}return t.render("{{text}}",{text:e})}function A(s,t,n){var a=e.Deferred();var o=["subscription-manager","register","--auto-attach"];if(s!==null)o.push("--serverurl="+s);o.push("--username="+t);o.push("--password="+n);a.notify(i("Registering system..."));var u=r.spawn(o,{directory:"/",superuser:"require",environ:["LC_ALL=C"],err:"out"});var c;var l="";u.input("").always(function(){if(v===c)v=null}).stream(function(e){l+=e}).done(function(e){a.resolve()}).fail(function(e){if(e.problem==="cancelled"){a.reject(e);return}var r="Invalid username or password.";var s="Invalid Credentials";var t;var n;if(l.indexOf(r)===0){n="credentials";t=l.substring(r.length).trim()}else if(l.indexOf(s)===0){n="credentials";t=l.substring(s.length).trim()}else if(l.indexOf("Unable to reach the server at")===0){n="server";t=l.trim()}else if(l.indexOf("The system has been registered")===0){a.resolve();return}else{t=l.trim()}if(!t){t=i("Failed to register the system");console.warn(e.message)}var o=new Error(t);o.reason=n;a.reject(o)});c=a.promise();c.cancel=function d(){u.close("cancelled")};v=c;return c}function I(r,s,t){if(L()){console.log(i("Unable to register at this time because a call to subscription manager "+"is already in progress. Please try again."));return}c.hide();e("#subscriptions-register-password-note-details").hide();var n=A(r,s,t);e("#subscriptions-register-dialog").dialog("wait",n);n.done(function(){e("#subscriptions-register-dialog").modal("hide");R()}).fail(function(r){if(r.problem=="cancelled")return;switch(r.reason){case"credentials":var s=new Error("");s.target="#subscription-register-username";var t=new Error(i("Invalid login or password."));t.target="#subscription-register-password";e("#subscriptions-register-dialog").dialog("failure",s,t);if(r.message){e("#subscriptions-register-password-note-details").html(U(r.message)).show()}break;case"server":r.target="#subscription-register-url-area";e("#subscriptions-register-dialog").dialog("failure",r);break;default:e("#subscriptions-register-dialog").dialog("failure",r);break}c.show()})}o.subscribe({path:"/EntitlementStatus","interface":"com.redhat.SubscriptionManager.EntitlementStatus",member:"entitlement_status_changed"},function(e,r,s,t){m=null;if(L()){p=true;return}P()});e("#subscriptions-register").on("click",function(){e("#subscriptions-register-dialog").modal("show")});if(s){P()}return{update_subscriptions:R,get_status:w,register_system:I}}u();a.register=function(){e("#subscriptions-register-dialog").modal("show")};a.init=function(r){if(r===undefined)r=true;var s=e("#subscription-register-url-custom");var t=e("#subscription-register-url");s.hide();t.on("change",function(){if(t.val()==="Default"){s.hide()}else{s.show();s.focus();s.select()}});t.selectpicker("refresh");a.manager=c(r)};return a});
