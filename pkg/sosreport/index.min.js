define(["jquery","base1/cockpit","data!./run-sosreport.sh","translated!base1/po"],function(e,s,o,r){"use strict";s.locale(r);s.translate();var t=s.gettext;var n;var a;var i;function c(){u()}function l(s,o){e("#sos-alert, #sos-progress, #sos-download").hide();e("#sos-error .alert-message").text(s);if(o){e("#sos-error-extra").text(o);e("#sos-error-extra").show()}else e("#sos-error-extra").hide();e("#sos-error").show();e("#sos-cancel").text(t("Close"))}function u(){e("#sos-progress .progress-bar").css("width","0%");e("#sos-download, #sos-error").hide();e("#sos-cancel").text(t("Cancel"));a=null;i=[];var r=s.script(o,["--batch"],{superuser:true,err:"out",pty:true});n=r;var c="";var u=/Running ([0-9]+)\/([0-9]+):/g;var d=/Your sosreport has been generated and saved in:[ \r\n]+(\/[^\r\n]+)/;r.stream(function(s){if(n==r){var o,t;c+=s;t=0;while(o=u.exec(c)){t=parseInt(o[1],10)/parseInt(o[2],10)*100}e("#sos-alert, #sos-progress").show();e("#sos-progress .progress-bar").css("width",t.toString()+"%")}});r.done(function(){if(n==r){var o=d.exec(c);if(o){var u=o[1];var f=u.replace(/.*\//,"");if(u.indexOf("/host")===0)u=u.substr(5);i=[u,u+".md5"];var p=window.btoa(JSON.stringify({payload:"fsread1",binary:"raw",path:u,superuser:true,external:{"content-disposition":'attachment; filename="'+f+'"',"content-type":"application/x-xz, application/octet-stream"}}));a="/cockpit/channel/"+s.transport.csrf_token+"?"+p;e("#sos-progress, #sos-error").hide();e("#sos-alert, #sos-download").show();e("#sos-cancel").text(t("Close"))}else{l(t("No archive has been created."),c)}n=null}});r.fail(function(e){if(n==r){l(e.toString(),c);n=null}})}function d(){if(n){n.close("cancelled");n=null}if(i.length>0){s.spawn(["rm"].concat(i),{superuser:true,err:"message"}).fail(function(e){console.log("failed to remove",i,e)})}a=null;i=[];e("#sos").modal("hide")}function f(){var s=e("<iframe>").attr("src",a).hide();s.on("load",function(e){var o=s.get(0).contentDocument.title;if(o)l(o)});e("body").append(s)}function p(){e(function(){e("#sos").on("show.bs.modal",c);e("#sos-cancel").on("click",d);e("#sos-download button").on("click",f);e("body").show();s.transport.wait(function(){})})}return{init:p}});
