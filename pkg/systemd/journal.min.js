define(["jquery","base1/cockpit","translated!base1/po","base1/mustache","system/journalctl","system/renderer"],function(t,o,n,a,e,r){"use strict";o.locale(n);o.translate();var i=o.gettext;var l;function c(){if(l)l.stop()}function s(){c();var n=[];var a=o.location.options["prio"]||"3";var e=parseInt(a,10);t("#journal-prio button").each(function(){var o=parseInt(t(this).attr("data-prio"),10);t(this).toggleClass("active",isNaN(e)||o<=e)});if(e){for(var i=0;i<=e;i++)n.push("PRIORITY="+i.toString())}var l=o.location.options;if(l["service"])n.push("_SYSTEMD_UNIT="+l["service"]);else if(l["tag"])n.push("SYSLOG_IDENTIFIER="+l["tag"]);var s=o.location.options["start"]||"recent";if(s=="recent")t(window).scrollTop(t(document).height());r.journalbox(t("#journal-box"),s,n,t("#journal-current-day"))}function u(){var n=o.location.path[0];var a=t("#journal-entry-fields");a.empty();function l(o){t("#journal-entry-message").text(r.make_printable(o["MESSAGE"]));var n=new Date(o["__REALTIME_TIMESTAMP"]/1e3);t("#journal-entry-date").text(n.toString());var e;if(o["SYSLOG_IDENTIFIER"])e=o["SYSLOG_IDENTIFIER"];else if(o["_SYSTEMD_UNIT"])e=o["_SYSTEMD_UNIT"];else e=i("Journal entry");t("#journal-entry-id").text(e);var l=Object.keys(o).sort();t.each(l,function(n,e){if(e!="MESSAGE"){a.append(t("<tr>").append(t('<td style="text-align:right">').text(e),t('<td style="text-align:left">').text(r.make_printable(o[e]))))}})}function c(o){a.append(t("<tr>").append(t("<td>").text(o)))}e({cursor:n,count:1,follow:false}).done(function(t){if(t.length>=1&&t[0]["__CURSOR"]==n)l(t[0]);else c(i("Journal entry not found"))}).fail(function(t){c(t)})}function f(){var n=o.location.path;if(n.length===0){t("#journal-entry").hide();s();t("#journal").show()}else if(n.length==1){c();t("#journal").hide();u();t("#journal-entry").show()}else{console.warn("not a journal location: "+n);o.location=""}t("body").show()}t(o).on("locationchanged",f);t("#journal-current-day-menu a").on("click",function(){o.location.go([],t.extend(o.location.options,{start:t(this).attr("data-op")}))});t("#journal-box").on("click",".cockpit-logline",function(){var n=t(this).attr("data-cursor");if(n)o.location.go([n])});t("#journal-prio button").on("click",function(){var n=o.location.options;var a=t(this).attr("data-prio");if(a)n.prio=a;else delete n.prio;o.location.go([],n)});t("#journal-navigate-home").on("click",function(){o.location.go("/")});return f});
