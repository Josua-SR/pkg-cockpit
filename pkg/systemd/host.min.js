define(["jquery","base1/cockpit","base1/mustache","domain/operation","performance/dialog","shell/controls","shell/shell","system/server","system/service","shell/plot","shell/cockpit-plot","shell/cockpit-util","base1/bootstrap-datepicker","base1/bootstrap-combobox","base1/patterns"],function(e,t,s,i,n,r,o,a,l){"use strict";var c=t.gettext;var m=t.gettext;var u=t.permission({admin:true});e(u).on("changed",p);function p(){r.update_privileged_ui(u,".hostname-privileged",t.format(c("The user <b>$0</b> is not permitted to modify hostnames"),t.user.name))}function d(){if(window.debugging=="all"||window.debugging=="system")console.debug.apply(console,arguments)}function _(){var s=this;var i=t.dbus("org.freedesktop.timedate1");var n=i.proxy();var r=null;var o=null;s.timedate=n;s.timedate1_service=l.proxy("dbus-org.freedesktop.timedate1.service");s.timesyncd_service=l.proxy("systemd-timesyncd.service");Object.defineProperty(s,"now",{enumerable:true,get:function m(){var e=r+o;return new Date(e+(new Date).valueOf())}});s.format=function u(e){var t=s.now.toISOString();if(!e)return t.split("T")[0];var i=t.lastIndexOf(":");if(i!==-1)t=t.substring(0,i);return t.replace("T"," ")};var a=window.setInterval(function(){e(s).triggerHandler("changed")},3e4);function c(t,i){var n=new Date;r=t-n.valueOf();o=i;e(s).triggerHandler("changed")}s.update=function p(){t.spawn(["date","+%s:%:z"]).done(function(e){var t=e.trim().split(":").map(function(e){return parseInt(e,10)});if(t[1]<0)t[2]=-t[2];c(t[0]*1e3,t[1]*36e5+t[2]*6e4)})};s.change_time=function d(i,r,o){var a=e.Deferred();t.spawn(["date","--date="+i+" "+r+":"+o,"+%s"]).fail(function(e){a.reject(e)}).done(function(e){var t=parseInt(e.trim(),10);n.call("SetTime",[t*1e3*1e3,false,true]).fail(function(e){a.reject(e)}).done(function(){s.update();a.resolve()})});return a};s.poll_ntp_synchronized=function _(){i.call(n.path,"org.freedesktop.DBus.Properties","Get",["org.freedesktop.timedate1","NTPSynchronized"]).fail(function(e){if(e.name!="org.freedesktop.DBus.Error.UnknownProperty"&&e.problem!="not-found")console.log("can't get NTPSynchronized property",e)}).done(function(e){var t={"org.freedesktop.timedate1":{NTPSynchronized:e[0].v}};var s={};s[n.path]=t;i.notify(s)})};s.close=function h(){i.close()};s.update()}var h;f.prototype={_init:function(){this.id="server";this.server_time=null;this.client=null;this.hostname_proxy=null},getTitle:function(){return null},setup:function(){var r=this;p();e("#shutdown-group").append(o.action_btn(function(e){r.shutdown(e)},[{title:c("Restart"),action:"default"},{title:c("Shutdown"),action:"shutdown"}]));e("#system-ostree-version-link").on("click",function(){t.jump("/updates",t.transport.host)});e("#system_information_hostname_button").on("click",function(){v.client=r.client;e("#system_information_change_hostname").modal("show")});e("#system_information_systime_button").on("click",function(){h.display(r.server_time)});r.domain_button=i.button();e("#system-info-realms td.button-location").append(r.domain_button);r.performance_button=n.button();e("#system-info-performance td.button-location").append(r.performance_button);r.server_time=new _;e(r.server_time).on("changed",function(){e("#system_information_systime_button").text(r.server_time.format(true))});r.ntp_status_tmpl=e("#ntp-status-tmpl").html();s.parse(this.ntp_status_tmpl);r.ntp_status_icon_tmpl=e("#ntp-status-icon-tmpl").html();s.parse(this.ntp_status_icon_tmpl);function a(){var t=e("#system_information_systime_ntp_status");if(!r.server_time.timedate.NTP){t.hide();t.popover("hide");return}t.show();var i={Synched:r.server_time.timedate.NTPSynchronized,service:null};var n=/.*time server (.*)\./i;var o=r.server_time.timesyncd_service.state=="running"&&r.server_time.timesyncd_service.service&&r.server_time.timesyncd_service.service.StatusText;if(r.server_time.timesyncd_service.state=="running")i.service="systemd-timesyncd.service";if(o){var a=o.match(n);if(a)i.Server=a[1];else if(o!="Idle."&&o!=="")i.SubStatus=o}var l=s.render(r.ntp_status_tmpl,i);if(l!=t.attr("data-content")){t.attr("data-content",l);if(t.data("bs.popover").tip().hasClass("in"))t.popover("show")}var c=s.render(r.ntp_status_icon_tmpl,i);t.html(c)}e("#system_information_systime_ntp_status").popover();e(r.server_time.timesyncd_service).on("changed",a);e(r.server_time.timedate).on("changed",a);a();window.setInterval(function(){r.server_time.poll_ntp_synchronized()},5e3);e("#server").on("click","[data-goto-service]",function(){var s=e(this).attr("data-goto-service");t.jump("/system/services/#/"+window.encodeURIComponent(s))});r.plot_controls=o.setup_plot_controls(e("#server"),e("#server-graph-toolbar"));var m=l.proxy("pmcd");var u=l.proxy("pmlogger");var d;e("#server-pmlogger-switch").on("change",function(t){var s=e(this).onoff("value");if(u.exists){if(s){d=e.when(m.enable(),m.start(),u.enable(),u.start()).fail(function(e){console.warn("Enabling pmlogger failed",e)})}else{d=e.when(u.disable(),u.stop()).fail(function(e){console.warn("Disabling pmlogger failed",e)})}d.always(function(){d=null;f()})}});function f(){if(!u.exists)e("#server-pmlogger-onoff-row").hide();else if(!d){e("#server-pmlogger-switch").onoff("value",u.enabled);e("#server-pmlogger-onoff-row").show()}}e(u).on("changed",f);f()},enter:function(){var s=this;s.ostree_client=t.dbus("org.projectatomic.rpmostree1",{superuser:true});e(s.ostree_client).on("close",function(){s.ostree_client=null});s.sysroot=s.ostree_client.proxy("org.projectatomic.rpmostree1.Sysroot","/org/projectatomic/rpmostree1/Sysroot");e(s.sysroot).on("changed",e.proxy(this,"sysroot_changed"));s.client=t.dbus("org.freedesktop.hostname1");s.hostname_proxy=s.client.proxy("org.freedesktop.hostname1","/org/freedesktop/hostname1");s.kernel_hostname=null;var i;var n={direct:["kernel.all.cpu.nice","kernel.all.cpu.user","kernel.all.cpu.sys"],internal:["cpu.basic.nice","cpu.basic.user","cpu.basic.system"],units:"millisec",derive:"rate",factor:.1};var r=o.plot_simple_template();e.extend(r.yaxis,{tickFormatter:function(e){return e.toFixed(0)},max:100});s.cpu_plot=o.plot(e("#server_cpu_graph"),300);s.cpu_plot.set_options(r);i=s.cpu_plot.add_metrics_sum_series(n,{});var a={direct:["mem.util.used"],internal:["memory.used"],units:"bytes"};var l=o.plot_simple_template();e.extend(l.yaxis,{ticks:o.memory_ticks,tickFormatter:o.format_bytes_tick_no_unit});l.setup_hook=function v(t){var s=t.getAxes();e("#server_memory_unit").text(o.bytes_tick_unit(s.yaxis))};s.memory_plot=o.plot(e("#server_memory_graph"),300);s.memory_plot.set_options(l);i=s.memory_plot.add_metrics_sum_series(a,{});var m={direct:["network.interface.total.bytes"],internal:["network.all.tx","network.all.rx"],units:"bytes",derive:"rate"};var u=o.plot_simple_template();e.extend(u.yaxis,{tickFormatter:o.format_bits_per_sec_tick_no_unit});u.setup_hook=function y(t){var s=t.getAxes();if(s.yaxis.datamax<1e5)s.yaxis.options.max=1e5;else s.yaxis.options.max=null;s.yaxis.options.min=0;e("#server_network_traffic_unit").text(o.bits_per_sec_tick_unit(s.yaxis))};s.network_plot=o.plot(e("#server_network_traffic_graph"),300);s.network_plot.set_options(u);i=s.network_plot.add_metrics_sum_series(m,{});var p={direct:["disk.all.total_bytes"],internal:["disk.all.read","disk.all.written"],units:"bytes",derive:"rate"};var _=o.plot_simple_template();e.extend(_.yaxis,{ticks:o.memory_ticks,tickFormatter:o.format_bytes_per_sec_tick_no_unit});_.setup_hook=function g(t){var s=t.getAxes();if(s.yaxis.datamax<1e5)s.yaxis.options.max=1e5;else s.yaxis.options.max=null;s.yaxis.options.min=0;e("#server_disk_io_unit").text(o.bytes_per_sec_tick_unit(s.yaxis))};s.disk_plot=o.plot(e("#server_disk_io_graph"),300);s.disk_plot.set_options(_);i=s.disk_plot.add_metrics_sum_series(p,{});o.util.machine_info(null).done(function(e){r.yaxis.max=e.cpus*100;s.cpu_plot.set_options(r);l.yaxis.max=e.memory;s.memory_plot.set_options(l)});s.plot_controls.reset([s.cpu_plot,s.memory_plot,s.network_plot,s.disk_plot]);e(window).on("resize.server",function(){s.cpu_plot.resize();s.memory_plot.resize();s.network_plot.resize();s.disk_plot.resize()});function h(t){var s={};e.each(t.split("\n"),function(e,t){var i=t.indexOf(":");if(i!==-1)s[t.substring(0,i)]=t.substring(i+1)});return s}t.spawn(["grep","\\w","sys_vendor","product_name"],{directory:"/sys/devices/virtual/dmi/id",err:"ignore"}).done(function(t){var s=h(t);e("#system_information_hardware_text").text(s.sys_vendor+" "+s.product_name)}).fail(function(e){d("couldn't read dmi info: "+e)});t.spawn(["grep","\\w","product_serial","chassis_serial"],{directory:"/sys/devices/virtual/dmi/id",superuser:"try",err:"ignore"}).done(function(t){var s=h(t);e("#system_information_asset_tag_text").text(s.product_serial||s.chassis_serial)}).fail(function(e){d("couldn't read serial dmi info: "+e)});function f(){if(!s.hostname_proxy)return;var t=s.hostname_proxy.PrettyHostname;var i=s.hostname_proxy.StaticHostname;var n=s.kernel_hostname;if(t&&i&&i!=t)n=t+" ("+i+")";else if(i)n=i;if(!n)n=c("Set Host name");e("#system_information_hostname_button").text(n);e("#system_information_os_text").text(s.hostname_proxy.OperatingSystemPrettyName||"")}t.spawn(["hostname"],{err:"ignore"}).done(function(t){s.kernel_hostname=e.trim(t);f()}).fail(function(e){f();d("couldn't read kernel hostname: "+e)});e(s.hostname_proxy).on("changed",f)},show:function(){this.cpu_plot.start_walking();this.memory_plot.start_walking();this.disk_plot.start_walking();this.network_plot.start_walking()},leave:function(){var s=this;s.cpu_plot.destroy();s.memory_plot.destroy();s.disk_plot.destroy();s.network_plot.destroy();e(s.hostname_proxy).off();s.hostname_proxy=null;s.client.close();s.client=null;e(t).off(".server");e(s.sysroot).off();s.sysroot=null;if(s.ostree_client){s.ostree_client.close();s.ostree_client=null}},sysroot_changed:function(){var t=this;if(t.sysroot.Booted&&t.ostree_client){var s="";t.ostree_client.call(t.sysroot.Booted,"org.freedesktop.DBus.Properties","Get",["org.projectatomic.rpmostree1.OS","BootedDeployment"]).done(function(e){if(e&&e[0]){var t=e[0].v;if(t&&t.version)s=t.version.v}}).fail(function(e){console.log(e)}).always(function(){e("#system-ostree-version").toggleClass("hidden",!s);e("#system-ostree-version-link").text(s)})}else{e("#system-ostree-version").toggleClass("hidden",true);e("#system-ostree-version-link").text("")}},shutdown:function(t){g.type=t;e("#shutdown-dialog").modal("show")}};function f(){this._init()}v.prototype={_init:function(){this.id="system_information_change_hostname"},setup:function(){e("#sich-pretty-hostname").on("input change",e.proxy(this._on_full_name_changed,this));e("#sich-hostname").on("input change",e.proxy(this._on_name_changed,this));e("#sich-apply-button").on("click",e.proxy(this._on_apply_button,this))},enter:function(){var t=this;t.hostname_proxy=v.client.proxy();t._initial_hostname=t.hostname_proxy.StaticHostname||"";t._initial_pretty_hostname=t.hostname_proxy.PrettyHostname||"";e("#sich-pretty-hostname").val(t._initial_pretty_hostname);e("#sich-hostname").val(t._initial_hostname);this._always_update_from_pretty=false;this._update()},show:function(){e("#sich-pretty-hostname").focus()},leave:function(){this.hostname_proxy=null},_on_apply_button:function(t){var s=this;var i=e("#sich-pretty-hostname").val();var n=e("#sich-hostname").val();var r=s.hostname_proxy.call("SetStaticHostname",[n,true]);var o=s.hostname_proxy.call("SetPrettyHostname",[i,true]);e("#system_information_change_hostname").dialog("promise",e.when(r,o))},_on_full_name_changed:function(t){var s=e("#sich-pretty-hostname").val();if(this._always_update_from_pretty||this._initial_pretty_hostname!=s){var i=e("#sich-hostname").val();var n=i.indexOf(".");var r=s.toLowerCase().replace(/['".]+/g,"").replace(/[^a-zA-Z0-9]+/g,"-");r=r.substr(0,64);if(n>=0)r=r+i.substr(n);e("#sich-hostname").val(r);this._always_update_from_pretty=true}this._update()},_on_name_changed:function(e){this._update()},_update:function(){var t=e("#sich-apply-button");var s=e("#sich-note-1");var i=e("#sich-note-2");var n=false;var r=false;var o=false;var a="Real host name can only contain lower-case characters, digits, dashes, and periods (with populated subdomains)";var l="Real host name must be 64 characters or less";var c=e("#sich-hostname").val().length<=64;var m=e("#sich-hostname").val();var u=e("#sich-pretty-hostname").val();var p=true;var d=0;for(var _=0;_<e("#sich-hostname").val().length;_++){if(e("#sich-hostname").val()[_]==".")d++;else d=0;if(d>1){p=false;break}}var h=m.match(/[.a-z0-9-]*/)==m&&p;if((m!=this._initial_hostname||u!=this._initial_pretty_hostname)&&(m!==""||u!==""))n=true;if(c&&h)r=true;if(n&&r)o=true;if(r){e(s).css("visibility","hidden");e(i).css("visibility","hidden");e("#sich-hostname-error").removeClass("has-error")}else if(!c&&h){e("#sich-hostname-error").addClass("has-error");e(s).text(l);e(s).css("visibility","visible");e(i).css("visibility","hidden")}else if(c&&!h){e("#sich-hostname-error").addClass("has-error");e(s).text(a);e(s).css("visibility","visible");e(i).css("visibility","hidden")}else{e("#sich-hostname-error").addClass("has-error");if(e(s).text()===l)e(i).text(a);else if(e(s).text()===a)e(i).text(l);else{e(s).text(l);e(i).text(a)}e(s).css("visibility","visible");e(i).css("visibility","visible")}t.prop("disabled",!o)}};function v(){this._init()}y.prototype={_init:function(){this.id="system_information_change_systime";this.date=""},setup:function(){var t=this;function i(){e("#systime-apply-button").prop("disabled",false)}e("#systime-apply-button").on("click",e.proxy(this._on_apply_button,this));e("#change_systime").on("change",e.proxy(this,"update"));e("#systime-time-minutes").on("focusout",e.proxy(this,"update_minutes"));e("#systime-date-input").datepicker({autoclose:true,todayHighlight:true,format:"yyyy-mm-dd"});e("#systime-timezones").css("max-height","10em");e("#systime-timezones").combobox();e("#systime-time-minutes").on("input",i);e("#systime-time-hours").on("input",i);e("#systime-date-input").on("input",i);e("#systime-timezones").on("change",i);e("#systime-date-input").on("focusin",e.proxy(this,"store_date"));e("#systime-date-input").on("focusout",e.proxy(this,"restore_date"));t.ntp_servers_tmpl=e("#ntp-servers-tmpl").html();s.parse(this.ntp_servers_tmpl);e("#systime-ntp-servers").on("click",'[data-action="add"]',function(){var s=e(this).attr("data-index");t.sync_ntp_servers();t.custom_ntp_servers.splice(s+1,0,"");t.update_ntp_servers();return false});e("#systime-ntp-servers").on("click",'[data-action="del"]',function(){var s=e(this).attr("data-index");t.sync_ntp_servers();t.custom_ntp_servers.splice(s,1);t.update_ntp_servers();return false})},enter:function(){var t=this;e("#systime-date-input").val(t.server_time.format());e("#systime-time-minutes").val(t.server_time.now.getUTCMinutes());e("#systime-time-hours").val(t.server_time.now.getUTCHours());e("#change_systime").val(t.server_time.timedate.NTP?t.custom_ntp_enabled?"ntp_time_custom":"ntp_time":"manual_time");e('#change_systime [value="ntp_time"]').attr("disabled",!t.server_time.timedate.CanNTP?"disabled":null);e('#change_systime [value="ntp_time_custom"]').attr("disabled",!(t.server_time.timedate.CanNTP&&t.custom_ntp_supported)?"disabled":null);e("#change_systime").selectpicker("refresh");e("#systime-parse-error").parents("tr").hide();e("#systime-timezone-error").parents("tr").hide();e("#systime-apply-button").prop("disabled",false);e("#systime-timezones").prop("disabled","disabled");t.update();t.update_minutes();t.update_ntp_servers();t.get_timezones()},display:function(t){var s=this;if(s.server_time){console.warn("change-systime dialog reentered");return}s.server_time=t;s.get_ntp_servers(function(){e("#system_information_change_systime").modal("show")})},get_timezones:function(){var s=this;function i(t){var i=[];var n=t.split("\n");var r=s.server_time.timedate.Timezone;e("#systime-timezones").empty();for(var o=0;o<n.length;o++){e("#systime-timezones").append(e("<option>",{value:n[o],text:n[o].replace(/_/g," "),selected:n[o]==r}))}e("#systime-timezones").prop("disabled",false);e("#systime-timezones").combobox("refresh")}t.spawn(["/usr/bin/timedatectl","list-timezones"]).done(i)},get_ntp_servers:function(s){var i=this;var n=i.server_time.timedate1_service;var r=i.server_time.timesyncd_service;i.custom_ntp_supported=false;i.custom_ntp_enabled=false;i.custom_ntp_servers=[];function o(){if((n.exists===false||n.unit)&&r.exists!==null){e([n,r]).off(".get_ntp_servers");if(!n.exists||n.unit.Id!=="systemd-timedated.service"){console.log("systemd-timedated not in use, ntp server configuration not supported");s();return}if(!r.exists){console.log("systemd-timesyncd not available, ntp server configuration not supported");s();return}i.custom_ntp_supported=true;if(!i.ntp_config_file)i.ntp_config_file=t.file("/etc/systemd/timesyncd.conf.d/50-cockpit.conf",{superuser:"try"});i.ntp_config_file.read().done(function(e){var t="";i.ntp_servers=null;if(e){i.custom_ntp_enabled=true;e.split("\n").forEach(function(e){if(e.indexOf("NTP=")===0){t=e.slice(4);i.custom_ntp_enabled=true}else if(e.indexOf("#NTP=")===0){t=e.slice(5);i.custom_ntp_enabled=false}});i.custom_ntp_servers=t.split(" ").filter(function(e){return e!==""});if(i.custom_ntp_servers.length===0)i.custom_ntp_enabled=false}s()}).fail(function(e){console.warn("failed to load time servers",e);s()})}}e([n,r]).on("changed.get_ntp_servers",o);o()},set_ntp_servers:function(e,s){var i=this;var n;var r;n=t.format("# This file is automatically generated by Cockpit\n\n[Time]\n${0}NTP=${1}\n",s?"":"#",e.join(" "));return t.spawn(["mkdir","-p","/etc/systemd/timesyncd.conf.d"],{superuser:"try"}).then(function(){return i.ntp_config_file.replace(n)})},show:function(){},leave:function(){var t=this;e(t.server_time.timedate1_service).off(".change_systime");e(t.server_time.timesyncd_service).off(".change_systime");t.server_time=null},_on_apply_button:function(t){var s=this;if(!s.check_input())return;var i=e("#change_systime").val()=="manual_time";var n=e("#change_systime").val()=="ntp_time_custom";s.sync_ntp_servers();var r=s.custom_ntp_servers.filter(function(e){return e!==""});function o(e,t){var s=new Error(e);s.target=t;return s}if(n&&r.length===0){var a=o(c("Need at least one NTP server"),"#systime-ntp-servers .systime-inline");e("#system_information_change_systime").dialog("failure",a);return}var l=[];if(!e("#systime-timezones").prop("disabled")){l.push(s.server_time.timedate.call("SetTimezone",[e("#systime-timezones").val(),true]))}function m(e){return s.server_time.timedate.call("SetNTP",[e,true])}if(i){l.push(m(false).then(function(){return s.server_time.change_time(e("#systime-date-input").val(),e("#systime-time-hours").val(),e("#systime-time-minutes").val())}))}else if(!s.custom_ntp_supported){l.push(m(true))}else{l.push(m(false).then(function(){return s.server_time.timedate.call("SetTime",[1,true,true])}).then(function(){return s.set_ntp_servers(r,n)}).then(function(){s.server_time.poll_ntp_synchronized();return m(true)}))}e("#system_information_change_systime").dialog("promise",e.when.apply(e,l))},check_input:function(){var t=false;var s=false;var i=false;var n;var r=parseInt(e("#systime-time-hours").val(),10);var o=parseInt(e("#systime-time-minutes").val(),10);if(isNaN(r)||r<0||r>23||isNaN(o)||o<0||o>59){t=true}n=new Date(e("#systime-date-input").val());if(isNaN(n.getTime())||n.getTime()<0)s=true;if(t&&s)e("#systime-parse-error").text(c("Invalid date format and invalid time format"));else if(t)e("#systime-parse-error").text(c("Invalid time format"));else if(s)e("#systime-parse-error").text(c("Invalid date format"));if(e("#systime-timezones").val()===""){i=true;e("#systime-timezone-error").css("visibility","visible")}else{e("#systime-timezone-error").css("visibility","hidden")}e("#systime-timezones").toggleClass("has-error",!i);e("#systime-time-hours").toggleClass("has-error",!t);e("#systime-time-minutes").toggleClass("has-error",!t);e("#systime-date-input").toggleClass("has-error",!s);e("#systime-parse-error").parents("tr").toggle(t||s);e("#systime-timezone-error").parents("tr").toggle(i);if(t||s||i){e("#systime-apply-button").prop("disabled",true);return false}else{e("#systime-apply-button").prop("disabled",false);return true}},update:function(){var t=e("#change_systime").val()==="manual_time";var s=e("#change_systime").val()==="ntp_time_custom";e("#systime-manual-row, #systime-manual-error-row").toggle(t);e("#systime-ntp-servers-row").toggle(s)},sync_ntp_servers:function(){var t=this;t.custom_ntp_servers=e("#systime-ntp-servers input").map(function(t,s){return e(s).val()}).get()},update_ntp_servers:function(){var t=this;if(t.custom_ntp_servers===null||t.custom_ntp_servers.length===0)t.custom_ntp_servers=[""];var i={NTPServers:t.custom_ntp_servers.map(function(e,t){return{index:t,Value:e,Placeholder:c("NTP Server")}})};e("#systime-ntp-servers").html(s.render(t.ntp_servers_tmpl,i))},update_minutes:function(){var t=parseInt(e("#systime-time-minutes").val(),10);if(t<10)e("#systime-time-minutes").val("0"+t)},store_date:function(){this.date=e("#systime-date-input").val()},restore_date:function(){if(e("#systime-date-input").val().length===0)e("#systime-date-input").val(this.date)}};function y(){this._init()}g.prototype={_init:function(){this.id="shutdown-dialog";this.delay=0},setup:function(){var t=this;e("#shutdown-delay li").on("click",function(s){t.delay=e(this).attr("value");t.update()});e("#shutdown-time input").change(e.proxy(t,"update"))},enter:function(t){var s=this;e("#shutdown-message").val("").attr("placeholder",c("Message to logged in users")).attr("rows",5);s.delay=e("#shutdown-delay li:first-child").attr("value");if(g.type=="shutdown"){e("#shutdown-dialog .modal-title").text(c("Shutdown"));e("#shutdown-action").click(e.proxy(this,"shutdown"));e("#shutdown-action").text(c("Shutdown"))}else{e("#shutdown-dialog .modal-title").text(c("Restart"));e("#shutdown-action").click(e.proxy(this,"restart"));e("#shutdown-action").text(c("Restart"))}this.update()},show:function(e){},leave:function(){},update:function(){var t=this;var s=false;e("#shutdown-time").toggle(t.delay=="x");if(t.delay=="x"){var i=parseInt(e("#shutdown-time input:nth-child(1)").val(),10);var n=parseInt(e("#shutdown-time input:nth-child(3)").val(),10);var r=i>=0&&i<24&&(n>=0&&n<60);e("#shutdown-time").toggleClass("has-error",!r);if(!r)s=true}e("#shutdown-delay button span").text(e("#shutdown-delay li[value='"+t.delay+"']").text());e("#shutdown-action").prop("disabled",s)},do_action:function(s){var i=this;var n=e("#shutdown-message").val();var r;if(i.delay=="x")r=e("#shutdown-time input:nth-child(1)").val()+":"+e("#shutdown-time input:nth-child(3)").val();else r="+"+i.delay;var o=s=="shutdown"?"--poweroff":"--reboot";if(s=="restart")t.hint("restart");var a=t.spawn(["shutdown",o,r,n],{superuser:"try"});e("#shutdown-dialog").dialog("promise",a)},restart:function(){this.do_action("restart")},shutdown:function(){this.do_action("shutdown")}};function g(){this._init()}w.prototype={_init:function(){this.id="cpu_status"},getTitle:function(){return m("page-title","CPU Status")},enter:function(){var e=this;var s={series:{shadowSize:0,lines:{lineWidth:0,fill:true}},yaxis:{min:0,max:100,show:true,ticks:5,tickFormatter:function(e){return e/10+"%"}},xaxis:{show:true,ticks:[[0*60,"5 min"],[1*60,"4 min"],[2*60,"3 min"],[3*60,"2 min"],[4*60,"1 min"]]},legend:{show:true},x_rh_stack_graphs:true};var i=[{name:"cpu.basic.iowait",derive:"rate"},{name:"cpu.basic.system",derive:"rate"},{name:"cpu.basic.user",derive:"rate"},{name:"cpu.basic.nice",derive:"rate"}];var n=[{color:"#e41a1c",label:c("I/O Wait")},{color:"#ff7f00",label:c("Kernel")},{color:"#377eb8",label:c("User")},{color:"#4daf4a",label:c("Nice")}];e.channel=t.metrics(1e3,{source:"internal",metrics:i,cache:"cpu-status-rate"});e.grid=t.grid(1e3,-300,-0);var r;for(r=0;r<n.length;r++){n[r].row=e.grid.add(e.channel,[i[r].name])}e.channel.follow();e.grid.walk();this.plot=o.setup_complicated_plot("#cpu_status_graph",e.grid,n,s);o.util.machine_info().done(function(t){e.plot.set_yaxis_max(t.cpus*1e3)})},show:function(){this.plot.start()},leave:function(){this.plot.destroy();this.channel.close();this.channel=null}};function w(){this._init()}b.prototype={_init:function(){this.id="memory_status"},getTitle:function(){return m("page-title","Memory")},enter:function(){var e=this;var s={series:{shadowSize:0,lines:{lineWidth:0,fill:true}},yaxis:{min:0,ticks:5,tickFormatter:function(e){return t.format_bytes(e)}},xaxis:{show:true,ticks:[[0*60,"5 min"],[1*60,"4 min"],[2*60,"3 min"],[3*60,"2 min"],[4*60,"1 min"]]},legend:{show:true},x_rh_stack_graphs:true};var i=[{name:"memory.swap-used"},{name:"memory.cached"},{name:"memory.used"},{name:"memory.free"}];var n=[{color:"#e41a1c",label:c("Swap Used")},{color:"#ff7f00",label:c("Cached")},{color:"#377eb8",label:c("Used")},{color:"#4daf4a",label:c("Free")}];e.channel=t.metrics(1e3,{source:"internal",metrics:i,cache:"memory-status"});e.grid=t.grid(1e3,-300,-0);var r;for(r=0;r<n.length;r++){n[r].row=e.grid.add(e.channel,[i[r].name])}e.channel.follow();e.grid.walk();this.plot=o.setup_complicated_plot("#memory_status_graph",e.grid,n,s)},show:function(){this.plot.start()},leave:function(){this.plot.destroy();this.channel.close();this.channel=null}};function b(){this._init()}e("#link-cpu").on("click",function(){t.location.go(["cpu"]);return false});e("#link-memory").on("click",function(){t.location.go(["memory"]);return false});e("#link-network").on("click",function(){t.jump("/network");return false});e("#link-disk").on("click",function(){t.jump("/storage");return false});function x(t){t.setup();var s=false;e("#"+t.id).on("show.bs.modal",function(e){if(e.target.id===t.id)t.enter()}).on("shown.bs.modal",function(e){if(e.target.id===t.id)t.show()}).on("hidden.bs.modal",function(e){if(e.target.id===t.id)t.leave()})}function k(t,s){if(!t._entered_)t.enter(s);t._entered_=true;e("#"+t.id).show().removeAttr("hidden");t.show()}function z(t){e("#"+t.id).hide()}function S(){var s;var i;var n;function r(){var r=t.location.path;if(r.length===0){z(n);z(i);k(s)}else if(r.length===1&&r[0]=="cpu"){z(s);z(i);k(n)}else if(r.length===1&&r[0]=="memory"){z(s);z(n);k(i)}else{console.warn("not a system location: "+r);t.location=""}e("body").removeAttr("hidden")}t.translate();s=new f;s.setup();n=new w;i=new b;x(new v);x(h=new y);x(new g);e(t).on("locationchanged",r);r()}return S});
