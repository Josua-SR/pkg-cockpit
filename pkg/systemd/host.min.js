define(["jquery","base1/cockpit","base1/mustache","domain/operation","shell/controls","shell/shell","system/server","system/service","shell/plot","shell/cockpit-plot","shell/cockpit-util","base1/bootstrap-datepicker","base1/bootstrap-combobox","base1/patterns"],function(e,t,s,i,n,r,o,a){"use strict";var l=t.gettext;var c=t.gettext;var m=t.permission({group:"wheel"});e(m).on("changed",u);function u(){n.update_privileged_ui(m,".hostname-privileged",t.format(l("The user <b>$0</b> is not permitted to modify hostnames"),t.user.name))}function p(){if(window.debugging=="all"||window.debugging=="system")console.debug.apply(console,arguments)}function _(){var s=this;var i=t.dbus("org.freedesktop.timedate1");var n=i.proxy();var r=null;var o=null;s.timedate=n;s.timedate1_service=a.proxy("dbus-org.freedesktop.timedate1.service");s.timesyncd_service=a.proxy("systemd-timesyncd.service");Object.defineProperty(s,"now",{enumerable:true,get:function m(){var e=r+o;return new Date(e+(new Date).valueOf())}});s.format=function u(e){var t=s.now.toISOString();if(!e)return t.split("T")[0];var i=t.lastIndexOf(":");if(i!==-1)t=t.substring(0,i);return t.replace("T"," ")};var l=window.setInterval(function(){e(s).triggerHandler("changed")},3e4);function c(t,i){var n=new Date;r=t-n.valueOf();o=i;e(s).triggerHandler("changed")}s.update=function p(){t.spawn(["/usr/bin/date","+%s:%:z"]).done(function(e){var t=e.trim().split(":").map(function(e){return parseInt(e,10)});if(t[1]<0)t[2]=-t[2];c(t[0]*1e3,t[1]*36e5+t[2]*6e4)})};s.change_time=function _(i,r,o){var a=e.Deferred();t.spawn(["/usr/bin/date","--date="+i+" "+r+":"+o,"+%s"]).fail(function(e){a.reject(e)}).done(function(e){var t=parseInt(e.trim(),10);n.call("SetTime",[t*1e3*1e3,false,true]).fail(function(e){a.reject(e)}).done(function(){s.update();a.resolve()})});return a};s.poll_ntp_synchronized=function d(){i.call(n.path,"org.freedesktop.DBus.Properties","Get",["org.freedesktop.timedate1","NTPSynchronized"]).fail(function(e){if(e.name!="org.freedesktop.DBus.Error.UnknownProperty"&&e.problem!="not-found")console.log("can't get NTPSynchronized property",e)}).done(function(e){var t={"org.freedesktop.timedate1":{NTPSynchronized:e[0].v}};var s={};s[n.path]=t;i.notify(s)})};s.close=function h(){i.close()};s.update()}var d;h.prototype={_init:function(){this.id="server";this.server_time=null;this.os_file_name="/etc/os-release";this.client=null;this.hostname_proxy=null},getTitle:function(){return null},setup:function(){var n=this;u();e("#shutdown-group").append(r.action_btn(function(e){n.shutdown(e)},[{title:l("Restart"),action:"default"},{title:l("Shutdown"),action:"shutdown"}]));e("#system_information_hostname_button").on("click",function(){f.client=n.client;e("#system_information_change_hostname").modal("show")});e("#system_information_systime_button").on("click",function(){d.display(n.server_time)});n.domain_button=i.button();e("#system-info-realms td.button-location").append(n.domain_button);n.server_time=new _;e(n.server_time).on("changed",function(){e("#system_information_systime_button").text(n.server_time.format(true))});n.ntp_status_tmpl=e("#ntp-status-tmpl").html();s.parse(this.ntp_status_tmpl);n.ntp_status_icon_tmpl=e("#ntp-status-icon-tmpl").html();s.parse(this.ntp_status_icon_tmpl);function o(){var t=e("#system_information_systime_ntp_status");if(!n.server_time.timedate.NTP){t.hide();t.popover("hide");return}t.show();var i={Synched:n.server_time.timedate.NTPSynchronized,service:null};var r=/.*time server (.*)\./i;var o=n.server_time.timesyncd_service.state=="running"&&n.server_time.timesyncd_service.service&&n.server_time.timesyncd_service.service.StatusText;if(n.server_time.timesyncd_service.state=="running")i.service="systemd-timesyncd.service";if(o){var a=o.match(r);if(a)i.Server=a[1];else if(o!="Idle."&&o!=="")i.SubStatus=o}var l=s.render(n.ntp_status_tmpl,i);if(l!=t.attr("data-content")){t.attr("data-content",l);if(t.data("bs.popover").tip().hasClass("in"))t.popover("show")}var c=s.render(n.ntp_status_icon_tmpl,i);t.html(c)}e("#system_information_systime_ntp_status").popover();e(n.server_time.timesyncd_service).on("changed",o);e(n.server_time.timedate).on("changed",o);o();window.setInterval(function(){n.server_time.poll_ntp_synchronized()},5e3);e("#server").on("click","[data-goto-service]",function(){var s=e(this).attr("data-goto-service");t.jump("/system/services/#/"+window.encodeURIComponent(s))});n.plot_controls=r.setup_plot_controls(e("#server"),e("#server-graph-toolbar"));var c=a.proxy("pmcd");var m=a.proxy("pmlogger");var p;e("#server-pmlogger-switch").on("change",function(t){var s=e(this).onoff("value");if(m.exists){if(s){p=e.when(c.enable(),c.start(),m.enable(),m.start()).fail(function(e){console.warn("Enabling pmlogger failed",e)})}else{p=e.when(m.disable(),m.stop()).fail(function(e){console.warn("Disabling pmlogger failed",e)})}p.always(function(){p=null;h()})}});function h(){if(!m.exists)e("#server-pmlogger-onoff-row").hide();else if(!p){e("#server-pmlogger-switch").onoff("value",m.enabled);e("#server-pmlogger-onoff-row").show()}}e(m).on("changed",h);h()},enter:function(){var s=this;s.client=t.dbus("org.freedesktop.hostname1");s.hostname_proxy=s.client.proxy("org.freedesktop.hostname1","/org/freedesktop/hostname1");s.kernel_hostname=null;function i(t,s,i){if(i){console.warn("couldn't load os data: "+i);t=""}var n=t.split("\n");for(var r=0;r<n.length;r++){var o=n[r].split("=");if(o[0]==="PRETTY_NAME"){var a=o[1];try{a=JSON.parse(a)}catch(l){}e("#system_information_os_text").text(a);break}}}s.os_file=t.file(s.os_file_name);s.os_file.watch(i);var n;var o={direct:["kernel.all.cpu.nice","kernel.all.cpu.user","kernel.all.cpu.sys"],internal:["cpu.basic.nice","cpu.basic.user","cpu.basic.system"],units:"millisec",derive:"rate",factor:.1};var a=r.plot_simple_template();e.extend(a.yaxis,{tickFormatter:function(e){return e.toFixed(0)},max:100});s.cpu_plot=r.plot(e("#server_cpu_graph"),300);s.cpu_plot.set_options(a);n=s.cpu_plot.add_metrics_sum_series(o,{});var c={direct:["mem.util.used"],internal:["memory.used"],units:"bytes"};var m=r.plot_simple_template();e.extend(m.yaxis,{ticks:r.memory_ticks,tickFormatter:r.format_bytes_tick_no_unit});m.setup_hook=function y(t){var s=t.getAxes();e("#server_memory_unit").text(r.bytes_tick_unit(s.yaxis))};s.memory_plot=r.plot(e("#server_memory_graph"),300);s.memory_plot.set_options(m);n=s.memory_plot.add_metrics_sum_series(c,{});var u={direct:["network.interface.total.bytes"],internal:["network.all.tx","network.all.rx"],units:"bytes",derive:"rate"};var _=r.plot_simple_template();e.extend(_.yaxis,{tickFormatter:r.format_bits_per_sec_tick_no_unit});_.setup_hook=function g(t){var s=t.getAxes();if(s.yaxis.datamax<1e5)s.yaxis.options.max=1e5;else s.yaxis.options.max=null;s.yaxis.options.min=0;e("#server_network_traffic_unit").text(r.bits_per_sec_tick_unit(s.yaxis))};s.network_plot=r.plot(e("#server_network_traffic_graph"),300);s.network_plot.set_options(_);n=s.network_plot.add_metrics_sum_series(u,{});var d={direct:["disk.dev.total_bytes"],internal:["block.device.read","block.device.written"],units:"bytes",derive:"rate"};var h=r.plot_simple_template();e.extend(h.yaxis,{ticks:r.memory_ticks,tickFormatter:r.format_bytes_per_sec_tick_no_unit});h.setup_hook=function b(t){var s=t.getAxes();if(s.yaxis.datamax<1e5)s.yaxis.options.max=1e5;else s.yaxis.options.max=null;s.yaxis.options.min=0;e("#server_disk_io_unit").text(r.bytes_per_sec_tick_unit(s.yaxis))};s.disk_plot=r.plot(e("#server_disk_io_graph"),300);s.disk_plot.set_options(h);n=s.disk_plot.add_metrics_sum_series(d,{});r.util.machine_info(null).done(function(e){a.yaxis.max=e.cpus*100;s.cpu_plot.set_options(a);m.yaxis.max=e.memory;s.memory_plot.set_options(m)});s.plot_controls.reset([s.cpu_plot,s.memory_plot,s.network_plot,s.disk_plot]);e(window).on("resize.server",function(){s.cpu_plot.resize();s.memory_plot.resize();s.network_plot.resize();s.disk_plot.resize()});function f(t){var s={};e.each(t.split("\n"),function(e,t){var i=t.indexOf(":");if(i!==-1)s[t.substring(0,i)]=t.substring(i+1)});return s}t.spawn(["grep","\\w","bios_vendor","bios_version","bios_date","sys_vendor","product_name"],{directory:"/sys/devices/virtual/dmi/id",err:"ignore"}).done(function(t){var s=f(t);e("#system_information_bios_text").text(s.bios_vendor+" "+s.bios_version+" ("+s.bios_date+")");e("#system_information_hardware_text").text(s.sys_vendor+" "+s.product_name)}).fail(function(e){p("couldn't read dmi info: "+e)});t.spawn(["grep","\\w","product_serial","chassis_serial"],{directory:"/sys/devices/virtual/dmi/id",superuser:"try",err:"ignore"}).done(function(t){var s=f(t);e("#system_information_asset_tag_text").text(s.product_serial||s.chassis_serial)}).fail(function(e){p("couldn't read serial dmi info: "+e)});function v(){if(!s.hostname_proxy)return;var t=s.hostname_proxy.PrettyHostname;var i=s.hostname_proxy.StaticHostname;var n=s.kernel_hostname;if(t&&i&&i!=t)n=t+" ("+i+")";else if(i)n=i;if(!n)n=l("Set Host name");e("#system_information_hostname_button").text(n)}t.spawn(["hostname"],{err:"ignore"}).done(function(t){s.kernel_hostname=e.trim(t);v()}).fail(function(e){v();p("couldn't read kernel hostname: "+e)});e(s.hostname_proxy).on("changed",v)},show:function(){this.cpu_plot.start_walking();this.memory_plot.start_walking();this.disk_plot.start_walking();this.network_plot.start_walking()},leave:function(){var s=this;s.cpu_plot.destroy();s.memory_plot.destroy();s.disk_plot.destroy();s.network_plot.destroy();s.os_file.close();s.os_file=null;e(s.hostname_proxy).off();s.hostname_proxy=null;s.client.close();s.client=null;e(t).off(".server")},shutdown:function(t){y.type=t;e("#shutdown-dialog").modal("show")}};function h(){this._init()}f.prototype={_init:function(){this.id="system_information_change_hostname"},setup:function(){e("#sich-pretty-hostname").on("input change",e.proxy(this._on_full_name_changed,this));e("#sich-hostname").on("input change",e.proxy(this._on_name_changed,this));e("#sich-apply-button").on("click",e.proxy(this._on_apply_button,this))},enter:function(){var t=this;t.hostname_proxy=f.client.proxy();t._initial_hostname=t.hostname_proxy.StaticHostname||"";t._initial_pretty_hostname=t.hostname_proxy.PrettyHostname||"";e("#sich-pretty-hostname").val(t._initial_pretty_hostname);e("#sich-hostname").val(t._initial_hostname);this._always_update_from_pretty=false;this._update()},show:function(){e("#sich-pretty-hostname").focus()},leave:function(){this.hostname_proxy=null},_on_apply_button:function(t){var s=this;var i=e("#sich-pretty-hostname").val();var n=e("#sich-hostname").val();var r=s.hostname_proxy.call("SetStaticHostname",[n,true]);var o=s.hostname_proxy.call("SetPrettyHostname",[i,true]);e("#system_information_change_hostname").dialog("promise",e.when(r,o))},_on_full_name_changed:function(t){var s=e("#sich-pretty-hostname").val();if(this._always_update_from_pretty||this._initial_pretty_hostname!=s){var i=e("#sich-hostname").val();var n=i.indexOf(".");var r=s.toLowerCase().replace(/['".]+/g,"").replace(/[^a-zA-Z0-9]+/g,"-");r=r.substr(0,64);if(n>=0)r=r+i.substr(n);e("#sich-hostname").val(r);this._always_update_from_pretty=true}this._update()},_on_name_changed:function(e){this._update()},_update:function(){var t=e("#sich-apply-button");var s=e("#sich-note-1");var i=e("#sich-note-2");var n=false;var r=false;var o=false;var a="Real host name can only contain lower-case characters, digits, dashes, and periods (with populated subdomains)";var l="Real host name must be 64 characters or less";var c=e("#sich-hostname").val().length<=64;var m=e("#sich-hostname").val();var u=e("#sich-pretty-hostname").val();var p=true;var _=0;for(var d=0;d<e("#sich-hostname").val().length;d++){if(e("#sich-hostname").val()[d]==".")_++;else _=0;if(_>1){p=false;break}}var h=m.match(/[.a-z0-9-]*/)==m&&p;if((m!=this._initial_hostname||u!=this._initial_pretty_hostname)&&(m!==""||u!==""))n=true;if(c&&h)r=true;if(n&&r)o=true;if(r){e(s).css("visibility","hidden");e(i).css("visibility","hidden");e("#sich-hostname-error").removeClass("has-error")}else if(!c&&h){e("#sich-hostname-error").addClass("has-error");e(s).text(l);e(s).css("visibility","visible");e(i).css("visibility","hidden")}else if(c&&!h){e("#sich-hostname-error").addClass("has-error");e(s).text(a);e(s).css("visibility","visible");e(i).css("visibility","hidden")}else{e("#sich-hostname-error").addClass("has-error");if(e(s).text()===l)e(i).text(a);else if(e(s).text()===a)e(i).text(l);else{e(s).text(l);e(i).text(a)}e(s).css("visibility","visible");e(i).css("visibility","visible")}t.prop("disabled",!o)}};function f(){this._init()}v.prototype={_init:function(){this.id="system_information_change_systime";this.date=""},setup:function(){var t=this;function i(){e("#systime-apply-button").prop("disabled",false)}e("#systime-apply-button").on("click",e.proxy(this._on_apply_button,this));e("#change_systime").on("change",e.proxy(this,"update"));e("#systime-time-minutes").on("focusout",e.proxy(this,"update_minutes"));e("#systime-date-input").datepicker({autoclose:true,todayHighlight:true,format:"yyyy-mm-dd"});e("#systime-timezones").css("max-height","10em");e("#systime-timezones").combobox();e("#systime-time-minutes").on("input",i);e("#systime-time-hours").on("input",i);e("#systime-date-input").on("input",i);e("#systime-timezones").on("change",i);e("#systime-date-input").on("focusin",e.proxy(this,"store_date"));e("#systime-date-input").on("focusout",e.proxy(this,"restore_date"));t.ntp_servers_tmpl=e("#ntp-servers-tmpl").html();s.parse(this.ntp_servers_tmpl);e("#systime-ntp-servers").on("click",'[data-action="add"]',function(){var s=e(this).attr("data-index");t.sync_ntp_servers();t.custom_ntp_servers.splice(s+1,0,"");t.update_ntp_servers();return false});e("#systime-ntp-servers").on("click",'[data-action="del"]',function(){var s=e(this).attr("data-index");t.sync_ntp_servers();t.custom_ntp_servers.splice(s,1);t.update_ntp_servers();return false})},enter:function(){var t=this;e("#systime-date-input").val(t.server_time.format());e("#systime-time-minutes").val(t.server_time.now.getUTCMinutes());e("#systime-time-hours").val(t.server_time.now.getUTCHours());e("#change_systime").val(t.server_time.timedate.NTP?t.custom_ntp_enabled?"ntp_time_custom":"ntp_time":"manual_time");e('#change_systime [value="ntp_time"]').attr("disabled",!t.server_time.timedate.CanNTP?"disabled":null);e('#change_systime [value="ntp_time_custom"]').attr("disabled",!(t.server_time.timedate.CanNTP&&t.custom_ntp_supported)?"disabled":null);e("#change_systime").selectpicker("refresh");e("#systime-parse-error").parents("tr").hide();e("#systime-timezone-error").parents("tr").hide();e("#systime-apply-button").prop("disabled",false);e("#systime-timezones").prop("disabled","disabled");t.update();t.update_minutes();t.update_ntp_servers();t.get_timezones()},display:function(t){var s=this;if(s.server_time){console.warn("change-systime dialog reentered");return}s.server_time=t;s.get_ntp_servers(function(){e("#system_information_change_systime").modal("show")})},get_timezones:function(){var s=this;function i(t){var i=[];var n=t.split("\n");var r=s.server_time.timedate.Timezone;e("#systime-timezones").empty();for(var o=0;o<n.length;o++){e("#systime-timezones").append(e("<option>",{value:n[o],text:n[o].replace(/_/g," "),selected:n[o]==r}))}e("#systime-timezones").prop("disabled",false);e("#systime-timezones").combobox("refresh")}t.spawn(["/usr/bin/timedatectl","list-timezones"]).done(i)},get_ntp_servers:function(s){var i=this;var n=i.server_time.timedate1_service;var r=i.server_time.timesyncd_service;i.custom_ntp_supported=false;i.custom_ntp_enabled=false;i.custom_ntp_servers=[];function o(){if((n.exists===false||n.unit)&&r.exists!==null){e([n,r]).off(".get_ntp_servers");if(!n.exists||n.unit.Id!=="systemd-timedated.service"){console.log("systemd-timedated not in use, ntp server configuration not supported");s();return}if(!r.exists){console.log("systemd-timesyncd not available, ntp server configuration not supported");s();return}i.custom_ntp_supported=true;if(!i.ntp_config_file)i.ntp_config_file=t.file("/etc/systemd/timesyncd.conf.d/50-cockpit.conf",{superuser:"try"});i.ntp_config_file.read().done(function(e){var t="";i.ntp_servers=null;if(e){i.custom_ntp_enabled=true;e.split("\n").forEach(function(e){if(e.indexOf("NTP=")===0){t=e.slice(4);i.custom_ntp_enabled=true}else if(e.indexOf("#NTP=")===0){t=e.slice(5);i.custom_ntp_enabled=false}});i.custom_ntp_servers=t.split(" ").filter(function(e){return e!==""});if(i.custom_ntp_servers.length===0)i.custom_ntp_enabled=false}s()}).fail(function(e){console.warn("failed to load time servers",e);s()})}}e([n,r]).on("changed.get_ntp_servers",o);o()},set_ntp_servers:function(e,s){var i=this;var n;var r;n=t.format("# This file is automatically generated by Cockpit\n\n[Time]\n${0}NTP=${1}\n",s?"":"#",e.join(" "));return t.spawn(["mkdir","-p","/etc/systemd/timesyncd.conf.d"],{superuser:"try"}).then(function(){return i.ntp_config_file.replace(n)})},show:function(){},leave:function(){var t=this;e(t.server_time.timedate1_service).off(".change_systime");e(t.server_time.timesyncd_service).off(".change_systime");t.server_time=null},_on_apply_button:function(t){var s=this;if(!s.check_input())return;var i=e("#change_systime").val()=="manual_time";var n=e("#change_systime").val()=="ntp_time_custom";s.sync_ntp_servers();var r=s.custom_ntp_servers.filter(function(e){return e!==""});function o(e,t){var s=new Error(e);s.target=t;return s}if(n&&r.length===0){var a=o(l("Need at least one NTP server"),"#systime-ntp-servers .systime-inline");e("#system_information_change_systime").dialog("failure",a);return}var c=[];if(!e("#systime-timezones").prop("disabled")){c.push(s.server_time.timedate.call("SetTimezone",[e("#systime-timezones").val(),true]))}function m(e){return s.server_time.timedate.call("SetNTP",[e,true])}if(i){c.push(m(false).then(function(){return s.server_time.change_time(e("#systime-date-input").val(),e("#systime-time-hours").val(),e("#systime-time-minutes").val())}))}else if(!s.custom_ntp_supported){c.push(m(true))}else{c.push(m(false).then(function(){return s.server_time.timedate.call("SetTime",[1,true,true])}).then(function(){return s.set_ntp_servers(r,n)}).then(function(){s.server_time.poll_ntp_synchronized();return m(true)}))}e("#system_information_change_systime").dialog("promise",e.when.apply(e,c))},check_input:function(){var t=false;var s=false;var i=false;var n;var r=parseInt(e("#systime-time-hours").val(),10);var o=parseInt(e("#systime-time-minutes").val(),10);if(isNaN(r)||r<0||r>23||isNaN(o)||o<0||o>59){t=true}n=new Date(e("#systime-date-input").val());if(isNaN(n.getTime())||n.getTime()<0)s=true;if(t&&s)e("#systime-parse-error").text(l("Invalid date format and invalid time format"));else if(t)e("#systime-parse-error").text(l("Invalid time format"));else if(s)e("#systime-parse-error").text(l("Invalid date format"));if(e("#systime-timezones").val()===""){i=true;e("#systime-timezone-error").css("visibility","visible")}else{e("#systime-timezone-error").css("visibility","hidden")}e("#systime-timezones").toggleClass("has-error",!i);e("#systime-time-hours").toggleClass("has-error",!t);e("#systime-time-minutes").toggleClass("has-error",!t);e("#systime-date-input").toggleClass("has-error",!s);e("#systime-parse-error").parents("tr").toggle(t||s);e("#systime-timezone-error").parents("tr").toggle(i);if(t||s||i){e("#systime-apply-button").prop("disabled",true);return false}else{e("#systime-apply-button").prop("disabled",false);return true}},update:function(){var t=e("#change_systime").val()==="manual_time";var s=e("#change_systime").val()==="ntp_time_custom";e("#systime-manual-row, #systime-manual-error-row").toggle(t);e("#systime-ntp-servers-row").toggle(s)},sync_ntp_servers:function(){var t=this;t.custom_ntp_servers=e("#systime-ntp-servers input").map(function(t,s){return e(s).val()}).get()},update_ntp_servers:function(){var t=this;if(t.custom_ntp_servers===null||t.custom_ntp_servers.length===0)t.custom_ntp_servers=[""];var i={NTPServers:t.custom_ntp_servers.map(function(e,t){return{index:t,Value:e,Placeholder:l("NTP Server")}})};e("#systime-ntp-servers").html(s.render(t.ntp_servers_tmpl,i))},update_minutes:function(){var t=parseInt(e("#systime-time-minutes").val(),10);if(t<10)e("#systime-time-minutes").val("0"+t)},store_date:function(){this.date=e("#systime-date-input").val()},restore_date:function(){if(e("#systime-date-input").val().length===0)e("#systime-date-input").val(this.date)}};function v(){this._init()}y.prototype={_init:function(){this.id="shutdown-dialog"},setup:function(){e("#shutdown-delay").html(this.delay_btn=r.select_btn(e.proxy(this,"update"),[{choice:"1",title:l("1 Minute")},{choice:"5",title:l("5 Minutes")},{choice:"20",title:l("20 Minutes")},{choice:"40",title:l("40 Minutes")},{choice:"60",title:l("60 Minutes")},{group:[{choice:"0",title:l("No Delay")},{choice:"x",title:l("Specific Time")}]}]).css("display","inline"));e("#shutdown-time input").change(e.proxy(this,"update"))},enter:function(t){e("#shutdown-message").val("").attr("placeholder",l("Message to logged in users")).attr("rows",5);r.select_btn_select(this.delay_btn,"1");if(y.type=="shutdown"){e("#shutdown-dialog .modal-title").text(l("Shutdown"));e("#shutdown-action").click(e.proxy(this,"shutdown"));e("#shutdown-action").text(l("Shutdown"))}else{e("#shutdown-dialog .modal-title").text(l("Restart"));e("#shutdown-action").click(e.proxy(this,"restart"));e("#shutdown-action").text(l("Restart"))}this.update()},show:function(e){},leave:function(){},update:function(){var t=false;var s=r.select_btn_selected(this.delay_btn);e("#shutdown-time").toggle(s=="x");if(s=="x"){var i=parseInt(e("#shutdown-time input:nth-child(1)").val(),10);var n=parseInt(e("#shutdown-time input:nth-child(3)").val(),10);var o=i>=0&&i<24&&(n>=0&&n<60);e("#shutdown-time").toggleClass("has-error",!o);if(!o)t=true}e("#shutdown-action").prop("disabled",t)},do_action:function(s){var i=r.select_btn_selected(this.delay_btn);var n=e("#shutdown-message").val();var o;if(i=="x")o=e("#shutdown-time input:nth-child(1)").val()+":"+e("#shutdown-time input:nth-child(3)").val();else o="+"+i;var a=s=="shutdown"?"--poweroff":"--reboot";var l=t.spawn(["shutdown",a,o,n],{superuser:"try"});e("#shutdown-dialog").dialog("promise",l);l.done(function(){if(s=="restart")t.hint("restart")})},restart:function(){this.do_action("restart")},shutdown:function(){this.do_action("shutdown")}};function y(){this._init()}g.prototype={_init:function(){this.id="cpu_status"},getTitle:function(){return c("page-title","CPU Status")},enter:function(){var e=this;var s={series:{shadowSize:0,lines:{lineWidth:0,fill:true}},yaxis:{min:0,max:100,show:true,ticks:5,tickFormatter:function(e){return e/10+"%"}},xaxis:{show:true,ticks:[[0*60,"5 min"],[1*60,"4 min"],[2*60,"3 min"],[3*60,"2 min"],[4*60,"1 min"]]},legend:{show:true},x_rh_stack_graphs:true};var i=[{name:"cpu.basic.iowait",derive:"rate"},{name:"cpu.basic.system",derive:"rate"},{name:"cpu.basic.user",derive:"rate"},{name:"cpu.basic.nice",derive:"rate"}];var n=[{color:"#e41a1c",label:l("I/O Wait")},{color:"#ff7f00",label:l("Kernel")},{color:"#377eb8",label:l("User")},{color:"#4daf4a",label:l("Nice")}];e.channel=t.metrics(1e3,{source:"internal",metrics:i,cache:"cpu-status-rate"});e.grid=t.grid(1e3,-300,-0);var o;for(o=0;o<n.length;o++){n[o].row=e.grid.add(e.channel,[i[o].name])}e.channel.follow();e.grid.walk();this.plot=r.setup_complicated_plot("#cpu_status_graph",e.grid,n,s);r.util.machine_info().done(function(t){e.plot.set_yaxis_max(t.cpus*1e3)})},show:function(){this.plot.start()},leave:function(){this.plot.destroy();this.channel.close();this.channel=null}};function g(){this._init()}b.prototype={_init:function(){this.id="memory_status"},getTitle:function(){return c("page-title","Memory")},enter:function(){var e=this;var s={series:{shadowSize:0,lines:{lineWidth:0,fill:true}},yaxis:{min:0,ticks:5,tickFormatter:function(e){return t.format_bytes(e)}},xaxis:{show:true,ticks:[[0*60,"5 min"],[1*60,"4 min"],[2*60,"3 min"],[3*60,"2 min"],[4*60,"1 min"]]},legend:{show:true},x_rh_stack_graphs:true};var i=[{name:"memory.swap-used"},{name:"memory.cached"},{name:"memory.used"},{name:"memory.free"}];var n=[{color:"#e41a1c",label:l("Swap Used")},{color:"#ff7f00",label:l("Cached")},{color:"#377eb8",label:l("Used")},{color:"#4daf4a",label:l("Free")}];e.channel=t.metrics(1e3,{source:"internal",metrics:i,cache:"memory-status"});e.grid=t.grid(1e3,-300,-0);var o;for(o=0;o<n.length;o++){n[o].row=e.grid.add(e.channel,[i[o].name])}e.channel.follow();e.grid.walk();this.plot=r.setup_complicated_plot("#memory_status_graph",e.grid,n,s)},show:function(){this.plot.start()},leave:function(){this.plot.destroy();this.channel.close();this.channel=null}};function b(){this._init()}e("#link-cpu").on("click",function(){t.location.go(["cpu"]);return false});e("#link-memory").on("click",function(){t.location.go(["memory"]);return false});e("#link-network").on("click",function(){t.jump("/network");return false});e("#link-disk").on("click",function(){t.jump("/storage");return false});function w(t){t.setup();var s=false;e("#"+t.id).on("show.bs.modal",function(e){if(e.target.id===t.id)t.enter()}).on("shown.bs.modal",function(e){if(e.target.id===t.id)t.show()}).on("hidden.bs.modal",function(e){if(e.target.id===t.id)t.leave()})}function x(t,s){if(!t._entered_)t.enter(s);t._entered_=true;e("#"+t.id).show().removeAttr("hidden");t.show()}function k(t){e("#"+t.id).hide()}function z(){var s;var i;var n;function r(){var r=t.location.path;if(r.length===0){k(n);k(i);x(s)}else if(r.length===1&&r[0]=="cpu"){k(s);k(i);x(n)}else if(r.length===1&&r[0]=="memory"){k(s);k(n);x(i)}else{console.warn("not a system location: "+r);t.location=""}e("body").removeAttr("hidden")}t.translate();s=new h;s.setup();n=new g;i=new b;w(new f);w(d=new v);w(new y);e(t).on("locationchanged",r);r()}return z});
