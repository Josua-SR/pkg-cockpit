define(["jquery","base1/cockpit","base1/mustache","system/journalctl","data!./journal_day_header.mustache","data!./journal_line.mustache","data!./journal_reboot.mustache"],function(e,t,n,r,a,i,o){"use strict";var u=t.gettext;var s=t.gettext;var l={};l.output_funcs_for_box=function d(t){n.parse(a);n.parse(i);n.parse(o);function r(e,t,r,a,o,u){var s={cursor:u["__CURSOR"],time:o,message:r,service:e};if(a>1)s["count"]=a;if(t<4)s["warning"]=true;return n.render(i,s)}var s=u("Reboot");var l=n.render(o,{message:s});function f(){return l}function d(e){return n.render(a,{day:e})}return{render_line:r,render_day_header:d,render_reboot_separator:f,append:function(n){t.append(e(n))},prepend:function(n){t.prepend(e(n))},remove_last:function(){e(t[0].lastChild).remove()},remove_first:function(){e(t[0].firstChild).remove()}}};l.journalbox=function p(t,n,a,i){var o=e('<div class="panel panel-default cockpit-log-panel">');var s=e('<div class="journal-start">');t.empty().append(o,s);var f=5e3;var d=1e3;var p=l.journal_renderer(l.output_funcs_for_box(o));var c=null;var _=[];function y(e){}function h(e){for(var t=0;t<e.length;t++)p.prepend(e[t]);p.prepend_flush();c=null}function v(e){for(var t=0;t<e.length;t++)p.append(e[t]);p.append_flush();c=null}function m(t){var n=e('<button id="journal-load-earlier" class="btn btn-default" data-inline="true" data-mini="true">'+u("Load earlier entries")+"</button>");s.html(n);n.click(function(){var e=0;var n=null;s.text(u("Loading..."));_.push(r(a,{follow:false,reverse:true,cursor:t}).fail(y).stream(function(r){if(r[0]["__CURSOR"]==t)r.shift();e+=r.length;v(r);if(e>=d){n=r[r.length-1]["__CURSOR"];m(n);this.stop()}}).done(function(){if(s.text()==u("Loading..."))s.empty()}))})}function b(e){_.push(r(a,{follow:true,count:0,cursor:e}).fail(y).stream(function(t){if(t[0]["__CURSOR"]==e)t.shift();h(t);g()}))}function g(){if(c===null){c=[];for(var t=o[0].firstChild;t;t=t.nextSibling){if(e(t).hasClass("panel-heading"))c.push([e(t).offset().top,e(t).text()])}}if(c.length>0){var n=0;var r=window.scrollY;while(n+1<c.length&&c[n+1][0]<r){n++}i.text(c[n][1])}else{i.text(u("Go to"))}}s.text(u("Loading..."));e(window).on("scroll",g);var R={follow:false,reverse:true};var x=false;if(n=="boot"){R["boot"]=null}else if(n=="last-24h"){R["since"]="-1days"}else if(n=="last-week"){R["since"]="-7days"}else{x=true}var w=null;var S=0;var O=null;_.push(r(a,R).fail(y).stream(function(e){if(!w){w=e[0]["__CURSOR"];b(w);g()}S+=e.length;v(e);if(S>=f){O=e[e.length-1]["__CURSOR"];m(O);this.stop()}}).done(function(){if(s.text()==u("Loading..."))s.empty();if(!w){_.push(r(a,{follow:true,count:0,boot:R["boot"],since:R["since"]}).fail(y).stream(function(e){h(e);g()}))}if(!x||O)m()}));t.stop=function C(){e(window).off("scroll",g);e.each(_,function(e,t){t.stop()})};return t};var f=["January","February","March","April","May","June","July","August","September","October","November","December"];l.journal_renderer=function c(e){function t(e){var t={};for(var n in e)t[n]=e[n];return t}function n(e){function t(e){var t=e.toFixed();if(t.length==1)t="0"+t;return t}var n=new Date(e["__REALTIME_TIMESTAMP"]/1e3);return{cursor:e["__CURSOR"],full:e,day:s("month-name",f[n.getMonth()])+" "+n.getDate().toFixed()+", "+n.getFullYear().toFixed(),time:t(n.getHours())+":"+t(n.getMinutes()),bootid:e["_BOOT_ID"],ident:e["SYSLOG_IDENTIFIER"]||e["_COMM"],prio:e["PRIORITY"],message:e["MESSAGE"]}}function r(e,t){return e&&t&&e.day==t.day&&e.bootid==t.bootid&&e.ident==t.ident&&e.prio==t.prio&&e.message==t.message}function a(t){return e.render_line(t.entry.ident,t.entry.prio,t.entry.message,t.count,t.last_time,t.entry.full)}var i,o;i=o={};function u(){if(i===o&&i.entry){i=t(o)}}function l(){if(i.header_present){e.remove_first();i.header_present=false}if(i.line_present){e.remove_first();i.line_present=false}if(i.entry){e.prepend(a(i));i.line_present=true}}function d(t){var a=n(t);if(r(i.entry,a)){i.count+=1;i.first_time=a.time}else{l();if(i.entry){if(a.bootid!=i.entry.bootid)e.prepend(e.render_reboot_separator());if(a.day!=i.entry.day)e.prepend(e.render_day_header(i.entry.day))}u();i.entry=a;i.count=1;i.first_time=i.last_time=a.time;i.line_present=false}}function p(){l();if(i.entry){e.prepend(e.render_day_header(i.entry.day));i.header_present=true}}function c(){if(o.line_present){e.remove_last();o.line_present=false}if(o.entry){e.append(a(o));o.line_present=true}}function _(t){var a=n(t);if(r(o.entry,a)){o.count+=1;o.last_time=a.time}else{c();if(!o.entry||a.day!=o.entry.day){e.append(e.render_day_header(a.day));o.header_present=true}if(o.entry&&a.bootid!=o.entry.bootid)e.append(e.render_reboot_separator());u();o.entry=a;o.count=1;o.first_time=o.last_time=a.time;o.line_present=false}}function y(){c()}return{prepend:d,prepend_flush:p,append:_,append_flush:y}};return l});
