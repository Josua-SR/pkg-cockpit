define(["jquery","base1/cockpit","base1/mustache","system/server","translated!base1/po"],function(e,t,i,n,a){t.locale(a);t.translate();var r=t.gettext;function o(e,t){return e.indexOf(t)===0}function s(e){function t(e){var t=/[0-9a-zA-Z:-_.\\]/;var i="";var n;for(n=0;n<e.length;n++){var a=e[n];if(a=="/")i+="-";else if(a=="-"||a=="\\"||!t.test(a)){i+="\\x";var r=a.charCodeAt(0).toString(16);while(r.length<2)r="0"+r;i+=r}else i+=a}return i}function i(e){e=e.replace(/\/+/g,"/");if(e.length>1)e=e.replace(/\/$/,"").replace(/^\//,"");return e}function n(e){e=i(e);if(e=="/")return"-";else return t(e)}if(e.length>0&&e[0]=="/")return n(e);else return t(e)}var l=t.dbus("org.freedesktop.systemd1",{superuser:"try"});var c=l.proxy("org.freedesktop.systemd1.Manager","/org/freedesktop/systemd1");var f=false;function d(){if(!f){f=true;u()}}function u(){var n={};var a={};function s(e){var t=n[e];if(!t){t={aliases:[],path:e};n[e]=t}return t}function f(e,t){function i(i){if(t[i])e[i]=t[i].v}i("Id");i("Description");i("LoadState");i("ActiveState");i("SubState");if(t["Id"])a[e.Id]=e.path;d(e)}function d(e){var t=e.LoadState;var i=e.ActiveState;var n=e.SubState;if(t=="loaded")t="";e.HasFailed=i=="failed"||t!=="";t=r(t);i=r(i);n=r(n);if(n!==""&&n!=i)i=i+" ("+n+")";if(t!=="")i=t+" / "+i;e.CombinedState=i}function u(e,t){l.call(e,"org.freedesktop.DBus.Properties","GetAll",["org.freedesktop.systemd1.Unit"]).fail(function(e){console.log(e)}).done(function(i){var n=s(e);f(n,i[0]);if(t)t(n);h()})}var v=e("#services-units-tmpl").html();i.parse(v);function p(){var t=e("#services-filter button.active").attr("data-pattern");function a(e,t){return n[e].Id.localeCompare(n[t].Id)}var s=Object.keys(n).sort(a);var l=[],c=[],f=[];s.forEach(function(e){var i=n[e];if(!(i.Id&&t&&i.Id.match(t)))return;if(i.UnitFileState&&o(i.UnitFileState,"enabled"))l.push(i);else if(i.UnitFileState&&o(i.UnitFileState,"disabled"))c.push(i);else f.push(i)});function d(e,t,n){var a=i.render(v,{heading:t,units:n});e.html(a)}d(e("#services-list-enabled"),r("Enabled"),l);d(e("#services-list-disabled"),r("Disabled"),c);d(e("#services-list-static"),r("Static"),f)}var g;var m;function h(){if(!g){p();g=window.setTimeout(b,200)}else{m=true}}function b(){g=null;if(m){m=false;p()}}var U=0;function S(){var e=++U;var i={};function o(e){console.log(e)}function l(e){i[e[0]]=true;var t=s(e[6]);t.Id=e[0];t.Description=e[1];t.LoadState=e[2];t.ActiveState=e[3];t.SubState=e[4];a[t.Id]=t.path;d(t)}function f(e){var o=e[0].split("/").pop();i[o]=true;if(o.indexOf("@")!=-1){n[o]={Id:o,Description:t.format(r("$0 Template"),o),UnitFileState:e[1]};a[o]=o;return}if(a[o])s(a[o]);else{c.LoadUnit(o).fail(function(e){console.log(e)}).done(s)}function s(t){var i=n[t];if(i)a(i);else u(t,a);function a(t){if(t.Id==o){t.UnitFileState=e[1]}else{t.aliases.push(o)}d(t)}}}c.ListUnits().fail(o).done(function(t){if(e!=U)return;for(var a=0;a<t.length;a++)l(t[a]);c.ListUnitFiles().fail(o).done(function(t){var a,r;if(e!=U)return;for(a=0;a<t.length;a++)f(t[a]);r=Object.keys(n);for(a=0;a<r;a++){if(!i[n[r[a]].Id]){console.log("R",r[a]);delete n[r[a]]}}h()})})}e(c).on("UnitNew",function(e,t,i){a[t]=i});e(c).on("JobNew JobRemoved",function(e,t,i,n,r){var o=a[n];if(o)u(o)});l.subscribe({"interface":"org.freedesktop.DBus.Properties",member:"PropertiesChanged"},function(e,t,i,a){var r=n[e];if(r){f(r,a[1]);h()}});e(c).on("UnitFilesChanged",function(e){S()});e("#services-filter button").on("click",function(){e("#services-filter button").removeClass("active");e(this).addClass("active");h()});S()}var v;var p;var g;var m;var h;var b;var U;var S=e("#action-btn-tmpl").html();i.parse(S);var k=e("#service-unit-tmpl").html();i.parse(k);var y=e("#service-template-tmpl").html();i.parse(y);var F=[{title:r("Start"),action:"StartUnit"},{title:r("Stop"),action:"StopUnit"},{title:r("Restart"),action:"RestartUnit"},{title:r("Reload"),action:"ReloadUnit"},{title:r("Reload or Restart"),action:"ReloadOrRestartUnit"},{title:r("Try Restart"),action:"TryRestartUnit"},{title:r("Reload or Try Restart"),action:"ReloadOrTryRestartUnit"},{title:r("Isolate"),action:"StartUnit:isolate"}];function w(){var t=e(this).attr("data-action").split(":");var i=t[0];var n=t[1];if(p){c.call(i,[v,n||"fail"]).fail(function(t){e("#service-error-dialog-message").text(t.toString());e("#service-error-dialog").modal("show")})}}var I=[{title:r("Enable"),action:"EnableUnitFiles:false"},{title:r("Enable Forcefully"),action:"EnableUnitFiles:true"},{title:r("Disable"),action:"DisableUnitFiles"},{title:r("Preset"),action:"PresetUnitFiles:false"},{title:r("Preset Forcefully"),action:"PresetUnitFiles:true"},{title:r("Mask"),action:"MaskUnitFiles:false"},{title:r("Mask Forcefully"),action:"MaskUnitFiles:true"},{title:r("Unmask"),action:"UnmaskUnitFiles"}];function R(){var t=e(this).attr("data-action").split(":");var i=t[0];var n=t[1];if(p){var a=[[v],false];if(n!==undefined)a.push(n=="true");c.call(i,a).done(function(){if(arguments.length==2&&!arguments[0])e("#service-no-install-info-dialog").modal("show");c.Reload()}).fail(function(t){e("#service-error-dialog-message").text(t.toString());e("#service-error-dialog").modal("show")})}}function x(a){if(p){e(p).off("changed");p=null;g=null}if(U){U.stop();U=null}function o(){if(!p.valid)return;var n;var a=p.ActiveState;if(a=="active"||a=="reloading"||a=="activating")n=1;else n=0;var o;var s=p.LoadState;var l=p.UnitFileState;if(s=="masked")o=7;else if(l=="static")o=5;else if(l=="enabled")o=2;else o=0;var c;if(a=="active"||a=="reloading")c=p.ActiveEnterTimestamp;else if(a=="inactive"||a=="failed")c=p.InactiveEnterTimestamp;else if(a=="activating")c=p.InactiveExitTimestamp;else c=p.ActiveExitTimestamp;var f="";if(c)f=t.format(r("Since $0"),new Date(c/1e3).toLocaleString());var d=i.render(S,{id:"service-unit-action",def:F[n],actions:F});var u=i.render(S,{id:"service-file-action",def:I[o],actions:I});var v=null;if(h){var m=i.render('<a data-goto-unit="{{unit}}">{{unit}}</a>',{unit:h});v=t.format(r("This unit is an instance of the $0 template."),m)}var b=i.render(k,{Unit:p,Since:f,HasLoadError:p.LoadState!=="loaded",LoadError:p.LoadError[1],UnitFileState:g,TemplateDescription:v,UnitButton:d,FileButton:u});e("#service-unit").html(b);e("#service-unit-action").on("click","[data-action]",w);e("#service-file-action").on("click","[data-action]",R)}function s(){var n=i.render(y,{Description:t.format(r("$0 Template"),v)});e("#service-template").html(n)}e("#service-valid").hide();e("#service-template").hide();e("#service-invalid").hide();e("#service").hide();v=a;if(!v)return;e("#service .breadcrumb .active").text(a);var f=v.indexOf("@");var d=v.lastIndexOf(".");m=f!=-1&&(f+1==d||f+1==v.length);h=undefined;if(f!=-1&&!m){h=v.substring(0,f+1);if(d!=-1)h=h+v.substring(d)}if(m){s();e("#service-template").show();e("#service").show();return}c.LoadUnit(a).done(function(t){if(v==a){var i=l.proxy("org.freedesktop.systemd1.Unit",t);p=i;i.wait(function(){if(p==i){o();e(p).on("changed",o);e("#service-valid").show();e("#service").show()}})}}).fail(function(t){e("#service-error-message").text(t.toString());e("#service-invalid").show();e("#service").show()});L();U=n.logbox(["_SYSTEMD_UNIT="+v,"+","COREDUMP_UNIT="+v,"+","UNIT="+v],10);e("#service-log").empty().append(U)}function E(){t.location.go([e(this).attr("data-goto-unit")])}function T(e){if(v){var i=v.indexOf("@");var n=v.lastIndexOf(".");if(i!=-1){var a=v.substring(0,i+1);a=a+s(e);if(n!=-1)a=a+v.substring(n);t.location.go([a])}}}function D(){var e=p;if(e){l.call(e.path,"org.freedesktop.DBus.Properties","GetAll",["org.freedesktop.systemd1.Unit"]).fail(function(e){console.log(e)}).done(function(t){var i={};for(var n in t[0])i[n]=t[0][n].v;var a={};a["org.freedesktop.systemd1.Unit"]=i;var r={};r[e.path]=a;l.notify(r)})}}function L(){var t=v;if(t){c.GetUnitFileState(t).done(function(i){if(v==t){g=i;if(p)e(p).triggerHandler("changed")}})}}e(c).on("Reloading",function(e,t){if(!t)D()});e(c).on("JobNew JobRemoved",function(e,t,i,n,a){if(v==n)D()});e(c).on("UnitFilesChanged",function(e){L()});function A(){var i=t.location.path;if(i.length===0){x(null);d();e("#services").show()}else if(i.length==1){e("#services").hide();x(t.location.path[0])}else{console.warn("not a init location: "+i);t.location=""}e("body").show()}function O(){c.wait(function(){c.Subscribe().fail(function(e){if(e.name!="org.freedesktop.systemd1.AlreadySubscribed"&&e.name!="org.freedesktop.DBus.Error.FileExists")console.warn("Subscribing to systemd signals failed",e)});A()})}e(t).on("locationchanged",A);e("#service-navigate-home").on("click",function(){t.location.go("/")});e("body").on("click","[data-goto-unit]",E);e("#service-template").on("click","button",function(){T(e("#service-template input").val())});return O});
