define(["jquery","base1/cockpit"],function(e,r){"use strict";var n=r.gettext;return function t(){var n=[];var t={follow:true};for(var s=0;s<arguments.length;s++){var i=arguments[s];if(typeof i=="string"){n.push(i)}else if(typeof i=="object"){if(i instanceof Array)n.push.apply(n,i);else e.extend(t,i)}else{console.warn("server.journal called with invalid argument:",i)}}if(t.count===undefined){if(t.follow)t.count=10;else t.count=null}var o=["journalctl","-q","--output=json"];if(!t.count)o.push("--no-tail");else o.push("--lines="+t.count);if(t.directory)o.push("--directory="+t.directory);if(t.boot)o.push("--boot="+t.boot);else if(t.boot!==undefined)o.push("--boot");if(t.since)o.push("--since="+t.since);if(t.until)o.push("--until="+t.until);if(t.cursor)o.push("--cursor="+t.cursor);if(t.after)o.push("--after="+t.after);if(t.reverse)o.push("--reverse");else if(t.follow)o.push("--follow");o.push("--");o.push.apply(o,n);var l=new e.Deferred;var u;var a="";var f=[];var c=null;var p=null;var h;function v(){if(c&&f.length>0){var e=f;f=[];c.fireWith(u,[e])}else{window.clearInterval(p);p=null}}var d=r.spawn(o,{host:t.host,batch:8192,latency:300,superuser:"try"}).stream(function(r){var n=0;var t;if(a)r=a+r;a="";var s=r.split("\n");var i=s.length-1;e.each(s,function(e,r){if(e==i){a=r}else if(r&&r.indexOf("-- ")!==0){try{f.push(JSON.parse(r))}catch(n){console.warn(n,r)}}});if(c&&p===null)p=window.setInterval(v,300)}).done(function(){v();l.resolve(f)}).fail(function(e){if(e.problem=="cancelled"||e.exit_status===1){v();l.resolve(f)}else{l.reject(e)}}).always(function(){window.clearInterval(p)});var w=l.promise;l.promise=function(){return e.extend(w.apply(this,arguments),{stream:function r(n){if(c===null)c=e.Callbacks("");c.add(n);return this},stop:function n(){d.close("cancelled")},promise:this.promise})};u=l.promise();return u}});
