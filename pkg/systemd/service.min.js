define(["jquery","base1/cockpit"],function(e,t){var n;var i;function r(e,t){e.wait(function(){if(e.valid)t()})}function a(e){if(!i){n=t.dbus("org.freedesktop.systemd1",{superuser:"try"});i=n.proxy("org.freedesktop.systemd1.Manager","/org/freedesktop/systemd1");r(i,function(){i.Subscribe().fail(function(e){if(e.name!="org.freedesktop.systemd1.AlreadySubscribed"&&e.name!="org.freedesktop.DBus.Error.FileExists")console.warn("Subscribing to systemd signals failed",e)})})}r(i,e)}function o(t){var o={exists:null,state:null,enabled:null,start:b,stop:y,restart:S,enable:m,disable:k};var s,f;if(t.indexOf(".")==-1)t=t+".service";function d(){o.exists=s.LoadState!="not-found"||s.ActiveState!="inactive";if(s.ActiveState=="activating")o.state="starting";else if(s.ActiveState=="deactivating")o.state="stopping";else if(s.ActiveState=="active"||s.ActiveState=="reloading")o.state="running";else if(s.ActiveState=="failed")o.state="failed";else if(s.ActiveState=="inactive"&&o.exists)o.state="stopped";else o.state=undefined;if(s.UnitFileState=="enabled"||s.UnitFileState=="linked")o.enabled=true;else if(s.UnitFileState=="disabled"||s.UnitFileState=="masked")o.enabled=false;else o.enabled=undefined;o.unit=s;e(o).triggerHandler("changed")}function l(){o.service=f;e(o).triggerHandler("changed")}a(function(){i.LoadUnit(t).done(function(t){s=n.proxy("org.freedesktop.systemd1.Unit",t);e(s).on("changed",d);r(s,d);f=n.proxy("org.freedesktop.systemd1.Service",t);e(f).on("changed",l);r(f,l)}).fail(function(t){o.exists=false;e(o).triggerHandler("changed")})});function c(){if(!s||!f)return;function e(e,t){n.call(e,"org.freedesktop.DBus.Properties","GetAll",[t]).fail(function(e){console.log(e)}).done(function(e){var i={};for(var r in e[0])i[r]=e[0][r].v;var a={};a[t]=i;var o={};o[s.path]=a;n.notify(o)})}e(s.path,"org.freedesktop.systemd1.Unit");e(f.path,"org.freedesktop.systemd1.Service")}if(false){e(i).on("UnitNew",function(e,n,i){if(n==t)c()})}else{e(i).on("Reloading",function(e,t){if(!t)c()});e(i).on("JobNew JobRemoved",function(e,n,i,r,a){if(r==t)c()})}var u={};e(i).on("JobRemoved",function(e,t,n,i,r){if(u[n]){if(r=="done")u[n].resolve();else u[n].reject(r);delete u[n]}});function g(e,t){return n.call("/org/freedesktop/systemd1","org.freedesktop.systemd1.Manager",e,t)}function p(t,n){var i=e.Deferred();g(t,n).done(function(e){var t=e[0];u[t]=i}).fail(function(e){i.reject(e)});return i.promise()}function v(e,t){return g(e,t).then(function(){return g("Reload",[])})}function b(){return p("StartUnit",[t,"replace"])}function y(){return p("StopUnit",[t,"replace"])}function S(){return p("RestartUnit",[t,"replace"])}function m(){return v("EnableUnitFiles",[[t],false,false])}function k(){return v("DisableUnitFiles",[[t],false])}return o}return{proxy:o}});
