define(["jquery","base1/cockpit","base1/term","translated!base1/po"],function(e,n,r,i){n.locale(i);n.translate();var t=null;var l=null;var o=n.user;var s=null;var a=null;function u(){if(a===null)a=new Date;if(o.shell===undefined&&new Date-a<1e3){s=window.setTimeout(u,50);return}a=null;t=new r({cols:80,rows:24,screenKeys:true});var i=e("#terminal");t.open(i[0]);i.children().first().css("margin",0);var c="/bin/bash";if(o.shell!==undefined)c=o.shell;l=n.channel({payload:"stream",spawn:[c,"-i"],environ:["TERM=xterm-256color","PATH=/sbin:/bin:/usr/sbin:/usr/bin"],directory:o.home||"/",pty:true});e(l).on("close",function(e,n){if(t){var r=n.problem||"disconnected";t.write("[31m"+r+"[m\r\n");t.cursorHidden=true;t.refresh(t.y,t.y)}}).on("message",function(e,n){if(t)t.write(n)});t.on("data",function(e){if(l&&l.valid)l.send(e)});t.on("title",function(n){e("#terminal-title").text(n)})}function c(){e("#terminal-reset").on("click",function(){if(l){l.close()}e("#terminal").empty();u()});u();e("body").show()}return c});
