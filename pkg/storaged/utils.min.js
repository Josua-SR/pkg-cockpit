define(["jquery","base1/cockpit","base1/mustache","system/service"],function(e,r,t,a){var n=r.gettext;var o=r.gettext;var i={};var l=r.dbus("org.freedesktop.hostname1").proxy();i.array_find=function s(e,r){for(var t=0;t<e.length;t++)if(r(e[t]))return e[t];return undefined};i.flatten=function u(e){if(e.length>0)return Array.prototype.concat.apply([],e);else return[]};i.decode_filename=function f(e){return r.utf8_decoder().decode(r.base64_decode(e).slice(0,-1))};i.encode_filename=function m(e){return r.base64_encode(r.utf8_encoder().encode(e).concat([0]))};i.fmt_size=function v(e){return r.format_bytes(e,1024)};i.fmt_size_long=function _(e){var t=r.format_bytes(e,1024);var a=r.format_bytes(e,1e3);return t+", "+a+", "+e+" "+o("format-bytes","bytes")};i.fmt_rate=function p(e){return r.format_bytes_per_sec(e,1024)};i.format_temperature=function d(e){var r=e-273.15;var t=9*r/5+32;return r.toFixed(1)+"° C / "+t.toFixed(1)+"° F"};i.format_fsys_usage=function b(e,t){var a="";var n=1024;var o=r.format_bytes(t,n,true);a=" / "+o.join(" ");n=o[1];o=r.format_bytes(e,n,true);return o[0]+a};i.format_delay=function g(e){var r=Math.round(e/1e3);var t=Math.floor(r/60);var a=Math.floor(t/60);r=r-t*60;t=t-a*60;var n=r+" seconds";if(t>0)n=t+" minutes, "+n;if(a>0)n=a+" hours, "+n;return n};i.validate_lvm2_name=function k(e){if(e==="")return n("Name can not be empty.");if(e.length>127)return n("Name can not be longer than 127 characters.");var t=e.match(/[^a-zA-Z0-9+._-]/);if(t){if(t[0].search(/\s+/)===-1)return r.format(n("Name can not contain the character '$0'."),t[0]);else return r.format(n("Name can not contain whitespace."),t[0])}};i.block_name=function h(e){return i.decode_filename(e.PreferredDevice)};i.mdraid_name=function y(e){if(!e.Name)return"";var t=e.Name.split(":");if(t.length!=2)return e.Name;if(t[0]==l.StaticHostname)return t[1];else return r.format(n("$name (from $host)"),{name:t[1],host:t[0]})};i.lvol_name=function D(e){var r;if(e.Type=="pool")r=n("Pool for Thin Logical Volumes");else if(e.ThinPool!="/")r=n("Thin Logical Volume");else if(e.Origin!="/")r=n("Logical Volume (Snapshot)");else r=n("Logical Volume");return t.render('{{Type}} "{{Name}}"',{Type:r,Name:e.Name})};i.drive_name=function V(e){var r=[];if(e.Vendor)r.push(e.Vendor);if(e.Model)r.push(e.Model);var t=r.join(" ");if(e.Serial)t+=" ("+e.Serial+")";else if(e.WWN)t+=" ("+e.WWN+")";return t};i.get_block_link_target=function N(e,a){var o,l,c;while(true){if(e.blocks_part[a]&&e.blocks_ptable[e.blocks_part[a].Table]){o=true;a=e.blocks_part[a].Table}else if(e.blocks_crypto[a]&&e.blocks[e.blocks_crypto[a].CryptoBackingDevice]){l=true;a=e.blocks_crypto[a].CryptoBackingDevice}else break}if(e.blocks_lvm2[a]&&e.lvols[e.blocks_lvm2[a].LogicalVolume])c=true;function s(e){if(c&&l)return r.format(n("<span>Encrypted Logical Volume of $0</span>"),e);else if(o&&l)return r.format(n("<span>Encrypted Partition of $0</span>"),e);else if(c)return r.format(n("<span>Logical Volume of $0</span>"),e);else if(o)return r.format(n("<span>Partition of $0</span>"),e);else if(l)return r.format(n("<span>Encrypted $0</span>"),e);else return e}var u=e.blocks[a];if(!u)return;var f,m,v;if(e.mdraids[u.MDRaid]){f="mdraid";m=e.mdraids[u.MDRaid].UUID;v=r.format(n("RAID Device $0"),i.mdraid_name(e.mdraids[u.MDRaid]))}else if(e.blocks_lvm2[a]&&e.lvols[e.blocks_lvm2[a].LogicalVolume]&&e.vgroups[e.lvols[e.blocks_lvm2[a].LogicalVolume].VolumeGroup]){f="vgroup";m=e.vgroups[e.lvols[e.blocks_lvm2[a].LogicalVolume].VolumeGroup].Name;v=r.format(n("Volume Group $0"),m)}else{f="block";m=i.block_name(u).replace(/^\/dev\//,"");if(e.drives[u.Drive])v=i.drive_name(e.drives[u.Drive]);else v=i.block_name(u)}return{type:f,target:m,html:s(t.render('<a data-goto-{{type}}="{{target}}">{{name}}</a>',{type:f,target:m,name:v}))}};i.get_free_blockdevs=function L(r){function t(e){var t=r.blocks[e];var a=r.blocks_ptable[e];var n=r.blocks_part[e];var o=r.blocks_pvol[e];function i(){if(!t.IdUsage)return false;if(t.IdType=="LVM2_member"&&(!o||!r.vgroups[o.VolumeGroup]))return false;return true}function l(){if(!r.drives[t.Drive])return false;if(!r.drives_block[t.Drive]){return true}var e=r.drives_multipath_blocks[t.Drive];for(var a=0;a<e.length;a++){if(e[a]==t)return true}return false}return!t.HintIgnore&&t.Size>0&&!i()&&!l()&&!a&&!(n&&n.IsContainer)}function a(t){var a=r.blocks[t];var n=i.get_block_link_target(r,t);var o=e("<div>").html(n.html).text();return{path:t,Name:i.block_name(a),Description:i.fmt_size(a.Size)+" "+o}}return Object.keys(r.blocks).filter(t).sort(i.make_block_path_cmp(r)).map(a)};i.block_cmp=function z(e,r){return e.DeviceNumber-r.DeviceNumber};i.make_block_path_cmp=function(e){return function(r,t){return i.block_cmp(e.blocks[r],e.blocks[t])}};var c;i.get_multipathd_service=function(){if(!c)c=a.proxy("multipathd");return c};i.init_arming_zones=function $(r){r.on("click","button.arm-button",function(){var r=e(this).hasClass("active");e(this).toggleClass("active",!r);e(this).parents(".arming-zone").toggleClass("armed",!r)})};i.reset_arming_zone=function C(e){var r=e.parents(".arming-zone");var t=r.find(".arm-button");t.removeClass("active");r.removeClass("armed")};return i});
