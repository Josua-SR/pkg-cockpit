define(["jquery","base1/mustache","base1/patterns"],function(e,i){var a;function n(){a=e("#storage-dialog-tmpl").html();i.parse(a)}var l;function t(n){n.Fields.forEach(function(e){if(e.SizeInput&&e.Value)e.ValueMB=(e.Value/(1024*1024)).toFixed(0)});function t(i){var a=e(this).hasClass("collapsed");if(a){e(this).removeClass("collapsed");e(this).find(".fa").removeClass("fa-angle-right").addClass("fa-angle-down")}else{e(this).addClass("collapsed");e(this).find(".fa").removeClass("fa-angle-down").addClass("fa-angle-right")}c()}function f(i){var a=e(this);var n=e(i.target).parent("tr");a.find("tr").removeClass("highlight");n.addClass("highlight")}if(l)l.modal("hide");var o=e(i.render(a,n));e("body").append(o);l=o;o.on("hidden.bs.modal",function(){o.remove()});o.find(".selectpicker").selectpicker();o.find(".dialog-arrow").on("click",t);o.find(".dialog-select-row-table tbody").on("click",f);o.find(".dialog-select-row-table tbody tr:first-child").addClass("highlight");var s={};function r(e){return e.TextInput||e.PassInput||e.SelectOne||e.SelectMany||e.SizeInput||e.CheckBox||e.Arrow||e.SelectRow}function d(){var i={};n.Fields.forEach(function(a){var n=r(a);var l=o.find('[data-field="'+n+'"]');if(a.TextInput)i[n]=l.val();else if(a.PassInput)i[n]=l.val();else if(a.SelectOne)i[n]=l.val();else if(a.SizeInput)i[n]=parseInt(l.val())*1024*1024;else if(a.CheckBox)i[n]=l.prop("checked");else if(a.SelectMany){i[n]=[];l.find("input").each(function(e,l){if(l.checked)i[n].push(a.Options[e].value)})}else if(a.SelectRow){l.find("tbody tr").each(function(l,t){if(e(t).hasClass("highlight"))i[n]=a.Rows[l].value})}else if(a.Arrow){i[n]=!l.hasClass("collapsed")}});return i}function c(){var e=d();n.Fields.forEach(function(i){if(i.visible){var a=r(i);s[a]=!i.visible(e);o.find('[data-field="'+a+'"]').parents("tr").toggle(!s[a])}})}function u(){var e=d();var i=[];n.Fields.forEach(function(a){var n=r(a);if(s[n])e[n]=undefined;else{if(a.validate){var l=a.validate(e[n],e);if(l){var t=new Error(l);t.target='[data-field="'+n+'"]';i.push(t)}}}});o.dialog("failure",i);return i.length===0?e:null}o.on("change input",function(){c()});function h(e){if(e.field)return{message:e.message,target:'[data-field="'+e.field+'"]'};else return e}o.find('button[data-action="apply"]').on("click",function(){var e=u();if(e!==null){var i=n.Action.action(e);if(i){o.dialog("wait",i);i.done(function(e){o.modal("hide")}).fail(function(i){if(n.Action.failure_filter)i=n.Action.failure_filter(e,i);if(i){if(i.length)i=i.map(h);else i=h(i);o.dialog("failure",i)}})}else{o.modal("hide")}}});c();o.modal("show")}e(n);return{open:t}});
