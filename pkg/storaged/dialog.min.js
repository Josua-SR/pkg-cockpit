define(["jquery","base1/mustache","base1/patterns"],function(e,n){var i;function a(){i=e("#storage-dialog-tmpl").html();n.parse(i)}function t(a){a.Fields.forEach(function(e){if(e.SizeInput&&e.Value)e.ValueMB=(e.Value/(1024*1024)).toFixed(0)});var t=e(n.render(i,a));e("body").append(t);t.find(".selectpicker").selectpicker();var l={};function r(){t.dialog("failure",null)}function o(e){return e.TextInput||e.PassInput||e.SelectOne||e.SelectMany||e.SizeInput||e.CheckBox}function f(){var e={};a.Fields.forEach(function(n){var i=o(n);var a=t.find('[data-field="'+i+'"]');if(n.TextInput)e[i]=a.val();else if(n.PassInput)e[i]=a.val();else if(n.SelectOne)e[i]=a.val();else if(n.SizeInput)e[i]=parseInt(a.val())*1024*1024;else if(n.CheckBox)e[i]=a.prop("checked");else if(n.SelectMany){e[i]=[];a.find("input").each(function(a,t){if(t.checked)e[i].push(n.Options[a].value)})}});return e}function u(){var e=f();a.Fields.forEach(function(n){if(n.visible){var i=o(n);l[i]=!n.visible(e);t.find('[data-field="'+i+'"]').parents("tr").toggle(!l[i])}})}function c(){var e=f();var n=[];a.Fields.forEach(function(i){var a=o(i);if(l[a])e[a]=undefined;else{if(i.validate){var t=i.validate(e[a],e);if(t){var r=new Error(t);r.target='[data-field="'+a+'"]';n.push(r)}}}});t.dialog("failure",n);return n.length===0?e:null}t.on("change input",function(){r();u()});t.on("hidden.bs.modal",function(){t.remove()});t.find('button[data-action="apply"]').on("click",function(){var e=c();if(e!==null){var n=a.Action.action(e);t.dialog("promise",n)}});u();t.modal("show")}e(a);return{open:t}});
