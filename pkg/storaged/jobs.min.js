define(["jquery","base1/cockpit","base1/mustache","system/server","shell/shell","storage/utils"],function(e,t,r,a,o,i){var n=t.gettext;var s=t.gettext;function l(a){l=e("#jobs-tmpl").html();r.parse(l);function o(e){return e.replace("/org/freedesktop/UDisks2/","/org/storaged/Storaged/")}function s(t){var r;e(t).find("[data-job-object]").css("visibility","hidden");function i(e){if(a.blocks_part[e]&&a.blocks[a.blocks_part[e].Table])return a.blocks_part[e].Table;if(a.blocks_crypto[e]&&a.blocks[a.blocks_crypto[e].CryptoBackingDevice])return a.blocks_crypto[e].CryptoBackingDevice;if(a.blocks[e]&&a.drives[a.blocks[e].Drive])return a.blocks[e].Drive;if(a.blocks[e]&&a.mdraids[a.blocks[e].MDRaid])return a.blocks[e].MDRaid;if(a.blocks_lvm2[e]&&a.lvols[a.blocks_lvm2[e].LogicalVolume])return a.blocks_lvm2[e].LogicalVolume;if(a.lvols[e]&&a.vgroups[a.lvols[e].VolumeGroup])return a.lvols[e].VolumeGroup}function n(r){e(t).find('[data-job-object="'+r+'"]').css("visibility","visible")}function s(e){n(e);var t=i(e);if(t)s(t)}function l(e){for(var t=0;t<e.length;t++)s(e[t])}for(r in a.storaged_jobs)l(a.storaged_jobs[r].Objects);for(r in a.udisks_jobs){l(a.udisks_jobs[r].Objects.map(o))}}e(a.storaged_jobs).on("added removed changed",function(){s("body")});e(a.udisks_jobs).on("added removed changed",function(){s("body")});var l;function g(){var e={"ata-smart-selftest":n("SMART self-test of $target"),"drive-eject":n("Ejecting $target"),"encrypted-unlock":n("Unlocking $target"),"encrypted-lock":n("Locking $target"),"encrypted-modify":n("Modifying $target"),"swapspace-start":n("Starting swapspace $target"),"swapspace-stop":n("Stopping swapspace $target"),"filesystem-mount":n("Mounting $target"),"filesystem-unmount":n("Unmounting $target"),"filesystem-modify":n("Modifying $target"),"format-erase":n("Erasing $target"),"format-mkfs":n("Creating filesystem on $target"),"loop-setup":n("Setting up loop device $target"),"partition-modify":n("Modifying $target"),"partition-delete":n("Deleting $target"),"partition-create":n("Creating partition $target"),cleanup:n("Cleaning up for $target"),"ata-secure-erase":n("Securely erasing $target"),"ata-enhanced-secure-erase":n("Very securely erasing $target"),"md-raid-stop":n("Stopping RAID Device $target"),"md-raid-start":n("Starting RAID Device $target"),"md-raid-fault-device":n("Marking $target as faulty"),"md-raid-remove-device":n("Removing $target from RAID Device"),"md-raid-create":n("Creating RAID Device $target"),"lvm-lvol-delete":n("Deleting $target"),"lvm-lvol-activate":n("Activating $target"),"lvm-lvol-deactivate":n("Deactivating $target"),"lvm-lvol-snapshot":n("Creating snapshot of $target"),"lvm-vg-create":n("Creating volume group $target"),"lvm-vg-delete":n("Deleting volume group $target"),"lvm-vg-add-device":n("Adding physical volume to $target"),"lvm-vg-rem-device":n("Removing physical volume from $target"),"lvm-vg-empty-device":n("Emptying $target"),"lvm-vg-create-volume":n("Creating logical volume $target"),"lvm-vg-rename":n("Renaming $target"),"lvm-vg-resize":n("Resizing $target")};function s(r){var s=e[r.Operation];if(!s)s=n("Operation '$operation' on $target");var l=r.Objects.map(function(e){var t=o(e);if(a.blocks[t])return i.block_name(a.blocks[t]);else if(a.mdraids[t])return i.mdraid_name(a.mdraids[t]);else if(a.vgroups[t])return a.vgroups[t].Name;else if(a.lvols[t])return i.lvol_name(a.lvols[t]);else return n("unknown target")}).join(", ");return t.format(s,{operation:r.Operation,target:l})}function g(e){return a.storaged_jobs[e]||a.udisks_jobs[e]}function c(e,t){return g(e).StartTime-g(t).StartTime}function d(e){var t=g(e);var r=null;if(t.ExpectedEndTime>0){var o=g.ExpectedEndTime/1e3-(new Date).getTime()-a.time_offset;if(o>0)r=i.format_delay(o)}return{path:e,Description:s(t),Progress:t.ProgressValid&&(t.Progress*100).toFixed()+"%",RemainingTime:r,Cancelable:t.Cancelable}}var v=Object.keys(a.storaged_jobs).concat(Object.keys(a.udisks_jobs)).sort(c).map(d);return r.render(l,{Jobs:v,HasJobs:v.length>0})}return{update:s,render:g}}return{init:l}});
