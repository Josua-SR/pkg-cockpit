define(["jquery","base1/cockpit","base1/mustache","system/server","shell/shell","storage/utils","storage/dialog","storage/permissions","shell/plot"],function(e,t,a,i,r,s,n,o){var l=t.gettext;var d=t.gettext;function u(u,c){function m(){e("#vgroups").toggle(u.features.lvm2);e("#iscsi-sessions").toggle(u.features.iscsi)}e(u.features).on("changed",m);m();var v=e("#mdraids-tmpl").html();a.parse(v);function p(){function t(e,t){return u.mdraids[e].Name.localeCompare(u.mdraids[t].Name)}function i(e){var t=u.mdraids[e];return{path:e,UUID:t.UUID,Size:s.fmt_size(t.Size),Name:s.mdraid_name(t)}}var r=Object.keys(u.mdraids).sort(t).map(i);e("#mdraids").amend(a.render(v,{MDRaids:r,HasMDRaids:r.length>0}));o.update();c.update("#mdraids")}e(u).on("changed",p);var f=e("#vgroups-tmpl").html();a.parse(f);function g(){function t(e,t){return u.vgroups[e].Name.localeCompare(u.vgroups[t].Name)}function i(e){var t=u.vgroups[e];return{path:e,Size:s.fmt_size(t.Size),Name:t.Name}}var r=Object.keys(u.vgroups).sort(t).map(i);e("#vgroups").amend(a.render(f,{VGroups:r,HasVGroups:r.length>0}));o.update();c.update("#vgroups")}e(u).on("changed",g);var _=e("#iscsi-sessions-tmpl").html();a.parse(_);function h(){function t(e,t){var a=u.iscsi_sessions[e];var i=u.iscsi_sessions[t];return a.target_name.localeCompare(i.target_name)}function i(e){var t=u.iscsi_sessions[e];return{path:e,Name:t.data["target_name"],Tpgt:t.data["tpgt"],Address:t.data["persistent_address"],Port:t.data["persistent_port"]}}var r=Object.keys(u.iscsi_sessions).sort(t).map(i);e("#iscsi-sessions").amend(a.render(_,{Sessions:r,HasSessions:r.length>0}));o.update()}e(u).on("changed",h);var k=e("#drives-tmpl").html();a.parse(k);var T;function b(){function t(e,t){return u.drives[e].SortKey.localeCompare(u.drives[t].SortKey)}function i(e){if(e.MediaRemovable||e.Media){for(var t=0;t<e.MediaCompatibility.length;t++)if(e.MediaCompatibility[t].indexOf("optical")===0)return"optical";return"removable"}return e.RotationRate===0?"ssd":"hdd"}function r(e){var t=u.drives[e];var a=u.drives_block[e];if(!a){a=u.drives_multipath_blocks[e][0]}if(!a)return;var r=s.decode_filename(a.Device).replace(/^\/dev\//,"");var n=u.blockdev_io.data[r];var o=s.drive_name(t);var l=i(t);var c=s.fmt_size(t.Size);var m;if(l=="hdd"){m=c+" "+d("storage","Hard Disk")}else if(l=="ssd"){m=c+" "+d("storage","Solid-State Disk")}else if(l=="removable"){if(t.Size===0)m=d("storage","Removable Drive");else m=c+" "+d("storage","Removable Drive")}else if(l=="optical"){m=d("storage","Optical Drive")}else{if(t.Size===0)m=d("storage","Drive");else m=c+" "+d("storage","Drive")}return{path:e,dev:r,Name:o,Classification:l,Description:m,ReadRate:n&&s.fmt_rate(n[0]),WriteRate:n&&s.fmt_rate(n[1]),Highlight:r==T}}var n=Object.keys(u.drives).sort(t).map(r);e("#drives").amend(a.render(k,{Drives:n,HasDrives:n.length>0}));o.update();c.update("#drives");for(var l in n){if(n[l]&&n[l].dev){C.add_instance(n[l].dev);P.add_instance(n[l].dev)}}}e(u).on("changed",b);e(u.blockdev_io).on("changed",b);var D=e("#others-tmpl").html();a.parse(D);function S(){function i(e){var t=u.blocks[e];var a=u.blocks_part[e];var i=u.blocks_lvm2[e];return(!a||a.Table=="/")&&t.Drive=="/"&&t.CryptoBackingDevice=="/"&&t.MDRaid=="/"&&(!i||i.LogicalVolume=="/")&&!t.HintIgnore}function r(e){var a=u.blocks[e];var i=s.block_name(a);return{path:e,dev:i.replace(/^\/dev\//,""),Name:i,Description:t.format(l("$0 Block Device"),s.fmt_size(a.Size))}}var n=Object.keys(u.blocks).filter(i).sort(s.make_block_path_cmp(u)).map(r);e("#others").amend(a.render(D,{Others:n,HasOthers:n.length>0}));o.update()}e(u).on("changed",S);var y=e("#mounts-tmpl").html();a.parse(y);function I(){function t(e){var t=u.blocks[e];var a=u.blocks_fsys[e];return a&&t.IdUsage=="filesystem"&&t.IdType!="mpath_member"&&!t.HintIgnore}function i(e,t){return u.blocks[e].IdLabel.localeCompare(u.blocks[t]).IdLabel}function r(e){var t=u.blocks[e];var a=u.blocks_fsys[e];var i=a.MountPoints.map(s.decode_filename);var r;for(var n=0;n<i.length&&!r;n++)r=u.fsys_sizes.data[i[n]];return{LinkTarget:s.get_block_link_target(u,e),Name:t.IdLabel||s.block_name(t),DeviceSize:s.fmt_size(t.Size),UsageText:r?s.format_fsys_usage(r[0],r[1]):null,UsagePercent:r?r[0]/r[1]*100:null,UsageCritical:r&&r[0]>.95*r[1],MountPoints:a.MountPoints.map(s.decode_filename),IsMounted:a.MountPoints.length>0}}var n=Object.keys(u.blocks).filter(t).sort(i).map(r);e("#mounts").amend(a.render(y,{Mounts:n,HasMounts:n.length>0}));o.update();c.update("#mounts")}e(u).on("changed",I);e(u.fsys_sizes).on("changed",I);function x(){e("#jobs").amend(c.render());o.update()}e(u).on("changed",x);function w(t){return function a(i){var s=i.getAxes();if(s.yaxis.datamax<1e5)s.yaxis.options.max=1e5;else s.yaxis.options.max=null;s.yaxis.options.min=0;e(t).text(r.bytes_per_sec_tick_unit(s.yaxis))}}function z(e,t){T=t;b()}var M={direct:"disk.dev.read_bytes",internal:"block.device.read",units:"bytes",derive:"rate",threshold:1e3};var N=r.plot_simple_template();e.extend(N.yaxis,{ticks:r.memory_ticks,tickFormatter:r.format_bytes_per_sec_tick_no_unit});e.extend(N.grid,{hoverable:true,autoHighlight:false});N.setup_hook=w("#storage-reading-unit");var A=r.plot(e("#storage-reading-graph"),300);A.set_options(N);var C=A.add_metrics_stacked_instances_series(M,{});A.start_walking();e(C).on("hover",z);var R={direct:"disk.dev.write_bytes",internal:"block.device.written",units:"bytes",derive:"rate",threshold:1e3};var O=r.plot_simple_template();e.extend(O.yaxis,{ticks:r.memory_ticks,tickFormatter:r.format_bytes_per_sec_tick_no_unit});e.extend(O.grid,{hoverable:true,autoHighlight:false});O.setup_hook=w("#storage-writing-unit");var U=r.plot(e("#storage-writing-graph"),300);U.set_options(O);var P=U.add_metrics_stacked_instances_series(R,{});U.start_walking();e(P).on("hover",z);e(window).on("resize",function(){A.resize();U.resize()});var H=r.setup_plot_controls(e("#storage"),e("#storage-graph-toolbar"));H.reset([A,U]);p();g();h();b();S();I();x();e("#storage-log").append(i.logbox(["_SYSTEMD_UNIT=storaged.service","+","_SYSTEMD_UNIT=udisks2.service","+","_SYSTEMD_UNIT=dm-event.service","+","_SYSTEMD_UNIT=smartd.service","+","_SYSTEMD_UNIT=multipathd.service"],10));e("#create-mdraid").on("click",function(){n.open({Title:l("Create RAID Device"),Fields:[{TextInput:"name",Title:l("Name")},{SelectOne:"level",Title:l("RAID Level"),Options:[{value:"raid0",Title:l("RAID 0 (Stripe)")},{value:"raid1",Title:l("RAID 1 (Mirror)")},{value:"raid4",Title:l("RAID 4 (Dedicated Parity)")},{value:"raid5",Title:l("RAID 5 (Distributed Parity)"),selected:true},{value:"raid6",Title:l("RAID 6 (Double Distributed Parity)")},{value:"raid10",Title:l("RAID 10 (Stripe of Mirrors)")}]},{SelectOne:"chunk",Title:l("Chunk Size"),Options:[{value:"4",Title:l("4 KiB")},{value:"8",Title:l("8 KiB")},{value:"16",Title:l("16 KiB")},{value:"32",Title:l("32 KiB")},{value:"64",Title:l("64 KiB")},{value:"128",Title:l("128 KiB")},{value:"512",Title:l("512 KiB"),selected:true},{value:"1024",Title:l("1 MiB")},{value:"2048",Title:l("2 MiB")}],visible:function(e){return e.level!="raid1"}},{SelectMany:"disks",Title:l("Disks"),Options:s.get_free_blockdevs(u).map(function(e){return{value:e.path,Title:e.Name+" "+e.Description}}),validate:function(e,a){var i=a.level=="raid6"?4:2;if(e.length<i)return t.format(l("At least $0 disks are needed."),i)}}],Action:{Title:l("Create"),action:function(e){return u.manager.MDRaidCreate(e.disks,e.level,e.name,(e.chunk||0)*1024,{})}}})});e("#create-volume-group").on("click",function(){n.open({Title:l("Create Volume Group"),Fields:[{TextInput:"name",Title:l("Name"),validate:s.validate_lvm2_name},{SelectMany:"disks",Title:l("Disks"),Options:s.get_free_blockdevs(u).map(function(e){return{value:e.path,Title:e.Name+" "+e.Description}}),validate:function(e){if(e.length===0)return l("At least one disk is needed.")}}],Action:{Title:l("Create"),action:function(e,t){return u.manager_lvm2.VolumeGroupCreate(e.name,e.disks,{})}}})});function B(){n.open({Title:l("Add iSCSI Portal"),Fields:[{TextInput:"address",Title:l("Server Address"),validate:function(e){if(e==="")return l("Server address can not be empty.")}},{TextInput:"username",Title:"Username"},{PassInput:"password",Title:"Password"}],Action:{Title:l("Next"),action:function(t,a){var i=e.Deferred();var r={};if(t.username||t.password){r.username={t:"s",v:t.username};r.password={t:"s",v:t.password}}var s=false;u.manager_iscsi.call("DiscoverSendTargets",[t.address,0,r]).done(function(e){if(!s){i.resolve();K(t,e[0])}}).fail(function(e){if(!s)i.reject(e)});var n=i.promise();n.cancel=function(){s=true;i.reject()};return n},failure_filter:function(e,t){if(!t)return t;if(t.message.indexOf("initiator failed authorization")!=-1)return[{field:"username",message:null},{field:"password",message:l("Invalid username or password")}];else if(t.message.indexOf("cannot resolve host name")!=-1)return{field:"address",message:l("Unknown host name")};else if(t.message.indexOf("connection login retries")!=-1)return{field:"address",message:l("Unable to reach server")};else return t}}})}function j(e,t){var a={"node.startup":{t:"s",v:"automatic"}};if(t.username||t.password){a.username={t:"s",v:t.username};a.password={t:"s",v:t.password}}return u.manager_iscsi.call("Login",[e[0],e[1],e[2],e[3],e[4],a])}function K(e,a){var i=a.map(function(e){return{Columns:[e[0],e[2],e[3]],value:e}});n.open({Title:t.format(l("Available targets on $0"),e.address),Fields:[{SelectRow:"target",Title:l("Targets"),Headers:[l("Name"),l("Address"),l("Port")],Rows:i}],Action:{Title:l("Add"),action:function(t){return j(t.target,e)},failure_filter:function(t,a){if(a.message.indexOf("authorization")!=-1)F(e,t);else return a}}})}function F(e,t){n.open({Title:"Authentication required",Fields:[{TextInput:"username",Title:"Username",Value:e.username},{PassInput:"password",Title:"Password",Value:e.password}],Action:{Title:l("Add"),action:function(e){return j(t.target,e)},failure_filter:function(e,t){if(t.message.indexOf("authorization")!=-1)return[{field:"username",message:null},{field:"password",message:l("Invalid username or password")}];else return t}}})}function L(t){var a=u.iscsi_sessions[t];if(!a)return;var i={"node.startup":{t:"s",v:"manual"}};a.Logout(i).fail(function(t){e("#error-popup-title").text(l("Error"));e("#error-popup-message").text(t.toString());e("#error-popup").modal("show")})}function V(){u.manager_iscsi.call("GetInitiatorName").done(function(e){var t=e[0];n.open({Title:l("Change iSCSI Initiator Name"),Fields:[{TextInput:"name",Title:l("Name"),Value:t}],Action:{Title:l("Change"),action:function(e){return u.manager_iscsi.call("SetInitiatorName",[e.name,{}])}}})})}e("#storage").on("click",'[data-action="add-iscsi-portal"]',function(){B()});e("#storage").on("click",'[data-action="edit-iscsi"]',function(){V()});e("#storage").on("click","[data-iscsi-session-remove]",function(){s.reset_arming_zone(e(this));L(e(this).attr("data-iscsi-session-remove"))});function E(){e("#storage").hide()}function G(){e("#storage").show();A.resize();U.resize()}return{show:G,hide:E}}return{init:u}});
