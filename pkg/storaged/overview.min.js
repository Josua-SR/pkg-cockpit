define(["jquery","base1/cockpit","base1/mustache","system/server","shell/shell","storage/utils","storage/dialog","storage/permissions","shell/plot"],function(e,t,a,r,i,s,n,o){var l=t.gettext;var d=t.gettext;function c(c,u){function v(){e("#vgroups").toggle(c.features.lvm2)}e(c.features).on("changed",v);v();var m=e("#mdraids-tmpl").html();a.parse(m);function p(){function t(e,t){return c.mdraids[e].Name.localeCompare(c.mdraids[t].Name)}function r(e){var t=c.mdraids[e];return{path:e,UUID:t.UUID,Size:s.fmt_size(t.Size),Name:s.mdraid_name(t)}}var i=Object.keys(c.mdraids).sort(t).map(r);e("#mdraids").amend(a.render(m,{MDRaids:i,HasMDRaids:i.length>0}));o.update();u.update("#mdraids")}e(c).on("changed",p);var _=e("#vgroups-tmpl").html();a.parse(_);function g(){function t(e,t){return c.vgroups[e].Name.localeCompare(c.vgroups[t].Name)}function r(e){var t=c.vgroups[e];return{path:e,Size:s.fmt_size(t.Size),Name:t.Name}}var i=Object.keys(c.vgroups).sort(t).map(r);e("#vgroups").amend(a.render(_,{VGroups:i,HasVGroups:i.length>0}));o.update();u.update("#vgroups")}e(c).on("changed",g);var f=e("#drives-tmpl").html();a.parse(f);var h;function k(){function r(e,t){return c.drives[e].SortKey.localeCompare(c.drives[t].SortKey)}function i(e){if(e.MediaRemovable||e.Media){for(var t=0;t<e.MediaCompatibility.length;t++)if(e.MediaCompatibility[t].indexOf("optical")===0)return"optical";return"removable"}return e.RotationRate===0?"ssd":"hdd"}function n(e){var a=c.drives[e];var r=c.drives_block[e];if(!r){r=c.drives_multipath_blocks[e][0]}if(!r)return;var n=s.decode_filename(r.Device).replace(/^\/dev\//,"");var o=c.blockdev_io.data[n];var l=s.drive_name(a);var u=i(a);var v=s.fmt_size(a.Size);var m;if(u=="hdd"){m=v+" "+d("storage","Hard Disk")}else if(u=="ssd"){m=v+" "+d("storage","Solid-State Disk")}else if(u=="removable"){if(a.Size===0)m=d("storage","Removable Drive");else m=v+" "+d("storage","Removable Drive")}else if(u=="optical"){m=d("storage","Optical Drive")}else{if(a.Size===0)m=d("storage","Drive");else m=v+" "+d("storage","Drive")}return{path:e,dev:n,Name:l,Classification:u,Description:m,ReadRate:o&&t.format_bytes_per_sec(o[0]),WriteRate:o&&t.format_bytes_per_sec(o[1]),Highlight:n==h}}var l=Object.keys(c.drives).sort(r).map(n);e("#drives").amend(a.render(f,{Drives:l,HasDrives:l.length>0}));o.update();u.update("#drives");for(var v in l){if(l[v]&&l[v].dev){N.add_instance(l[v].dev);U.add_instance(l[v].dev)}}}e(c).on("changed",k);e(c.blockdev_io).on("changed",k);var b=e("#others-tmpl").html();a.parse(b);function D(){function r(e){var t=c.blocks[e];var a=c.blocks_part[e];var r=c.blocks_lvm2[e];return(!a||a.Table=="/")&&t.Drive=="/"&&t.CryptoBackingDevice=="/"&&t.MDRaid=="/"&&(!r||r.LogicalVolume=="/")&&!t.HintIgnore}function i(e){var a=c.blocks[e];var r=s.block_name(a);return{path:e,dev:r.replace(/^\/dev\//,""),Name:r,Description:t.format(l("$0 Block Device"),s.fmt_size(a.Size))}}var n=Object.keys(c.blocks).filter(r).sort(s.make_block_path_cmp(c)).map(i);e("#others").amend(a.render(b,{Others:n,HasOthers:n.length>0}));o.update()}e(c).on("changed",D);var T=e("#mounts-tmpl").html();a.parse(T);function y(){function t(e){var t=c.blocks[e];var a=c.blocks_fsys[e];return a&&t.IdUsage=="filesystem"&&t.IdType!="mpath_member"&&!t.HintIgnore}function r(e,t){return c.blocks[e].IdLabel.localeCompare(c.blocks[t]).IdLabel}function i(e){var t=c.blocks[e];var a=c.blocks_fsys[e];var r=a.MountPoints.map(s.decode_filename);var i;for(var n=0;n<r.length&&!i;n++)i=c.fsys_sizes.data[r[n]];return{LinkTarget:s.get_block_link_target(c,e),Name:t.IdLabel||s.block_name(t),DeviceSize:s.fmt_size(t.Size),UsageText:i?s.format_fsys_usage(i[0],i[1]):null,UsagePercent:i?i[0]/i[1]*100:null,UsageCritical:i&&i[0]>.95*i[1],MountPoints:a.MountPoints.map(s.decode_filename),IsMounted:a.MountPoints.length>0}}var n=Object.keys(c.blocks).filter(t).sort(r).map(i);e("#mounts").amend(a.render(T,{Mounts:n,HasMounts:n.length>0}));o.update();u.update("#mounts")}e(c).on("changed",y);e(c.fsys_sizes).on("changed",y);function S(){e("#jobs").amend(u.render());o.update()}e(c).on("changed",S);function M(t){return function a(r){var s=r.getAxes();if(s.yaxis.datamax<1e5)s.yaxis.options.max=1e5;else s.yaxis.options.max=null;s.yaxis.options.min=0;e(t).text(i.bytes_per_sec_tick_unit(s.yaxis))}}function I(e,t){h=t;k()}var x={direct:"disk.dev.read_bytes",internal:"block.device.read",units:"bytes",derive:"rate",threshold:1e3};var z=i.plot_simple_template();e.extend(z.yaxis,{ticks:i.memory_ticks,tickFormatter:i.format_bytes_per_sec_tick_no_unit});e.extend(z.grid,{hoverable:true,autoHighlight:false});z.setup_hook=M("#storage-reading-unit");var R=i.plot(e("#storage-reading-graph"),300);R.set_options(z);var N=R.add_metrics_stacked_instances_series(x,{});R.start_walking();e(N).on("hover",I);var C={direct:"disk.dev.write_bytes",internal:"block.device.written",units:"bytes",derive:"rate",threshold:1e3};var O=i.plot_simple_template();e.extend(O.yaxis,{ticks:i.memory_ticks,tickFormatter:i.format_bytes_per_sec_tick_no_unit});e.extend(O.grid,{hoverable:true,autoHighlight:false});O.setup_hook=M("#storage-writing-unit");var A=i.plot(e("#storage-writing-graph"),300);A.set_options(O);var U=A.add_metrics_stacked_instances_series(C,{});A.start_walking();e(U).on("hover",I);e(window).on("resize",function(){R.resize();A.resize()});var B=i.setup_plot_controls(e("#storage"),e("#storage-graph-toolbar"));B.reset([R,A]);p();g();k();D();y();S();e("#storage-log").append(r.logbox(["_SYSTEMD_UNIT=storaged.service","+","_SYSTEMD_UNIT=udisks2.service","+","_SYSTEMD_UNIT=dm-event.service","+","_SYSTEMD_UNIT=smartd.service","+","_SYSTEMD_UNIT=multipathd.service"],10));e("#create-mdraid").on("click",function(){n.open({Title:l("Create RAID Device"),Fields:[{TextInput:"name",Title:l("Name")},{SelectOne:"level",Title:l("RAID Level"),Options:[{value:"raid0",Title:l("RAID 0 (Stripe)")},{value:"raid1",Title:l("RAID 1 (Mirror)")},{value:"raid4",Title:l("RAID 4 (Dedicated Parity)")},{value:"raid5",Title:l("RAID 5 (Distributed Parity)"),selected:true},{value:"raid6",Title:l("RAID 6 (Double Distributed Parity)")},{value:"raid10",Title:l("RAID 10 (Stripe of Mirrors)")}]},{SelectOne:"chunk",Title:l("Chunk Size"),Options:[{value:"4",Title:l("4 KB")},{value:"8",Title:l("8 KB")},{value:"16",Title:l("16 KB")},{value:"32",Title:l("32 KB")},{value:"64",Title:l("64 KB")},{value:"128",Title:l("128 KB")},{value:"512",Title:l("512 KB"),selected:true},{value:"1024",Title:l("1 MB")},{value:"2048",Title:l("2 MB")}],visible:function(e){return e.level!="raid1"}},{SelectMany:"disks",Title:l("Disks"),Options:s.get_free_blockdevs(c).map(function(e){return{value:e.path,Title:e.Name+" "+e.Description}}),validate:function(e,a){var r=a.level=="raid6"?4:2;if(e.length<r)return t.format(l("At least $0 disks are needed."),r)}}],Action:{Title:l("Create"),action:function(e){return c.manager.MDRaidCreate(e.disks,e.level,e.name,(e.chunk||0)*1024,{})}}})});e("#create-volume-group").on("click",function(){n.open({Title:l("Create Volume Group"),Fields:[{TextInput:"name",Title:l("Name"),validate:s.validate_lvm2_name},{SelectMany:"disks",Title:l("Disks"),Options:s.get_free_blockdevs(c).map(function(e){return{value:e.path,Title:e.Name+" "+e.Description}}),validate:function(e){if(e.length===0)return l("At least one disk is needed.")}}],Action:{Title:l("Create"),action:function(e,t){return c.manager_lvm2.VolumeGroupCreate(e.name,e.disks,{})}}})});function H(){e("#storage").hide()}function w(){e("#storage").show();R.resize();A.resize()}return{show:w,hide:H}}return{init:c}});
