define(["jquery","base1/cockpit","base1/mustache","system/server","shell/shell","storage/utils","storage/dialog","storage/permissions"],function(e,t,i,a,n,r,o,l){var s=t.gettext;var u=t.gettext;function c(n,c){var p,d;var f=r.get_multipathd_service();function m(e){var t=[];if(n.blocks_cleartext[e]){t.push(n.blocks_cleartext[e].path)}if(n.blocks_ptable[e]){n.blocks_partitions[e].forEach(function(e){if(!e.IsContainer)t.push(e.path)})}if(n.blocks_part[e]&&n.blocks_part[e].IsContainer){n.blocks_partitions[e].forEach(function(e){if(e.IsContained)t.push(e.path)})}if(n.vgroups[e]){n.vgroups_lvols[e].forEach(function(e){if(n.lvols_block[e.path])t.push(n.lvols_block[e.path].path)})}return t}function v(e){var i=n.blocks[e];var a=n.blocks_fsys[e];var o=n.blocks_pvol[e];var l=r.flatten(m(e).map(v));if(a&&a.MountPoints.length>0)l.push({usage:"mounted",Message:t.format(s("Device $0 is mounted on $1"),r.block_name(i),r.decode_filename(a.MountPoints[0]))});if(i&&n.mdraids[i.MDRaidMember])l.push({usage:"mdraid-member",Message:t.format(s("Device $0 is a member of RAID Array $1"),r.block_name(i),r.mdraid_name(n.mdraids[i.MDRaidMember]))});if(o&&n.vgroups[o.VolumeGroup])l.push({usage:"pvol",Message:t.format(s("Device $0 is a physical volume of $1"),r.block_name(i),n.vgroups[o.VolumeGroup].Name)});return l}function _(e,i,a,l){var u=n.blocks[e];var c=n.blocks_ptable[e];var p=i!==undefined;var d;if(p)d=t.format(s("Create partition on $0"),r.block_name(u));else d=t.format(s("Format $0"),r.block_name(u));function f(e){return e.type=="luks+xfs"||e.type=="luks+ext4"}function m(e){return e.type!="empty"&&e.type!="dos-extended"}o.open({Title:d,Alerts:v(e),Fields:[{SizeInput:"size",Title:s("Size"),Value:a,Max:a,visible:function(){return p},validate:function(e){if(isNaN(e))return s("Size must be specified.");if(e<=0)return s("Size must be greater than zero.")}},{SelectOne:"erase",Title:s("Erase"),Options:[{value:"no",Title:s("Don't overwrite existing data")},{value:"zero",Title:s("Overwrite existing data with zeros")}]},{SelectOne:"type",Title:s("Type"),Options:[{value:"xfs",Title:s("XFS - Red Hat Enterprise Linux 7 default")},{value:"ext4",Title:s("ext4 - Red Hat Enterprise Linux 6 default")},{value:"luks+xfs",Title:s("Encrypted XFS (LUKS)")},{value:"luks+ext4",Title:s("Encrypted EXT4 (LUKS)")},{value:"vfat",Title:s("VFAT - Compatible with all systems and devices")},{value:"ntfs",Title:s("NTFS - Compatible with most systems")},{value:"dos-extended",Title:s("Extended Partition"),disabled:!(p&&l)},{value:"empty",Title:s("No Filesystem")},{value:"custom",Title:s("Custom (Enter filesystem type)")}]},{TextInput:"name",Title:s("Name"),visible:m},{TextInput:"custom",Title:s("Filesystem type"),visible:function(e){return e.type=="custom"}},{PassInput:"passphrase",Title:s("Passphrase"),validate:function(e){if(e==="")return s("Passphrase can not be empty")},visible:f},{PassInput:"passphrase2",Title:s("Confirm passphrase"),validate:function(e,t){if(e!=t.passphrase)return s("Passphrases do not match")},visible:f},{CheckBox:"store_passphrase",Title:s("Store passphrase"),visible:f},{TextInput:"crypto_options",Title:s("Encryption Options"),visible:f},{SelectOne:"mounting",Title:s("Mounting"),Options:[{value:"default",Title:s("Default")},{value:"custom",Title:s("Custom")}],visible:m},{TextInput:"mount_point",Title:s("Mount Point"),visible:function(e){return m(e)&&e.mounting=="custom"}},{TextInput:"mount_options",Title:s("Mount Options"),visible:function(e){return m(e)&&e.mounting=="custom"}}],Action:{Title:p?s("Create partition"):s("Format"),Danger:p?null:s("Formatting a storage device will erase all data on it."),action:function(e){if(e.type=="custom")e.type=e.custom;var t={"no-block":{t:"b",v:true},"tear-down":{t:"b",v:true}};if(e.erase!="no")t.erase={t:"s",v:e.erase};if(e.name)t.label={t:"s",v:e.name};var a=[];if(e.mounting=="custom")a.push(["fstab",{dir:{t:"ay",v:r.encode_filename(e.mount_point)},type:{t:"ay",v:r.encode_filename("auto")},opts:{t:"ay",v:r.encode_filename(e.mount_options||"defaults")},freq:{t:"i",v:0},passno:{t:"i",v:0},"track-parents":{t:"b",v:true}}]);if(f(e)){e.type=e.type.replace("luks+","");t["encrypt.passphrase"]={t:"s",v:e.passphrase};var n={options:{t:"ay",v:r.encode_filename(e.crypto_options)},"track-parents":{t:"b",v:true}};if(e.store_passphrase){n["passphrase-contents"]={t:"ay",v:r.encode_filename(e.passphrase)}}else{n["passphrase-contents"]={t:"ay",v:r.encode_filename("")}}a.push(["crypttab",n])}if(a.length>0)t["config-items"]={t:"a(sa{sv})",v:a};if(p){if(e.type=="dos-extended")return c.CreatePartition(i,e.size,"0x05","",{});else if(e.type=="empty")return c.CreatePartition(i,e.size,"","",{});else return c.CreatePartitionAndFormat(i,e.size,"","",{},e.type,t)}else return u.Format(e.type,t)}}})}var g={format_disk:function O(e){var i=n.blocks[e];o.open({Title:t.format(s("Format Disk $0"),r.block_name(i)),Alerts:v(e),Fields:[{SelectOne:"erase",Title:s("Erase"),Options:[{value:"no",Title:s("Don't overwrite existing data")},{value:"zero",Title:s("Overwrite existing data with zeros")}]},{SelectOne:"type",Title:s("Partitioning"),Options:[{value:"dos",Title:s("Compatible with all systems and devices (MBR)")},{value:"gpt",Title:s("Compatible with modern system and hard disks > 2TB (GPT)"),selected:true},{value:"empty",Title:s("No partitioning")}]}],Action:{Title:s("Format"),Danger:s("Formatting a disk will erase all data on it."),action:function(e){var t={"no-block":{t:"b",v:true},"tear-down":{t:"b",v:true}};if(e.erase!="no")t.erase={t:"s",v:e.erase};return i.Format(e.type,t)}}})},create_partition:function U(e,t,i,a){_(e,t,i,a)},mount:function B(e){return n.blocks_fsys[e].Mount({})},unmount:function G(e){return n.blocks_fsys[e].Unmount({})},fsys_options:function j(t){var i=n.blocks[t];var a=n.blocks_fsys[t];var l=null;var u,c;if(!i||!a)return;l=r.array_find(i.Configuration,function(e){return e[0]=="fstab"});if(l){u=r.decode_filename(l[1].dir.v);c=r.decode_filename(l[1].opts.v).split(",").filter(function(e){return e.indexOf("x-parent")!==0}).join(",")}function p(e){if(e!=i.IdLabel)return a.SetLabel(e,{})}function d(e,t,a){var n=null;if(e){n=["fstab",{dir:{t:"ay",v:r.encode_filename(t)},type:{t:"ay",v:r.encode_filename("auto")},opts:{t:"ay",v:r.encode_filename(a||"defaults")},freq:{t:"i",v:0},passno:{t:"i",v:0},"track-parents":{t:"b",v:true}}]}if(!l&&n)return i.AddConfigurationItem(n,{});else if(l&&!n)return i.RemoveConfigurationItem(l,{});else if(l&&n&&(t!=u||a!=c))return i.UpdateConfigurationItem(l,n,{})}o.open({Title:s("Filesystem Options"),Fields:[{TextInput:"name",Title:s("Name"),Value:i.IdLabel},{SelectOne:"mounting",Title:s("Mounting"),Options:[{value:"default",Title:s("Default"),selected:!l},{value:"custom",Title:s("Custom"),selected:!!l}]},{TextInput:"mount_point",Title:s("Mount Point"),Value:u,visible:function(e){return e.mounting=="custom"}},{TextInput:"mount_options",Title:s("Mount Options"),Value:c,visible:function(e){return e.mounting=="custom"}}],Action:{Title:s("Apply"),action:function(t){return e.when(p(t.name),d(t.mounting=="custom",t.mount_point,t.mount_options))}}})},lock:function X(e){return n.blocks_crypto[e].Lock({})},unlock:function q(e){var t=n.blocks_crypto[e];if(!t)return;o.open({Title:s("Unlock"),Fields:[{PassInput:"passphrase",Title:s("Passphrase")}],Action:{Title:s("Unlock"),action:function(e){return t.Unlock(e.passphrase,{})}}})},crypto_options:function Y(e){var t=n.blocks[e];var i=null;var a,l;if(!t)return;t.GetSecretConfiguration({}).done(function(e){i=r.array_find(e,function(e){return e[0]=="crypttab"});if(i){if(i[1]["passphrase-contents"])a=r.decode_filename(i[1]["passphrase-contents"].v);l=r.decode_filename(i[1].options.v).split(",").filter(function(e){return e.indexOf("x-parent")!==0}).join(",")}function n(e,n){if(e!=a||n!=l){var o=["crypttab",{options:{t:"ay",v:r.encode_filename(n)},"track-parents":{t:"b",v:true},"passphrase-contents":{t:"ay",v:r.encode_filename(e)}}];if(i)return t.UpdateConfigurationItem(i,o,{});else return t.AddConfigurationItem(o,{})}}o.open({Title:s("Encryption Options"),Fields:[{PassInput:"passphrase",Title:s("Stored Passphrase"),Value:a},{TextInput:"options",Title:s("Options"),Value:l}],Action:{Title:s("Apply"),action:function(e){return n(e.passphrase,e.options)}}})})},mdraid_start:function K(e){return n.mdraids[e].Start({"start-degraded":{t:"b",v:true}})},mdraid_stop:function H(e){return n.mdraids[e].Stop({})},mdraid_start_scrub:function J(e){return n.mdraids[e].RequestSyncAction("repair",{})},mdraid_stop_scrub:function W(e){return n.mdraids[e].RequestSyncAction("idle",{})},mdraid_toggle_bitmap:function Q(e){var t=r.decode_filename(n.mdraids[e].BitmapLocation);return n.mdraids[e].SetBitmapLocation(r.encode_filename(t=="none"?"internal":"none"),{})},mdraid_add_disk:function Z(t){var i=n.mdraids[t];o.open({Title:s("Add Disks"),Fields:[{SelectMany:"disks",Title:s("Disks"),Options:r.get_free_blockdevs(n).filter(function(e){if(n.blocks_part[e.path])e=n.blocks[n.blocks_part[e.path].PartitionTable];return e&&n.blocks[e.path].MDRaid!=t}).map(function(e){return{value:e.path,Title:e.Name+" "+e.Description}}),validate:function(e){if(e.length===0)return s("At least one disk is needed.")}}],Action:{Title:s("Add"),action:function(t){return e.when.apply(null,t.disks.map(function(e){return i.AddDevice(e,{})}))}}})},mdraid_remove_disk:function ee(e){var t=n.blocks[e];var i=n.mdraids[t.MDRaidMember];return i.RemoveDevice(e,{wipe:{t:"b",v:true}})},mdraid_delete:function te(e){var i=t.location;var a=n.mdraids[e];if(!a)return;var l=n.mdraids_block[e];o.open({Title:t.format(s("Please confirm deletion of $0"),r.mdraid_name(a)),Alerts:l&&v(l.path),Fields:[],Action:{Title:s("Delete"),Danger:s("Deleting a RAID device will erase all data on it."),action:function(t){return n.mdraids[e].Delete({"tear-down":{t:"b",v:true}}).done(function(){i.go("/")})}}})},resize:function ie(t){var i=n.lvols[t];if(!i)return;var a=n.lvols_block[t];o.open({Title:s("Resize Logical Volume"),Fields:[{SizeInput:"size",Title:s("Size"),Value:i.Size,Max:"XXX"}],Action:{Title:s("Resize"),action:function(t){function n(t){return e.Deferred().reject({message:t}).promise()}var r=a&&a.IdUsage=="filesystem";if(!r&&t.size<i.Size)return n(s("This logical volume can not be made smaller."));var o={};if(r)o.resize_fsys={t:"b",v:r};return i.Resize(t.size,o)}}})},rename:function ae(e){var t=n.lvols[e];if(!t)return;o.open({Title:s("Renamee Logical Volume"),Fields:[{TextInput:"name",Title:s("Name"),Value:t.Name}],Action:{Title:s("Rename"),action:function(e){return t.Rename(e.name,{})}}})},create_snapshot:function ne(e){var t=n.lvols[e];if(!t)return;o.open({Title:s("Create Snapshot"),Fields:[{TextInput:"name",Title:s("Name"),validate:r.validate_lvm2_name},{SizeInput:"size",Title:s("Size"),Max:"XXX",visible:function(){return t.ThinPool=="/"}}],Action:{Title:s("Create"),action:function(e){return t.CreateSnapshot(e.name,e.size||0,{})}}})},activate:function re(e){if(n.lvols[e])return n.lvols[e].Activate({})},deactivate:function oe(e){if(n.lvols[e])return n.lvols[e].Deactivate({})},create_thin:function le(e){var t=n.lvols[e];var i=t&&n.vgroups[t.VolumeGroup];if(!t||!i)return;o.open({Title:s("Create Thin Volume"),Fields:[{TextInput:"name",Title:s("Name"),validate:r.validate_lvm2_name},{SizeInput:"size",Title:s("Size"),Max:undefined}],Action:{Title:s("Create"),action:function(e){return i.CreateThinVolume(e.name,e.size,t.path,{})}}})},vgroup_rename:function se(e){var i=t.location;var a=n.vgroups[e];if(!a)return;o.open({Title:s("Rename Volume Group"),Fields:[{TextInput:"name",Title:s("Name"),Value:a.Name,validate:r.validate_lvm2_name}],Action:{Title:s("Create"),action:function(e){return a.Rename(e.name,{}).done(function(){i.go(["vg",e.name])})}}})},vgroup_delete:function ue(e){var i=t.location;var a=n.vgroups[e];if(!a)return;o.open({Title:t.format(s("Please confirm deletion of $0"),a.Name),Alerts:v(e),Fields:[],Action:{Danger:s("Deleting a volume group will erase all data on it."),Title:s("Delete"),action:function(){return a.Delete(true,{"tear-down":{t:"b",v:true}}).done(function(){i.go("/")})}}})},vgroup_create_plain:function ce(e){var t=n.vgroups[e];if(!t)return;o.open({Title:s("Create Plain Volume"),Fields:[{TextInput:"name",Title:s("Name"),validate:r.validate_lvm2_name},{SizeInput:"size",Title:s("Size"),Max:t.FreeSize}],Action:{Title:s("Create"),action:function(e){return t.CreatePlainVolume(e.name,e.size,{})}}})},vgroup_create_raid:function pe(t){e("#error-popup-title").text(s("Sorry"));e("#error-popup-message").text("Not yet.");e("#error-popup").modal("show")},vgroup_create_thinpool:function de(e){var t=n.vgroups[e];if(!t)return;o.open({Title:s("Create Pool for Thin Logical Volumes"),Fields:[{TextInput:"name",Title:s("Name"),validate:r.validate_lvm2_name},{SizeInput:"size",Title:s("Size"),Max:t.FreeSize}],Action:{Title:s("Create"),action:function(e){return t.CreateThinPoolVolume(e.name,e.size,{})}}})},vgroup_add_disk:function fe(t){var i=n.vgroups[t];if(!i)return;o.open({Title:s("Add Disks"),Fields:[{SelectMany:"disks",Title:s("Disks"),Options:r.get_free_blockdevs(n).filter(function(e){if(n.blocks_part[e.path])e=n.blocks[n.blocks_part[e.path].PartitionTable];var i=e&&n.blocks_lvm2[e.path]&&n.lvols[n.blocks_lvm2[e.path].LogicalVolume];return!i||i.VolumeGroup!=t}).map(function(e){return{value:e.path,Title:e.Name+" "+e.Description}}),validate:function(e){if(e.length===0)return s("At least one disk is needed.")}}],Action:{Title:s("Add"),action:function(t){return e.when.apply(null,t.disks.map(function(e){return i.AddDevice(e,{})}))}}})},pvol_empty:function me(e){var t=n.blocks_pvol[e];var i=t&&n.vgroups[t.VolumeGroup];if(!i)return;return i.EmptyDevice(e,{})},pvol_remove:function ve(e){var t=n.blocks_pvol[e];var i=t&&n.vgroups[t.VolumeGroup];if(!i)return;return i.RemoveDevice(e,true,{})},format:function _e(e){if(n.blocks[e])_(e);else if(n.lvols_block[e])_(n.lvols_block[e].path)},"delete":function ge(e){var i,a,l;i=n.blocks[e];if(i){a=n.blocks_part[e];l=n.blocks_lvm2[e]&&n.lvols[n.blocks_lvm2[e].LogicalVolume]}else{l=n.lvols[e]}var u,c;if(l){u=r.lvol_name(l);c=s("Deleting a logical volume will delete all data in it.")}else if(a){u=r.block_name(i);c=s("Deleting a partition will delete all data in it.")}if(u){o.open({Title:t.format(s("Please confirm deletion of $0"),u),Alerts:v(e),Fields:[],Action:{Danger:c,Title:s("Delete"),action:function(){if(l)return l.Delete({"tear-down":{t:"b",v:true}});else if(a)return a.Delete({"tear-down":{t:"b",v:true}})}}})}},job_cancel:function be(e){var t=n.storaged_jobs[e]||n.udisks_jobs[e];if(t)return t.Cancel({})}};e("#storage-detail").on("click","[data-action]",function(){var t=e(this).attr("data-action");var i=[];if(e(this).attr("data-args"))i=JSON.parse(e(this).attr("data-args"));else if(e(this).attr("data-arg"))i=[e(this).attr("data-arg")];var a=g[t].apply(this,i);if(a)a.fail(function(t){e("#error-popup-title").text(s("Error"));e("#error-popup-message").text(t.toString());e("#error-popup").modal("show")})});function b(e,t,a){return i.render('<button class="btn btn-default storage-privileged" data-action="{{Action}}" data-args="{{Args}}">{{Title}}</button>',{Title:e,Action:t,Args:JSON.stringify(a)})}var h=e("#action-btn-tmpl").html();i.parse(h);function T(e,t,a){function r(e,t){return e.indexOf(t,e.length-t.length)!==-1}var o=r(e.iface,".Block")?e:null;var l=o&&n.blocks_fsys[o.path];var u=o&&n.blocks_lvm2[o.path];var c=r(e.iface,".LogicalVolume")?e:null;var p=o&&o.IdUsage=="filesystem";var d=l&&l.MountPoints.length>0;var f=o&&o.IdUsage=="crypto";var m=c||u&&u.LogicalVolume!="/";var v=c&&c.Type=="pool";var _=o||c&&c.Active;var g=o&&!o.ReadOnly;var b;if(c)b=c.path;else if(u)b=u.LogicalVolume;var T=[{title:s("Mount"),action:"mount",disabled:d},{title:s("Unmount"),action:"unmount",disabled:!d},{title:s("Filesystem Options"),action:"fsys_options"}];var k=[{title:s("Lock"),action:"lock",disabled:t},{title:s("Unlock"),action:"unlock",disabled:!t},{title:s("Encryption Options"),action:"crypto_options"}];var y=[{title:s("Resize"),action:"resize",arg:b},{title:s("Rename"),action:"rename",arg:b}];var S=[{title:s("Create Snapshot"),action:"create_snapshot",arg:b},{title:s("Activate"),action:"activate",disabled:_,arg:b},{title:s("Deactivate"),action:"deactivate",disabled:!_,arg:b}];var z=[{title:s("Create Thin Volume"),action:"create_thin",arg:b}];var D=[{title:s("Format"),action:"format"}];var x=[{title:s("Delete"),action:"delete"}];var I=null;var A=[];if(p){A=A.concat(T);if(d)I=T[1];else I=T[0]}else if(f){A=A.concat(k);if(t)I=k[1];else I=k[0]}if(g){A=A.concat(D);if(!I)I=D[0]}if(m){A=A.concat(y);if(v){A=A.concat(z);I=z[0]}else{A=A.concat(S);if(!I){if(_)I=S[2];else I=S[1]}}}if(a||m){A=A.concat(x);if(!I)I=x[0]}return i.render(h,{arg:e.path,def:I,actions:A})}function k(i,a,o){var l,c,p;var d=n.blocks_pvol[i.path];var f=n.blocks_lvm2[i.path];if(i.IdUsage=="filesystem"){l=e("<span>").text(t.format(u("storage-id-desc","$0 File System"),i.IdType))}else if(i.IdUsage=="raid"){if(i.IdType=="linux_raid_member"){l=e("<span>").text(u("storage-id-desc","Linux MD-RAID Component"))}else if(i.IdType=="LVM2_member"){l=e("<span>").text(u("storage-id-desc","LVM2 Physical Volume"))}else{l=e("<span>").text(u("storage-id-desc","RAID Member"))}if(d&&n.vgroups[d.VolumeGroup]){var m=n.vgroups[d.VolumeGroup];l.append(" of ",e("<a>",{"data-goto-vgroup":m.Name}).text(m.Name))}else if(n.mdraids[i.MDRaidMember]){var v=n.mdraids[i.MDRaidMember];l.append(" of ",e("<a>",{"data-goto-mdraid":v.UUID}).text(r.mdraid_name(v)))}}else if(i.IdUsage=="crypto"){if(i.IdType=="crypto_LUKS"){l=e("<span>").text(u("storage-id-desc","LUKS Encrypted"))}else{l=e("<span>").text(u("storage-id-desc","Encrypted"))}}else if(i.IdUsage=="other"){if(i.IdType=="swap"){l=e("<span>").text(u("storage-id-desc","Swap Space"))}else{l=e("<span>").text(u("storage-id-desc","Other Data"))}}else{l=e("<span>").text(u("storage-id-desc","Unrecognized Data"))}if(a){c=e("<span>").append(t.format(s("$size $partition"),{size:r.fmt_size(i.Size),partition:a})," (",l,")")}else if(f&&n.lvols[f.LogicalVolume]){var _=n.lvols[f.LogicalVolume];c=e("<span>").append(t.format(s("$size $partition"),{size:r.fmt_size(i.Size),partition:r.lvol_name(_)})," (",l,")")}else c=l;p=r.block_name(i);if(i.IdUsage=="filesystem"){var g=n.blocks_fsys[i.path];p+=", ";if(g&&g.MountPoints.length>0)p+=t.format(s("mounted on $0"),r.decode_filename(g.MountPoints[0]));else p+=s("not mounted")}else if(i.IdUsage=="crypto"){p+=", ";if(o)p+=s("unlocked");else p+=s("locked")}return e("<div>").append(e("<div>").html(c),e("<div>").text(p)).html()}var y=e("#content-tmpl").html();i.parse(y);var S=[];function z(e,t,i,a,n){S.push({LevelWidth:30*e,Name:t,Description:i,Button:a,job_object:n})}function D(e,t,i){var a,r,o,l;var s;if(t.IdUsage=="crypto")s=n.blocks_cleartext[t.path];l=T(t,!s,!!i);if(t.IdLabel.length>0)r=t.IdLabel;else if(!l)r=null;else r="—";o=k(t,i,s);z(e,r,o,l,t.path);if(s)I(e+1,s)}function x(e,i){var a=n.blocks_ptable[i.path];var o=e;var l=a.Type=="dos";var u=n.blocks_partitions[i.path];function c(e,a,n){var u;var c=(Math.floor(a/(1024*1024))+1)*1024*1024;var p=false;if(a+n-c>=1024*1024){if(l){if(e>o){u=t.format(s("$0 Free Space for Logical Partitions"),r.fmt_size(n))}else{u=t.format(s("$0 Free Space for Primary Partitions"),r.fmt_size(n));p=true}}else{u=t.format(s("$0 Free Space"),r.fmt_size(n))}z(e,null,u,b(s("Create Partition"),"create_partition",[i.path,a,n,p]),null)}}function p(e,i,a,n){var o=t.format(s("$0 Extended Partition"),r.fmt_size(n));var l=T(i,false,true);z(e,null,o,l,i.path);d(e+1,a,n)}function d(e,t,i){var a;var r=t;var d=t+i;var f,m,v,_,g,b;for(a=0;a<u.length;a++){f=n.blocks[u[a].path];m=u[a].Offset;v=u[a].Size;_=u[a].Type;g=u[a].IsContainer;if(f===null)continue;if(e===o&&_=="l")continue;if(e==o+1&&_!="l")continue;if(m<t||m+v>t+i)continue;c(e,r,m-r);if(g)p(e,f,m,v);else{if(l){if(e>o)b=s("Logical Partition");else b=s("Primary Partition")}else b=s("Partition");D(e,f,b)}r=m+v}c(e,r,d-r)}d(o,0,i.Size)}function I(e,t){if(n.blocks_ptable[t.path])x(e,t);else D(e,t,null)}function A(e,t){S=[];I(t||0,e);return S}var C=e("#block-detail-tmpl").html();i.parse(C);function M(){e("#storage-detail .breadcrumb .active").text(d);var t=n.slashdevs_block[d];if(!t)return;var a={dbus:t,Name:r.block_name(t),Size:r.fmt_size_long(t.Size)};var o=n.drives[t.Drive];var l=n.drives_ata[t.Drive];var u=null;if(l){u={Failing:n.drives_ata.SmartFailing,Temperature:l.SmartTemperature>0&&r.format_temperature(l.SmartTemperature)}}var c=null;var p=t;if(o){var m=n.drives_block[o.path];var v=n.drives_multipath_blocks[o.path];var _=null;if(v.length>0){_={Devices:v.map(r.block_name)}}c={dbus:o,Size:o.Size>0&&r.fmt_size_long(o.Size),Assessment:u,Device:m&&r.block_name(m),Multipath:_,MultipathActive:f.state=="running"};p=m}return i.render(C,{Block:a,Drive:c,Content:p&&i.render(y,{Title:s("Content"),path:p.path,Entries:A(p)})})}var P=e("#mdraid-detail-tmpl").html();i.parse(P);function R(){var e=n.uuids_mdraid[d];if(!e)return;var a=n.mdraids_block[e.path];function o(e){return{raid0:s("RAID 0"),raid1:s("RAID 1"),raid4:s("RAID 4"),raid5:s("RAID 5"),raid6:s("RAID 6"),raid10:s("RAID 10")}[e]||t.format(s("RAID ($0)"),e)}var l=o(e.Level);if(e.NumDevices>0)l+=", "+t.format(s("$0 Disks"),e.NumDevices);if(e.ChunkSize>0)l+=", "+t.format(s("$0 Chunk Size"),r.fmt_size(e.ChunkSize));var u=null;if(e.BitmapLocation)u={Value:r.decode_filename(e.BitmapLocation)!="none"};var c=null;if(e.SyncAction){var p={idle:"",check:s("Data Scrubbing"),repair:s("Data Scrubbing and Repair"),resync:s("Resyncing"),recover:s("Recovering "),frozen:s("Frozen")}[e.SyncAction]||e.SyncAction;var f=null;if(p&&p!="idle"){var m=Math.round(e.SyncCompleted*100).toString();if(e.SyncRate>0){f=t.format(s("$action, ${percent}% complete at $rate"),{action:p,percent:m,rate:r.fmt_rate(e.SyncRate)})}else{f=t.format(s("$action, ${percent}% complete"),{action:p,percent:m})}if(e.SyncRemainingTime>0){f+=t.format(s(", $0 remaining"),r.format_delay(e.SyncRemainingTime/1e3))}}c={Name:d,Progress:f}}var v={dbus:e,Name:r.mdraid_name(e),Size:r.fmt_size_long(e.Size),Level:l,Bitmap:u,Degraded:e.Degraded>0&&t.format(s("$0 disks are missing"),e.Degraded),State:e.Running?s("Running"):s("Not running"),SyncAction:c};var _=null;if(a){_={dbus:a,Device:r.decode_filename(a.PreferredDevice)}}function g(i){var a=r.array_find(e.ActiveDevices,function(e){return e[0]==i.path});function o(e){return{Description:{faulty:s("FAILED"),in_sync:s("In Sync"),spare:a[1]<0?s("Spare"):s("Recovering"),write_mostly:s("Write-mostly"),blocked:s("Blocked")}[e]||t.format(s("Unknown ($0)"),e),Danger:e=="faulty"}}return{path:i.path,LinkTarget:r.get_block_link_target(n,i.path),Description:r.decode_filename(i.PreferredDevice),Slot:a&&a[1]>=0&&a[1].toString(),States:a&&a[2].map(o)}}var b=[{title:s("Start"),action:"mdraid_start"},{title:s("Stop"),action:"mdraid_stop"},{title:s("Start Scrubbing"),action:"mdraid_start_scrub"},{title:s("Stop Scrubbing"),action:"mdraid_stop_scrub"},{title:s("Delete"),action:"mdraid_delete"}];var T;if(e.Running)T=b[1];else T=b[0];return i.render(P,{MDRaid:v,MDRaidButton:i.render(h,{arg:e.path,def:T,actions:b}),Block:_,Members:n.mdraids_members[e.path].map(g),DynamicMembers:e.Level!="raid0",Content:a&&i.render(y,{Title:s("Content"),path:a.path,Entries:A(a)})})}function F(a,o){function l(i,a,o){var l,u;if(n.blocks_ptable[a.path]){u=t.format(s("$size $desc"),{desc:o.Name,size:r.fmt_size(a.Size)});u+="<br/>"+e("<span>").text(r.decode_filename(a.PreferredDevice));l=T(a,false,false);z(i,null,u,l,a.path);x(i+1,a)}else D(i,a,null)}function u(e,i){var a,o,c,p;if(i.Type=="pool"){c=Math.max(i.DataAllocatedRatio,i.MetadataAllocatedRatio);o=t.format(s("$size $desc<br/>${percent}% full"),{size:r.fmt_size(i.Size),desc:r.lvol_name(i),percent:(c*100).toFixed(0)});a=T(i,false,false);z(e,null,o,a);n.lvols_pool_members[i.path].forEach(function(t){u(e+1,t)})}else{p=n.lvols_block[i.path];if(p)l(e,p,i);else{o=t.format(s("$size $desc<br/>($state)"),{size:r.fmt_size(i.Size),desc:r.lvol_name(i),state:i.Active?s("active, but unsupported"):s("inactive")});a=T(i,false,false);z(e,null,o,a,null)}}}S=[];o=o||0;n.vgroups_lvols[a.path].forEach(function(e){if(e.ThinPool=="/")u(o,e)});if(a.FreeSize>0){var c,p,d;d=t.format(s("$0 Free Space for Logical Volumes"),r.fmt_size(a.FreeSize));p=[{title:s("Create Plain Logical Volume"),action:"vgroup_create_plain"},{title:s("Create RAID Logical Volume"),action:"vgroup_create_raid"},{title:s("Create Pool for Thin Logical Volumes"),action:"vgroup_create_thinpool"}];c=i.render(h,{arg:a.path,def:p[0],actions:p});z(o,null,d,c,null)}return S}var V=e("#vgroup-detail-tmpl").html();i.parse(V);var L;function $(){var e=n.vgnames_vgroup[d];if(!e)return;if(e.NeedsPolling&&L===null){L=window.setInterval(function(){e.Poll()},2e3)}else if(!e.NeedsPolling&&L!==null){window.clearInterval(L);L=null}var a={dbus:e,Size:r.fmt_size_long(e.Size)};function o(e){var a=n.blocks[e.path];var o=[{action:"pvol_remove",title:s("Remove")},{action:"pvol_empty",title:s("Empty")}];return{dbus:a,LinkTarget:r.get_block_link_target(n,e.path),Device:r.decode_filename(a.PreferredDevice),Sizes:t.format(s("$0, $1 free"),r.fmt_size(e.Size),r.fmt_size(e.FreeSize)),Button:i.render(h,{arg:e.path,def:o[0],actions:o})}}var l=[{action:"vgroup_rename",title:s("Rename")},{action:"vgroup_delete",title:s("Delete")}];return i.render(V,{VGroup:a,VGroupButton:i.render(h,{arg:e.path,def:l[0],actions:l}),PVols:n.vgroups_pvols[e.path].map(o),Content:i.render(y,{Title:s("Logical Volumes"),Entries:F(e)})})}function w(){e("#storage-detail .breadcrumb .active").text(d);var t;if(p=="block")t=M();else if(p=="mdraid")t=R();else if(p=="vgroup")t=$();if(t)e("#detail").amend(t);else e("#detail").text(s("Not found"));c.update("#storage-detail");e("#detail-jobs").amend(c.render());l.update()}e(f).on("changed",w);e(n).on("changed",w);e("#storage-detail-log").append(a.logbox(["_SYSTEMD_UNIT=storaged.service","+","_SYSTEMD_UNIT=udisks2.service","+","_SYSTEMD_UNIT=dm-event.service","+","_SYSTEMD_UNIT=smartd.service","+","_SYSTEMD_UNIT=multipathd.service"],10));e("#storage-detail .breadcrumb a").on("click",function(){t.location.go("/")});function N(){d=null;e("#storage-detail").hide()}function E(t,i){if(L!==null){window.clearInterval(L);L=null}p=t;d=i;w();e("#storage-detail").show()}return{show:E,hide:N}}return{init:c}});
