
define("storage/details", ["jquery","base1/cockpit","base1/mustache","system/server","shell/shell","storage/utils","storage/dialog","storage/permissions"],function(e,t,i,a,n,r,o,l){var s=t.gettext;var u=t.gettext;function c(n,c){var p,d;var f=r.get_multipathd_service();function m(e){var t=[];if(n.blocks_cleartext[e]){t.push(n.blocks_cleartext[e].path)}if(n.blocks_ptable[e]){n.blocks_partitions[e].forEach(function(e){if(!e.IsContainer)t.push(e.path)})}if(n.blocks_part[e]&&n.blocks_part[e].IsContainer){n.blocks_partitions[e].forEach(function(e){if(e.IsContained)t.push(e.path)})}if(n.vgroups[e]){n.vgroups_lvols[e].forEach(function(e){if(n.lvols_block[e.path])t.push(n.lvols_block[e.path].path)})}return t}function v(e){var i=n.blocks[e];var a=n.blocks_fsys[e];var o=n.blocks_pvol[e];var l=r.flatten(m(e).map(v));if(a&&a.MountPoints.length>0)l.push({usage:"mounted",Message:t.format(s("Device $0 is mounted on $1"),r.block_name(i),r.decode_filename(a.MountPoints[0]))});if(i&&n.mdraids[i.MDRaidMember])l.push({usage:"mdraid-member",Message:t.format(s("Device $0 is a member of RAID Array $1"),r.block_name(i),r.mdraid_name(n.mdraids[i.MDRaidMember]))});if(o&&n.vgroups[o.VolumeGroup])l.push({usage:"pvol",Message:t.format(s("Device $0 is a physical volume of $1"),r.block_name(i),n.vgroups[o.VolumeGroup].Name)});return l}function _(e,i,a,l){var u=n.blocks[e];var c=n.blocks_ptable[e];var p=i!==undefined;var d;if(p)d=t.format(s("Create partition on $0"),r.block_name(u));else d=t.format(s("Format $0"),r.block_name(u));function f(e){return e.type=="luks+xfs"||e.type=="luks+ext4"}function m(e){return e.type!="empty"&&e.type!="dos-extended"}o.open({Title:d,Alerts:v(e),Fields:[{SizeInput:"size",Title:s("Size"),Value:a,Max:a,visible:function(){return p},validate:function(e){if(isNaN(e))return s("Size must be specified.");if(e<=0)return s("Size must be greater than zero.")}},{SelectOne:"erase",Title:s("Erase"),Options:[{value:"no",Title:s("Don't overwrite existing data")},{value:"zero",Title:s("Overwrite existing data with zeros")}]},{SelectOne:"type",Title:s("Type"),Options:[{value:"xfs",Title:s("XFS - Red Hat Enterprise Linux 7 default")},{value:"ext4",Title:s("ext4 - Red Hat Enterprise Linux 6 default")},{value:"luks+xfs",Title:s("Encrypted XFS (LUKS)")},{value:"luks+ext4",Title:s("Encrypted EXT4 (LUKS)")},{value:"vfat",Title:s("VFAT - Compatible with all systems and devices")},{value:"ntfs",Title:s("NTFS - Compatible with most systems")},{value:"dos-extended",Title:s("Extended Partition"),disabled:!(p&&l)},{value:"empty",Title:s("No Filesystem")},{value:"custom",Title:s("Custom (Enter filesystem type)")}]},{TextInput:"name",Title:s("Name"),visible:m},{TextInput:"custom",Title:s("Filesystem type"),visible:function(e){return e.type=="custom"}},{PassInput:"passphrase",Title:s("Passphrase"),validate:function(e){if(e==="")return s("Passphrase can not be empty")},visible:f},{PassInput:"passphrase2",Title:s("Confirm passphrase"),validate:function(e,t){if(e!=t.passphrase)return s("Passphrases do not match")},visible:f},{CheckBox:"store_passphrase",Title:s("Store passphrase"),visible:f},{TextInput:"crypto_options",Title:s("Encryption Options"),visible:f},{SelectOne:"mounting",Title:s("Mounting"),Options:[{value:"default",Title:s("Default")},{value:"custom",Title:s("Custom")}],visible:m},{TextInput:"mount_point",Title:s("Mount Point"),visible:function(e){return m(e)&&e.mounting=="custom"}},{TextInput:"mount_options",Title:s("Mount Options"),visible:function(e){return m(e)&&e.mounting=="custom"}}],Action:{Title:p?s("Create partition"):s("Format"),Danger:p?null:s("Formatting a storage device will erase all data on it."),action:function(e){if(e.type=="custom")e.type=e.custom;var t={"no-block":{t:"b",v:true},"tear-down":{t:"b",v:true}};if(e.erase!="no")t.erase={t:"s",v:e.erase};if(e.name)t.label={t:"s",v:e.name};var a=[];if(e.mounting=="custom")a.push(["fstab",{dir:{t:"ay",v:r.encode_filename(e.mount_point)},type:{t:"ay",v:r.encode_filename("auto")},opts:{t:"ay",v:r.encode_filename(e.mount_options||"defaults")},freq:{t:"i",v:0},passno:{t:"i",v:0},"track-parents":{t:"b",v:true}}]);if(f(e)){e.type=e.type.replace("luks+","");t["encrypt.passphrase"]={t:"s",v:e.passphrase};var n={options:{t:"ay",v:r.encode_filename(e.crypto_options)},"track-parents":{t:"b",v:true}};if(e.store_passphrase){n["passphrase-contents"]={t:"ay",v:r.encode_filename(e.passphrase)}}else{n["passphrase-contents"]={t:"ay",v:r.encode_filename("")}}a.push(["crypttab",n])}if(a.length>0)t["config-items"]={t:"a(sa{sv})",v:a};if(p){if(e.type=="dos-extended")return c.CreatePartition(i,e.size,"0x05","",{});else if(e.type=="empty")return c.CreatePartition(i,e.size,"","",{});else return c.CreatePartitionAndFormat(i,e.size,"","",{},e.type,t)}else return u.Format(e.type,t)}}})}var g={format_disk:function O(e){var i=n.blocks[e];o.open({Title:t.format(s("Format Disk $0"),r.block_name(i)),Alerts:v(e),Fields:[{SelectOne:"erase",Title:s("Erase"),Options:[{value:"no",Title:s("Don't overwrite existing data")},{value:"zero",Title:s("Overwrite existing data with zeros")}]},{SelectOne:"type",Title:s("Partitioning"),Options:[{value:"dos",Title:s("Compatible with all systems and devices (MBR)")},{value:"gpt",Title:s("Compatible with modern system and hard disks > 2TB (GPT)"),selected:true},{value:"empty",Title:s("No partitioning")}]}],Action:{Title:s("Format"),Danger:s("Formatting a disk will erase all data on it."),action:function(e){var t={"no-block":{t:"b",v:true},"tear-down":{t:"b",v:true}};if(e.erase!="no")t.erase={t:"s",v:e.erase};return i.Format(e.type,t)}}})},create_partition:function U(e,t,i,a){_(e,t,i,a)},mount:function B(e){return n.blocks_fsys[e].Mount({})},unmount:function G(e){return n.blocks_fsys[e].Unmount({})},fsys_options:function j(t){var i=n.blocks[t];var a=n.blocks_fsys[t];var l=null;var u,c;if(!i||!a)return;l=r.array_find(i.Configuration,function(e){return e[0]=="fstab"});if(l){u=r.decode_filename(l[1].dir.v);c=r.decode_filename(l[1].opts.v).split(",").filter(function(e){return e.indexOf("x-parent")!==0}).join(",")}function p(e){if(e!=i.IdLabel)return a.SetLabel(e,{})}function d(e,t,a){var n=null;if(e){n=["fstab",{dir:{t:"ay",v:r.encode_filename(t)},type:{t:"ay",v:r.encode_filename("auto")},opts:{t:"ay",v:r.encode_filename(a||"defaults")},freq:{t:"i",v:0},passno:{t:"i",v:0},"track-parents":{t:"b",v:true}}]}if(!l&&n)return i.AddConfigurationItem(n,{});else if(l&&!n)return i.RemoveConfigurationItem(l,{});else if(l&&n&&(t!=u||a!=c))return i.UpdateConfigurationItem(l,n,{})}o.open({Title:s("Filesystem Options"),Fields:[{TextInput:"name",Title:s("Name"),Value:i.IdLabel},{SelectOne:"mounting",Title:s("Mounting"),Options:[{value:"default",Title:s("Default"),selected:!l},{value:"custom",Title:s("Custom"),selected:!!l}]},{TextInput:"mount_point",Title:s("Mount Point"),Value:u,visible:function(e){return e.mounting=="custom"}},{TextInput:"mount_options",Title:s("Mount Options"),Value:c,visible:function(e){return e.mounting=="custom"}}],Action:{Title:s("Apply"),action:function(t){return e.when(p(t.name),d(t.mounting=="custom",t.mount_point,t.mount_options))}}})},lock:function X(e){return n.blocks_crypto[e].Lock({})},unlock:function q(e){var t=n.blocks_crypto[e];if(!t)return;o.open({Title:s("Unlock"),Fields:[{PassInput:"passphrase",Title:s("Passphrase")}],Action:{Title:s("Unlock"),action:function(e){return t.Unlock(e.passphrase,{})}}})},crypto_options:function Y(e){var t=n.blocks[e];var i=null;var a,l;if(!t)return;t.GetSecretConfiguration({}).done(function(e){i=r.array_find(e,function(e){return e[0]=="crypttab"});if(i){if(i[1]["passphrase-contents"])a=r.decode_filename(i[1]["passphrase-contents"].v);l=r.decode_filename(i[1].options.v).split(",").filter(function(e){return e.indexOf("x-parent")!==0}).join(",")}function n(e,n){if(e!=a||n!=l){var o=["crypttab",{options:{t:"ay",v:r.encode_filename(n)},"track-parents":{t:"b",v:true},"passphrase-contents":{t:"ay",v:r.encode_filename(e)}}];if(i)return t.UpdateConfigurationItem(i,o,{});else return t.AddConfigurationItem(o,{})}}o.open({Title:s("Encryption Options"),Fields:[{PassInput:"passphrase",Title:s("Stored Passphrase"),Value:a},{TextInput:"options",Title:s("Options"),Value:l}],Action:{Title:s("Apply"),action:function(e){return n(e.passphrase,e.options)}}})})},mdraid_start:function K(e){return n.mdraids[e].Start({"start-degraded":{t:"b",v:true}})},mdraid_stop:function H(e){return n.mdraids[e].Stop({})},mdraid_start_scrub:function J(e){return n.mdraids[e].RequestSyncAction("repair",{})},mdraid_stop_scrub:function W(e){return n.mdraids[e].RequestSyncAction("idle",{})},mdraid_toggle_bitmap:function Q(e){var t=r.decode_filename(n.mdraids[e].BitmapLocation);return n.mdraids[e].SetBitmapLocation(r.encode_filename(t=="none"?"internal":"none"),{})},mdraid_add_disk:function Z(t){var i=n.mdraids[t];o.open({Title:s("Add Disks"),Fields:[{SelectMany:"disks",Title:s("Disks"),Options:r.get_free_blockdevs(n).filter(function(e){if(n.blocks_part[e.path])e=n.blocks[n.blocks_part[e.path].PartitionTable];return e&&n.blocks[e.path].MDRaid!=t}).map(function(e){return{value:e.path,Title:e.Name+" "+e.Description}}),validate:function(e){if(e.length===0)return s("At least one disk is needed.")}}],Action:{Title:s("Add"),action:function(t){return e.when.apply(null,t.disks.map(function(e){return i.AddDevice(e,{})}))}}})},mdraid_remove_disk:function ee(e){var t=n.blocks[e];var i=n.mdraids[t.MDRaidMember];return i.RemoveDevice(e,{wipe:{t:"b",v:true}})},mdraid_delete:function te(e){var i=t.location;var a=n.mdraids[e];if(!a)return;var l=n.mdraids_block[e];o.open({Title:t.format(s("Please confirm deletion of $0"),r.mdraid_name(a)),Alerts:l&&v(l.path),Fields:[],Action:{Title:s("Delete"),Danger:s("Deleting a RAID device will erase all data on it."),action:function(t){return n.mdraids[e].Delete({"tear-down":{t:"b",v:true}}).done(function(){i.go("/")})}}})},resize:function ie(t){var i=n.lvols[t];if(!i)return;var a=n.lvols_block[t];o.open({Title:s("Resize Logical Volume"),Fields:[{SizeInput:"size",Title:s("Size"),Value:i.Size,Max:"XXX"}],Action:{Title:s("Resize"),action:function(t){function n(t){return e.Deferred().reject({message:t}).promise()}var r=a&&a.IdUsage=="filesystem";if(!r&&t.size<i.Size)return n(s("This logical volume can not be made smaller."));var o={};if(r)o.resize_fsys={t:"b",v:r};return i.Resize(t.size,o)}}})},rename:function ae(e){var t=n.lvols[e];if(!t)return;o.open({Title:s("Renamee Logical Volume"),Fields:[{TextInput:"name",Title:s("Name"),Value:t.Name}],Action:{Title:s("Rename"),action:function(e){return t.Rename(e.name,{})}}})},create_snapshot:function ne(e){var t=n.lvols[e];if(!t)return;o.open({Title:s("Create Snapshot"),Fields:[{TextInput:"name",Title:s("Name"),validate:r.validate_lvm2_name},{SizeInput:"size",Title:s("Size"),Max:"XXX",visible:function(){return t.ThinPool=="/"}}],Action:{Title:s("Create"),action:function(e){return t.CreateSnapshot(e.name,e.size||0,{})}}})},activate:function re(e){if(n.lvols[e])return n.lvols[e].Activate({})},deactivate:function oe(e){if(n.lvols[e])return n.lvols[e].Deactivate({})},create_thin:function le(e){var t=n.lvols[e];var i=t&&n.vgroups[t.VolumeGroup];if(!t||!i)return;o.open({Title:s("Create Thin Volume"),Fields:[{TextInput:"name",Title:s("Name"),validate:r.validate_lvm2_name},{SizeInput:"size",Title:s("Size"),Max:undefined}],Action:{Title:s("Create"),action:function(e){return i.CreateThinVolume(e.name,e.size,t.path,{})}}})},vgroup_rename:function se(e){var i=t.location;var a=n.vgroups[e];if(!a)return;o.open({Title:s("Rename Volume Group"),Fields:[{TextInput:"name",Title:s("Name"),Value:a.Name,validate:r.validate_lvm2_name}],Action:{Title:s("Create"),action:function(e){return a.Rename(e.name,{}).done(function(){i.go(["vg",e.name])})}}})},vgroup_delete:function ue(e){var i=t.location;var a=n.vgroups[e];if(!a)return;o.open({Title:t.format(s("Please confirm deletion of $0"),a.Name),Alerts:v(e),Fields:[],Action:{Danger:s("Deleting a volume group will erase all data on it."),Title:s("Delete"),action:function(){return a.Delete(true,{"tear-down":{t:"b",v:true}}).done(function(){i.go("/")})}}})},vgroup_create_plain:function ce(e){var t=n.vgroups[e];if(!t)return;o.open({Title:s("Create Plain Volume"),Fields:[{TextInput:"name",Title:s("Name"),validate:r.validate_lvm2_name},{SizeInput:"size",Title:s("Size"),Max:t.FreeSize}],Action:{Title:s("Create"),action:function(e){return t.CreatePlainVolume(e.name,e.size,{})}}})},vgroup_create_raid:function pe(t){e("#error-popup-title").text(s("Sorry"));e("#error-popup-message").text("Not yet.");e("#error-popup").modal("show")},vgroup_create_thinpool:function de(e){var t=n.vgroups[e];if(!t)return;o.open({Title:s("Create Pool for Thin Logical Volumes"),Fields:[{TextInput:"name",Title:s("Name"),validate:r.validate_lvm2_name},{SizeInput:"size",Title:s("Size"),Max:t.FreeSize}],Action:{Title:s("Create"),action:function(e){return t.CreateThinPoolVolume(e.name,e.size,{})}}})},vgroup_add_disk:function fe(t){var i=n.vgroups[t];if(!i)return;o.open({Title:s("Add Disks"),Fields:[{SelectMany:"disks",Title:s("Disks"),Options:r.get_free_blockdevs(n).filter(function(e){if(n.blocks_part[e.path])e=n.blocks[n.blocks_part[e.path].PartitionTable];var i=e&&n.blocks_lvm2[e.path]&&n.lvols[n.blocks_lvm2[e.path].LogicalVolume];return!i||i.VolumeGroup!=t}).map(function(e){return{value:e.path,Title:e.Name+" "+e.Description}}),validate:function(e){if(e.length===0)return s("At least one disk is needed.")}}],Action:{Title:s("Add"),action:function(t){return e.when.apply(null,t.disks.map(function(e){return i.AddDevice(e,{})}))}}})},pvol_empty:function me(e){var t=n.blocks_pvol[e];var i=t&&n.vgroups[t.VolumeGroup];if(!i)return;return i.EmptyDevice(e,{})},pvol_remove:function ve(e){var t=n.blocks_pvol[e];var i=t&&n.vgroups[t.VolumeGroup];if(!i)return;return i.RemoveDevice(e,true,{})},format:function _e(e){if(n.blocks[e])_(e);else if(n.lvols_block[e])_(n.lvols_block[e].path)},"delete":function ge(e){var i,a,l;i=n.blocks[e];if(i){a=n.blocks_part[e];l=n.blocks_lvm2[e]&&n.lvols[n.blocks_lvm2[e].LogicalVolume]}else{l=n.lvols[e]}var u,c;if(l){u=r.lvol_name(l);c=s("Deleting a logical volume will delete all data in it.")}else if(a){u=r.block_name(i);c=s("Deleting a partition will delete all data in it.")}if(u){o.open({Title:t.format(s("Please confirm deletion of $0"),u),Alerts:v(e),Fields:[],Action:{Danger:c,Title:s("Delete"),action:function(){if(l)return l.Delete({"tear-down":{t:"b",v:true}});else if(a)return a.Delete({"tear-down":{t:"b",v:true}})}}})}},job_cancel:function be(e){var t=n.storaged_jobs[e]||n.udisks_jobs[e];if(t)return t.Cancel({})}};e("#storage-detail").on("click","[data-action]",function(){var t=e(this).attr("data-action");var i=[];if(e(this).attr("data-args"))i=JSON.parse(e(this).attr("data-args"));else if(e(this).attr("data-arg"))i=[e(this).attr("data-arg")];var a=g[t].apply(this,i);if(a)a.fail(function(t){e("#error-popup-title").text(s("Error"));e("#error-popup-message").text(t.toString());e("#error-popup").modal("show")})});function b(e,t,a){return i.render('<button class="btn btn-default storage-privileged" data-action="{{Action}}" data-args="{{Args}}">{{Title}}</button>',{Title:e,Action:t,Args:JSON.stringify(a)})}var h=e("#action-btn-tmpl").html();i.parse(h);function T(e,t,a){function r(e,t){return e.indexOf(t,e.length-t.length)!==-1}var o=r(e.iface,".Block")?e:null;var l=o&&n.blocks_fsys[o.path];var u=o&&n.blocks_lvm2[o.path];var c=r(e.iface,".LogicalVolume")?e:null;var p=o&&o.IdUsage=="filesystem";var d=l&&l.MountPoints.length>0;var f=o&&o.IdUsage=="crypto";var m=c||u&&u.LogicalVolume!="/";var v=c&&c.Type=="pool";var _=o||c&&c.Active;var g=o&&!o.ReadOnly;var b;if(c)b=c.path;else if(u)b=u.LogicalVolume;var T=[{title:s("Mount"),action:"mount",disabled:d},{title:s("Unmount"),action:"unmount",disabled:!d},{title:s("Filesystem Options"),action:"fsys_options"}];var k=[{title:s("Lock"),action:"lock",disabled:t},{title:s("Unlock"),action:"unlock",disabled:!t},{title:s("Encryption Options"),action:"crypto_options"}];var y=[{title:s("Resize"),action:"resize",arg:b},{title:s("Rename"),action:"rename",arg:b}];var S=[{title:s("Create Snapshot"),action:"create_snapshot",arg:b},{title:s("Activate"),action:"activate",disabled:_,arg:b},{title:s("Deactivate"),action:"deactivate",disabled:!_,arg:b}];var z=[{title:s("Create Thin Volume"),action:"create_thin",arg:b}];var D=[{title:s("Format"),action:"format"}];var x=[{title:s("Delete"),action:"delete"}];var I=null;var A=[];if(p){A=A.concat(T);if(d)I=T[1];else I=T[0]}else if(f){A=A.concat(k);if(t)I=k[1];else I=k[0]}if(g){A=A.concat(D);if(!I)I=D[0]}if(m){A=A.concat(y);if(v){A=A.concat(z);I=z[0]}else{A=A.concat(S);if(!I){if(_)I=S[2];else I=S[1]}}}if(a||m){A=A.concat(x);if(!I)I=x[0]}return i.render(h,{arg:e.path,def:I,actions:A})}function k(i,a,o){var l,c,p;var d=n.blocks_pvol[i.path];var f=n.blocks_lvm2[i.path];if(i.IdUsage=="filesystem"){l=e("<span>").text(t.format(u("storage-id-desc","$0 File System"),i.IdType))}else if(i.IdUsage=="raid"){if(i.IdType=="linux_raid_member"){l=e("<span>").text(u("storage-id-desc","Linux MD-RAID Component"))}else if(i.IdType=="LVM2_member"){l=e("<span>").text(u("storage-id-desc","LVM2 Physical Volume"))}else{l=e("<span>").text(u("storage-id-desc","RAID Member"))}if(d&&n.vgroups[d.VolumeGroup]){var m=n.vgroups[d.VolumeGroup];l.append(" of ",e("<a>",{"data-goto-vgroup":m.Name}).text(m.Name))}else if(n.mdraids[i.MDRaidMember]){var v=n.mdraids[i.MDRaidMember];l.append(" of ",e("<a>",{"data-goto-mdraid":v.UUID}).text(r.mdraid_name(v)))}}else if(i.IdUsage=="crypto"){if(i.IdType=="crypto_LUKS"){l=e("<span>").text(u("storage-id-desc","LUKS Encrypted"))}else{l=e("<span>").text(u("storage-id-desc","Encrypted"))}}else if(i.IdUsage=="other"){if(i.IdType=="swap"){l=e("<span>").text(u("storage-id-desc","Swap Space"))}else{l=e("<span>").text(u("storage-id-desc","Other Data"))}}else{l=e("<span>").text(u("storage-id-desc","Unrecognized Data"))}if(a){c=e("<span>").append(t.format(s("$size $partition"),{size:r.fmt_size(i.Size),partition:a})," (",l,")")}else if(f&&n.lvols[f.LogicalVolume]){var _=n.lvols[f.LogicalVolume];c=e("<span>").append(t.format(s("$size $partition"),{size:r.fmt_size(i.Size),partition:r.lvol_name(_)})," (",l,")")}else c=l;p=r.block_name(i);if(i.IdUsage=="filesystem"){var g=n.blocks_fsys[i.path];p+=", ";if(g&&g.MountPoints.length>0)p+=t.format(s("mounted on $0"),r.decode_filename(g.MountPoints[0]));else p+=s("not mounted")}else if(i.IdUsage=="crypto"){p+=", ";if(o)p+=s("unlocked");else p+=s("locked")}return e("<div>").append(e("<div>").html(c),e("<div>").text(p)).html()}var y=e("#content-tmpl").html();i.parse(y);var S=[];function z(e,t,i,a,n){S.push({LevelWidth:30*e,Name:t,Description:i,Button:a,job_object:n})}function D(e,t,i){var a,r,o,l;var s;if(t.IdUsage=="crypto")s=n.blocks_cleartext[t.path];l=T(t,!s,!!i);if(t.IdLabel.length>0)r=t.IdLabel;else if(!l)r=null;else r="â€”";o=k(t,i,s);z(e,r,o,l,t.path);if(s)I(e+1,s)}function x(e,i){var a=n.blocks_ptable[i.path];var o=e;var l=a.Type=="dos";var u=n.blocks_partitions[i.path];function c(e,a,n){var u;var c=(Math.floor(a/(1024*1024))+1)*1024*1024;var p=false;if(a+n-c>=1024*1024){if(l){if(e>o){u=t.format(s("$0 Free Space for Logical Partitions"),r.fmt_size(n))}else{u=t.format(s("$0 Free Space for Primary Partitions"),r.fmt_size(n));p=true}}else{u=t.format(s("$0 Free Space"),r.fmt_size(n))}z(e,null,u,b(s("Create Partition"),"create_partition",[i.path,a,n,p]),null)}}function p(e,i,a,n){var o=t.format(s("$0 Extended Partition"),r.fmt_size(n));var l=T(i,false,true);z(e,null,o,l,i.path);d(e+1,a,n)}function d(e,t,i){var a;var r=t;var d=t+i;var f,m,v,_,g,b;for(a=0;a<u.length;a++){f=n.blocks[u[a].path];m=u[a].Offset;v=u[a].Size;_=u[a].Type;g=u[a].IsContainer;if(f===null)continue;if(e===o&&_=="l")continue;if(e==o+1&&_!="l")continue;if(m<t||m+v>t+i)continue;c(e,r,m-r);if(g)p(e,f,m,v);else{if(l){if(e>o)b=s("Logical Partition");else b=s("Primary Partition")}else b=s("Partition");D(e,f,b)}r=m+v}c(e,r,d-r)}d(o,0,i.Size)}function I(e,t){if(n.blocks_ptable[t.path])x(e,t);else D(e,t,null)}function A(e,t){S=[];I(t||0,e);return S}var C=e("#block-detail-tmpl").html();i.parse(C);function M(){e("#storage-detail .breadcrumb .active").text(d);var t=n.slashdevs_block[d];if(!t)return;var a={dbus:t,Name:r.block_name(t),Size:r.fmt_size_long(t.Size)};var o=n.drives[t.Drive];var l=n.drives_ata[t.Drive];var u=null;if(l){u={Failing:n.drives_ata.SmartFailing,Temperature:l.SmartTemperature>0&&r.format_temperature(l.SmartTemperature)}}var c=null;var p=t;if(o){var m=n.drives_block[o.path];var v=n.drives_multipath_blocks[o.path];var _=null;if(v.length>0){_={Devices:v.map(r.block_name)}}c={dbus:o,Size:o.Size>0&&r.fmt_size_long(o.Size),Assessment:u,Device:m&&r.block_name(m),Multipath:_,MultipathActive:f.state=="running"};p=m}return i.render(C,{Block:a,Drive:c,Content:p&&i.render(y,{Title:s("Content"),path:p.path,Entries:A(p)})})}var P=e("#mdraid-detail-tmpl").html();i.parse(P);function R(){var e=n.uuids_mdraid[d];if(!e)return;var a=n.mdraids_block[e.path];function o(e){return{raid0:s("RAID 0"),raid1:s("RAID 1"),raid4:s("RAID 4"),raid5:s("RAID 5"),raid6:s("RAID 6"),raid10:s("RAID 10")}[e]||t.format(s("RAID ($0)"),e)}var l=o(e.Level);if(e.NumDevices>0)l+=", "+t.format(s("$0 Disks"),e.NumDevices);if(e.ChunkSize>0)l+=", "+t.format(s("$0 Chunk Size"),r.fmt_size(e.ChunkSize));var u=null;if(e.BitmapLocation)u={Value:r.decode_filename(e.BitmapLocation)!="none"};var c=null;if(e.SyncAction){var p={idle:"",check:s("Data Scrubbing"),repair:s("Data Scrubbing and Repair"),resync:s("Resyncing"),recover:s("Recovering "),frozen:s("Frozen")}[e.SyncAction]||e.SyncAction;var f=null;if(p&&p!="idle"){var m=Math.round(e.SyncCompleted*100).toString();if(e.SyncRate>0){f=t.format(s("$action, ${percent}% complete at $rate"),{action:p,percent:m,rate:r.fmt_rate(e.SyncRate)})}else{f=t.format(s("$action, ${percent}% complete"),{action:p,percent:m})}if(e.SyncRemainingTime>0){f+=t.format(s(", $0 remaining"),r.format_delay(e.SyncRemainingTime/1e3))}}c={Name:d,Progress:f}}var v={dbus:e,Name:r.mdraid_name(e),Size:r.fmt_size_long(e.Size),Level:l,Bitmap:u,Degraded:e.Degraded>0&&t.format(s("$0 disks are missing"),e.Degraded),State:e.Running?s("Running"):s("Not running"),SyncAction:c};var _=null;if(a){_={dbus:a,Device:r.decode_filename(a.PreferredDevice)}}function g(i){var a=r.array_find(e.ActiveDevices,function(e){return e[0]==i.path});function o(e){return{Description:{faulty:s("FAILED"),in_sync:s("In Sync"),spare:a[1]<0?s("Spare"):s("Recovering"),write_mostly:s("Write-mostly"),blocked:s("Blocked")}[e]||t.format(s("Unknown ($0)"),e),Danger:e=="faulty"}}return{path:i.path,LinkTarget:r.get_block_link_target(n,i.path),Description:r.decode_filename(i.PreferredDevice),Slot:a&&a[1]>=0&&a[1].toString(),States:a&&a[2].map(o)}}var b=[{title:s("Start"),action:"mdraid_start"},{title:s("Stop"),action:"mdraid_stop"},{title:s("Start Scrubbing"),action:"mdraid_start_scrub"},{title:s("Stop Scrubbing"),action:"mdraid_stop_scrub"},{title:s("Delete"),action:"mdraid_delete"}];var T;if(e.Running)T=b[1];else T=b[0];return i.render(P,{MDRaid:v,MDRaidButton:i.render(h,{arg:e.path,def:T,actions:b}),Block:_,Members:n.mdraids_members[e.path].map(g),DynamicMembers:e.Level!="raid0",Content:a&&i.render(y,{Title:s("Content"),path:a.path,Entries:A(a)})})}function F(a,o){function l(i,a,o){var l,u;if(n.blocks_ptable[a.path]){u=t.format(s("$size $desc"),{desc:o.Name,size:r.fmt_size(a.Size)});u+="<br/>"+e("<span>").text(r.decode_filename(a.PreferredDevice));l=T(a,false,false);z(i,null,u,l,a.path);x(i+1,a)}else D(i,a,null)}function u(e,i){var a,o,c,p;if(i.Type=="pool"){c=Math.max(i.DataAllocatedRatio,i.MetadataAllocatedRatio);o=t.format(s("$size $desc<br/>${percent}% full"),{size:r.fmt_size(i.Size),desc:r.lvol_name(i),percent:(c*100).toFixed(0)});a=T(i,false,false);z(e,null,o,a);n.lvols_pool_members[i.path].forEach(function(t){u(e+1,t)})}else{p=n.lvols_block[i.path];if(p)l(e,p,i);else{o=t.format(s("$size $desc<br/>($state)"),{size:r.fmt_size(i.Size),desc:r.lvol_name(i),state:i.Active?s("active, but unsupported"):s("inactive")});a=T(i,false,false);z(e,null,o,a,null)}}}S=[];o=o||0;n.vgroups_lvols[a.path].forEach(function(e){if(e.ThinPool=="/")u(o,e)});if(a.FreeSize>0){var c,p,d;d=t.format(s("$0 Free Space for Logical Volumes"),r.fmt_size(a.FreeSize));p=[{title:s("Create Plain Logical Volume"),action:"vgroup_create_plain"},{title:s("Create RAID Logical Volume"),action:"vgroup_create_raid"},{title:s("Create Pool for Thin Logical Volumes"),action:"vgroup_create_thinpool"}];c=i.render(h,{arg:a.path,def:p[0],actions:p});z(o,null,d,c,null)}return S}var V=e("#vgroup-detail-tmpl").html();i.parse(V);var L;function $(){var e=n.vgnames_vgroup[d];if(!e)return;if(e.NeedsPolling&&L===null){L=window.setInterval(function(){e.Poll()},2e3)}else if(!e.NeedsPolling&&L!==null){window.clearInterval(L);L=null}var a={dbus:e,Size:r.fmt_size_long(e.Size)};function o(e){var a=n.blocks[e.path];var o=[{action:"pvol_remove",title:s("Remove")},{action:"pvol_empty",title:s("Empty")}];return{dbus:a,LinkTarget:r.get_block_link_target(n,e.path),Device:r.decode_filename(a.PreferredDevice),Sizes:t.format(s("$0, $1 free"),r.fmt_size(e.Size),r.fmt_size(e.FreeSize)),Button:i.render(h,{arg:e.path,def:o[0],actions:o})}}var l=[{action:"vgroup_rename",title:s("Rename")},{action:"vgroup_delete",title:s("Delete")}];return i.render(V,{VGroup:a,VGroupButton:i.render(h,{arg:e.path,def:l[0],actions:l}),PVols:n.vgroups_pvols[e.path].map(o),Content:i.render(y,{Title:s("Logical Volumes"),Entries:F(e)})})}function w(){e("#storage-detail .breadcrumb .active").text(d);var t;if(p=="block")t=M();else if(p=="mdraid")t=R();else if(p=="vgroup")t=$();if(t)e("#detail").amend(t);else e("#detail").text(s("Not found"));c.update("#storage-detail");e("#detail-jobs").amend(c.render());l.update()}e(f).on("changed",w);e(n).on("changed",w);e("#storage-detail-log").append(a.logbox(["_SYSTEMD_UNIT=storaged.service","+","_SYSTEMD_UNIT=udisks2.service","+","_SYSTEMD_UNIT=dm-event.service","+","_SYSTEMD_UNIT=smartd.service","+","_SYSTEMD_UNIT=multipathd.service"],10));e("#storage-detail .breadcrumb a").on("click",function(){t.location.go("/")});function N(){d=null;e("#storage-detail").hide()}function E(t,i){if(L!==null){window.clearInterval(L);L=null}p=t;d=i;w();e("#storage-detail").show()}return{show:E,hide:N}}return{init:c}});

//# sourceURL=storage/details.min.js

require(["jquery","base1/cockpit","storage/client","storage/jobs","storage/overview","storage/details","storage/utils","translated!base1/po","base1/bootstrap-select"],function(t,o,a,e,i,n,r,s){o.locale(s);var l=o.gettext;var c=o.gettext;function d(){var s;var c;var d;t("body").on("click","[data-goto-block]",function(){o.location.go([t(this).attr("data-goto-block")])});t("body").on("click","[data-goto-mdraid]",function(){o.location.go(["mdraid",t(this).attr("data-goto-mdraid")])});t("body").on("click","[data-goto-vgroup]",function(){o.location.go(["vg",t(this).attr("data-goto-vgroup")])});r.init_arming_zones(t("body"));function g(){var a=o.location.path;if(a.length===0){d.hide();c.show()}else if(a.length==1){c.hide();d.show("block",a[0])}else if(a.length==2&&a[0]=="mdraid"){c.hide();d.show("mdraid",a[1])}else if(a.length==2&&a[0]=="vg"){c.hide();d.show("vgroup",a[1])}else{console.warn("not a init location: "+a);o.location=""}t("body").show()}a.init(function(){o.translate();if(a.features===false){t("#unsupported").show();t("body").show()}else{s=e.init(a);c=i.init(a,s);d=n.init(a,s);t(o).on("locationchanged",g);g()}});var u=r.get_multipathd_service();function h(){var o=!u.state||u.state==="running";var e=a.broken_multipath_present===true;t("#multipath-broken").toggle(e&&!o)}t(u).on("changed",h);t(a).on("changed",h);h();t("#activate-multipath").on("click",function(){o.spawn(["mpathconf","--enable","--with_multipathd","y"],{superuser:"try"}).fail(function(o){t("#error-popup-title").text(l("Error"));t("#error-popup-message").text(o.toString());t("#error-popup").modal("show")})})}t(d)});

//# sourceURL=storage/devices.min.js

define("storage/dialog", ["jquery","base1/mustache","base1/patterns"],function(e,i){var a;function n(){a=e("#storage-dialog-tmpl").html();i.parse(a)}var l;function t(n){n.Fields.forEach(function(e){if(e.SizeInput&&e.Value)e.ValueMB=(e.Value/(1024*1024)).toFixed(0)});function t(i){var a=e(this).hasClass("collapsed");if(a){e(this).removeClass("collapsed");e(this).find(".fa").removeClass("fa-angle-right").addClass("fa-angle-down")}else{e(this).addClass("collapsed");e(this).find(".fa").removeClass("fa-angle-down").addClass("fa-angle-right")}c()}function f(i){var a=e(this);var n=e(i.target).parent("tr");a.find("tr").removeClass("highlight");n.addClass("highlight")}if(l)l.modal("hide");var o=e(i.render(a,n));e("body").append(o);l=o;o.on("hidden.bs.modal",function(){o.remove()});o.find(".selectpicker").selectpicker();o.find(".dialog-arrow").on("click",t);o.find(".dialog-select-row-table tbody").on("click",f);o.find(".dialog-select-row-table tbody tr:first-child").addClass("highlight");var s={};function r(e){return e.TextInput||e.PassInput||e.SelectOne||e.SelectMany||e.SizeInput||e.CheckBox||e.Arrow||e.SelectRow}function d(){var i={};n.Fields.forEach(function(a){var n=r(a);var l=o.find('[data-field="'+n+'"]');if(a.TextInput)i[n]=l.val();else if(a.PassInput)i[n]=l.val();else if(a.SelectOne)i[n]=l.val();else if(a.SizeInput)i[n]=parseInt(l.val())*1024*1024;else if(a.CheckBox)i[n]=l.prop("checked");else if(a.SelectMany){i[n]=[];l.find("input").each(function(e,l){if(l.checked)i[n].push(a.Options[e].value)})}else if(a.SelectRow){l.find("tbody tr").each(function(l,t){if(e(t).hasClass("highlight"))i[n]=a.Rows[l].value})}else if(a.Arrow){i[n]=!l.hasClass("collapsed")}});return i}function c(){var e=d();n.Fields.forEach(function(i){if(i.visible){var a=r(i);s[a]=!i.visible(e);o.find('[data-field="'+a+'"]').parents("tr").toggle(!s[a])}})}function u(){var e=d();var i=[];n.Fields.forEach(function(a){var n=r(a);if(s[n])e[n]=undefined;else{if(a.validate){var l=a.validate(e[n],e);if(l){var t=new Error(l);t.target='[data-field="'+n+'"]';i.push(t)}}}});o.dialog("failure",i);return i.length===0?e:null}o.on("change input",function(){c()});function h(e){if(e.field)return{message:e.message,target:'[data-field="'+e.field+'"]'};else return e}o.find('button[data-action="apply"]').on("click",function(){var e=u();if(e!==null){var i=n.Action.action(e);if(i){o.dialog("wait",i);i.done(function(e){o.modal("hide")}).fail(function(i){if(n.Action.failure_filter)i=n.Action.failure_filter(e,i);if(i){if(i.length)i=i.map(h);else i=h(i);o.dialog("failure",i)}})}else{o.modal("hide")}}});c();o.modal("show")}e(n);return{open:t}});

//# sourceURL=storage/dialog.min.js

define("storage/client", ["jquery","base1/cockpit","storage/utils"],function(e,o,s){var r={};function i(s){var r;var i={data:{},close:t};function l(e){i.data={};r=[];for(var o=0;o<e.metrics.length;o++){r[o]=e.metrics[o].instances;for(var s=0;s<r[o].length;s++)i.data[r[o][s]]=[]}}function a(o){var s=false;for(var l=0;l<o.length;l++){var a=o[l];for(var n=0;n<a.length;n++){var t=a[n];for(var c=0;c<t.length;c++){if(t[c]!==null){s=true;i.data[r[n][c]][n]=t[c]}}}}if(s)e(i).triggerHandler("changed")}var n=o.channel({payload:"metrics1",source:"internal",metrics:s});e(n).on("closed",function(e,o){console.log("closed",o)});e(n).on("message",function(e,o){var s=JSON.parse(o);if(s.length)a(s);else l(s)});function t(){n.close()}return i}var l="org.storaged.Storaged";var a="/org/storaged/Storaged";var n="org.storaged.Storaged";if(false){l="org.freedesktop.UDisks2";a="/org/freedesktop/UDisks2";n="org.freedesktop.UDisks2"}r.time_offset=undefined;r.features=undefined;r.storaged_client=o.dbus(l);function t(e,o){return r.storaged_client.proxy(n+"."+e,a+"/"+o,{watch:true})}function c(e){return r.storaged_client.proxies(n+"."+e,a,{watch:false})}r.storaged_client.watch({path_namespace:a});r.manager=t("Manager","Manager");r.manager_lvm2=t("Manager.LVM2","Manager");r.manager_iscsi=t("Manager.ISCSI.Initiator","Manager");r.mdraids=c("MDRaid");r.vgroups=c("VolumeGroup");r.lvols=c("LogicalVolume");r.drives=c("Drive");r.drives_ata=c("Drive.Ata");r.blocks=c("Block");r.blocks_ptable=c("PartitionTable");r.blocks_part=c("Partition");r.blocks_lvm2=c("Block.LVM2");r.blocks_pvol=c("PhysicalVolume");r.blocks_fsys=c("Filesystem");r.blocks_crypto=c("Encrypted");r.iscsi_sessions=c("ISCSI.Session");r.storaged_jobs=c("Job");if(l!="org.freedesktop.UDisks2"){r.udisks_client=o.dbus("org.freedesktop.UDisks2");r.udisks_jobs=r.udisks_client.proxies("org.freedesktop.UDisks2.Job","/org/freedesktop/UDisks2")}else{r.udisks_client=null;r.udisks_jobs={}}r.fsys_sizes=i([{name:"mount.used"},{name:"mount.total"}]);r.blockdev_io=i([{name:"block.device.read",derive:"rate"},{name:"block.device.written",derive:"rate"}]);function d(e){if(e.Symlinks&&e.Symlinks.length){for(var o=0;o<e.Symlinks.length;o++)if(s.decode_filename(e.Symlinks[o]).indexOf("/dev/disk/by-id/dm-uuid-mpath-")===0)return true}return false}function u(){var e,o,i,l,a,n,t,c,u;r.broken_multipath_present=false;r.drives_multipath_blocks={};r.drives_block={};for(e in r.drives){r.drives_multipath_blocks[e]=[]}for(e in r.blocks){o=r.blocks[e];if(!r.blocks_part[e]&&r.drives_multipath_blocks[o.Drive]!==undefined){if(d(o))r.drives_block[o.Drive]=o;else r.drives_multipath_blocks[o.Drive].push(o)}}for(e in r.drives_multipath_blocks){if(!r.drives_block[e]&&r.drives_multipath_blocks[e].length==1){r.drives_block[e]=r.drives_multipath_blocks[e][0];r.drives_multipath_blocks[e]=[]}else{r.drives_multipath_blocks[e].sort(s.block_cmp);if(!r.drives_block[e])r.broken_multipath_present=true}}r.mdraids_block={};for(e in r.blocks){o=r.blocks[e];if(o.MDRaid!="/")r.mdraids_block[o.MDRaid]=o}r.mdraids_members={};for(e in r.mdraids){r.mdraids_members[e]=[]}for(e in r.blocks){o=r.blocks[e];if(r.mdraids_members[o.MDRaidMember]!==undefined)r.mdraids_members[o.MDRaidMember].push(o)}for(e in r.mdraids_members){r.mdraids_members[e].sort(s.block_cmp)}r.slashdevs_block={};function f(e,o){r.slashdevs_block[s.decode_filename(o).replace(/^\/dev\//,"")]=e}for(e in r.blocks){o=r.blocks[e];f(o,o.Device);f(o,o.PreferredDevice);for(u=0;u<o.Symlinks.length;u++)f(o,o.Symlinks[u])}r.uuids_mdraid={};for(e in r.mdraids){l=r.mdraids[e];r.uuids_mdraid[l.UUID]=l}r.vgnames_vgroup={};for(e in r.vgroups){a=r.vgroups[e];r.vgnames_vgroup[a.Name]=a}r.vgroups_pvols={};for(e in r.vgroups){r.vgroups_pvols[e]=[]}for(e in r.blocks_pvol){n=r.blocks_pvol[e];if(r.vgroups_pvols[n.VolumeGroup]!==undefined)r.vgroups_pvols[n.VolumeGroup].push(n)}function _(e,o){return s.block_cmp(r.blocks[e.path],r.blocks[o.path])}for(e in r.vgroups_pvols){r.vgroups_pvols[e].sort(_)}r.vgroups_lvols={};for(e in r.vgroups){r.vgroups_lvols[e]=[]}for(e in r.lvols){t=r.lvols[e];if(r.vgroups_lvols[t.VolumeGroup]!==undefined)r.vgroups_lvols[t.VolumeGroup].push(t)}for(e in r.vgroups_lvols){r.vgroups_lvols[e].sort(function(e,o){return e.Name.localeCompare(o.Name)})}r.lvols_block={};for(e in r.blocks_lvm2){r.lvols_block[r.blocks_lvm2[e].LogicalVolume]=r.blocks[e]}r.lvols_pool_members={};for(e in r.lvols){if(r.lvols[e].Type=="pool")r.lvols_pool_members[e]=[]}for(e in r.lvols){t=r.lvols[e];if(r.lvols_pool_members[t.ThinPool]!==undefined)r.lvols_pool_members[t.ThinPool].push(t)}for(e in r.lvols_pool_members){r.lvols_pool_members[e].sort(function(e,o){return e.Name.localeCompare(o.Name)})}r.blocks_cleartext={};for(e in r.blocks){o=r.blocks[e];if(o.CryptoBackingDevice!="/")r.blocks_cleartext[o.CryptoBackingDevice]=o}r.blocks_partitions={};for(e in r.blocks_ptable){r.blocks_partitions[e]=[]}for(e in r.blocks_part){c=r.blocks_part[e];if(r.blocks_partitions[c.Table]!==undefined)r.blocks_partitions[c.Table].push(c)}for(e in r.blocks_partitions){r.blocks_partitions[e].sort(function(e,o){return e.Offset-o.Offset})}}function f(s){function i(e,o){var s=e.pop();if(s){s.wait(function(){i(e,o)})}else o()}i([r.manager,r.mdraids,r.vgroups,r.drives,r.blocks,r.blocks_ptable,r.blocks_lvm2,r.blocks_fsys],function(){if(!r.manager.valid){r.features=false;s()}else{r.features={lvm2:r.manager_lvm2.valid,iscsi:r.manager_iscsi.valid};e(r.manager_lvm2).on("changed",function(){r.features.lvm2=r.manager_lvm2.valid;e(r.features).triggerHandler("changed")});e(r.manager_iscsi).on("changed",function(){r.features.iscsi=r.manager_iscsi.valid;e(r.features).triggerHandler("changed")});o.spawn(["date","+%s"]).done(function(e){r.time_offset=parseInt(e)*1e3-(new Date).getTime()}).always(function(){r.manager.EnableModules(true).fail(function(e){console.warn("Can't enable storaged modules",e.toString())});e(r.storaged_client).on("notify",function(){u();e(r).triggerHandler("changed")});e(r.udisks_jobs).on("added removed changed",function(){e(r).triggerHandler("changed")});u();s()})}})}r.init=f;return r});

//# sourceURL=storage/client.min.js

define("storage/jobs", ["jquery","base1/cockpit","base1/mustache","system/server","shell/shell","storage/utils"],function(e,t,r,a,i,o){var n=t.gettext;var s=t.gettext;function l(a){l=e("#jobs-tmpl").html();r.parse(l);function i(e){if(a.udisks_client)return e.replace("/org/freedesktop/UDisks2/","/org/storaged/Storaged/");else return e}function s(t){var r;e(t).find("[data-job-object]").css("visibility","hidden");function o(e){if(a.blocks_part[e]&&a.blocks[a.blocks_part[e].Table])return a.blocks_part[e].Table;if(a.blocks_crypto[e]&&a.blocks[a.blocks_crypto[e].CryptoBackingDevice])return a.blocks_crypto[e].CryptoBackingDevice;if(a.blocks[e]&&a.drives[a.blocks[e].Drive])return a.blocks[e].Drive;if(a.blocks[e]&&a.mdraids[a.blocks[e].MDRaid])return a.blocks[e].MDRaid;if(a.blocks_lvm2[e]&&a.lvols[a.blocks_lvm2[e].LogicalVolume])return a.blocks_lvm2[e].LogicalVolume;if(a.lvols[e]&&a.vgroups[a.lvols[e].VolumeGroup])return a.lvols[e].VolumeGroup}function n(r){e(t).find('[data-job-object="'+r+'"]').css("visibility","visible")}function s(e){n(e);var t=o(e);if(t)s(t)}function l(e){for(var t=0;t<e.length;t++)s(e[t])}for(r in a.storaged_jobs)l(a.storaged_jobs[r].Objects);for(r in a.udisks_jobs){l(a.udisks_jobs[r].Objects.map(i))}}e(a.storaged_jobs).on("added removed changed",function(){s("body")});e(a.udisks_jobs).on("added removed changed",function(){s("body")});var l;function g(){var e={"ata-smart-selftest":n("SMART self-test of $target"),"drive-eject":n("Ejecting $target"),"encrypted-unlock":n("Unlocking $target"),"encrypted-lock":n("Locking $target"),"encrypted-modify":n("Modifying $target"),"swapspace-start":n("Starting swapspace $target"),"swapspace-stop":n("Stopping swapspace $target"),"filesystem-mount":n("Mounting $target"),"filesystem-unmount":n("Unmounting $target"),"filesystem-modify":n("Modifying $target"),"format-erase":n("Erasing $target"),"format-mkfs":n("Creating filesystem on $target"),"loop-setup":n("Setting up loop device $target"),"partition-modify":n("Modifying $target"),"partition-delete":n("Deleting $target"),"partition-create":n("Creating partition $target"),cleanup:n("Cleaning up for $target"),"ata-secure-erase":n("Securely erasing $target"),"ata-enhanced-secure-erase":n("Very securely erasing $target"),"md-raid-stop":n("Stopping RAID Device $target"),"md-raid-start":n("Starting RAID Device $target"),"md-raid-fault-device":n("Marking $target as faulty"),"md-raid-remove-device":n("Removing $target from RAID Device"),"md-raid-create":n("Creating RAID Device $target"),"lvm-lvol-delete":n("Deleting $target"),"lvm-lvol-activate":n("Activating $target"),"lvm-lvol-deactivate":n("Deactivating $target"),"lvm-lvol-snapshot":n("Creating snapshot of $target"),"lvm-vg-create":n("Creating volume group $target"),"lvm-vg-delete":n("Deleting volume group $target"),"lvm-vg-add-device":n("Adding physical volume to $target"),"lvm-vg-rem-device":n("Removing physical volume from $target"),"lvm-vg-empty-device":n("Emptying $target"),"lvm-vg-create-volume":n("Creating logical volume $target"),"lvm-vg-rename":n("Renaming $target"),"lvm-vg-resize":n("Resizing $target")};var s=(new Date).getTime()+a.time_offset;function g(r){var s=e[r.Operation];if(!s)s=n("Operation '$operation' on $target");var l=r.Objects.map(function(e){var t=i(e);if(a.blocks[t])return o.block_name(a.blocks[t]);else if(a.mdraids[t])return o.mdraid_name(a.mdraids[t]);else if(a.vgroups[t])return a.vgroups[t].Name;else if(a.lvols[t])return o.lvol_name(a.lvols[t]);else return n("unknown target")}).join(", ");return t.format(s,{operation:r.Operation,target:l})}function c(e){return a.storaged_jobs[e]||a.udisks_jobs[e]}function d(e,t){return c(e).StartTime-c(t).StartTime}function v(e){var t=c(e);var r=s-t.StartTime/1e3;return r>=2e3}function u(e){var t=c(e);var r=null;if(t.ExpectedEndTime>0){var a=t.ExpectedEndTime/1e3-s;if(a>0)r=o.format_delay(a)}return{path:e,Description:g(t),Progress:t.ProgressValid&&(t.Progress*100).toFixed()+"%",RemainingTime:r,Cancelable:t.Cancelable}}var m=Object.keys(a.storaged_jobs).concat(Object.keys(a.udisks_jobs)).filter(v).sort(d).map(u);return r.render(l,{Jobs:m,HasJobs:m.length>0})}return{update:s,render:g}}return{init:l}});

//# sourceURL=storage/jobs.min.js

define("storage/overview", ["jquery","base1/cockpit","base1/mustache","system/server","shell/shell","storage/utils","storage/dialog","storage/permissions","shell/plot"],function(e,t,a,i,r,s,n,o){var l=t.gettext;var d=t.gettext;function u(u,c){function m(){e("#vgroups").toggle(u.features.lvm2);e("#iscsi-sessions").toggle(u.features.iscsi)}e(u.features).on("changed",m);m();var v=e("#mdraids-tmpl").html();a.parse(v);function p(){function t(e,t){return u.mdraids[e].Name.localeCompare(u.mdraids[t].Name)}function i(e){var t=u.mdraids[e];return{path:e,UUID:t.UUID,Size:s.fmt_size(t.Size),Name:s.mdraid_name(t)}}var r=Object.keys(u.mdraids).sort(t).map(i);e("#mdraids").amend(a.render(v,{MDRaids:r,HasMDRaids:r.length>0}));o.update();c.update("#mdraids")}e(u).on("changed",p);var f=e("#vgroups-tmpl").html();a.parse(f);function g(){function t(e,t){return u.vgroups[e].Name.localeCompare(u.vgroups[t].Name)}function i(e){var t=u.vgroups[e];return{path:e,Size:s.fmt_size(t.Size),Name:t.Name}}var r=Object.keys(u.vgroups).sort(t).map(i);e("#vgroups").amend(a.render(f,{VGroups:r,HasVGroups:r.length>0}));o.update();c.update("#vgroups")}e(u).on("changed",g);var _=e("#iscsi-sessions-tmpl").html();a.parse(_);function h(){function t(e,t){var a=u.iscsi_sessions[e];var i=u.iscsi_sessions[t];return a.target_name.localeCompare(i.target_name)}function i(e){var t=u.iscsi_sessions[e];return{path:e,Name:t.data["target_name"],Tpgt:t.data["tpgt"],Address:t.data["persistent_address"],Port:t.data["persistent_port"]}}var r=Object.keys(u.iscsi_sessions).sort(t).map(i);e("#iscsi-sessions").amend(a.render(_,{Sessions:r,HasSessions:r.length>0}));o.update()}e(u).on("changed",h);var k=e("#drives-tmpl").html();a.parse(k);var T;function b(){function t(e,t){return u.drives[e].SortKey.localeCompare(u.drives[t].SortKey)}function i(e){if(e.MediaRemovable||e.Media){for(var t=0;t<e.MediaCompatibility.length;t++)if(e.MediaCompatibility[t].indexOf("optical")===0)return"optical";return"removable"}return e.RotationRate===0?"ssd":"hdd"}function r(e){var t=u.drives[e];var a=u.drives_block[e];if(!a){a=u.drives_multipath_blocks[e][0]}if(!a)return;var r=s.decode_filename(a.Device).replace(/^\/dev\//,"");var n=u.blockdev_io.data[r];var o=s.drive_name(t);var l=i(t);var c=s.fmt_size(t.Size);var m;if(l=="hdd"){m=c+" "+d("storage","Hard Disk")}else if(l=="ssd"){m=c+" "+d("storage","Solid-State Disk")}else if(l=="removable"){if(t.Size===0)m=d("storage","Removable Drive");else m=c+" "+d("storage","Removable Drive")}else if(l=="optical"){m=d("storage","Optical Drive")}else{if(t.Size===0)m=d("storage","Drive");else m=c+" "+d("storage","Drive")}return{path:e,dev:r,Name:o,Classification:l,Description:m,ReadRate:n&&s.fmt_rate(n[0]),WriteRate:n&&s.fmt_rate(n[1]),Highlight:r==T}}var n=Object.keys(u.drives).sort(t).map(r);e("#drives").amend(a.render(k,{Drives:n,HasDrives:n.length>0}));o.update();c.update("#drives");for(var l in n){if(n[l]&&n[l].dev){C.add_instance(n[l].dev);P.add_instance(n[l].dev)}}}e(u).on("changed",b);e(u.blockdev_io).on("changed",b);var D=e("#others-tmpl").html();a.parse(D);function S(){function i(e){var t=u.blocks[e];var a=u.blocks_part[e];var i=u.blocks_lvm2[e];return(!a||a.Table=="/")&&t.Drive=="/"&&t.CryptoBackingDevice=="/"&&t.MDRaid=="/"&&(!i||i.LogicalVolume=="/")&&!t.HintIgnore}function r(e){var a=u.blocks[e];var i=s.block_name(a);return{path:e,dev:i.replace(/^\/dev\//,""),Name:i,Description:t.format(l("$0 Block Device"),s.fmt_size(a.Size))}}var n=Object.keys(u.blocks).filter(i).sort(s.make_block_path_cmp(u)).map(r);e("#others").amend(a.render(D,{Others:n,HasOthers:n.length>0}));o.update()}e(u).on("changed",S);var y=e("#mounts-tmpl").html();a.parse(y);function I(){function t(e){var t=u.blocks[e];var a=u.blocks_fsys[e];return a&&t.IdUsage=="filesystem"&&t.IdType!="mpath_member"&&!t.HintIgnore}function i(e,t){return u.blocks[e].IdLabel.localeCompare(u.blocks[t]).IdLabel}function r(e){var t=u.blocks[e];var a=u.blocks_fsys[e];var i=a.MountPoints.map(s.decode_filename);var r;for(var n=0;n<i.length&&!r;n++)r=u.fsys_sizes.data[i[n]];return{LinkTarget:s.get_block_link_target(u,e),Name:t.IdLabel||s.block_name(t),DeviceSize:s.fmt_size(t.Size),UsageText:r?s.format_fsys_usage(r[0],r[1]):null,UsagePercent:r?r[0]/r[1]*100:null,UsageCritical:r&&r[0]>.95*r[1],MountPoints:a.MountPoints.map(s.decode_filename),IsMounted:a.MountPoints.length>0}}var n=Object.keys(u.blocks).filter(t).sort(i).map(r);e("#mounts").amend(a.render(y,{Mounts:n,HasMounts:n.length>0}));o.update();c.update("#mounts")}e(u).on("changed",I);e(u.fsys_sizes).on("changed",I);function x(){e("#jobs").amend(c.render());o.update()}e(u).on("changed",x);function w(t){return function a(i){var s=i.getAxes();if(s.yaxis.datamax<1e5)s.yaxis.options.max=1e5;else s.yaxis.options.max=null;s.yaxis.options.min=0;e(t).text(r.bytes_per_sec_tick_unit(s.yaxis))}}function z(e,t){T=t;b()}var M={direct:"disk.dev.read_bytes",internal:"block.device.read",units:"bytes",derive:"rate",threshold:1e3};var N=r.plot_simple_template();e.extend(N.yaxis,{ticks:r.memory_ticks,tickFormatter:r.format_bytes_per_sec_tick_no_unit});e.extend(N.grid,{hoverable:true,autoHighlight:false});N.setup_hook=w("#storage-reading-unit");var A=r.plot(e("#storage-reading-graph"),300);A.set_options(N);var C=A.add_metrics_stacked_instances_series(M,{});A.start_walking();e(C).on("hover",z);var R={direct:"disk.dev.write_bytes",internal:"block.device.written",units:"bytes",derive:"rate",threshold:1e3};var O=r.plot_simple_template();e.extend(O.yaxis,{ticks:r.memory_ticks,tickFormatter:r.format_bytes_per_sec_tick_no_unit});e.extend(O.grid,{hoverable:true,autoHighlight:false});O.setup_hook=w("#storage-writing-unit");var U=r.plot(e("#storage-writing-graph"),300);U.set_options(O);var P=U.add_metrics_stacked_instances_series(R,{});U.start_walking();e(P).on("hover",z);e(window).on("resize",function(){A.resize();U.resize()});var H=r.setup_plot_controls(e("#storage"),e("#storage-graph-toolbar"));H.reset([A,U]);p();g();h();b();S();I();x();e("#storage-log").append(i.logbox(["_SYSTEMD_UNIT=storaged.service","+","_SYSTEMD_UNIT=udisks2.service","+","_SYSTEMD_UNIT=dm-event.service","+","_SYSTEMD_UNIT=smartd.service","+","_SYSTEMD_UNIT=multipathd.service"],10));e("#create-mdraid").on("click",function(){n.open({Title:l("Create RAID Device"),Fields:[{TextInput:"name",Title:l("Name")},{SelectOne:"level",Title:l("RAID Level"),Options:[{value:"raid0",Title:l("RAID 0 (Stripe)")},{value:"raid1",Title:l("RAID 1 (Mirror)")},{value:"raid4",Title:l("RAID 4 (Dedicated Parity)")},{value:"raid5",Title:l("RAID 5 (Distributed Parity)"),selected:true},{value:"raid6",Title:l("RAID 6 (Double Distributed Parity)")},{value:"raid10",Title:l("RAID 10 (Stripe of Mirrors)")}]},{SelectOne:"chunk",Title:l("Chunk Size"),Options:[{value:"4",Title:l("4 KiB")},{value:"8",Title:l("8 KiB")},{value:"16",Title:l("16 KiB")},{value:"32",Title:l("32 KiB")},{value:"64",Title:l("64 KiB")},{value:"128",Title:l("128 KiB")},{value:"512",Title:l("512 KiB"),selected:true},{value:"1024",Title:l("1 MiB")},{value:"2048",Title:l("2 MiB")}],visible:function(e){return e.level!="raid1"}},{SelectMany:"disks",Title:l("Disks"),Options:s.get_free_blockdevs(u).map(function(e){return{value:e.path,Title:e.Name+" "+e.Description}}),validate:function(e,a){var i=a.level=="raid6"?4:2;if(e.length<i)return t.format(l("At least $0 disks are needed."),i)}}],Action:{Title:l("Create"),action:function(e){return u.manager.MDRaidCreate(e.disks,e.level,e.name,(e.chunk||0)*1024,{})}}})});e("#create-volume-group").on("click",function(){n.open({Title:l("Create Volume Group"),Fields:[{TextInput:"name",Title:l("Name"),validate:s.validate_lvm2_name},{SelectMany:"disks",Title:l("Disks"),Options:s.get_free_blockdevs(u).map(function(e){return{value:e.path,Title:e.Name+" "+e.Description}}),validate:function(e){if(e.length===0)return l("At least one disk is needed.")}}],Action:{Title:l("Create"),action:function(e,t){return u.manager_lvm2.VolumeGroupCreate(e.name,e.disks,{})}}})});function B(){n.open({Title:l("Add iSCSI Portal"),Fields:[{TextInput:"address",Title:l("Server Address"),validate:function(e){if(e==="")return l("Server address can not be empty.")}},{TextInput:"username",Title:"Username"},{PassInput:"password",Title:"Password"}],Action:{Title:l("Next"),action:function(t,a){var i=e.Deferred();var r={};if(t.username||t.password){r.username={t:"s",v:t.username};r.password={t:"s",v:t.password}}var s=false;u.manager_iscsi.call("DiscoverSendTargets",[t.address,0,r]).done(function(e){if(!s){i.resolve();K(t,e[0])}}).fail(function(e){if(!s)i.reject(e)});var n=i.promise();n.cancel=function(){s=true;i.reject()};return n},failure_filter:function(e,t){if(!t)return t;if(t.message.indexOf("initiator failed authorization")!=-1)return[{field:"username",message:null},{field:"password",message:l("Invalid username or password")}];else if(t.message.indexOf("cannot resolve host name")!=-1)return{field:"address",message:l("Unknown host name")};else if(t.message.indexOf("connection login retries")!=-1)return{field:"address",message:l("Unable to reach server")};else return t}}})}function j(e,t){var a={"node.startup":{t:"s",v:"automatic"}};if(t.username||t.password){a.username={t:"s",v:t.username};a.password={t:"s",v:t.password}}return u.manager_iscsi.call("Login",[e[0],e[1],e[2],e[3],e[4],a])}function K(e,a){var i=a.map(function(e){return{Columns:[e[0],e[2],e[3]],value:e}});n.open({Title:t.format(l("Available targets on $0"),e.address),Fields:[{SelectRow:"target",Title:l("Targets"),Headers:[l("Name"),l("Address"),l("Port")],Rows:i}],Action:{Title:l("Add"),action:function(t){return j(t.target,e)},failure_filter:function(t,a){if(a.message.indexOf("authorization")!=-1)F(e,t);else return a}}})}function F(e,t){n.open({Title:"Authentication required",Fields:[{TextInput:"username",Title:"Username",Value:e.username},{PassInput:"password",Title:"Password",Value:e.password}],Action:{Title:l("Add"),action:function(e){return j(t.target,e)},failure_filter:function(e,t){if(t.message.indexOf("authorization")!=-1)return[{field:"username",message:null},{field:"password",message:l("Invalid username or password")}];else return t}}})}function L(t){var a=u.iscsi_sessions[t];if(!a)return;var i={"node.startup":{t:"s",v:"manual"}};a.Logout(i).fail(function(t){e("#error-popup-title").text(l("Error"));e("#error-popup-message").text(t.toString());e("#error-popup").modal("show")})}function V(){u.manager_iscsi.call("GetInitiatorName").done(function(e){var t=e[0];n.open({Title:l("Change iSCSI Initiator Name"),Fields:[{TextInput:"name",Title:l("Name"),Value:t}],Action:{Title:l("Change"),action:function(e){return u.manager_iscsi.call("SetInitiatorName",[e.name,{}])}}})})}e("#storage").on("click",'[data-action="add-iscsi-portal"]',function(){B()});e("#storage").on("click",'[data-action="edit-iscsi"]',function(){V()});e("#storage").on("click","[data-iscsi-session-remove]",function(){s.reset_arming_zone(e(this));L(e(this).attr("data-iscsi-session-remove"))});function E(){e("#storage").hide()}function G(){e("#storage").show();A.resize();U.resize()}return{show:G,hide:E}}return{init:u}});

//# sourceURL=storage/overview.min.js

define("storage/permissions", ["jquery","base1/cockpit"],function(t,e){var i=e.gettext;var a=e.gettext;function s(e,i,a){var s=e.allowed!==false;t(i).each(function(){var e="allowed-title";if(typeof t(this).data(e)==="undefined"||t(this).data(e)===false)t(this).data(e,t(this).attr("title")||"");t(this).tooltip({html:true});if(t(this).hasClass("disabled")===s){t(this).toggleClass("disabled",!s).attr("data-original-title",null);if(s)t(this).attr("title",t(this).data(e));else t(this).attr("title",a);t(this).tooltip("fixTitle")}})}var l=e.permission({admin:true});function r(){s(l,".storage-privileged",e.format(i("The user <b>$0</b> is not permitted to manage storage"),e.user.name))}t(l).on("changed",r);return{update:r}});

//# sourceURL=storage/permissions.min.js

define("storage/utils", ["jquery","base1/cockpit","base1/mustache","system/service"],function(e,r,t,a){var n=r.gettext;var o=r.gettext;var i={};var l=r.dbus("org.freedesktop.hostname1").proxy();i.array_find=function s(e,r){for(var t=0;t<e.length;t++)if(r(e[t]))return e[t];return undefined};i.flatten=function u(e){if(e.length>0)return Array.prototype.concat.apply([],e);else return[]};i.decode_filename=function f(e){return r.utf8_decoder().decode(r.base64_decode(e).slice(0,-1))};i.encode_filename=function m(e){return r.base64_encode(r.utf8_encoder().encode(e).concat([0]))};i.fmt_size=function v(e){return r.format_bytes(e,1024)};i.fmt_size_long=function _(e){var t=r.format_bytes(e,1024);var a=r.format_bytes(e,1e3);return t+", "+a+", "+e+" "+o("format-bytes","bytes")};i.fmt_rate=function p(e){return r.format_bytes_per_sec(e,1024)};i.format_temperature=function d(e){var r=e-273.15;var t=9*r/5+32;return r.toFixed(1)+"Â° C / "+t.toFixed(1)+"Â° F"};i.format_fsys_usage=function b(e,t){var a="";var n=1024;var o=r.format_bytes(t,n,true);a=" / "+o.join(" ");n=o[1];o=r.format_bytes(e,n,true);return o[0]+a};i.format_delay=function g(e){var r=Math.round(e/1e3);var t=Math.floor(r/60);var a=Math.floor(t/60);r=r-t*60;t=t-a*60;var n=r+" seconds";if(t>0)n=t+" minutes, "+n;if(a>0)n=a+" hours, "+n;return n};i.validate_lvm2_name=function k(e){if(e==="")return n("Name can not be empty.");if(e.length>127)return n("Name can not be longer than 127 characters.");var t=e.match(/[^a-zA-Z0-9+._-]/);if(t){if(t[0].search(/\s+/)===-1)return r.format(n("Name can not contain the character '$0'."),t[0]);else return r.format(n("Name can not contain whitespace."),t[0])}};i.block_name=function h(e){return i.decode_filename(e.PreferredDevice)};i.mdraid_name=function y(e){if(!e.Name)return"";var t=e.Name.split(":");if(t.length!=2)return e.Name;if(t[0]==l.StaticHostname)return t[1];else return r.format(n("$name (from $host)"),{name:t[1],host:t[0]})};i.lvol_name=function D(e){var r;if(e.Type=="pool")r=n("Pool for Thin Logical Volumes");else if(e.ThinPool!="/")r=n("Thin Logical Volume");else if(e.Origin!="/")r=n("Logical Volume (Snapshot)");else r=n("Logical Volume");return t.render('{{Type}} "{{Name}}"',{Type:r,Name:e.Name})};i.drive_name=function V(e){var r=[];if(e.Vendor)r.push(e.Vendor);if(e.Model)r.push(e.Model);var t=r.join(" ");if(e.Serial)t+=" ("+e.Serial+")";else if(e.WWN)t+=" ("+e.WWN+")";return t};i.get_block_link_target=function N(e,a){var o,l,c;while(true){if(e.blocks_part[a]&&e.blocks_ptable[e.blocks_part[a].Table]){o=true;a=e.blocks_part[a].Table}else if(e.blocks_crypto[a]&&e.blocks[e.blocks_crypto[a].CryptoBackingDevice]){l=true;a=e.blocks_crypto[a].CryptoBackingDevice}else break}if(e.blocks_lvm2[a]&&e.lvols[e.blocks_lvm2[a].LogicalVolume])c=true;function s(e){if(c&&l)return r.format(n("<span>Encrypted Logical Volume of $0</span>"),e);else if(o&&l)return r.format(n("<span>Encrypted Partition of $0</span>"),e);else if(c)return r.format(n("<span>Logical Volume of $0</span>"),e);else if(o)return r.format(n("<span>Partition of $0</span>"),e);else if(l)return r.format(n("<span>Encrypted $0</span>"),e);else return e}var u=e.blocks[a];if(!u)return;var f,m,v;if(e.mdraids[u.MDRaid]){f="mdraid";m=e.mdraids[u.MDRaid].UUID;v=r.format(n("RAID Device $0"),i.mdraid_name(e.mdraids[u.MDRaid]))}else if(e.blocks_lvm2[a]&&e.lvols[e.blocks_lvm2[a].LogicalVolume]&&e.vgroups[e.lvols[e.blocks_lvm2[a].LogicalVolume].VolumeGroup]){f="vgroup";m=e.vgroups[e.lvols[e.blocks_lvm2[a].LogicalVolume].VolumeGroup].Name;v=r.format(n("Volume Group $0"),m)}else{f="block";m=i.block_name(u).replace(/^\/dev\//,"");if(e.drives[u.Drive])v=i.drive_name(e.drives[u.Drive]);else v=i.block_name(u)}return{type:f,target:m,html:s(t.render('<a data-goto-{{type}}="{{target}}">{{name}}</a>',{type:f,target:m,name:v}))}};i.get_free_blockdevs=function L(r){function t(e){var t=r.blocks[e];var a=r.blocks_ptable[e];var n=r.blocks_part[e];var o=r.blocks_pvol[e];function i(){if(!t.IdUsage)return false;if(t.IdType=="LVM2_member"&&(!o||!r.vgroups[o.VolumeGroup]))return false;return true}function l(){if(!r.drives[t.Drive])return false;if(!r.drives_block[t.Drive]){return true}var e=r.drives_multipath_blocks[t.Drive];for(var a=0;a<e.length;a++){if(e[a]==t)return true}return false}return!t.HintIgnore&&t.Size>0&&!i()&&!l()&&!a&&!(n&&n.IsContainer)}function a(t){var a=r.blocks[t];var n=i.get_block_link_target(r,t);var o=e("<div>").html(n.html).text();return{path:t,Name:i.block_name(a),Description:i.fmt_size(a.Size)+" "+o}}return Object.keys(r.blocks).filter(t).sort(i.make_block_path_cmp(r)).map(a)};i.block_cmp=function z(e,r){return e.DeviceNumber-r.DeviceNumber};i.make_block_path_cmp=function(e){return function(r,t){return i.block_cmp(e.blocks[r],e.blocks[t])}};var c;i.get_multipathd_service=function(){if(!c)c=a.proxy("multipathd");return c};i.init_arming_zones=function $(r){r.on("click","button.arm-button",function(){var r=e(this).hasClass("active");e(this).toggleClass("active",!r);e(this).parents(".arming-zone").toggleClass("armed",!r)})};i.reset_arming_zone=function C(e){var r=e.parents(".arming-zone");var t=r.find(".arm-button");t.removeClass("active");r.removeClass("armed")};return i});

//# sourceURL=storage/utils.min.js
