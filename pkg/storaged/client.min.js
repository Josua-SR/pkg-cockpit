define(["jquery","base1/cockpit","storage/utils"],function(e,o,s){var r={};function i(s){var r;var i={data:{},close:t};function l(e){i.data={};r=[];for(var o=0;o<e.metrics.length;o++){r[o]=e.metrics[o].instances;for(var s=0;s<r[o].length;s++)i.data[r[o][s]]=[]}}function a(o){var s=false;for(var l=0;l<o.length;l++){var a=o[l];for(var n=0;n<a.length;n++){var t=a[n];for(var c=0;c<t.length;c++){if(t[c]!==null){s=true;i.data[r[n][c]][n]=t[c]}}}}if(s)e(i).triggerHandler("changed")}var n=o.channel({payload:"metrics1",source:"internal",metrics:s});e(n).on("closed",function(e,o){console.log("closed",o)});e(n).on("message",function(e,o){var s=JSON.parse(o);if(s.length)a(s);else l(s)});function t(){n.close()}return i}var l="org.storaged.Storaged";var a="/org/storaged/Storaged";var n="org.storaged.Storaged";if(false){l="org.freedesktop.UDisks2";a="/org/freedesktop/UDisks2";n="org.freedesktop.UDisks2"}r.time_offset=undefined;r.features=undefined;r.storaged_client=o.dbus(l);function t(e,o){return r.storaged_client.proxy(n+"."+e,a+"/"+o,{watch:true})}function c(e){return r.storaged_client.proxies(n+"."+e,a,{watch:false})}r.storaged_client.watch({path_namespace:a});r.manager=t("Manager","Manager");r.manager_lvm2=t("Manager.LVM2","Manager");r.manager_iscsi=t("Manager.ISCSI.Initiator","Manager");r.mdraids=c("MDRaid");r.vgroups=c("VolumeGroup");r.lvols=c("LogicalVolume");r.drives=c("Drive");r.drives_ata=c("Drive.Ata");r.blocks=c("Block");r.blocks_ptable=c("PartitionTable");r.blocks_part=c("Partition");r.blocks_lvm2=c("Block.LVM2");r.blocks_pvol=c("PhysicalVolume");r.blocks_fsys=c("Filesystem");r.blocks_crypto=c("Encrypted");r.iscsi_sessions=c("ISCSI.Session");r.storaged_jobs=c("Job");if(l!="org.freedesktop.UDisks2"){r.udisks_client=o.dbus("org.freedesktop.UDisks2");r.udisks_jobs=r.udisks_client.proxies("org.freedesktop.UDisks2.Job","/org/freedesktop/UDisks2")}else{r.udisks_client=null;r.udisks_jobs={}}r.fsys_sizes=i([{name:"mount.used"},{name:"mount.total"}]);r.blockdev_io=i([{name:"block.device.read",derive:"rate"},{name:"block.device.written",derive:"rate"}]);function d(e){if(e.Symlinks&&e.Symlinks.length){for(var o=0;o<e.Symlinks.length;o++)if(s.decode_filename(e.Symlinks[o]).indexOf("/dev/disk/by-id/dm-uuid-mpath-")===0)return true}return false}function u(){var e,o,i,l,a,n,t,c,u;r.broken_multipath_present=false;r.drives_multipath_blocks={};r.drives_block={};for(e in r.drives){r.drives_multipath_blocks[e]=[]}for(e in r.blocks){o=r.blocks[e];if(!r.blocks_part[e]&&r.drives_multipath_blocks[o.Drive]!==undefined){if(d(o))r.drives_block[o.Drive]=o;else r.drives_multipath_blocks[o.Drive].push(o)}}for(e in r.drives_multipath_blocks){if(!r.drives_block[e]&&r.drives_multipath_blocks[e].length==1){r.drives_block[e]=r.drives_multipath_blocks[e][0];r.drives_multipath_blocks[e]=[]}else{r.drives_multipath_blocks[e].sort(s.block_cmp);if(!r.drives_block[e])r.broken_multipath_present=true}}r.mdraids_block={};for(e in r.blocks){o=r.blocks[e];if(o.MDRaid!="/")r.mdraids_block[o.MDRaid]=o}r.mdraids_members={};for(e in r.mdraids){r.mdraids_members[e]=[]}for(e in r.blocks){o=r.blocks[e];if(r.mdraids_members[o.MDRaidMember]!==undefined)r.mdraids_members[o.MDRaidMember].push(o)}for(e in r.mdraids_members){r.mdraids_members[e].sort(s.block_cmp)}r.slashdevs_block={};function f(e,o){r.slashdevs_block[s.decode_filename(o).replace(/^\/dev\//,"")]=e}for(e in r.blocks){o=r.blocks[e];f(o,o.Device);f(o,o.PreferredDevice);for(u=0;u<o.Symlinks.length;u++)f(o,o.Symlinks[u])}r.uuids_mdraid={};for(e in r.mdraids){l=r.mdraids[e];r.uuids_mdraid[l.UUID]=l}r.vgnames_vgroup={};for(e in r.vgroups){a=r.vgroups[e];r.vgnames_vgroup[a.Name]=a}r.vgroups_pvols={};for(e in r.vgroups){r.vgroups_pvols[e]=[]}for(e in r.blocks_pvol){n=r.blocks_pvol[e];if(r.vgroups_pvols[n.VolumeGroup]!==undefined)r.vgroups_pvols[n.VolumeGroup].push(n)}function _(e,o){return s.block_cmp(r.blocks[e.path],r.blocks[o.path])}for(e in r.vgroups_pvols){r.vgroups_pvols[e].sort(_)}r.vgroups_lvols={};for(e in r.vgroups){r.vgroups_lvols[e]=[]}for(e in r.lvols){t=r.lvols[e];if(r.vgroups_lvols[t.VolumeGroup]!==undefined)r.vgroups_lvols[t.VolumeGroup].push(t)}for(e in r.vgroups_lvols){r.vgroups_lvols[e].sort(function(e,o){return e.Name.localeCompare(o.Name)})}r.lvols_block={};for(e in r.blocks_lvm2){r.lvols_block[r.blocks_lvm2[e].LogicalVolume]=r.blocks[e]}r.lvols_pool_members={};for(e in r.lvols){if(r.lvols[e].Type=="pool")r.lvols_pool_members[e]=[]}for(e in r.lvols){t=r.lvols[e];if(r.lvols_pool_members[t.ThinPool]!==undefined)r.lvols_pool_members[t.ThinPool].push(t)}for(e in r.lvols_pool_members){r.lvols_pool_members[e].sort(function(e,o){return e.Name.localeCompare(o.Name)})}r.blocks_cleartext={};for(e in r.blocks){o=r.blocks[e];if(o.CryptoBackingDevice!="/")r.blocks_cleartext[o.CryptoBackingDevice]=o}r.blocks_partitions={};for(e in r.blocks_ptable){r.blocks_partitions[e]=[]}for(e in r.blocks_part){c=r.blocks_part[e];if(r.blocks_partitions[c.Table]!==undefined)r.blocks_partitions[c.Table].push(c)}for(e in r.blocks_partitions){r.blocks_partitions[e].sort(function(e,o){return e.Offset-o.Offset})}}function f(s){function i(e,o){var s=e.pop();if(s){s.wait(function(){i(e,o)})}else o()}i([r.manager,r.mdraids,r.vgroups,r.drives,r.blocks,r.blocks_ptable,r.blocks_lvm2,r.blocks_fsys],function(){if(!r.manager.valid){r.features=false;s()}else{r.features={lvm2:r.manager_lvm2.valid,iscsi:r.manager_iscsi.valid};e(r.manager_lvm2).on("changed",function(){r.features.lvm2=r.manager_lvm2.valid;e(r.features).triggerHandler("changed")});e(r.manager_iscsi).on("changed",function(){r.features.iscsi=r.manager_iscsi.valid;e(r.features).triggerHandler("changed")});o.spawn(["date","+%s"]).done(function(e){r.time_offset=parseInt(e)*1e3-(new Date).getTime()}).always(function(){r.manager.EnableModules(true).fail(function(e){console.warn("Can't enable storaged modules",e.toString())});e(r.storaged_client).on("notify",function(){u();e(r).triggerHandler("changed")});e(r.udisks_jobs).on("added removed changed",function(){e(r).triggerHandler("changed")});u();s()})}})}r.init=f;return r});
