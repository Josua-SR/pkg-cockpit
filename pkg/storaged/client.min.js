define(["jquery","base1/cockpit","storage/utils"],function(o,e,r){var s={};function l(r){var s;var l={data:{},close:n};function a(o){l.data={};s=[];for(var e=0;e<o.metrics.length;e++){s[e]=o.metrics[e].instances;for(var r=0;r<s[e].length;r++)l.data[s[e][r]]=[]}}function t(e){var r=false;for(var a=0;a<e.length;a++){var t=e[a];for(var i=0;i<t.length;i++){var n=t[i];for(var d=0;d<n.length;d++){if(n[d]!==null){r=true;l.data[s[i][d]][i]=n[d]}}}}if(r)o(l).triggerHandler("changed")}var i=e.channel({payload:"metrics1",source:"internal",metrics:r});o(i).on("closed",function(o,e){console.log("closed",e)});o(i).on("message",function(o,e){var r=JSON.parse(e);if(r.length)t(r);else a(r)});function n(){i.close()}return l}s.time_offset=undefined;s.storaged_features=undefined;s.storaged_client=e.dbus("org.storaged.Storaged");function a(o,e){return s.storaged_client.proxy(o,e,{watch:true})}function t(o){return s.storaged_client.proxies(o,"/org/storaged/Storaged",{watch:false})}s.storaged_client.watch({path_namespace:"/org/storaged/Storaged"});s.manager=a("org.storaged.Storaged.Manager","/org/storaged/Storaged/Manager");s.manager_lvm2=a("org.storaged.Storaged.Manager.LVM2","/org/storaged/Storaged/Manager");s.mdraids=t("org.storaged.Storaged.MDRaid");s.vgroups=t("org.storaged.Storaged.VolumeGroup");s.lvols=t("org.storaged.Storaged.LogicalVolume");s.drives=t("org.storaged.Storaged.Drive");s.drives_ata=t("org.storaged.Storaged.Drive.Ata");s.blocks=t("org.storaged.Storaged.Block");s.blocks_ptable=t("org.storaged.Storaged.PartitionTable");s.blocks_part=t("org.storaged.Storaged.Partition");s.blocks_lvm2=t("org.storaged.Storaged.Block.LVM2");s.blocks_pvol=t("org.storaged.Storaged.PhysicalVolume");s.blocks_fsys=t("org.storaged.Storaged.Filesystem");s.blocks_crypto=t("org.storaged.Storaged.Encrypted");s.storaged_jobs=t("org.storaged.Storaged.Job");s.udisks_client=e.dbus("org.freedesktop.UDisks2");s.udisks_jobs=s.udisks_client.proxies("org.freedesktop.UDisks2.Job","/org/freedesktop/UDisks2");s.fsys_sizes=l([{name:"mount.used"},{name:"mount.total"}]);s.blockdev_io=l([{name:"block.device.read",derive:"rate"},{name:"block.device.written",derive:"rate"}]);function i(o){if(o.Symlinks&&o.Symlinks.length){for(var e=0;e<o.Symlinks.length;e++)if(r.decode_filename(o.Symlinks[e]).indexOf("/dev/disk/by-id/dm-uuid-mpath-")===0)return true}return false}function n(){var o,e,l,a,t,n,d,c,g;s.broken_multipath_present=false;s.drives_multipath_blocks={};s.drives_block={};for(o in s.drives){s.drives_multipath_blocks[o]=[]}for(o in s.blocks){e=s.blocks[o];if(!s.blocks_part[o]&&s.drives_multipath_blocks[e.Drive]!==undefined){if(i(e))s.drives_block[e.Drive]=e;else s.drives_multipath_blocks[e.Drive].push(e)}}for(o in s.drives_multipath_blocks){if(!s.drives_block[o]&&s.drives_multipath_blocks[o].length==1){s.drives_block[o]=s.drives_multipath_blocks[o][0];s.drives_multipath_blocks[o]=[]}else{s.drives_multipath_blocks[o].sort(r.block_cmp);if(!s.drives_block[o])s.broken_multipath_present=true}}s.mdraids_block={};for(o in s.blocks){e=s.blocks[o];if(e.MDRaid!="/")s.mdraids_block[e.MDRaid]=e}s.mdraids_members={};for(o in s.mdraids){s.mdraids_members[o]=[]}for(o in s.blocks){e=s.blocks[o];if(s.mdraids_members[e.MDRaidMember]!==undefined)s.mdraids_members[e.MDRaidMember].push(e)}for(o in s.mdraids_members){s.mdraids_members[o].sort(r.block_cmp)}s.slashdevs_block={};function u(o,e){s.slashdevs_block[r.decode_filename(e).replace(/^\/dev\//,"")]=o}for(o in s.blocks){e=s.blocks[o];u(e,e.Device);u(e,e.PreferredDevice);for(g=0;g<e.Symlinks.length;g++)u(e,e.Symlinks[g])}s.uuids_mdraid={};for(o in s.mdraids){a=s.mdraids[o];s.uuids_mdraid[a.UUID]=a}s.vgnames_vgroup={};for(o in s.vgroups){t=s.vgroups[o];s.vgnames_vgroup[t.Name]=t}s.vgroups_pvols={};for(o in s.vgroups){s.vgroups_pvols[o]=[]}for(o in s.blocks_pvol){n=s.blocks_pvol[o];if(s.vgroups_pvols[n.VolumeGroup]!==undefined)s.vgroups_pvols[n.VolumeGroup].push(n)}function m(o,e){return r.block_cmp(s.blocks[o.path],s.blocks[e.path])}for(o in s.vgroups_pvols){s.vgroups_pvols[o].sort(m)}s.vgroups_lvols={};for(o in s.vgroups){s.vgroups_lvols[o]=[]}for(o in s.lvols){d=s.lvols[o];if(s.vgroups_lvols[d.VolumeGroup]!==undefined)s.vgroups_lvols[d.VolumeGroup].push(d)}for(o in s.vgroups_lvols){s.vgroups_lvols[o].sort(function(o,e){return o.Name.localeCompare(e.Name)})}s.lvols_block={};for(o in s.blocks_lvm2){s.lvols_block[s.blocks_lvm2[o].LogicalVolume]=s.blocks[o]}s.lvols_pool_members={};for(o in s.lvols){if(s.lvols[o].Type=="pool")s.lvols_pool_members[o]=[]}for(o in s.lvols){d=s.lvols[o];if(s.lvols_pool_members[d.ThinPool]!==undefined)s.lvols_pool_members[d.ThinPool].push(d)}for(o in s.lvols_pool_members){s.lvols_pool_members[o].sort(function(o,e){return o.Name.localeCompare(e.Name)})}s.blocks_cleartext={};for(o in s.blocks){e=s.blocks[o];if(e.CryptoBackingDevice!="/")s.blocks_cleartext[e.CryptoBackingDevice]=e}s.blocks_partitions={};for(o in s.blocks_ptable){s.blocks_partitions[o]=[]}for(o in s.blocks_part){c=s.blocks_part[o];if(s.blocks_partitions[c.Table]!==undefined)s.blocks_partitions[c.Table].push(c)}for(o in s.blocks_partitions){s.blocks_partitions[o].sort(function(o,e){return o.Offset-e.Offset})}}function d(r){function l(o,e){var r=o.pop();if(r){r.wait(function(){l(o,e)})}else e()}l([s.manager,s.mdraids,s.vgroups,s.drives,s.blocks,s.blocks_ptable,s.blocks_lvm2,s.blocks_fsys],function(){if(!s.manager.valid){s.features=false;r()}else{s.features={lvm2:s.manager_lvm2.valid};o(s.manager_lvm2).on("changed",function(){s.features.lvm2=s.manager_lvm2.valid;o(s.features).triggerHandler("changed")});e.spawn(["date","+%s"]).done(function(o){s.time_offset=parseInt(o)*1e3-(new Date).getTime()}).always(function(){s.manager.EnableModules(true).fail(function(o){console.warn("Can't enable storaged modules",o.toString())});o(s.storaged_client).on("notify",function(){n();o(s).triggerHandler("changed")});o(s.udisks_jobs).on("added removed changed",function(){o(s).triggerHandler("changed")});n();r()})}})}s.init=d;return s});
