var phantom_checkpoint=phantom_checkpoint||function(){};define(["jquery","base1/cockpit","manifests"],function(e,t,n){"use strict";var o=window.location.pathname.indexOf(".html")!==-1;var r=t.gettext;function i(t){var n=this;var o={};function r(t){e(t.contentWindow).off();e(t).remove()}n.remove=function a(t){var n=t.address;if(!n)n="localhost";var i=o[n];if(i){delete o[n];e.each(i,function(e,t){r(t)})}};function i(n,o){var r=false;window.clearTimeout(n.timer);n.timer=null;try{r=e("body",n.contentWindow.document).is(":visible")}catch(a){r=true}if(!o)o=0;o+=1;if(o>50)r=true;if(r){if(n.getAttribute("data-ready")!="1"){n.setAttribute("data-ready","1");if(o>0)t.navigate()}}else{n.timer=window.setTimeout(function(){i(n,o+1)},100)}}n.lookup_component_hash=function(e,t){var n,r,i,a;if(e)n=e.address;if(!n)n="localhost";r=o[n];if(r)i=r[t];if(i){a=i.getAttribute("src");if(a)return a.split("#")[1]}};n.lookup=function s(t,n,a){var s;var c;var f=false;if(t){s=t.connection_string;c=t.address}if(!s)s="localhost";if(!c)c=s;var u=o[c];if(!u)o[c]=u={};var l="cockpit1:"+s+"/"+n;var h=u[n];if(h&&h.getAttribute("name")!=l){r(h);h=null}var d,p;if(!h){d=window.frames[l];if(d)h=d.frameElement;if(h){p=h.getAttribute("src");h.url=p.split("#")[0];u[n]=h}}if(!h){f=true;h=document.createElement("iframe");h.setAttribute("class","container-frame");h.setAttribute("name",l);h.style.display="none";var v=n.split("/");var m,g;if(t)g=t.checksum;if(s==="localhost")m="..";else if(g)m="../../"+g;else m="../../@"+s;h.url=m+"/"+n;if(n.indexOf("/")===-1)h.url+="/index";h.url+=".html"}if(!a)a="/";p=h.url+"#"+a;if(h.getAttribute("src")!=p)h.setAttribute("src",p);if(f){u[n]=h;e("#content").append(h)}i(h);return h}}function a(n){var o=this;var r=0;var i=t.transport.origin;var a={};var s={};t.transport.filter(function(e,t,n){var o,r,s;if(n){if(n.channel!==undefined){for(o in a)a[o].window.postMessage(e,i)}return true}else if(t){s=t.indexOf("!");if(s!==-1){o=t.substring(0,s+1);r=a[o];if(r){r.window.postMessage(e,i);return false}}return true}});function c(e,t){var o=n.current_frame();if(e!==window){if(!o||o.contentWindow!=e)return}var r=t.location||"";if(r[0]!="/")r="/"+r;if(t.host)r="/@"+encodeURIComponent(t.host)+r;n.jump(r)}function f(e){var t;var o=n.current_frame();if(o&&o.contentWindow===e&&e.name&&e.name.indexOf("/shell/shell")===-1){t=e.location.hash;if(t.indexOf("#")===0)t=t.substring(1);if(t==="/")t="";n.jump({hash:t})}}function u(e){var t=s[e.target.defaultView.name];if(t)d(t)}function l(e){var t=s[e.target.name];if(t)f(t.window)}function h(e){var t=s[e.target.contentWindow.name];if(t)f(t.window)}function d(e){var n=e.window;t.kill(null,n.name);var o=n.frameElement;if(o)o.removeEventListener("load",h);n.removeEventListener("unload",u);n.removeEventListener("hashchange",l);delete a[e.channel_seed];delete s[e.name]}function p(e){var o,i=e.name||"";if(i.indexOf("cockpit1:")===0)o=i.substring(9).split("/")[0];if(!i||!o){console.warn("invalid child window name",e,i);return}r+=1;var c=(t.transport.options["channel-seed"]||"undefined:")+r+"!";var d={name:i,window:e,channel_seed:c,default_host:o};a[c]=d;s[i]=d;var p=e.frameElement;p.addEventListener("load",h);e.addEventListener("unload",u);e.addEventListener("hashchange",l);p.setAttribute("data-loaded","1");f(e);phantom_checkpoint();n.navigate();return d}function v(o){if(o.origin!==i)return;var r=o.data;var a=o.source;if(!a||typeof r!=="string")return;var f=s[a.name];if(r.length===0){if(f)d(f);return}if(r[0]=="\n"){var u=JSON.parse(r.substring(1));if(u.command==="init"){if(f)d(f);f=p(a);if(f){var l=e.extend({},t.transport.options,{command:"init",host:f.default_host,"channel-seed":f.channel_seed});a.postMessage("\n"+JSON.stringify(l),i)}}else if(u.command==="jump"){c(a,u);return}else if(u.command==="hint"){if(u.hint=="restart"&&u.host!=t.transport.host)n.expect_restart(u.host);return}else if(u.command=="oops"){n.show_oops();return}else if(u.channel===undefined){return}else if(u.command=="open"){u.group=a.name;r="\n"+JSON.stringify(u)}}if(!f){console.warn("child frame "+a.name+" sending data without init");return}t.transport.inject(r)}o.start=function m(e){window.addEventListener("message",v,false);for(var t=0,n=e.length;t<n;t++)v(e[t])}}function s(){var s=this;var f;if(typeof s.navigate!=="function")throw"Index requires a prototype with a navigate function";s.frames=new i(s);s.router=new a(s);var u=t.channel({payload:"null"});e(u).on("close",function(t,n){var o=n.problem||"disconnected";console.warn("transport closed: "+o);e(s).triggerHandler("disconnect",o)});e(document).on("click","a[href]",function(e){var t=this;if(window.location.host===t.host){s.jump(t.getAttribute("href"));e.preventDefault();phantom_checkpoint()}});if(window.navigator.userAgent.indexOf("PhantomJS")==-1){var l=window.onerror;window.onerror=function x(e,t,n){s.show_oops();phantom_checkpoint();if(l)return l(e,t,n);return false}}function h(e,n){var o=[];if(e.host&&(n||e.host!=="localhost"))o.push("@"+e.host);if(e.component)o.push.apply(o,e.component.split("/"));var r=t.location.encode(o);if(e.hash&&e.hash!=="/")r+="#"+e.hash;return r}function d(e){var n={version:"v1",hash:""};var o=e.indexOf("#");if(o!==-1){n.hash=e.substring(o+1);e=e.substring(0,o)}if(e[0]!="/")e="/"+e;var r=t.location.decode(e);if(r[0]&&r[0][0]=="@"){n.host=r.shift().substring(1);n.sidebar=true}else{n.host="localhost"}if(r.length&&r[r.length-1]=="index")r.pop();n.component=r.join("/");return n}function p(){var t=e("#content-navbar");function r(t){var n=e("<a>").attr("href",s.href({host:"localhost",component:t.path})).text(t.label);return e("<li class='dashboard-link'>").attr("data-component",t.path).append(n)}var i,a={};if(o){t.hide()}else{var f=new c;f.load(n,"dashboard");t.append(f.ordered("dashboard").map(r))}}s.recalculate_layout=function(){var t=e("#topnav");var n=e("#sidebar");var o=e("#content");var r=e(window).height();var i=t.height();var a=r-i;e(f).height(Math.floor(a));n.height(a);var s=n.is(":visible")?n.outerWidth():0;o.css("margin-left",s+"px")};s.retrieve_state=function(){var e=window.history.state;if(!e||e.version!=="v1"){if(o)e=d("/"+window.location.hash);else e=d(window.location.pathname+window.location.hash)}return e};s.jump=function(e,t){if(typeof e==="string")e=d(e);var n=s.retrieve_state();if(!e.host)e.host=n.host||"localhost";if(!("component"in e))e.component=n.component||"";var r;var i=window.history;var a=e.host!==n.host||e.component!==n.component;if(a&&!e.hash){e.hash=s.frames.lookup_component_hash(e.host,e.component)}if(o)r=window.location;else r=h(e);if(t){i.replaceState(e,"",r);return false}if(a||e.hash!==n.hash){i.pushState(e,"",r);s.navigate(e,true);return true}return false};s.href=function(e,t){return h(e,t)};s.show_oops=function(){if(s.oops_sel)e(s.oops_sel).show()};s.current_frame=function(e){if(e!==undefined)f=e;return f};s.start=function(e){s.router.start(e)};s.ready=function(){e(window).on("popstate",function(e){s.navigate(e.state,true)});e(window).on("resize",function(){s.recalculate_layout()});p();s.navigate();e("body").show()};s.expect_restart=function(t){e(s).triggerHandler("expect_restart",t)};function v(t){var n=e(t);if(!n)return;n.children("a").on("click",function(){e("#error-popup-title").text(r("Unexpected error"));var t=r("Cockpit had an unexpected internal error. <br/><br/>")+r("You can try restarting Cockpit by pressing refresh in your browser. ")+r("The javascript console contains details about this error ")+r("(<b>Ctrl-Shift-J</b> in most browsers).");e("#error-popup-message").html(t);e("#error-popup").modal("show")})}function m(n,o){var r=JSON.parse(window.localStorage["os-release"]||"{}");var i,a=e(n)[0];if(a)i=window.getComputedStyle(a);if(!i)return;var s,c=i.content;if(c&&c!="none"&&c!="normal"){s=c.length;if((c[0]==='"'||c[0]==="'")&&s>2&&c[s-1]===c[0])c=c.substr(1,s-2);a.innerHTML=t.format(c,r)||o;return e(a).text()}}function g(n){e(n).on("click",function(){t.logout()})}function w(o){var r=n["shell"]||{};e(".display-language-menu").toggle(!!r.linguas);e.each(r.linguas||{},function(n,o){var r=e("<option>").text(o).val(n);if(n==t.language)r.attr("selected","true");e("#display-language-list").append(r)});e("#display-language-select-button").on("click",function(t){var n=e("#display-language-list").val();window.localStorage.setItem("cockpit.lang",n);window.location.reload(true);return false});e(o).on("shown.bs.modal",function(){e("display-language-list").focus();phantom_checkpoint()})}function _(n){e(t.info).on("changed",function(){e(n).text(t.info.version);phantom_checkpoint()})}function b(n){e(n).on("click",function(){s.jump({host:"localhost",component:"users",hash:"/"+t.user["user"]})})}function y(n){function o(o){var r=t.user["name"]||t.user["user"];if(!r)r=o?"":"???";e(n).text(r);var i=t.user["user"]=="root";var a=t.user["user"]&&!i;e("#deauthorize-item").toggle(a)}e(t.user).on("changed",o);o(true)}if(s.oops_sel)v(s.oops_sel);if(s.logout_sel)g(s.logout_sel);if(s.language_sel)w(s.language_sel);if(s.brand_sel)s.default_title=m(s.brand_sel);if(s.about_sel)_(s.about_sel);if(s.user_sel)y(s.user_sel);if(s.account_sel)b(s.account_sel)}function c(){var n=this;n.items={};n.load=function(o,r){e.each(o||{},function(o,i){e.each(i[r]||{},function(e,i){var a={section:r,label:t.gettext(i.label)||e,order:i.order===undefined?1e3:i.order,wants:i.wants};if(i.path)a.path=i.path.replace(/\.html$/,"");else a.path=o+"/"+e;if(a.path.indexOf("/")===-1)a.path=o+"/"+a.path;if(a.path.slice(-6)=="/index")a.path=a.path.slice(0,-6);n.items[a.path]=a})})};n.ordered=function(e){var t,o=[];for(t in n.items){if(!e||n.items[t].section===e)o.push(n.items[t])}o.sort(function(e,t){return e.order-t.order});return o};n.search=function(e,t){var o;for(o in n.items){if(n.items[o][e]===t)return n.items[o]}}}return{new_index_from_proto:function(e){var t=new Object(e);s.call(t);return t},new_compiled:function(){return new c}}});
