define(["jquery","base1/cockpit","manifests"],function(e,n,o){var t={};var r="/var/lib/cockpit/machines.json";var a="v2-machines.json";function i(){var i=this;var l=null;var s=false;var f={};var c={content:null,tag:null,overlay:{localhost:{visible:true,manifests:o}}};function u(e){if(e.key===a&&e.storageArea===window.sessionStorage)m(JSON.parse(e.newValue))}window.addEventListener("storage",u);window.setTimeout(function(){var e=window.sessionStorage.getItem(a);if(!s&&e)m(JSON.parse(e))});var d=null;function v(n,o,t){var r=e.extend({},o||{},t||{});var a,i;for(a in r){if(n[a]!==r[a])n[a]=r[a]}for(a in n){if(n[a]!==r[a])delete n[a]}return n}function m(n,o){var t=!s;s=true;c=n;l=null;if(o&&!d){d=window.setTimeout(function(){d=null;window.sessionStorage.setItem(a,JSON.stringify(c))},10)}var r,u={};var m=n.content||{};var g=n.overlay||{};for(r in m)u[r]=true;for(r in g)u[r]=true;var y=[];var h;for(r in u){h=v(f[r]||{},m[r],g[r]);h.key=r;if(!h.address)h.address=r;if(!h.label){if(r=="localhost"||r=="localhost.localdomain")h.label=window.location.hostname;else h.label=r}if(!h.avatar)h.avatar="../shell/images/server-small.png";y.push([r in f?"updated":"added",[h,r]]);f[r]=h}for(r in f){if(!(r in u)){h=f[r];delete f[r];y.push(["removed",[h,r]])}}var p,b=e(i),w=y.length;for(p=0;p<w;p++)b.triggerHandler(y[p][0],y[p][1]);if(t)e(i).triggerHandler("ready")}i.add=function h(o,t){var r=e.Deferred();function a(){var e={address:o,visible:true,color:i.unused_color()};i.change(o,e).done(function(){r.resolve(o)}).fail(function(e){r.reject(e)})}if(t){var l=n.file("/var/lib/cockpit/known_hosts");l.modify(function(e){return e+"\n"+t}).done(a).fail(function(e){r.reject(e)}).always(function(){l.close()})}else{a()}return r.promise()};i.unused_color=function p(){var e,n=t.colors.length;for(e=0;e<n;e++){if(!g(t.colors[e]))return t.colors[e]}return"gray"};function g(n){var o,t,r=e.color.parse(n).toString();for(o in f){t=f[o];if(t.color&&e.color.parse(t.color).toString()==r)return true}return false}function y(e,n){for(var o in n){if(n[o]===null)delete e[o];else e[o]=n[o]}}i.change=function b(o,t){var a,l;if(t.label){a=n.dbus("org.freedesktop.hostname1",{host:o});l=a.call("/org/freedesktop/hostname1","org.freedesktop.hostname1","SetPrettyHostname",[t.label,true]).always(function(){a.close()}).fail(function(e){console.warn("couldn't set pretty host name: "+e)})}function s(e){if(!e)e={};var n=e[o];if(!n)n=e[o]={};y(n,t);return e}var f=n.file(r,{syntax:JSON});var u=f.modify(s,c.content,c.tag).done(function(e,n){var r,a={};for(r in t)a[r]=null;i.data(e,n);i.overlay(o,a)}).always(function(){f.close()});if(l)return e.when(l,u);return u};i.data=function w(e,n){m({content:e,tag:n,overlay:c.overlay},true)};i.overlay=function k(n,o){var t={};t[n]=e.extend({},c.overlay[n]||{});y(t[n],o);m({content:c.content,tag:c.tag,overlay:e.extend({},c.overlay,t)},true)};Object.defineProperty(i,"list",{enumerable:true,get:function j(){var e;if(!l){l=[];for(e in f){if(f[e].visible)l.push(f[e])}l.sort(function(e,n){return e.label.localeCompare(n.label)})}return l}});Object.defineProperty(i,"addresses",{enumerable:true,get:function S(){return Object.keys(f)}});i.lookup=function O(e){return f[e||"localhost"]||null};i.close=function x(){window.removeEventListener("storage",u)}}function l(o){var t=this;var a;var i={};var l={};a=n.file(r,{syntax:JSON});a.watch(function(e,n,t){if(t)console.warn("couldn't load machines data: "+t);o.data(e,n)});function s(e,n,t){var r={state:n,problem:t};if(n=="connected")r.restarting=false;else if(t)r.manifests=null;o.overlay(e,r)}e(o).on("added",f);e(o).on("updated",f);e(o).on("removed",c);function f(n,r,a){if(!r){r=o.lookup(a);if(!r)return}var i=l[a];if(!i||!i.valid)i={};var s={};if(!r.color)s.color=o.unused_color();var f=i.PrettyHostname||i.StaticHostname;if(f&&f!==r.label)s.label=f;var c=i.OperatingSystemPrettyName;if(c&&c!=r.os)s.os=i.OperatingSystemPrettyName;if(!e.isEmptyObject(s))o.overlay(a,s);if(r.visible&&(!r.problem||r.restarting))t.connect(a);else if(!r.visible)t.disconnect(a)}function c(e,n,o){t.disconnect(o)}t.connect=function u(r){var a=o.lookup(r);if(!a)return;var c=i[r];if(c)return;c=n.channel({host:r,payload:"echo"});i[r]=c;var u=r==="localhost";var d=null;var v=u;function m(){if(!d&&v)s(r,"connected",null);else s(r,"connecting",null)}var g;if(!a.manifests){if(a.checksum)g="../../"+a.checksum+"/manifests.json";else g="../../@"+a.address+"/manifests.json";d=e.ajax({url:g,dataType:"json",cache:true}).done(function(e){var n={manifests:e};var t=d.getResponseHeader("ETag");if(t)n.checksum=t.replace(/^"(.+)"$/,"$1");o.overlay(r,n)}).fail(function(e){console.warn("failed to load manifests from "+a.address+": "+e)}).always(function(){d=null;m()})}if(!u){c.send("x");e(c).on("message",function(){v=true;m()}).on("close",function(e,n){var a=n.problem||"disconnected";v=false;s(r,"failed",a);var i=o[r];if(i&&i.restarting){window.setTimeout(function(){t.connect(r)},1e4)}t.disconnect(r)})}var y=n.dbus("org.freedesktop.hostname1",{host:r}).proxy();l[r]=y;y.wait(function(){e(y).on("changed",function(){f(null,null,r)});f(null,null,r)});m()};t.disconnect=function d(n){if(n==="localhost")return;var o=i[n];delete i[n];if(o){o.close();e(o).off()}var t=l[n];delete l[n];if(t){t.client.close();e(t).off()}};t.expect_restart=function v(e){o.overlay(e,{restarting:true})};t.close=function m(){e(o).off("added",f);e(o).off("changed",f);e(o).off("removed",c);o=null;if(a)a.close();a=null;var n=Object.keys(i);n.forEach(t.disconnect)}}t.instance=function s(e){return new i};t.loader=function f(e){return new l(e)};t.colors=["#0099d3","#67d300","#d39e00","#d3007c","#00d39f","#00d1d3","#00618a","#4c8a00","#8a6600","#9b005b","#008a55","#008a8a","#00b9ff","#7dff00","#ffbe00","#ff0096","#00ffc0","#00fdff","#023448","#264802","#483602","#590034","#024830","#024848"];return t});
