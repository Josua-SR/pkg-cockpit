define(["jquery","base1/cockpit","manifests"],function(n,e,t){var o={};var r="/var/lib/cockpit/machines.json";var a="/var/lib/cockpit/known_hosts";var i="v2-machines.json";function s(){var s=this;var l=null;var c=false;var f={};var u={content:null,tag:null,overlay:{localhost:{visible:true,manifests:t}}};function d(n){if(n.key===i&&n.storageArea===window.sessionStorage)m(JSON.parse(n.newValue))}window.addEventListener("storage",d);window.setTimeout(function(){var n=window.sessionStorage.getItem(i);if(!c&&n)m(JSON.parse(n))});var v=null;function g(e,t,o){var r=n.extend({},t||{},o||{});var a,i;for(a in r){if(e[a]!==r[a])e[a]=r[a]}for(a in e){if(e[a]!==r[a])delete e[a]}return e}function m(e,t){var o=!c;c=true;u=e;l=null;if(t&&!v){v=window.setTimeout(function(){v=null;window.sessionStorage.setItem(i,JSON.stringify(u))},10)}var r,a={};var d=e.content||{};var m=e.overlay||{};for(r in d)a[r]=true;for(r in m)a[r]=true;var p=[];var h;for(r in a){var y=f[r]||{};var b=y.connection_string;if(d[r]&&d[r].color&&m[r])delete m[r].color;h=g(y,d[r],m[r]);h.key=r;if(!h.address)h.address=r;h.connection_string=s.generate_connection_string(h.user,h.port,h.address);if(!h.label){if(r=="localhost"||r=="localhost.localdomain")h.label=window.location.hostname;else h.label=r}if(!h.avatar)h.avatar="../shell/images/server-small.png";p.push([r in f?"updated":"added",[h,r,b]]);f[r]=h}for(r in f){if(!(r in a)){h=f[r];delete f[r];p.push(["removed",[h,r]])}}var w,_=n(s),k=p.length;for(w=0;w<k;w++)_.triggerHandler(p[w][0],p[w][1]);if(o)n(s).triggerHandler("ready")}s.add_key=function(n){var t=e.file(a,{superuser:"try"});return t.modify(function(e){return e+"\n"+n}).always(function(){t.close()})};s.add=function y(e,t){var o=s.split_connection_string(e);return s.change(o["address"],n.extend({visible:true,color:t||s.unused_color()},o))};s.unused_color=function b(){var n,e=o.colors.length;for(n=0;n<e;n++){if(!p(o.colors[n]))return o.colors[n]}return"gray"};function p(e){var t,o,r=n.color.parse(e).toString();for(t in f){o=f[t];if(o.color&&n.color.parse(o.color).toString()==r)return true}return false}function h(n,e){for(var t in e){if(e[t]===null)delete n[t];else n[t]=e[t]}}s.change=function w(t,o){var a,i;var l=s.lookup(t);if(o.label){var c=t;if(l)c=l.connection_string;if(!l||l.label!==o.label){a=e.dbus("org.freedesktop.hostname1",{host:c});i=a.call("/org/freedesktop/hostname1","org.freedesktop.hostname1","SetPrettyHostname",[o.label,true]).always(function(){a.close()}).fail(function(n){console.warn("couldn't set pretty host name: "+n)})}}function f(n){if(!n)n={};var e=n[t];if(!e)e=n[t]={};h(e,o);return n}var d=e.file(r,{syntax:JSON,superuser:"try"});var v=d.modify(f,u.content,u.tag).done(function(n,e){var r,a={};for(r in o)a[r]=null;s.data(n,e);s.overlay(t,a)}).always(function(){d.close()});if(i)return n.when(i,v);return v};s.data=function _(n,e){m({content:n,tag:e,overlay:u.overlay},true)};s.overlay=function k(e,t){var o={};o[e]=n.extend({},u.overlay[e]||{});h(o[e],t);m({content:u.content,tag:u.tag,overlay:n.extend({},u.overlay,o)},true)};Object.defineProperty(s,"list",{enumerable:true,get:function O(){var n;if(!l){l=[];for(n in f){if(f[n].visible)l.push(f[n])}l.sort(function(n,e){return n.label.localeCompare(e.label)})}return l}});Object.defineProperty(s,"addresses",{enumerable:true,get:function S(){return Object.keys(f)}});s.lookup=function x(n){var e=s.split_connection_string(n);return f[e.address||"localhost"]||null};s.generate_connection_string=function(n,e,t){var o=t;if(n)o=n+"@"+o;if(e)o=o+":"+e;return o};s.split_connection_string=function(n){var e={};var t=-1;var o=-1;if(n){t=n.lastIndexOf("@");o=n.lastIndexOf(":")}if(t>0){e.user=n.substring(0,t);n=n.substring(t+1);o=n.lastIndexOf(":")}if(o>-1){var r=parseInt(n.substring(o+1));if(!isNaN(r)){e.port=r;n=n.substring(0,o)}}e.address=n;return e};s.close=function j(){window.removeEventListener("storage",d)}}function l(t){var o=this;var a;var i={};var s={};a=e.file(r,{syntax:JSON});a.watch(function(n,e,o){if(o)console.warn("couldn't load machines data: "+o);t.data(n,e)});function l(n,e,o){var r={state:e,problem:o};if(e=="connected"){r.restarting=false}else if(o){r.manifests=null;r.checksum=null}t.overlay(n,r)}n(t).on("added",c);n(t).on("updated",c);n(t).on("removed",f);function c(r,a,i,l){if(!a){a=t.lookup(i);if(!a)return}var c=s[i];if(!c||!c.valid)c={};var f={};if(!a.color)f.color=t.unused_color();var u=c.PrettyHostname||c.StaticHostname;if(u&&u!==a.label)f.label=u;var d=c.OperatingSystemPrettyName;if(d&&d!=a.os)f.os=c.OperatingSystemPrettyName;if(!n.isEmptyObject(f))t.overlay(i,f);if(a.visible){if(l&&a.connection_string!=l){e.kill(l);o.disconnect(i);o.connect(i)}else if(!a.problem){o.connect(i)}}else{o.disconnect(i)}}function f(n,e,t){o.disconnect(t)}o.connect=function u(r){var a=t.lookup(r);if(!a)return;var f=i[r];if(f)return;f=e.channel({host:a.connection_string,payload:"echo"});i[r]=f;var u=r==="localhost";var d=null;var v=u;var g=null;function m(){if(!d&&v)l(r,"connected",null);else if(!g)l(r,"connecting",null)}var p;if(!a.manifests){if(a.checksum)p="../../"+a.checksum+"/manifests.json";else p="../../@"+encodeURI(a.connection_string)+"/manifests.json";d=n.ajax({url:p,dataType:"json",cache:true}).done(function(n){var e={manifests:n};var o=d.getResponseHeader("ETag");if(o)e.checksum=o.replace(/^"(.+)"$/,"$1");t.overlay(r,e)}).fail(function(n){console.warn("failed to load manifests from "+a.connection_string+": "+n)}).always(function(){d=null;m()})}if(!u){f.send("x");n(f).on("message",function(){v=true;m()}).on("close",function(n,e){g=e.problem||"disconnected";v=false;l(r,"failed",g);var a=t.lookup(r);if(a&&a.restarting){window.setTimeout(function(){o.connect(r)},1e4)}o.disconnect(r)})}var h=e.dbus("org.freedesktop.hostname1",{host:a.connection_string}).proxy();s[r]=h;h.wait(function(){n(h).on("changed",function(){c(null,null,r)});c(null,null,r)});m()};o.disconnect=function d(e){if(e==="localhost")return;var t=i[e];delete i[e];if(t){t.close();n(t).off()}var o=s[e];delete s[e];if(o){o.client.close();n(o).off()}};o.expect_restart=function v(n){var e=t.split_connection_string(n);t.overlay(e.address,{restarting:true,problem:null})};o.close=function g(){n(t).off("added",c);n(t).off("changed",c);n(t).off("removed",f);t=null;if(a)a.close();a=null;var e=Object.keys(i);e.forEach(o.disconnect)}}o.instance=function c(n){return new s};o.loader=function f(n){return new l(n)};o.colors=["#0099d3","#67d300","#d39e00","#d3007c","#00d39f","#00d1d3","#00618a","#4c8a00","#8a6600","#9b005b","#008a55","#008a8a","#00b9ff","#7dff00","#ffbe00","#ff0096","#00ffc0","#00fdff","#023448","#264802","#483602","#590034","#024830","#024848"];o.known_hosts_path=a;e.transport.wait(function(){var t=e.transport.options.capabilities||[];o.allow_connection_string=n.inArray("connection-string",t)!=-1;o.has_auth_results=n.inArray("auth-method-results",t)!=-1});return o});
