
define("shell/credentials", ["jquery","base1/cockpit","data!shell/ssh-list-private-keys.sh","base1/patterns"],function(e,n,t){"use strict";var a=n.gettext;function i(){var i=this;i.path=n.user["home"]+"/.ssh";i.items={};var r=null;var o=null;var s=null;d();function d(){if(r===null){r=n.channel({payload:"fslist1",path:i.path});e(r).on("close",function(n,t){e(r).off();if(!t.problem||t.problem=="not-found"){r=null}else{console.warn("couldn't watch "+i.path+": "+(t.message||t.problem));r=false}}).on("message",function(e,n){var t=JSON.parse(n);var a=t.path;if(a&&a.indexOf("/")===-1&&a.slice(-4)===".pub"){if(t.event==="present"||t.event==="created"||t.event==="changed"||t.event==="deleted"){window.clearInterval(s);s=window.setTimeout(d,100)}}})}if(o)return;window.clearTimeout(s);s=null;o=n.script(t,[i.path],{err:"message"}).always(function(){o=null;if(!s)s=window.setTimeout(d,5e3)}).done(function(e){l(e)}).fail(function(e){console.warn("failed to list keys in home directory: "+e.message)})}function l(n){var t=n.split("");var a,r={};t[0].trim().split("\n").forEach(function(e){a=f(e,r);if(a)a.loaded=true});t.slice(1).forEach(function(e,n){switch(n%3){case 0:a=f(e,r);break;case 1:if(a){e=e.trim();if(e.slice(-4)===".pub")a.name=e.slice(0,-4);else a.name=e}break;case 2:if(a)c(e,a);break}});i.items=r;e(i).triggerHandler("changed")}function f(e,n){var t=e.trim().split(" ");var a,i,r;if(!isNaN(parseInt(t[0],10))){a=t[2];i="RSA1";r=t.slice(3).join(" ")}else if(t[0].indexOf("ssh-")===0){a=t[1];i=t[0].substring(4).toUpperCase();r=t.slice(2).join(" ")}else{return}var o=n[a];if(!o)o=n[a]={};o.type=i;o.comment=r;o.data=e;return o}function c(e,n){var t=e.trim().split(" ");n.size=parseInt(t[0],10);if(isNaN(n.size))n.size=null;n.fingerprint=t[1]}i.change=function u(t,r,o,s){var d=[/.*Enter old passphrase: $/];var l=[/.*Enter new passphrase.*/,/.*Enter same passphrase again: $/];var f=[/.*failed: passphrase is too short.*/];var c=e.Deferred();var u="";var p=false;var v=a("No such file or directory");var h;if(o!==s){c.reject(new Error(a("The passwords do not match.")));return c.promise()}var m=window.setTimeout(function(){v=a("Prompting via ssh-keygen timed out");g.close("terminated")},10*1e3);var g=n.spawn(["ssh-keygen","-p","-f",t],{pty:true,environ:["LC_ALL=C"],err:"out",directory:i.path}).always(function(){window.clearInterval(m)}).done(function(){c.resolve()}).fail(function(e){if(e.constructor.name=="ProcessError")e=new Error(v);c.reject(e)}).stream(function(e){u+=e;for(h=0;h<d.length;h++){if(d[h].test(u)){u="";v=a("Old password not accepted");g.input(r+"\n",true);return}}for(h=0;h<l.length;h++){if(l[h].test(u)){u="";g.input(o+"\n",true);v=a("Failed to change password");p=true;return}}for(h=0;p&&h<f.length;h++){if(f[h].test(u)){v=a("New password was not accepted");return}}});return c.promise()};i.load=function(t,r){var o=/.*Enter passphrase for .*/;var s=/.*UNPROTECTED PRIVATE KEY FILE.*/;var l=/.*Bad passphrase.*/;var f=e.Deferred();var c="";var u=a("Not a valid private key");var p=window.setTimeout(function(){u=a("Prompting via ssh-add timed out");v.close("terminated")},10*1e3);var v=n.spawn(["ssh-add",t],{pty:true,environ:["LC_ALL=C"],err:"out",directory:i.path}).always(function(){window.clearInterval(p)}).done(function(){d();f.resolve()}).fail(function(e){if(e.constructor.name=="ProcessError")e=new Error(u);f.reject(e)}).stream(function(e){c+=e;if(s.test(c)){u=a("Invalid file permissions");c=""}else if(o.test(c)){c="";u=a("Password not accepted");v.input(r+"\n",true)}else if(l.test(c)){c="";v.input("\n",true)}});return f.promise()};i.unload=function p(e){return n.spawn(["ssh-add","-d",e],{pty:true,err:"message",directory:i.path}).done(d)};i.close=function v(){if(r)r.close();if(o)o.close();window.clearTimeout(s);s=null}}var r;e("#credential-authorize button").on("click",function(t){e("#credential-authorize").remove();n.drop_privileges(false);t.preventDefault()});e("#credentials-dialog").on("click","tr.listing-item, tr.listing-head",function(n){var t,a;if(e(n.target).parents(".listing-actions, ul").length===0){t=e(this).parents("tbody");t.toggleClass("open").removeClass("unlock");t.find(".alert").hide()}}).on("mouseenter",".listing-head",function(n){e(n.target).parents("tbody").find(".listing-head").addClass("highlight")}).on("mouseleave",".listing-head",function(n){e(n.target).parents("tbody").find(".listing-head").removeClass("highlight")}).on("change",".btn-group",function(n){var t=e(this).parents("tbody");var a=t.attr("data-id");var i=r.items[a];if(!i||!i.name)return;var o=e(this).onoff("value");if(o&&!i.loaded){t.addClass("open").addClass("unlock")}else if(!o&&i.loaded){r.unload(i.name).done(function(e){t.removeClass("open")}).fail(function(e){t.addClass("open").removeClass("unlock");t.find(".alert").show().find(".credential-alert").text(e.message)})}}).on("click",".credential-unlock button",function(n){var t=e(this).parents("tbody");var a=t.attr("data-id");var i=r.items[a];if(!i||!i.name)return;t.find("input button").prop("disabled",true);var o=t.find(".credential-password").val();r.load(i.name,o).always(function(e){t.find("input button").prop("disabled",false)}).done(function(e){t.find(".credential-password").val("");t.removeClass("unlock");t.find(".alert").hide()}).fail(function(e){t.find(".alert").show().find("span").text(e.message);console.warn("loading key failed: ",e.message)})}).on("click",".credential-change",function(n){var t=e(this).parents("tbody");var a=t.attr("data-id");var i=r.items[a];if(!i||!i.name)return;t.find("input button").prop("disabled",true);var o=t.find(".credential-old").val();var s=t.find(".credential-new").val();var d=t.find(".credential-two").val();if(o===undefined||s===undefined||d===undefined)throw"invalid password fields";r.change(i.name,o,s,d).always(function(e){t.find("input button").prop("disabled",false)}).done(function(){t.find(".credential-old").val("");t.find(".credential-new").val("");t.find(".credential-two").val("");t.find("li a").first().click()}).fail(function(e){t.find(".alert").show().find("span").text(e.message)})}).on("change keypress","input",function(n){var t,a=e(this).parents("tbody");if(n.type=="keypress"&&n.keyCode==13)e(this).parents("dl").find(".btn-primary").click();a.find(".alert").hide()}).on("click","tr.listing-head ul > li > a",function(){var n=e(this).parent();var t=n.index();n.parent().children().removeClass("active");n.addClass("active");var a=e(this).parents("tbody");a.find(".credential-tab").hide().eq(t).show();a.find(".alert").hide()}).on("click","[data-toggle='popover']",function(){e(this).popover("toggle")}).on("hide.bs.modal",function(){if(r){e(r).off();r.close();r=null}}).on("show.bs.modal",function(){r=new i;e(r).on("changed",function(){var n,t,a,i={};var o=e("#credentials-dialog table.credential-listing");o.find("tbody[data-id]").each(function(n,t){a=e(t);i[a.attr("data-id")]=a});var s=o.find("tbody").first();for(t in r.items){if(!(t in i)){a=i[t]=s.clone();a.attr("data-id",t).show().onoff();o.append(a)}}function d(e,n,t){var a=e.find(n);t=t||"";if(a.text()!==t)a.text(t)}for(t in i){a=i[t];n=r.items[t];if(n){d(a,".credential-label",n.name);d(a,".credential-type",n.type);d(a,".credential-fingerprint",n.fingerprint);d(a,".credential-comment",n.comment);d(a,".credential-data",n.data);a.attr("data-name",n.name).attr("data-loaded",n.loaded?"1":"0").find(".btn-onoff").onoff("value",n.loaded).onoff("disabled",!n.name)}else{a.remove()}}})})});

//# sourceURL=shell/credentials.min.js

var phantom_checkpoint=phantom_checkpoint||function(){};define("shell/index", ["jquery","base1/cockpit","shell/machines","shell/credentials","translated!base1/po","manifests"],function(e,t,n,o,a,i){"use strict";var r={};t.locale(a);var s=t.gettext;var c="Cockpit";var l=window.location.pathname.indexOf(".html")!==-1;var f=null;function d(){if(f)return true;f=e("#navbar-oops");if(!f)return false;f.children("a").on("click",function(){e("#error-popup-title").text(s("Unexpected error"));var t=s("Cockpit had an unexpected internal error. <br/><br/>")+s("You can try restarting Cockpit by pressing refresh in your browser. ")+s("The javascript console contains details about this error ")+s("(<b>Ctrl-Shift-J</b> in most browsers).");e("#error-popup-message").html(t);e("#error-popup").modal("show")});return true}if(window.navigator.userAgent.indexOf("PhantomJS")==-1){var u=window.onerror;window.onerror=function V(e,t,n){if(d())f.show();phantom_checkpoint();if(u)return u(e,t,n);return false}}function h(n){var o=JSON.parse(window.localStorage["os-release"]||"{}");var a,i=e(n)[0];if(i)a=window.getComputedStyle(i);if(!a)return;var r,s=a.content;if(s&&s!="none"){r=s.length;if((s[0]==='"'||s[0]==="'")&&r>2&&s[r-1]===s[0])s=s.substr(1,r-2);i.innerHTML=t.format(s,o)||c;c=e(i).text()}}h("#index-brand");e("#go-logout").on("click",function(){t.logout()});e("#go-account").on("click",function(){A({host:"localhost",component:"users",hash:"/"+t.user["user"]})});function p(n){var o=t.user["name"]||t.user["user"];if(!o)o=n?"":"???";e("#content-user-name").text(o);var a=t.user["user"]=="root";var i=t.user["user"]&&!a;e("#deauthorize-item").toggle(i)}e(t.user).on("changed",p);p(true);var m=i["shell"]||{};e.each(m.linguas,function(n,o){var a=e("<option>").text(o).val(n);if(n==t.language)a.attr("selected","true");e("#display-language-list").append(a)});e("#display-language-select-button").on("click",function(t){var n=e("#display-language-list").val();window.localStorage.setItem("cockpit.lang",n);window.location.reload(true);return false});e("display-language").on("shown.bs.modal",function(){e("display-language-list").focus();phantom_checkpoint()});e(t.info).on("changed",function(){e("#about-version").text(t.info.version);phantom_checkpoint()});var v=null;e("#disconnected-dialog").on("show.bs.modal",function(){t.channel({payload:"null"});e("#disconnected-error").text(t.message(v));phantom_checkpoint()});e("#disconnected-reconnect").on("click",function(){window.sessionStorage.clear();window.location.reload(false)});e("#disconnected-logout").on("click",function(){t.logout();phantom_checkpoint()});var g=t.channel({payload:"null"});e(g).on("close",function(t,n){v=n.problem||"disconnected";console.warn("transport closed: "+v);e('.modal[role="dialog"]').modal("hide");e("#disconnected-dialog").modal("show");phantom_checkpoint()});var w=null;var b=false;var k=n.instance();var y=n.loader(k);var x=new U;r.router=new R;e(k).on("ready",function(t){b=true;e(window).on("popstate",function(e){E(e.state,true)});M();E();e("body").show();phantom_checkpoint()}).on("added updated",function(e,t){if(!t.visible)x.remove(t);if(t.problem)x.remove(t);I();if(b)E()}).on("removed",function(e,t){x.remove(t);I()});e("#machine-link").on("click",function(e){if(k.list.length==1){A({host:k.list[0].address,sidebar:true,component:""});return false}});e(".curtains button").on("click",function(e){E(null,true)});e(document).on("click","a[href]",function(e){var t=this;if(window.location.host===t.host){A(t.getAttribute("href"));e.preventDefault();phantom_checkpoint()}});function _(e,t){return C(e,t)}function C(e,n){var o=[];if(e.host&&(n||e.host!=="localhost"))o.push("@"+e.host);if(e.component)o.push.apply(o,e.component.split("/"));var a=t.location.encode(o);if(e.hash&&e.hash!=="/")a+="#"+e.hash;return a}function O(e){var n={version:"v1",hash:""};var o=e.indexOf("#");if(o!==-1){n.hash=e.substring(o+1);e=e.substring(0,o)}if(e[0]!="/")e="/"+e;var a=t.location.decode(e);if(a[0]&&a[0][0]=="@"){n.host=a.shift().substring(1);n.sidebar=true}else{n.host="localhost"}if(a.length&&a[a.length-1]=="index")a.pop();n.component=a.join("/");return n}function S(){var e=window.history.state;if(!e||e.version!=="v1"){if(l)e=O("/"+window.location.hash);else e=O(window.location.pathname+window.location.hash)}return e}function A(e,t){if(typeof e==="string")e=O(e);var n=S();if(!e.host)e.host=n.host||"localhost";if(!("component"in e))e.component=n.component||"";var o;var a=window.history;if(l)o=window.location;else o=C(e);if(t){a.replaceState(e,"",o);return false}if(e.host!==n.host||e.component!==n.component||e.hash!==n.hash){a.pushState(e,"",o);E(e,true);return true}return false}function E(e,t){var n;if(v)return;if(!e)e=S();n=k.lookup(e.host);if(!n){n={key:e.host,address:e.host,label:e.host,state:"failed",problem:"not-found"}}else if(t&&n.state!=="connected"){y.connect(e.host)}var o=D(n);if(n.manifests&&!e.component)e.component=L(e,o);J(n,e,o);W(n,e,o);T(n,e,o);N();A(e,true)}function L(t,n){var o;if(k.list.length<=1||l)t.sidebar=true;if(!t.sidebar){o=H(n.items,"dashboard")[0];if(o)return o.path}var a=e("#sidebar li.active a").text();if(a){o=P(n.items,"label",a);if(o)return o.path}o=H(n.items,"menu")[0];if(o)return o.path;return"system"}function M(){var t=e("#content-navbar");function n(t){var n=e("<a>").attr("href",_({host:"localhost",component:t.path})).text(t.label);return e("<li class='dashboard-link'>").attr("data-component",t.path).append(n)}var o,a={};if(l){t.hide()}else{z(i,"dashboard",a);t.append(H(a).map(n))}}function J(t,n,o){e(".dashboard-link").each(function(){var t=e(this);t.toggleClass("active",t.attr("data-component")===n.component)});var a=o.items[n.component];if(a&&a.section=="dashboard"){delete n.sidebar;t=null}e("#machine-avatar").attr("src",t&&t.avatar?encodeURI(t.avatar):"../shell/images/server-small.png");var i;if(t){i=t.label}else if(k.list.length==1){i=k.list[0].label}else{i=s("Machines")}e("#machine-link span").text(i);var r;if(k.list.length==1||!t)r="transparent";else r=t.color||"";e("#machine-color").css("border-left-color",r);e("#machine-dropdown").toggleClass("active",!!t);var c=e("#sidebar");if(t&&t.state=="connected")c.show();else c.hide()}function W(t,n,o){function a(o){return e("<li>").toggleClass("active",n.component===o.path).append(e("<a>").attr("href",_({host:t.address,component:o.path})).text(o.label))}var i=H(o.items,"menu").map(a);e("#sidebar-menu").empty().append(i);var r=H(o.items,"tools").map(a);e("#sidebar-tools").empty().append(r)}function j(e,t){if(e)e+=" - ";else e="";var n=c;if(t&&t.label)n=t.label;document.title=e+n}function T(n,o,a){var i,r,c,l;if(n.state!="connected"){e(w).hide();w=null;c=n.state=="connecting";if(n.restarting){i=s("The machine is restarting");r=""}else if(c){i=s("Connecting to the machine");r=""}else{i=s("Couldn't connect to the machine");if(n.problem=="not-found")r=s("Cannot connect to an unknown machine");else r=t.message(n.problem||n.state)}l=!!n.restarting;e(".curtains").show();e(".curtains .spinner").toggle(c||l);e(".curtains button").toggle(!c);e(".curtains i").toggle(!c&&!l);e(".curtains h1").text(i);e(".curtains p").text(r);e("#machine-spinner").hide();j(null,n);if(!c)return}var f=o.hash;var d=o.component;var u;if(n&&a.compat){u=a.compat[d];if(u){d="shell/shell";f=u}}var h;if(d)h=x.lookup(n,d,f);if(h!=w){e(w).css("display","none");w=h;e(h).css("display","block")}var p,m;if(n.state=="connected"){e(".curtains").hide();e("#machine-spinner").toggle(h&&!e(h).attr("data-ready"));m=a.items[o.component];p=m?m.label:"";j(p,n)}phantom_checkpoint()}function I(){e("#machine-dropdown .caret").toggle(k.list.length>1);var t=e("machine-link");if(k.list.length>1)t.attr("data-toggle","dropdown");else t.removeAttr("data-toggle");var n=e("#machine-dropdown ul");var o=k.list.map(function(t){var n=e("<img>").addClass("machine-avatar").attr("src",encodeURI(t.avatar));var o=e("<span>").text(t.label);return e("<li role='presentation'>").css("border-left-color",t.color||"").append(e("<a>").attr("role","menuitem").attr("tabindex","-1").attr("data-address",t.address).attr("href",_({host:t.address},true)).append(n,o))});n.empty().append(o)}function N(){var t=e("#topnav");var n=e("#sidebar");var o=e(window).height();var a=e(window).width();var i=t.height();var r=n.is(":visible")?n.outerWidth():0;var s=o-i;if(w){e(w).height(Math.abs(s)).width(Math.abs(a-r))}n.height(s)}e(window).on("resize",function(){N()});function U(){var t=this;var n={};t.remove=function a(t){var o=t.address;if(!o)o="localhost";var a=n[o];if(a){delete n[o];e.each(a,function(t,n){e(n.contentWindow).off();e(n).remove()})}};function o(t,n){var a=false;window.clearTimeout(t.timer);t.timer=null;try{a=e("body",t.contentWindow.document).is(":visible")}catch(i){a=true}if(!n)n=0;n+=1;if(n>50)a=true;if(a){if(t.getAttribute("data-ready")!="1"){t.setAttribute("data-ready","1");if(n>0)E()}}else{t.timer=window.setTimeout(function(){o(t,n+1)},100)}}t.lookup=function i(t,a,r){var s;if(t)s=t.address;if(!s)s="localhost";var c=n[s];if(!c)n[s]=c={};var l="cockpit1:"+s+"/"+a;var f=c[a];var d=window.frames[l];if(!f&&d){f=d.frameElement;f.url=f.getAttribute("src").split("#")[0];c[a]=f}else if(!f){f=document.createElement("iframe");f.setAttribute("class","container-frame");f.setAttribute("name",l);f.style.display="none";var u=a.split("/");var h,p;if(t)p=t.checksum;if(s==="localhost")h="..";else if(p)h="../../"+p;else h="../../@"+s;f.url=h+"/"+a;if(a.indexOf("/")===-1)f.url+="/index";f.url+=".html";e("#content").append(f);c[a]=f}if(!r)r="/";var m=f.url+"#"+r;if(f.getAttribute("src")!=m)f.setAttribute("src",m);o(f);return f}}function R(){var n=this;var o=0;var a=t.transport.origin;var i={};var r={};t.transport.filter(function(e,t,n){var o,r,s;if(n){if(n.channel!==undefined){for(o in i)i[o].window.postMessage(e,a)}return true}else if(t){s=t.indexOf("!");if(s!==-1){o=t.substring(0,s+1);r=i[o];if(r){r.window.postMessage(e,a);return false}}return true}});function s(e,t){if(e!==window){if(!w||w.contentWindow!=e)return}var n=t.location||"";if(n[0]!="/")n="/"+n;if(t.host)n="/@"+encodeURIComponent(t.host)+n;A(n)}function c(e){var t;if(w&&w.contentWindow===e&&e.name&&e.name.indexOf("/shell/shell")===-1){t=e.location.hash;if(t.indexOf("#")===0)t=t.substring(1);if(t==="/")t="";A({hash:t})}}function l(e){var t=r[e.target.defaultView.name];if(t)p(t)}function u(e){var t=r[e.target.name];if(t)c(t.window)}function h(e){var t=r[e.target.contentWindow.name];if(t)c(t.window)}function p(e){var n=e.window;t.kill(null,n.name);var o=n.frameElement;if(o)o.removeEventListener("load",h);n.removeEventListener("unload",l);n.removeEventListener("hashchange",u);delete i[e.channel_seed];delete r[e.name]}function m(e){var n,a=e.name||"";if(a.indexOf("cockpit1:")===0)n=a.substring(9).split("/")[0];if(!a||!n){console.warn("invalid child window name",e,a);return}o+=1;var s=(t.transport.options["channel-seed"]||"undefined:")+o+"!";var f={name:a,window:e,channel_seed:s,default_host:n};i[s]=f;r[a]=f;var d=e.frameElement;d.addEventListener("load",h);e.addEventListener("unload",l);e.addEventListener("hashchange",u);d.setAttribute("data-loaded","1");c(e);phantom_checkpoint();E();return f}function v(n){if(n.origin!==a)return;var o=n.data;var i=n.source;if(!i||typeof o!=="string")return;var c=r[i.name];if(o.length===0){if(c)p(c);return}if(o[0]=="\n"){var l=JSON.parse(o.substring(1));if(l.command==="init"){if(c)p(c);c=m(i);if(c){var u=e.extend({},t.transport.options,{command:"init",host:c.default_host,"channel-seed":c.channel_seed});i.postMessage("\n"+JSON.stringify(u),a)}}else if(l.command==="jump"){s(i,l);return}else if(l.command==="hint"){if(l.hint=="restart"&&l.host!=t.transport.host){y.expect_restart(l.host);A({host:"localhost",component:""})}return}else if(l.command=="oops"){if(d())f.show();return}else if(l.channel===undefined){return}else if(l.command=="open"){l.group=i.name;o="\n"+JSON.stringify(l)}}if(!c){console.warn("child frame "+i.name+" sending data without init");return}t.transport.inject(o)}n.start=function g(e){window.addEventListener("message",v,false);for(var t=0,n=e.length;t<n;t++)v(e[t])}}function z(n,o,a){e.each(n||{},function(n,i){e.each(i[o]||{},function(e,i){var r={section:o,label:t.gettext(i.label)||e,order:i.order===undefined?1e3:i.order};if(i.path)r.path=i.path.replace(/\.html$/,"");else r.path=n+"/"+e;if(r.path.indexOf("/")===-1)r.path=n+"/"+r.path;if(r.path.slice(-6)=="/index")r.path=r.path.slice(0,-6);a[r.path]=r})})}function q(e){if(!e.manifests||e.address==="localhost")return null;var t=e.manifests["shell"]||{};var n=t["menu"]||{};var o=t["tools"]||{};var a={};if("_host_"in n)a["system/host"]="/server";if("_init_"in n)a["system/init"]="/services";if("_network_"in n)a["network/interfaces"]="/networking";if("_storage_"in n)a["storage/devices"]="/storage";if("_users_"in o)a["users/local"]="/accounts";if("_storage_"in n||"_init_"in n)a["docker/containers"]="/containers";return a}function D(e){var t={items:{},compat:q(e)};z(e.manifests,"tools",t.items);z(e.manifests,"dashboard",t.items);z(e.manifests,"menu",t.items);return t}function H(e,t){var n,o=[];if(!e)e={};for(n in e){if(!t||e[n].section===t)o.push(e[n])}o.sort(function(e,t){return e.order-t.order});return o}function P(e,t,n){var o;for(o in e){if(e[o][t]===n)return e[o]}}return r});

//# sourceURL=shell/index.min.js

define("shell/machines", ["jquery","base1/cockpit","manifests"],function(e,n,o){var t={};var r="/var/lib/cockpit/machines.json";var a="v2-machines.json";function i(){var i=this;var l=null;var s=false;var f={};var c={content:null,tag:null,overlay:{localhost:{visible:true,manifests:o}}};function u(e){if(e.key===a&&e.storageArea===window.sessionStorage)m(JSON.parse(e.newValue))}window.addEventListener("storage",u);window.setTimeout(function(){var e=window.sessionStorage.getItem(a);if(!s&&e)m(JSON.parse(e))});var d=null;function v(n,o,t){var r=e.extend({},o||{},t||{});var a,i;for(a in r){if(n[a]!==r[a])n[a]=r[a]}for(a in n){if(n[a]!==r[a])delete n[a]}return n}function m(n,o){var t=!s;s=true;c=n;l=null;if(o&&!d){d=window.setTimeout(function(){d=null;window.sessionStorage.setItem(a,JSON.stringify(c))},10)}var r,u={};var m=n.content||{};var g=n.overlay||{};for(r in m)u[r]=true;for(r in g)u[r]=true;var y=[];var h;for(r in u){h=v(f[r]||{},m[r],g[r]);h.key=r;if(!h.address)h.address=r;if(!h.label){if(r=="localhost"||r=="localhost.localdomain")h.label=window.location.hostname;else h.label=r}if(!h.avatar)h.avatar="../shell/images/server-small.png";y.push([r in f?"updated":"added",[h,r]]);f[r]=h}for(r in f){if(!(r in u)){h=f[r];delete f[r];y.push(["removed",[h,r]])}}var p,b=e(i),w=y.length;for(p=0;p<w;p++)b.triggerHandler(y[p][0],y[p][1]);if(t)e(i).triggerHandler("ready")}i.add=function h(o,t){var r=e.Deferred();function a(){var e={address:o,visible:true,color:i.unused_color()};i.change(o,e).done(function(){r.resolve(o)}).fail(function(e){r.reject(e)})}if(t){var l=n.file("/var/lib/cockpit/known_hosts");l.modify(function(e){return e+"\n"+t}).done(a).fail(function(e){r.reject(e)}).always(function(){l.close()})}else{a()}return r.promise()};i.unused_color=function p(){var e,n=t.colors.length;for(e=0;e<n;e++){if(!g(t.colors[e]))return t.colors[e]}return"gray"};function g(n){var o,t,r=e.color.parse(n).toString();for(o in f){t=f[o];if(t.color&&e.color.parse(t.color).toString()==r)return true}return false}function y(e,n){for(var o in n){if(n[o]===null)delete e[o];else e[o]=n[o]}}i.change=function b(o,t){var a,l;if(t.label){a=n.dbus("org.freedesktop.hostname1",{host:o});l=a.call("/org/freedesktop/hostname1","org.freedesktop.hostname1","SetPrettyHostname",[t.label,true]).always(function(){a.close()}).fail(function(e){console.warn("couldn't set pretty host name: "+e)})}function s(e){if(!e)e={};var n=e[o];if(!n)n=e[o]={};y(n,t);return e}var f=n.file(r,{syntax:JSON});var u=f.modify(s,c.content,c.tag).done(function(e,n){var r,a={};for(r in t)a[r]=null;i.data(e,n);i.overlay(o,a)}).always(function(){f.close()});if(l)return e.when(l,u);return u};i.data=function w(e,n){m({content:e,tag:n,overlay:c.overlay},true)};i.overlay=function k(n,o){var t={};t[n]=e.extend({},c.overlay[n]||{});y(t[n],o);m({content:c.content,tag:c.tag,overlay:e.extend({},c.overlay,t)},true)};Object.defineProperty(i,"list",{enumerable:true,get:function j(){var e;if(!l){l=[];for(e in f){if(f[e].visible)l.push(f[e])}l.sort(function(e,n){return e.label.localeCompare(n.label)})}return l}});Object.defineProperty(i,"addresses",{enumerable:true,get:function S(){return Object.keys(f)}});i.lookup=function O(e){return f[e||"localhost"]||null};i.close=function x(){window.removeEventListener("storage",u)}}function l(o){var t=this;var a;var i={};var l={};a=n.file(r,{syntax:JSON});a.watch(function(e,n,t){if(t)console.warn("couldn't load machines data: "+t);o.data(e,n)});function s(e,n,t){var r={state:n,problem:t};if(n=="connected")r.restarting=false;else if(t)r.manifests=null;o.overlay(e,r)}e(o).on("added",f);e(o).on("updated",f);e(o).on("removed",c);function f(n,r,a){if(!r){r=o.lookup(a);if(!r)return}var i=l[a];if(!i||!i.valid)i={};var s={};if(!r.color)s.color=o.unused_color();var f=i.PrettyHostname||i.StaticHostname;if(f&&f!==r.label)s.label=f;var c=i.OperatingSystemPrettyName;if(c&&c!=r.os)s.os=i.OperatingSystemPrettyName;if(!e.isEmptyObject(s))o.overlay(a,s);if(r.visible&&(!r.problem||r.restarting))t.connect(a);else if(!r.visible)t.disconnect(a)}function c(e,n,o){t.disconnect(o)}t.connect=function u(r){var a=o.lookup(r);if(!a)return;var c=i[r];if(c)return;c=n.channel({host:r,payload:"echo"});i[r]=c;var u=r==="localhost";var d=null;var v=u;function m(){if(!d&&v)s(r,"connected",null);else s(r,"connecting",null)}var g;if(!a.manifests){if(a.checksum)g="../../"+a.checksum+"/manifests.json";else g="../../@"+a.address+"/manifests.json";d=e.ajax({url:g,dataType:"json",cache:true}).done(function(e){var n={manifests:e};var t=d.getResponseHeader("ETag");if(t)n.checksum=t.replace(/^"(.+)"$/,"$1");o.overlay(r,n)}).fail(function(e){console.warn("failed to load manifests from "+a.address+": "+e)}).always(function(){d=null;m()})}if(!u){c.send("x");e(c).on("message",function(){v=true;m()}).on("close",function(e,n){var a=n.problem||"disconnected";v=false;s(r,"failed",a);var i=o[r];if(i&&i.restarting){window.setTimeout(function(){t.connect(r)},1e4)}t.disconnect(r)})}var y=n.dbus("org.freedesktop.hostname1",{host:r}).proxy();l[r]=y;y.wait(function(){e(y).on("changed",function(){f(null,null,r)});f(null,null,r)});m()};t.disconnect=function d(n){if(n==="localhost")return;var o=i[n];delete i[n];if(o){o.close();e(o).off()}var t=l[n];delete l[n];if(t){t.client.close();e(t).off()}};t.expect_restart=function v(e){o.overlay(e,{restarting:true})};t.close=function m(){e(o).off("added",f);e(o).off("changed",f);e(o).off("removed",c);o=null;if(a)a.close();a=null;var n=Object.keys(i);n.forEach(t.disconnect)}}t.instance=function s(e){return new i};t.loader=function f(e){return new l(e)};t.colors=["#0099d3","#67d300","#d39e00","#d3007c","#00d39f","#00d1d3","#00618a","#4c8a00","#8a6600","#9b005b","#008a55","#008a8a","#00b9ff","#7dff00","#ffbe00","#ff0096","#00ffc0","#00fdff","#023448","#264802","#483602","#590034","#024830","#024848"];return t});

//# sourceURL=shell/machines.min.js

define("shell/ssh-list-private-keys.sh_text", "#!/bin/sh\n\nset -eu\n\n# The first thing we do is list loaded keys\nssh-add -L || true\n\n# Try to list keys in this directory\ncd \"$1\" || exit 0\n\n# After that each .pub file gets its on set of blocks\nfor file in *.pub; do\n    printf \"\\v\"\n    cat \"$file\"\n    printf \"\\v%s\\v\" \"$file\"\n    ssh-keygen -l -f \"$file\" || true\ndone\n");
//# sourceURL=shell/ssh-list-private-keys.sh
