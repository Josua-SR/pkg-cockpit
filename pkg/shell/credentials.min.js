define(["jquery","base1/cockpit","data!shell/ssh-list-private-keys.sh","base1/patterns"],function(e,n,t){"use strict";var a=n.gettext;function i(){var i=this;i.path=n.user["home"]+"/.ssh";i.items={};var r=null;var o=null;var s=null;d();function d(){if(r===null){r=n.channel({payload:"fslist1",path:i.path});e(r).on("close",function(n,t){e(r).off();if(!t.problem||t.problem=="not-found"){r=null}else{console.warn("couldn't watch "+i.path+": "+(t.message||t.problem));r=false}}).on("message",function(e,n){var t=JSON.parse(n);var a=t.path;if(a&&a.indexOf("/")===-1&&a.slice(-4)===".pub"){if(t.event==="present"||t.event==="created"||t.event==="changed"||t.event==="deleted"){window.clearInterval(s);s=window.setTimeout(d,100)}}})}if(o)return;window.clearTimeout(s);s=null;o=n.script(t,[i.path],{err:"message"}).always(function(){o=null;if(!s)s=window.setTimeout(d,5e3)}).done(function(e){l(e)}).fail(function(e){console.warn("failed to list keys in home directory: "+e.message)})}function l(n){var t=n.split("\x0B");var a,r={};t[0].trim().split("\n").forEach(function(e){a=f(e,r);if(a)a.loaded=true});t.slice(1).forEach(function(e,n){switch(n%3){case 0:a=f(e,r);break;case 1:if(a){e=e.trim();if(e.slice(-4)===".pub")a.name=e.slice(0,-4);else a.name=e}break;case 2:if(a)c(e,a);break}});i.items=r;e(i).triggerHandler("changed")}function f(e,n){var t=e.trim().split(" ");var a,i,r;if(!isNaN(parseInt(t[0],10))){a=t[2];i="RSA1";r=t.slice(3).join(" ")}else if(t[0].indexOf("ssh-")===0){a=t[1];i=t[0].substring(4).toUpperCase();r=t.slice(2).join(" ")}else if(t[0].indexOf("ecdsa-")===0){a=t[1];i="ECDSA";r=t.slice(2).join(" ")}else{return}var o=n[a];if(!o)o=n[a]={};o.type=i;o.comment=r;o.data=e;return o}function c(e,n){var t=e.trim().split(" ");n.size=parseInt(t[0],10);if(isNaN(n.size))n.size=null;n.fingerprint=t[1]}i.change=function u(t,r,o,s){var d=[/.*Enter old passphrase: $/];var l=[/.*Enter new passphrase.*/,/.*Enter same passphrase again: $/];var f=[/.*failed: passphrase is too short.*/];var c=e.Deferred();var u="";var p=false;var v=a("No such file or directory");var h;if(o!==s){c.reject(new Error(a("The passwords do not match.")));return c.promise()}var m=window.setTimeout(function(){v=a("Prompting via ssh-keygen timed out");g.close("terminated")},10*1e3);var g=n.spawn(["ssh-keygen","-p","-f",t],{pty:true,environ:["LC_ALL=C"],err:"out",directory:i.path}).always(function(){window.clearInterval(m)}).done(function(){c.resolve()}).fail(function(e){if(e.constructor.name=="ProcessError")e=new Error(v);c.reject(e)}).stream(function(e){u+=e;for(h=0;h<d.length;h++){if(d[h].test(u)){u="";v=a("Old password not accepted");g.input(r+"\n",true);return}}for(h=0;h<l.length;h++){if(l[h].test(u)){u="";g.input(o+"\n",true);v=a("Failed to change password");p=true;return}}for(h=0;p&&h<f.length;h++){if(f[h].test(u)){v=a("New password was not accepted");return}}});return c.promise()};i.load=function(t,r){var o=/.*Enter passphrase for .*/;var s=/.*UNPROTECTED PRIVATE KEY FILE.*/;var l=/.*Bad passphrase.*/;var f=e.Deferred();var c="";var u="";var p=a("Not a valid private key");var v=window.setTimeout(function(){p=a("Prompting via ssh-add timed out");h.close("terminated")},10*1e3);var h=n.spawn(["ssh-add",t],{pty:true,environ:["LC_ALL=C"],err:"out",directory:i.path}).always(function(){window.clearInterval(v)}).done(function(){d();f.resolve()}).fail(function(e){console.log(u);if(e.constructor.name=="ProcessError")e=new Error(p);f.reject(e)}).stream(function(e){c+=e;u+=e;if(s.test(c)){p=a("Invalid file permissions");c=""}else if(o.test(c)){c="";p=a("Password not accepted");h.input(r+"\n",true)}else if(l.test(c)){c="";h.input("\n",true)}});return f.promise()};i.unload=function p(e){return n.spawn(["ssh-add","-d",e],{pty:true,err:"message",directory:i.path}).done(d)};i.close=function v(){if(r)r.close();if(o)o.close();window.clearTimeout(s);s=null}}var r;e("#credential-authorize button").on("click",function(t){e("#credential-authorize").remove();n.drop_privileges(false);t.preventDefault()});e("#credentials-dialog").on("click","tr.listing-item, tr.listing-head",function(n){var t,a;if(e(n.target).parents(".listing-actions, ul").length===0){t=e(this).parents("tbody");t.toggleClass("open").removeClass("unlock");t.find(".alert").hide()}}).on("mouseenter",".listing-head",function(n){e(n.target).parents("tbody").find(".listing-head").addClass("highlight")}).on("mouseleave",".listing-head",function(n){e(n.target).parents("tbody").find(".listing-head").removeClass("highlight")}).on("change",".btn-group",function(n){var t=e(this).parents("tbody");var a=t.attr("data-id");var i=r.items[a];if(!i||!i.name)return;var o=e(this).onoff("value");if(o&&!i.loaded){t.addClass("open").addClass("unlock")}else if(!o&&i.loaded){r.unload(i.name).done(function(e){t.removeClass("open")}).fail(function(e){t.addClass("open").removeClass("unlock");t.find(".alert").show().find(".credential-alert").text(e.message)})}}).on("click",".credential-unlock button",function(n){var t=e(this).parents("tbody");var a=t.attr("data-id");var i=r.items[a];if(!i||!i.name)return;t.find("input button").prop("disabled",true);var o=t.find(".credential-password").val();r.load(i.name,o).always(function(e){t.find("input button").prop("disabled",false)}).done(function(e){t.find(".credential-password").val("");t.removeClass("unlock");t.find(".alert").hide()}).fail(function(e){t.find(".alert").show().find("span").text(e.message);console.warn("loading key failed: ",e.message)})}).on("click",".credential-change",function(n){var t=e(this).parents("tbody");var a=t.attr("data-id");var i=r.items[a];if(!i||!i.name)return;t.find("input button").prop("disabled",true);var o=t.find(".credential-old").val();var s=t.find(".credential-new").val();var d=t.find(".credential-two").val();if(o===undefined||s===undefined||d===undefined)throw"invalid password fields";r.change(i.name,o,s,d).always(function(e){t.find("input button").prop("disabled",false)}).done(function(){t.find(".credential-old").val("");t.find(".credential-new").val("");t.find(".credential-two").val("");t.find("li a").first().click()}).fail(function(e){t.find(".alert").show().find("span").text(e.message)})}).on("change keypress","input",function(n){var t,a=e(this).parents("tbody");if(n.type=="keypress"&&n.keyCode==13)e(this).parents("dl").find(".btn-primary").click();a.find(".alert").hide()}).on("click","tr.listing-head ul > li > a",function(){var n=e(this).parent();var t=n.index();n.parent().children().removeClass("active");n.addClass("active");var a=e(this).parents("tbody");a.find(".credential-tab").hide().eq(t).show();a.find(".alert").hide()}).on("click","[data-toggle='popover']",function(){e(this).popover("toggle")}).on("hide.bs.modal",function(){if(r){e(r).off();r.close();r=null}}).on("show.bs.modal",function(){r=new i;e(r).on("changed",function(){var n,t,a,i={};var o=e("#credentials-dialog table.credential-listing");o.find("tbody[data-id]").each(function(n,t){a=e(t);i[a.attr("data-id")]=a});var s=o.find("tbody").first();for(t in r.items){if(!(t in i)){a=i[t]=s.clone();a.attr("data-id",t).show().onoff();o.append(a)}}function d(e,n,t){var a=e.find(n);t=t||"";if(a.text()!==t)a.text(t)}for(t in i){a=i[t];n=r.items[t];if(n){d(a,".credential-label",n.name);d(a,".credential-type",n.type);d(a,".credential-fingerprint",n.fingerprint);d(a,".credential-comment",n.comment);d(a,".credential-data",n.data);a.attr("data-name",n.name).attr("data-loaded",n.loaded?"1":"0").find(".btn-onoff").onoff("value",n.loaded).onoff("disabled",!n.name)}else{a.remove()}}})});return{keys_instance:function(){return new i}}});
