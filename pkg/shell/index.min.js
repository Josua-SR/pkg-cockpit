var phantom_checkpoint=phantom_checkpoint||function(){};define(["jquery","base1/cockpit","shell/base_index","shell/machines","shell/credentials","translated!base1/po","shell/machine-dialogs"],function(e,t,n,a,o,r,s){"use strict";t.locale(r);var i=t.gettext;var l=window.location.pathname.indexOf(".html")!==-1;var c=a.instance();var d=a.loader(c);var u=n.new_index_from_proto({navigate:function(e,t){return v(e,t)},brand_sel:"#index-brand",logout_sel:"#go-logout",oops_sel:"#navbar-oops",language_sel:"#display-language",about_sel:"#about-version",account_sel:"#go-account",user_sel:"#content-user-name",default_title:"Cockpit"});e(u).on("expect_restart",function(e,t){d.expect_restart(t)});var f=null;e(u).on("disconnect",function(e,t){f=t;p()});var h=false;e("#machine-reconnect").on("click",function(e){if(f){window.sessionStorage.clear();window.location.reload(true)}else{v(null,true)}});e("#troubleshoot-dialog").on("show.bs.modal",function(e){h=true});e("#troubleshoot-dialog").on("hide.bs.modal",function(e){h=false;v(null,true)});var m=false;s.setup_machines(c);e(c).on("ready",function(e){m=true;u.ready()}).on("added updated",function(e,t){if(!t.visible)u.frames.remove(t);else if(t.problem)u.frames.remove(t);x();if(m)v()}).on("removed",function(e,t){u.frames.remove(t);x()});e("#machine-link").on("click",function(e){if(c.list.length==1){u.jump({host:c.list[0].address,sidebar:true,component:""});return false}});function p(){var n=u.current_frame();if(n)e(n).hide();e(".curtains .spinner").toggle(false);e("#machine-reconnect").toggle(true);e("#machine-troubleshoot").toggle(false);e(".curtains i").toggle(true);e(".curtains h1").text(i("Disconnected"));e(".curtains p").text(t.message(f));e(".curtains").show();e("#navbar-dropdown").addClass("disabled");phantom_checkpoint()}function v(e,t){var n;if(f||h)return;if(!e)e=u.retrieve_state();n=c.lookup(e.host);if(!n){n={key:e.host,address:e.host,label:e.host,state:"failed",problem:"not-found"}}else if(!n.visible){n.state="failed";n.problem="not-found"}else if(t&&n.state!=="connected"){d.connect(e.host)}var a=C(n);if(n.manifests&&!e.component)e.component=g(e,a);b(n,e,a);_(n,e,a);k(n,e,a);u.recalculate_layout();u.jump(e,true)}function g(t,n){var a;var o=c.list.length<=1;var r=n.ordered("dashboard");if(l)t.sidebar=true;if(!t.sidebar&&r.length>0){a=r[0];if(a&&(!o||a.wants!=="multiple-machines"))return a.path;else a=null}var s=e("#sidebar li.active a").text();if(s){a=n.search("label",s);if(a)return a.path}a=n.ordered("menu")[0];if(a)return a.path;return"system"}function b(t,n,a){e(".dashboard-link").each(function(){var t=e(this);t.toggleClass("active",t.attr("data-component")===n.component)});var o=a.items[n.component];if(o&&o.section=="dashboard"){delete n.sidebar;t=null}e("#machine-avatar").attr("src",t&&t.avatar?encodeURI(t.avatar):"../shell/images/server-small.png");var r;if(t){r=t.label}else if(c.list.length==1){r=c.list[0].label}else{r=i("Machines")}e("#machine-link span").text(r);var s;if(c.list.length==1||!t)s="transparent";else s=t.color||"";e("#machine-color").css("border-left-color",s);e("#machine-dropdown").toggleClass("active",!!t);var l=e("#sidebar");if(t&&t.state=="connected")l.show();else l.hide()}function _(t,n,a){function o(a){return e("<li>").toggleClass("active",n.component===a.path).append(e("<a>").attr("href",u.href({host:t.address,component:a.path})).text(a.label))}var r=a.ordered("menu").map(o);e("#sidebar-menu").empty().append(r);var s=a.ordered("tools").map(o);e("#sidebar-tools").empty().append(s);e("#tools-panel li.active").parents("#tools-panel").collapse("show")}function w(e,t){if(e)e+=" - ";else e="";var n=u.default_title;if(t&&t.label)n=t.label;document.title=e+n}function k(n,a,o){var r,l,c,d;var f=u.current_frame();if(n.state!="connected"){e(f).hide();f=null;u.current_frame(f);c=n.state=="connecting";if(n.restarting){r=i("The machine is restarting");l=""}else if(c){r=i("Connecting to the machine");l=""}else{r=i("Couldn't connect to the machine");if(n.problem=="not-found"){l=i("Cannot connect to an unknown machine")}else{var h=n.problem||n.state;if(h)l=t.message(h);else l=""}}if(!n.restarting&&s.needs_troubleshoot(n)){e("#machine-troubleshoot").off().on("click",function(){s.troubleshoot("troubleshoot-dialog",n)});e("#machine-troubleshoot").show()}else{e("#machine-troubleshoot").hide()}d=!!n.restarting;e(".curtains").show();e(".curtains .spinner").toggle(c||d);e("#machine-reconnect").toggle(!c&&n.problem!="not-found");e(".curtains i").toggle(!c&&!d);e(".curtains h1").text(r);e(".curtains p").text(l);e("#machine-spinner").hide();w(null,n);if(!c)return}var m=a.hash;var p=a.component;var v;if(n&&o.compat){v=o.compat[p];if(v){p="shell/shell";m=v}}var g;if(p)g=u.frames.lookup(n,p,m);if(g!=f){e(f).css("display","none");u.current_frame(g)}var b,_;if(n.state=="connected"){e(".curtains").hide();e("#machine-spinner").toggle(g&&!e(g).attr("data-ready"));e(g).css("display","block");_=o.items[a.component];b=_?_.label:"";w(b,n)}phantom_checkpoint()}function x(){e("#machine-dropdown .caret").toggle(c.list.length>1);var t=e("machine-link");if(c.list.length>1)t.attr("data-toggle","dropdown");else t.removeAttr("data-toggle");var n=e("#machine-dropdown ul");var a=c.list.map(function(t){var n=e("<img>").addClass("machine-avatar").attr("src",encodeURI(t.avatar));var a=e("<span>").text(t.label);return e("<li role='presentation'>").css("border-left-color",t.color||"").append(e("<a>").attr("role","menuitem").attr("tabindex","-1").attr("data-address",t.address).attr("href",u.href({host:t.address},true)).append(n,a))});n.empty().append(a)}function y(e){if(!e.manifests||e.address==="localhost")return null;var t=e.manifests["shell"]||{};var n=t["menu"]||{};var a=t["tools"]||{};var o={};if("_host_"in n)o["system/host"]="/server";if("_init_"in n)o["system/init"]="/services";if("_network_"in n)o["network/interfaces"]="/networking";if("_storage_"in n)o["storage/devices"]="/storage";if("_users_"in a)o["users/local"]="/accounts";if("_storage_"in n||"_init_"in n)o["docker/containers"]="/containers";return o}function C(e){var t=n.new_compiled();t.load(e.manifests,"tools");t.load(e.manifests,"dashboard");t.load(e.manifests,"menu");t.compat=y(e);return t}return u});
