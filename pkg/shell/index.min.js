var phantom_checkpoint=phantom_checkpoint||function(){};define(["jquery","base1/cockpit","shell/machines","shell/credentials","translated!base1/po","manifests"],function(e,t,n,o,a,i){"use strict";var r={};t.locale(a);var s=t.gettext;var c="Cockpit";var l=window.location.pathname.indexOf(".html")!==-1;var f=null;function d(){if(f)return true;f=e("#navbar-oops");if(!f)return false;f.children("a").on("click",function(){e("#error-popup-title").text(s("Unexpected error"));var t=s("Cockpit had an unexpected internal error. <br/><br/>")+s("You can try restarting Cockpit by pressing refresh in your browser. ")+s("The javascript console contains details about this error ")+s("(<b>Ctrl-Shift-J</b> in most browsers).");e("#error-popup-message").html(t);e("#error-popup").modal("show")});return true}if(window.navigator.userAgent.indexOf("PhantomJS")==-1){var u=window.onerror;window.onerror=function V(e,t,n){if(d())f.show();phantom_checkpoint();if(u)return u(e,t,n);return false}}function h(n){var o=JSON.parse(window.localStorage["os-release"]||"{}");var a,i=e(n)[0];if(i)a=window.getComputedStyle(i);if(!a)return;var r,s=a.content;if(s&&s!="none"){r=s.length;if((s[0]==='"'||s[0]==="'")&&r>2&&s[r-1]===s[0])s=s.substr(1,r-2);i.innerHTML=t.format(s,o)||c;c=e(i).text()}}h("#index-brand");e("#go-logout").on("click",function(){t.logout()});e("#go-account").on("click",function(){A({host:"localhost",component:"users",hash:"/"+t.user["user"]})});function p(n){var o=t.user["name"]||t.user["user"];if(!o)o=n?"":"???";e("#content-user-name").text(o);var a=t.user["user"]=="root";var i=t.user["user"]&&!a;e("#deauthorize-item").toggle(i)}e(t.user).on("changed",p);p(true);var m=i["shell"]||{};e.each(m.linguas,function(n,o){var a=e("<option>").text(o).val(n);if(n==t.language)a.attr("selected","true");e("#display-language-list").append(a)});e("#display-language-select-button").on("click",function(t){var n=e("#display-language-list").val();window.localStorage.setItem("cockpit.lang",n);window.location.reload(true);return false});e("display-language").on("shown.bs.modal",function(){e("display-language-list").focus();phantom_checkpoint()});e(t.info).on("changed",function(){e("#about-version").text(t.info.version);phantom_checkpoint()});var v=null;e("#disconnected-dialog").on("show.bs.modal",function(){t.channel({payload:"null"});e("#disconnected-error").text(t.message(v));phantom_checkpoint()});e("#disconnected-reconnect").on("click",function(){window.sessionStorage.clear();window.location.reload(false)});e("#disconnected-logout").on("click",function(){t.logout();phantom_checkpoint()});var g=t.channel({payload:"null"});e(g).on("close",function(t,n){v=n.problem||"disconnected";console.warn("transport closed: "+v);e('.modal[role="dialog"]').modal("hide");e("#disconnected-dialog").modal("show");phantom_checkpoint()});var w=null;var b=false;var k=n.instance();var y=n.loader(k);var x=new U;r.router=new R;e(k).on("ready",function(t){b=true;e(window).on("popstate",function(e){E(e.state,true)});M();E();e("body").show();phantom_checkpoint()}).on("added updated",function(e,t){if(!t.visible)x.remove(t);if(t.problem)x.remove(t);I();if(b)E()}).on("removed",function(e,t){x.remove(t);I()});e("#machine-link").on("click",function(e){if(k.list.length==1){A({host:k.list[0].address,sidebar:true,component:""});return false}});e(".curtains button").on("click",function(e){E(null,true)});e(document).on("click","a[href]",function(e){var t=this;if(window.location.host===t.host){A(t.getAttribute("href"));e.preventDefault();phantom_checkpoint()}});function _(e,t){return C(e,t)}function C(e,n){var o=[];if(e.host&&(n||e.host!=="localhost"))o.push("@"+e.host);if(e.component)o.push.apply(o,e.component.split("/"));var a=t.location.encode(o);if(e.hash&&e.hash!=="/")a+="#"+e.hash;return a}function O(e){var n={version:"v1",hash:""};var o=e.indexOf("#");if(o!==-1){n.hash=e.substring(o+1);e=e.substring(0,o)}if(e[0]!="/")e="/"+e;var a=t.location.decode(e);if(a[0]&&a[0][0]=="@"){n.host=a.shift().substring(1);n.sidebar=true}else{n.host="localhost"}if(a.length&&a[a.length-1]=="index")a.pop();n.component=a.join("/");return n}function S(){var e=window.history.state;if(!e||e.version!=="v1"){if(l)e=O("/"+window.location.hash);else e=O(window.location.pathname+window.location.hash)}return e}function A(e,t){if(typeof e==="string")e=O(e);var n=S();if(!e.host)e.host=n.host||"localhost";if(!("component"in e))e.component=n.component||"";var o;var a=window.history;if(l)o=window.location;else o=C(e);if(t){a.replaceState(e,"",o);return false}if(e.host!==n.host||e.component!==n.component||e.hash!==n.hash){a.pushState(e,"",o);E(e,true);return true}return false}function E(e,t){var n;if(v)return;if(!e)e=S();n=k.lookup(e.host);if(!n){n={key:e.host,address:e.host,label:e.host,state:"failed",problem:"not-found"}}else if(t&&n.state!=="connected"){y.connect(e.host)}var o=D(n);if(n.manifests&&!e.component)e.component=L(e,o);J(n,e,o);W(n,e,o);T(n,e,o);N();A(e,true)}function L(t,n){var o;if(k.list.length<=1||l)t.sidebar=true;if(!t.sidebar){o=H(n.items,"dashboard")[0];if(o)return o.path}var a=e("#sidebar li.active a").text();if(a){o=P(n.items,"label",a);if(o)return o.path}o=H(n.items,"menu")[0];if(o)return o.path;return"system"}function M(){var t=e("#content-navbar");function n(t){var n=e("<a>").attr("href",_({host:"localhost",component:t.path})).text(t.label);return e("<li class='dashboard-link'>").attr("data-component",t.path).append(n)}var o,a={};if(l){t.hide()}else{z(i,"dashboard",a);t.append(H(a).map(n))}}function J(t,n,o){e(".dashboard-link").each(function(){var t=e(this);t.toggleClass("active",t.attr("data-component")===n.component)});var a=o.items[n.component];if(a&&a.section=="dashboard"){delete n.sidebar;t=null}e("#machine-avatar").attr("src",t&&t.avatar?encodeURI(t.avatar):"../shell/images/server-small.png");var i;if(t){i=t.label}else if(k.list.length==1){i=k.list[0].label}else{i=s("Machines")}e("#machine-link span").text(i);var r;if(k.list.length==1||!t)r="transparent";else r=t.color||"";e("#machine-color").css("border-left-color",r);e("#machine-dropdown").toggleClass("active",!!t);var c=e("#sidebar");if(t&&t.state=="connected")c.show();else c.hide()}function W(t,n,o){function a(o){return e("<li>").toggleClass("active",n.component===o.path).append(e("<a>").attr("href",_({host:t.address,component:o.path})).text(o.label))}var i=H(o.items,"menu").map(a);e("#sidebar-menu").empty().append(i);var r=H(o.items,"tools").map(a);e("#sidebar-tools").empty().append(r)}function j(e,t){if(e)e+=" - ";else e="";var n=c;if(t&&t.label)n=t.label;document.title=e+n}function T(n,o,a){var i,r,c,l;if(n.state!="connected"){e(w).hide();w=null;c=n.state=="connecting";if(n.restarting){i=s("The machine is restarting");r=""}else if(c){i=s("Connecting to the machine");r=""}else{i=s("Couldn't connect to the machine");if(n.problem=="not-found")r=s("Cannot connect to an unknown machine");else r=t.message(n.problem||n.state)}l=!!n.restarting;e(".curtains").show();e(".curtains .spinner").toggle(c||l);e(".curtains button").toggle(!c);e(".curtains i").toggle(!c&&!l);e(".curtains h1").text(i);e(".curtains p").text(r);e("#machine-spinner").hide();j(null,n);if(!c)return}var f=o.hash;var d=o.component;var u;if(n&&a.compat){u=a.compat[d];if(u){d="shell/shell";f=u}}var h;if(d)h=x.lookup(n,d,f);if(h!=w){e(w).css("display","none");w=h;e(h).css("display","block")}var p,m;if(n.state=="connected"){e(".curtains").hide();e("#machine-spinner").toggle(h&&!e(h).attr("data-ready"));m=a.items[o.component];p=m?m.label:"";j(p,n)}phantom_checkpoint()}function I(){e("#machine-dropdown .caret").toggle(k.list.length>1);var t=e("machine-link");if(k.list.length>1)t.attr("data-toggle","dropdown");else t.removeAttr("data-toggle");var n=e("#machine-dropdown ul");var o=k.list.map(function(t){var n=e("<img>").addClass("machine-avatar").attr("src",encodeURI(t.avatar));var o=e("<span>").text(t.label);return e("<li role='presentation'>").css("border-left-color",t.color||"").append(e("<a>").attr("role","menuitem").attr("tabindex","-1").attr("data-address",t.address).attr("href",_({host:t.address},true)).append(n,o))});n.empty().append(o)}function N(){var t=e("#topnav");var n=e("#sidebar");var o=e(window).height();var a=e(window).width();var i=t.height();var r=n.is(":visible")?n.outerWidth():0;var s=o-i;if(w){e(w).height(Math.abs(s)).width(Math.abs(a-r))}n.height(s)}e(window).on("resize",function(){N()});function U(){var t=this;var n={};t.remove=function a(t){var o=t.address;if(!o)o="localhost";var a=n[o];if(a){delete n[o];e.each(a,function(t,n){e(n.contentWindow).off();e(n).remove()})}};function o(t,n){var a=false;window.clearTimeout(t.timer);t.timer=null;try{a=e("body",t.contentWindow.document).is(":visible")}catch(i){a=true}if(!n)n=0;n+=1;if(n>50)a=true;if(a){if(t.getAttribute("data-ready")!="1"){t.setAttribute("data-ready","1");if(n>0)E()}}else{t.timer=window.setTimeout(function(){o(t,n+1)},100)}}t.lookup=function i(t,a,r){var s;if(t)s=t.address;if(!s)s="localhost";var c=n[s];if(!c)n[s]=c={};var l="cockpit1:"+s+"/"+a;var f=c[a];var d=window.frames[l];if(!f&&d){f=d.frameElement;f.url=f.getAttribute("src").split("#")[0];c[a]=f}else if(!f){f=document.createElement("iframe");f.setAttribute("class","container-frame");f.setAttribute("name",l);f.style.display="none";var u=a.split("/");var h,p;if(t)p=t.checksum;if(s==="localhost")h="..";else if(p)h="../../"+p;else h="../../@"+s;f.url=h+"/"+a;if(a.indexOf("/")===-1)f.url+="/index";f.url+=".html";e("#content").append(f);c[a]=f}if(!r)r="/";var m=f.url+"#"+r;if(f.getAttribute("src")!=m)f.setAttribute("src",m);o(f);return f}}function R(){var n=this;var o=0;var a=t.transport.origin;var i={};var r={};t.transport.filter(function(e,t,n){var o,r,s;if(n){if(n.channel!==undefined){for(o in i)i[o].window.postMessage(e,a)}return true}else if(t){s=t.indexOf("!");if(s!==-1){o=t.substring(0,s+1);r=i[o];if(r){r.window.postMessage(e,a);return false}}return true}});function s(e,t){if(e!==window){if(!w||w.contentWindow!=e)return}var n=t.location||"";if(n[0]!="/")n="/"+n;if(t.host)n="/@"+encodeURIComponent(t.host)+n;A(n)}function c(e){var t;if(w&&w.contentWindow===e&&e.name&&e.name.indexOf("/shell/shell")===-1){t=e.location.hash;if(t.indexOf("#")===0)t=t.substring(1);if(t==="/")t="";A({hash:t})}}function l(e){var t=r[e.target.defaultView.name];if(t)p(t)}function u(e){var t=r[e.target.name];if(t)c(t.window)}function h(e){var t=r[e.target.contentWindow.name];if(t)c(t.window)}function p(e){var n=e.window;t.kill(null,n.name);var o=n.frameElement;if(o)o.removeEventListener("load",h);n.removeEventListener("unload",l);n.removeEventListener("hashchange",u);delete i[e.channel_seed];delete r[e.name]}function m(e){var n,a=e.name||"";if(a.indexOf("cockpit1:")===0)n=a.substring(9).split("/")[0];if(!a||!n){console.warn("invalid child window name",e,a);return}o+=1;var s=(t.transport.options["channel-seed"]||"undefined:")+o+"!";var f={name:a,window:e,channel_seed:s,default_host:n};i[s]=f;r[a]=f;var d=e.frameElement;d.addEventListener("load",h);e.addEventListener("unload",l);e.addEventListener("hashchange",u);d.setAttribute("data-loaded","1");c(e);phantom_checkpoint();E();return f}function v(n){if(n.origin!==a)return;var o=n.data;var i=n.source;if(!i||typeof o!=="string")return;var c=r[i.name];if(o.length===0){if(c)p(c);return}if(o[0]=="\n"){var l=JSON.parse(o.substring(1));if(l.command==="init"){if(c)p(c);c=m(i);if(c){var u=e.extend({},t.transport.options,{command:"init",host:c.default_host,"channel-seed":c.channel_seed});i.postMessage("\n"+JSON.stringify(u),a)}}else if(l.command==="jump"){s(i,l);return}else if(l.command==="hint"){if(l.hint=="restart"&&l.host!=t.transport.host){y.expect_restart(l.host);A({host:"localhost",component:""})}return}else if(l.command=="oops"){if(d())f.show();return}else if(l.channel===undefined){return}else if(l.command=="open"){l.group=i.name;o="\n"+JSON.stringify(l)}}if(!c){console.warn("child frame "+i.name+" sending data without init");return}t.transport.inject(o)}n.start=function g(e){window.addEventListener("message",v,false);for(var t=0,n=e.length;t<n;t++)v(e[t])}}function z(n,o,a){e.each(n||{},function(n,i){e.each(i[o]||{},function(e,i){var r={section:o,label:t.gettext(i.label)||e,order:i.order===undefined?1e3:i.order};if(i.path)r.path=i.path.replace(/\.html$/,"");else r.path=n+"/"+e;if(r.path.indexOf("/")===-1)r.path=n+"/"+r.path;if(r.path.slice(-6)=="/index")r.path=r.path.slice(0,-6);a[r.path]=r})})}function q(e){if(!e.manifests||e.address==="localhost")return null;var t=e.manifests["shell"]||{};var n=t["menu"]||{};var o=t["tools"]||{};var a={};if("_host_"in n)a["system/host"]="/server";if("_init_"in n)a["system/init"]="/services";if("_network_"in n)a["network/interfaces"]="/networking";if("_storage_"in n)a["storage/devices"]="/storage";if("_users_"in o)a["users/local"]="/accounts";if("_storage_"in n||"_init_"in n)a["docker/containers"]="/containers";return a}function D(e){var t={items:{},compat:q(e)};z(e.manifests,"tools",t.items);z(e.manifests,"dashboard",t.items);z(e.manifests,"menu",t.items);return t}function H(e,t){var n,o=[];if(!e)e={};for(n in e){if(!t||e[n].section===t)o.push(e[n])}o.sort(function(e,t){return e.order-t.order});return o}function P(e,t,n){var o;for(o in e){if(e[o][t]===n)return e[o]}}return r});
