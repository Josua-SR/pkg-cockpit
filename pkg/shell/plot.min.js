define(["jquery","base1/cockpit","shell/shell"],function(e,t,n){var i=t.gettext;var r=t.gettext;n.plot=function s(n,i,r){var a={};var o={};var s=[];var c=[];var f=null;var u;var l;function d(){if(n.height()===0||n.width()===0)return;if(f===null)f=e.plot(n,c,a);f.setData(c);var t=f.getAxes();t.xaxis.options.min=l.beg*u;t.xaxis.options.max=(l.end-2)*u;if(a.setup_hook)a.setup_hook(f);t.xaxis.show=true;t.xaxis.used=true;t.yaxis.show=true;t.yaxis.used=true;f.setupGrid();f.draw()}var h=false;function v(){if(!h){h=true;window.setTimeout(function(){h=false;d()},0)}}function _(){l.walk()}function m(){l.move(l.beg,l.end)}var g=0;function p(n,i){if(f)f.clearSelection(true);u=Math.ceil(n/1e3)*1e3;var r;if(i!==undefined)r=(new Date).getTime()-i*1e3;else r=0;var a=-Math.ceil((n*1e3+r)/u);var o=-Math.floor(r/u);if(l&&l.interval==u){l.move(a,o)}else{if(l)l.close();l=t.grid(u,a,o);g++;for(var c=0;c<s.length;c++)s[c].reset();g--;b();e(l).on("notify",function(e,t,n){v()})}}function b(){if(g===0)l.sync()}function k(){l.close();for(var t=0;t<s.length;t++)s[t].stop();a={};s=[];c=[];f=null;e(n).empty();e(n).data("flot_data",null)}function x(){if(n.height()===0||n.width()===0)return;if(f)f.resize();v()}function w(e){a=e;f=null}function y(){return a}function M(n,i){var r=null;var a={options:i,move_to_front:_,remove:m};s.push({stop:f,reset:x,hover_hit:w,hover:y});function f(){if(r)r.close()}function d(){c.push(i)}function h(){var e=c.indexOf(i);if(e>=0)c.splice(e,1)}function _(){var e=c.indexOf(i);if(e>=0){c.splice(e,1);c.push(i)}}function m(){f();h();v()}function g(e){return{name:e,units:n.units,derive:n.derive}}var p=[];if(n.direct){p.push({source:"direct",archive_source:"pcp-archive",metrics:n.direct.map(g),instances:n.instances,"omit-instances":n["omit-instances"],host:n.host})}if(n.internal){p.push({source:"internal",metrics:n.internal.map(g),instances:n.instances,"omit-instances":n["omit-instances"],host:n.host})}function k(e){var t,n;if(!e)return 0;if(e.length!==undefined){n=0;for(t=0;t<e.length;t++)n+=k(e[t]);return n}return e}function x(){if(r)r.close();r=t.metrics(u,p);var a=l.add(r,[]);var s=n.factor||1;i.data=l.add(function(e,t,n){for(var i=0;i<n;i++)e[t+i]=[(l.beg+t+i)*u,k(a[t+i])*s]});function c(){if(r.archives&&!o.archives){o.archives=true;e(o).triggerHandler("changed")}}e(r).on("changed",c);c();b()}function w(e,t){return!!(t&&t.series.data==i.data)}function y(t){e(a).triggerHandler("hover",[t])}x();d();return a}function z(n,i){var r=null;var a={add_instance:p,clear_instances:k};s.push({stop:f,reset:v,hover_hit:x,hover:w});function f(){if(r)r.close()}function d(e){return{name:e,units:n.units,derive:n.derive}}var h=[];if(n.direct){h.push({source:"direct",archive_source:"pcp-archive",metrics:[d(n.direct)],metrics_path_names:["a"],instances:n.instances,"omit-instances":n["omit-instances"],host:n.host})}if(n.internal){h.push({source:"internal",metrics:[d(n.internal)],metrics_path_names:["a"],instances:n.instances,"omit-instances":n["omit-instances"],host:n.host})}function v(){if(r)r.close();r=t.metrics(u,h);function n(){if(r.archives&&!o.archives){o.archives=true;e(o).triggerHandler("changed")}}e(r).on("changed",n);n();g++;for(var i in _)_[i].reset();g--;b()}var _={};var m=null;function p(t){if(_[t])return;var a=e.extend({},i);var o=n.factor||1;var s=n.threshold||0;var f;var d=m;function h(){f=l.add(r,["a",t]);a.data=l.add(function(e,t,n){for(var i=0;i<n;i++){var r=(f[t+i]||0)*o;var a=(l.beg+t+i)*u;var c=0;if(d){if(d.data[t+i][1])c=d.data[t+i][1];else c=d.data[t+i][2]}if(Math.abs(r)>s){e[t+i]=[a,c+r,c];if(e[t+i-1]&&e[t+i-1][1]===null)e[t+i-1][1]=e[t+i-1][2]}else{e[t+i]=[a,null,c];if(e[t+i-1]&&e[t+i-1][1]!==null)e[t+i-1][1]=e[t+i-1][2]}}});b()}function v(){l.remove(f);l.remove(a.data);var e=c.indexOf(a);if(e>=0)c.splice(e,1)}m=a;_[t]=a;a.reset=h;a.remove=v;h();c.push(a)}function k(){for(var e in _)_[e].remove();_={};m=null}function x(e,t){var n,i;if(!l)return false;i=Math.round(e.x/u)-l.beg;if(i<0)i=0;for(n in _){var r=_[n].data;if(r[i]&&r[i][1]&&r[i][2]<=e.y&&e.y<=r[i][1])return n}return false}function w(t){e(a).triggerHandler("hover",[t])}v();return a}var D=null;var $=false;function F(e,t){if(D!=e){if(D)D.hover(false);D=e;$=t;if(D)D.hover($)}else if($!=t){$=t;if(D)D.hover($)}}function S(e,t,n){var i=null;var r=false;for(var a=0;a<s.length;a++){r=s[a].hover_hit(t,n);if(r){i=s[a];break}}F(i,r)}function H(e){F(null,false)}function C(t,n){if(n)e(o).triggerHandler("zoomstart",[])}function T(t,n){f.clearSelection(true);e(o).triggerHandler("zoom",[(n.xaxis.to-n.xaxis.from)/1e3,n.xaxis.to/1e3])}e(n).on("plothover",S);e(n).on("mouseleave",H);e(n).on("plotselecting",C);e(n).on("plotselected",T);e(n).data("flot_data",c);p(i,r);e.extend(o,{archives:false,start_walking:_,stop_walking:m,refresh:v,reset:p,destroy:k,resize:x,set_options:w,get_options:y,add_metrics_sum_series:M,add_metrics_stacked_instances_series:z});return o};var a=["#006bb4","#008ff0","#2daaff","#69c2ff","#a5daff","#e1f3ff","#00243c","#004778"];n.plot_simple_template=function c(){return{colors:a,legend:{show:false},series:{shadowSize:0,lines:{lineWidth:2,fill:.4}},xaxis:{tickLength:0,mode:"time",tickFormatter:n.format_date_tick,minTickSize:[1,"minute"],reserveSpace:false},yaxis:{tickColor:"#d1d1d1",min:0},points:{radius:0},grid:{borderWidth:1,aboveData:false,color:"black",borderColor:e.color.parse("black").scale("a",.22).toString(),labelMargin:0}}};n.memory_ticks=function f(e){var t=Math.pow(2,Math.ceil(Math.log(e.max/5)/Math.LN2));var n=[];for(var i=0;i<e.max;i+=t)n.push(i);return n};var o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];n.format_date_tick=function u(e,t){function n(e){var t=e.toFixed();if(t.length==1)t="0"+t;return t}var i=0;var a=1;var s=2;var c=3;var f;var u;var l=t.tickSize[1];if(l=="minute"||l=="hour")u=c;else if(l=="day")u=s;else if(l=="month")u=a;else u=i;var d=new Date;var h=new Date(t.min);f=i;if(h.getFullYear()==d.getFullYear()){f=a;if(h.getMonth()==d.getMonth()){f=s;if(h.getDate()==d.getDate())f=c}}if(f>u)f=u;if(f==s)f=a;var v=new Date(e);var _=" ";if(i>=f&&i<=u)_+=v.getFullYear().toFixed()+" ";if(a>=f&&a<=u)_+=r("month-name",o[v.getMonth()])+" ";if(s>=f&&s<=u)_+=v.getDate().toFixed()+" ";if(c>=f&&c<=u)_+=n(v.getHours())+":"+n(v.getMinutes())+" ";return _.substr(0,_.length-1)};n.bytes_tick_unit=function l(e){return t.format_bytes(e.max,1024,true)[1]};n.format_bytes_tick_no_unit=function d(e,i){return t.format_bytes(e,n.bytes_tick_unit(i),true)[0]};n.format_bytes_tick=function h(e,n){return t.format_bytes(e,1024)};n.bytes_per_sec_tick_unit=function v(e){return t.format_bytes_per_sec(e.max,1024,true)[1]};n.format_bytes_per_sec_tick_no_unit=function _(e,i){return t.format_bytes_per_sec(e,n.bytes_per_sec_tick_unit(i),true)[0]};n.format_bytes_per_sec_tick=function m(e,n){return t.format_bytes_per_sec(e,1024)};n.bits_per_sec_tick_unit=function g(e){return t.format_bits_per_sec(e.max*8,1e3,true)[1]};n.format_bits_per_sec_tick_no_unit=function p(e,i){return t.format_bits_per_sec(e*8,n.bits_per_sec_tick_unit(i),true)[0]};n.format_bits_per_sec_tick=function b(e,n){return t.format_bits_per_sec(e*8,1e3)};n.setup_plot_controls=function k(n,i,r){var a=5*60;var o=[5*60,60*60,6*60*60,24*60*60,7*24*60*60,30*24*60*60,365*24*60*60];var s=5*60;var c;var f=[];i.find("[data-range]").click(function(){f=[];s=parseInt(e(this).attr("data-range"),10);m()});i.find('[data-action="goto-now"]').click(function(){c=undefined;m()});i.find('[data-action="scroll-left"]').click(function(){var e=s/10;if(c===undefined)c=(new Date).getTime()/1e3;c-=e;m()});i.find('[data-action="scroll-right"]').click(function(){var e=s/10;if(c!==undefined){c+=e;m()}});i.find('[data-action="zoom-out"]').click(function(){d()});function u(){if(c===undefined){r.forEach(function(e){e.stop_walking()});c=(new Date).getTime()/1e3;v()}}function l(e,t){f.push(s);s=e;c=t;m()}function d(){var e=f.pop();if(e===undefined){var t;for(t=0;t<o.length-1;t++){if(o[t]>s)break}e=o[t]}if(c!==undefined)c+=(e-s)/2;s=e;m()}function h(e){function n(e,n,i){return t.format(t.ngettext(e,n,i),i)}if(e>=365*24*60*60)return n("$0 year","$0 years",Math.ceil(e/(365*24*60*60)));else if(e>=30*24*60*60)return n("$0 month","$0 months",Math.ceil(e/(30*24*60*60)));else if(e>=7*24*60*60)return n("$0 week","$0 weeks",Math.ceil(e/(7*24*60*60)));else if(e>=24*60*60)return n("$0 day","$0 days",Math.ceil(e/(24*60*60)));else if(e>=60*60)return n("$0 hour","$0 hours",Math.ceil(e/(60*60)));else return n("$0 minute","$0 minutes",Math.ceil(e/60))}function v(){i.find('[data-action="scroll-right"]').attr("disabled",c===undefined);i.find('[data-action="zoom-out"]').attr("disabled",s>=o[o.length-1])}function _(){var e;if(n.hasClass("show-zoom-controls")&&s>a){n.addClass("show-zoom-cursor");e="x"}else{n.removeClass("show-zoom-cursor");e=null}r.forEach(function(t){var n=t.get_options();if(!n.selection||n.selection.mode!=e){n.selection={mode:e,color:"#d4edfa"};t.set_options(n);t.refresh()}})}function m(){if(s<a){c+=(a-s)/2;s=a}if(c>=(new Date).getTime()/1e3-10)c=undefined;i.find(".dropdown-toggle span:first-child").text(h(s));r.forEach(function(t){t.stop_walking();t.reset(s,c);t.refresh();if(c===undefined)t.start_walking();function i(){if(t.archives){n.addClass("show-zoom-controls");_()}}e(t).on("changed",i);i()});v();_()}function g(t){if(t===undefined)t=[];r=t;r.forEach(function(t){e(t).on("zoomstart",function(e){u()});e(t).on("zoom",function(e,t,n){l(t,n)})});m()}g(r);return{reset:g}}});
