define(["jquery","base1/cockpit","base1/mustache","shell/machines","shell/credentials","manifests","data!shell/templates/add-machine.html","data!shell/templates/auth-failed.html","data!shell/templates/change-auth.html","data!shell/templates/change-port.html","data!shell/templates/color-picker.html","data!shell/templates/invalid-hostkey.html","data!shell/templates/not-supported.html","data!shell/templates/sync-users.html","data!shell/templates/unknown-hostkey.html","translated!base1/po","base1/patterns","base1/bootstrap-select"],function(e,n,r,t,o,s,a,i,l,c,u,d,f,h,p,v){"use strict";n.locale(v);var m=n.gettext;var g;var _={"no-cockpit":"not-supported","not-supported":"not-supported","protocol-error":"not-supported","authentication-not-supported":"change-auth","authentication-failed":"change-auth","no-forwarding":"change-auth","unknown-hostkey":"unknown-hostkey","invalid-hostkey":"invalid-hostkey","not-found":"add-machine","no-host":"change-port"};function w(t){var o=e("<div>").append(t);o.find('[translatable="yes"]').each(function(r,o){var s=o.outerHTML;var a=n.gettext(o.getAttribute("context"),e(o).text());e(o).removeAttr("translatable").text(a);t.replace(s,o.outerHTML)});r.parse(t);return t}var k={"add-machine":w(a),"auth-failed":w(i),"change-auth":w(l),"change-port":w(c),"color-picker":w(u),"invalid-hostkey":w(d),"not-supported":w(f),"sync-users":w(h),"unknown-hostkey":w(p)};function b(e){var n=g.lookup(e);if(n&&n.address!="localhost")return n.connection_string;return e}function y(t,o){var s=this;s.address=b(o);var a=null;var i=null;var l=null;var c=null;function u(){var e=g.lookup(s.address);var n=g.split_connection_string(s.address).address;if(e&&e.label)n=e.label;return n}function d(e,n){var r=c;if(l===e)return;if(e=="add-machine")c=new T(s);else if(e=="sync-users")c=new F(s);else if(e=="unknown-hostkey")c=new S(s,e);else if(e=="invalid-hostkey")c=new S(s,e);else if(e=="change-auth")c=new A(s);else if(e=="change-port")c=new I(s);else c=new O(s);l=e;c.load(n);if(r&&r.close)r.close();r=null}s.get_sel=function(n){var r=t;if(n)r=r+" "+n;return e(r)};s.set_on_success=function(e){i=e};s.set_goal=function(e){a=e};s.complete=function(n){if(i)i(n);else e(t).modal("hide")};s.render=function f(n,t){if(!t)t=l;var o=g.split_connection_string(s.address);var a=e.extend({host:u(),full_address:s.address,context_title:s.context_title,strong:function(){return function(e,n){return"<strong>"+n(e)+"</strong>"}}},n,o);var i=r.render(k[t],a);s.get_sel(".modal-content").html(i)};s.render_error=function h(r){var o;if(r.problem&&r.command=="close")o=_[r.problem];if(o&&l!==o)d(o,r);else e(t).dialog("failure",n.message(r))};s.render_template=function p(e){d(e)};s.show=function(){var e=s.get_sel();e.on("hide.bs.modal",function(){s.get_sel(".model-content").empty()});e.modal("show")};s.run=function(n,r){var t=e.Deferred();var o=[];function i(e){o[e]().done(function(n){e=e+1;if(e<o.length){i(e)}else{t.resolve();s.complete(n)}}).fail(function(e){if(r)r(e);else s.render_error(e);t.reject(e)})}o.push(function(){return n});s.get_sel().dialog("wait",t.promise());if(a)o.push(a);i(0)}}function x(r,t){var o=e.Deferred();var s=e.extend({payload:"echo",host:r},t);var a=n.channel(s);a.send("x");e(a).on("message",function(){e(a).off();a.close();o.resolve()}).on("close",function(e,n){o.reject(n)});return o.promise()}function j(e,n){var r=e[n];return r?r!="no-server-support":false}function D(e,n){if(j(e,n))return n=="password"||e[n]!="not-provided";return false}function C(){var n=this;var o=[];for(var s=0;s<t.colors.length;s+=6){var a=t.colors.slice(s,s+6);o.push({list:a})}function i(){var n=e(this).css("background-color");e("#host-edit-color").css("background-color",n)}n.render=function(n,t,s){var a;if(t&&!s){a=g.lookup(t);if(a)s=a.color}if(!s)s=g.unused_color();var l=r.render(k["color-picker"],{colors:o,selected_color:s});e(n).html(l);e("#host-edit-color-popover .popover-content .color-cell").click(i);e("#host-edit-color").parent().on("show.bs.dropdown",function(){var n=e("#host-edit-color");var r=e("#host-edit-color-popover");var t=n.position();var o=n.width();var s=n.height();var a=r.width();var i=r.height();var l=t.top-i+10;if(l<0){l=t.top+s+10;r.addClass("bottom");r.removeClass("top")}else{r.addClass("top");r.removeClass("bottom")}r.css("left",t.left+(o-a)/2);r.css("top",l);r.show()}).on("hide.bs.dropdown",function(){e("#host-edit-color-popover").hide()})}}var E=new C;function O(e){var n=this;n.load=function(){e.render()}}function T(r){var o=this;var a=null;var i=r.get_sel();var l=null;var c=g.addresses.filter(function(e){var n=g.lookup(e);return!n||!n.visible});function u(e){var n=null;var r=g.lookup(e);if(r&&r.visible){n=new Error(m("This machine has already been added."));n.target="#add-machine-address"}return n}function d(n){var o=true;var s=null;var a=e("#add-machine-address").val();var c=r.get_sel(".btn-primary");if(a===""){o=true}else if(!t.allow_connection_string&&(a.indexOf("@")>-1||a.indexOf(":")>-1)){s=new Error(m("This version of cockpit-ws does not support connecting to a host with an alternate user or port"))}else if(a.search(/\s+/)===-1){s=u(a);if(!s)o=false}else{s=new Error(m("The IP address or host name cannot contain whitespace."))}if(s)s.target="#add-machine-address";if(l)i.dialog("failure",l,s);else i.dialog("failure",s);c.prop("disabled",o)}function f(){l=null;r.address=e("#add-machine-address").val();a=e.color.parse(e("#host-edit-color").css("background-color")).toString();if(u(r.address))return;r.set_goal(function(){var t=e.Deferred();g.add(r.address,a).done(t.resolve).fail(function(e){var r=n.format(m("Failed to add machine: $0"),n.message(e));t.reject(r)});return t.promise()});r.run(x(r.address),function(e){if(e.problem=="no-host"){e=n.message(e);l=e}r.render_error(e)})}o.load=function(){var n=s["shell"]||{};var t=parseInt(n["machine-limit"],10);if(!t||isNaN(t))t=20;r.render({nearlimit:t*.75<=g.list.length,limit:t,placeholder:m("Enter IP address or host name"),options:c});var o=r.get_sel(".btn-primary");o.on("click",f);e("#add-machine-address").on("keyup",function(e){if(e.which===13){var n=o.prop("disabled");if(!n)f()}});e("#add-machine-address").on("input focus",d);E.render("#add-machine-color-picker",r.address,a);e("#add-machine-address").focus()}}function I(r){var o=this;function s(){var t=e.Deferred();var o=g.split_connection_string(r.address);o.port=e("#edit-machine-port").val();var s=g.generate_connection_string(o.user,o.port,o.address);function a(){r.address=s;g.change(o.address,{port:o.port}).done(t.resolve).fail(function(e){var r=n.format(m("Failed to edit machine: $0"),n.message(e));t.reject(r)})}x(s).done(a).fail(function(e){if(e.problem!="no-host")a();t.reject(e)});r.run(t.promise())}o.load=function(){var e=g.lookup(r.address);if(!e)r.get_sel().modal("hide");r.render({port:e.port,allow_connection_string:t.allow_connection_string});if(t.allow_connection_string)r.get_sel(".btn-primary").on("click",s)}}function S(n,r){var o=this;var s=null;var a=null;var i=r=="unknown-hostkey";function l(){var r=e.Deferred();g.add_key(a).done(function(){x(n.address).done(r.resolve).fail(r.reject)}).fail(r.reject);n.run(r.promise())}function c(){var e=null;var o;if(s){a=s["host-key"];o=s["host-fingerprint"]}n.render({context_title:n.context_title,path:t.known_hosts_path,key:o,key_host:a?a.split(" ")[0]:null});if(!a){e=x(n.address).fail(function(e){if(e.problem!=r){n.render_error(e)}else{s=e;c()}}).done(function(e){n.complete(e)});n.get_sel().dialog("wait",e)}else if(i){n.get_sel(".btn-primary").on("click",l)}}o.load=function(e){s=e;c()}}function A(r){var s=this;var a=null;var i=false;var l=null;var c=null;var u=null;var d=g.lookup(r.address);function f(){var n=[];var t;var o=r.get_sel(".keys");if(o){o.empty();for(var s in u.items){var a=u.items[s];if(a.loaded)o.append(e("<div>").text(a.name))}}}function h(){var t;var o={};var s=e.Deferred();var a=e("#login-custom-user").val();var i=g.split_connection_string(r.address);i.user=a;t=g.generate_connection_string(i.user,i.port,i.address);if(e("#login-type").val()!="stored"){o["password"]=e("#login-custom-password").val();if(!a){o["user"]=n.user.user;o["temp-session"]=false}}x(t,o).done(function(){r.address=t;if(d){g.change(d.address,{user:a}).done(s.resolve).fail(s.reject)}else{s.resolve()}}).fail(s.reject);r.run(s.promise())}function p(){var n=e("#login-type").val()=="stored";e("#login-available").toggle(n);e("#login-diff-password").toggle(!n)}function v(){var o=null;var s="change-auth";if(!t.allow_connection_string||!t.has_auth_results)s="auth-failed";var l=null;var c=null;var u=null;var m=g.split_connection_string(r.address).user;if(!m&&d)m=d.user;if(a&&t.has_auth_results){u={};c={};l=a["auth-method-results"];if(l){i=j(l,"password");for(var _ in l){if(D(l,_)){c[_]=true}}}if(e.isEmptyObject(c))s="auth-failed"}r.render({supported:l,available:c,machine_user:m,user:n.user.user,allows_password:i,"machines.allow_connection_string":t.allow_connection_string,sync_link:function(){return function(e,n){return'<a id="do-sync-users">'+n(e)+"</a>"}}},s);if(l===null&&t.has_auth_results){o=x(r.address).fail(function(e){a=e;v()}).done(function(e){r.complete(e)});r.get_sel().dialog("wait",o)}else if(!e.isEmptyObject(c)){e("#login-type").selectpicker("refresh");e("#login-type").on("change",p);p();r.get_sel(".btn-primary").on("click",h);r.get_sel("a[data-content]").popover();f()}r.get_sel("#do-sync-users").on("click",function(){r.render_template("sync-users")})}s.load=function(n){a=n;u=o.keys_instance();e(u).on("changed",f);v()};s.close=function(n){e(u).off();u.close();u=null}}function F(r){var o=this;var s={};var a=false;var i=false;var l=null;var c={superuser:true};var u=null;function d(){var r=n.dbus(null,{bus:"internal",host:"localhost",superuser:true});e(r).on("close",function(e,n){u=n;p()});var t=r.proxy("cockpit.Setup","/setup");t.wait(function(){if(t.valid){var n={t:"(asas)",v:[[],[]]};t.Transfer("passwd1",n).done(function(e){var n,r,t;var o=e.v[1];for(n=0;n<e.v[0].length;n++){var a=e.v[0][n];r=a.split(":");t=r[0];s[t]={username:t,name:r[4]||t,raw:a,groups:[]}}for(n=0;n<o.length;n++){r=o[n].split(":");t=r[0];var i=r[r.length-1].split(",");for(var l=0;l<i.length;l++){var c=i[l];if(s[c])s[c].groups.push(t)}}}).fail(function(e){u=e}).always(function(n){e(r).off();r.close();p()})}})}function f(){var t=null;var o=e.Deferred();var i=o.promise();r.run(i);r.set_on_success(null);i.always(function(){if(t){e(t).off();t.close()}});var l={bus:"internal"};if(a){l.user=e("#sync-username").val();l.password=e("#sync-password").val()}e.extend(l,c,{host:r.address});t=n.dbus(null,l);e(t).on("close",function(e,r){o.reject(n.message(r))});var u={t:"(asas)",v:[[]]};var d={};r.get_sel("input:checked").each(function(){var n=s[e(this).attr("name")];if(n){u.v[0].push(n.raw);for(var r=0;r<n.groups.length;r++){var t=n.groups[r];if(!d[t])d[t]=[];d[t].push(n.username)}}});u.v.push(Object.keys(d).map(function(e){return e+":::"+d[e].join()}));var f=t.proxy("cockpit.Setup","/setup");f.wait(function(){if(f.valid){f.Commit("passwd1",u).fail(o.reject).done(o.resolve)}})}function h(){var e=r.get_sel("input:checked").length>0;r.get_sel(".btn-primary").toggleClass("disabled",!e)}function p(){function o(){if(this.groups)return this.groups.join(", ")}var c=true;var d=Object.keys(s).sort().map(function(e){return s[e]});if(t.has_auth_results&&l)c=j(l,"password");var p=r.render({needs_auth:a,needs_root:i,users:d,perm_failed:u?n.message(u):null,allows_password:c,formated_groups:o});r.get_sel(".modal-content").html(p);r.get_sel(".btn-primary").on("click",f);r.get_sel("input:checkbox").on("change",function(){var n=e(this).attr("name");s[n].checked=e(this).is(":checked");h()});h()}o.load=function(e){if(e)l=e["auth-method-results"];p();x(r.address,c).fail(function(e){a=true;if(e.problem=="access-denied"){i=true;if(!l&&t.has_auth_results)x(r.address,{user:"1"}).fail(function(e){l=e["auth-method-results"]}).always(p)}else{l=e["auth-method-results"];p()}});d()}}return{setup_machines:function(e){g=e},troubleshoot:function(e,n){var r="#"+e;if(!n||!n.problem)return;var t=_[n.problem];var o=new y(r,n.address);o.render_template(t);o.show()},needs_troubleshoot:function(e){if(!e||!e.problem)return false;return _[e.problem]?true:false},render_dialog:function(e,n,r){var t="#"+n;var o=new y(t,r);o.render_template(e);o.show()},render_color_picker:function(e,n){E.render(e,n)}}});
