define(["jquery","base1/cockpit","base1/mustache","shell/controls","shell/shell","shell/machines","./image-editor","base1/patterns","shell/plot"],function(e,t,s,a,o,r,i){"use strict";var n=t.gettext;var d=t.gettext;e(document).on("click","a[data-address]",function(s){t.jump("/",e(this).attr("data-address"));s.preventDefault()});var l={legend:{show:false},series:{shadowSize:0},xaxis:{tickColor:"#d1d1d1",mode:"time",tickFormatter:o.format_date_tick,minTickSize:[1,"minute"]},points:{radius:0},grid:{borderWidth:1,borderColor:"#e1e6ed",hoverable:true,autoHighlight:false}};var h=[{selector:"#dashboard-plot-0",plot:{direct:["kernel.all.cpu.nice","kernel.all.cpu.user","kernel.all.cpu.sys"],internal:["cpu.basic.nice","cpu.basic.user","cpu.basic.system"],units:"millisec",derive:"rate",factor:.1},options:{yaxis:{tickColor:"#e1e6ed",tickFormatter:function(e){return e+"%"}}},ymax_unit:100},{selector:"#dashboard-plot-1",plot:{direct:["mem.util.used"],internal:["memory.used"],units:"bytes"},options:{yaxis:{ticks:o.memory_ticks,tickColor:"#e1e6ed",tickFormatter:o.format_bytes_tick}},ymax_unit:1e8},{selector:"#dashboard-plot-2",plot:{direct:["network.interface.total.bytes"],internal:["network.all.rx","network.all.tx"],units:"bytes","omit-instances":["lo"],derive:"rate"},options:{yaxis:{tickColor:"#e1e6ed",tickFormatter:o.format_bits_per_sec_tick}},ymax_min:1e5},{selector:"#dashboard-plot-3",plot:{direct:["disk.dev.total_bytes"],internal:["block.device.read","block.device.written"],units:"bytes",derive:"rate"},options:{yaxis:{ticks:o.memory_ticks,tickColor:"#e1e6ed",tickFormatter:o.format_bytes_per_sec_tick}},ymax_min:1e5}];var c;e(function(){c=i(e("#host-edit-avatar"),256,256);e("#host-edit-color").parent().on("show.bs.dropdown",function(){var t=e("#host-edit-color");var s=e("#host-edit-color-popover");var a=t.position();var o=t.width();var r=t.height();var i=s.width();var n=s.height();s.css("left",a.left+(o-i)/2);s.css("top",a.top-n+10);s.show()}).on("hide.bs.dropdown",function(){e("#host-edit-color-popover").hide()})});function _(t,s){var a=t.lookup(s);if(!a)return;var o=e("#host-edit-dialog");e("#host-edit-fail").text("").hide();e("#host-edit-name").val(a.label);e("#host-edit-name").prop("disabled",a.state=="failed");e("#host-edit-color").css("background-color",a.color);e("#host-edit-apply").off("click");e("#host-edit-apply").on("click",function(){o.dialog("failure",null);var s={avatar:c.changed?c.get_data(128,128,"image/png"):null,color:e.color.parse(e("#host-edit-color").css("background-color")).toString(),label:e("#host-edit-name").val()};var r=t.change(a.key,s);o.dialog("promise",r)});e("#host-edit-avatar").off("click");e("#host-edit-avatar").on("click",function(){e("#host-edit-fail").text("").hide();c.select_file().done(function(){e("#host-edit-avatar").off("click");c.changed=true;c.start_cropping()})});o.modal("show");c.stop_cropping();c.load_data(a.avatar||"images/server-large.png").fail(function(){e("#host-edit-fail").text("Can't load image").show()})}var u=t.permission({group:"wheel"});e(u).on("changed",p);function p(){a.update_privileged_ui(u,".servers-privileged",t.format(n("The user <b>$0</b> is not permitted to manage servers"),t.user.name))}f.prototype={_init:function(){this.id="dashboard";this.edit_enabled=false},getTitle:function(){return null},toggle_edit:function(t){var s=this;s.edit_enabled=t;e("#dashboard-enable-edit").toggleClass("active",s.edit_enabled);e(".os").toggleClass("hidden",s.edit_enabled);e("#dashboard-hosts").toggleClass("editable",s.edit_enabled)},setup:function(){var t=this;t.machines=r.instance();function a(t){return e('<div class="color-cell">').css("background-color",t)}var i=[];for(var d=0;d<r.colors.length;d+=6){var c=r.colors.slice(d,d+6);i.push(e("<div>").append(c.map(a)))}e("#host-edit-color-popover .popover-content").append(i);e("#host-edit-color-popover .popover-content .color-cell").click(function(){e("#host-edit-color").css("background-color",e(this).css("background-color"))});var u=0;e("#dashboard-add").click(function(){g(t.machines)});e("#dashboard-enable-edit").click(function(){t.toggle_edit(!t.edit_enabled)});var f=k(e("#dashboard-hosts .list-group"));e(t.machines).on("added.dashboard",f);e(t.machines).on("removed.dashboard",f);e(t.machines).on("updated.dashboard",f);e("#dashboard .nav-tabs li").click(function(){b(parseInt(e(this).data("monitor-id"),10))});function b(t){e("#dashboard .nav-tabs li").removeClass("active");e("#dashboard .nav-tabs li[data-monitor-id="+t+"]").addClass("active");u=t;e(".dashboard-plot").hide();e(h[t].selector).show();y()}C();b(u);o.setup_plot_controls(e("#dashboard"),e("#dashboard-toolbar"),t.plots);e("#dashboard-hosts").on("click","a.list-group-item",function(){if(t.edit_enabled)return false}).on("click","button.pficon-delete",function(){var s=e(this).parent(".list-group-item");t.toggle_edit(false);var a=t.machines.lookup(s.attr("data-address"));if(a)t.machines.change(a.key,{visible:false});return false}).on("click","button.pficon-edit",function(){var s=e(this).parent(".list-group-item");var a=s.attr("data-address");t.toggle_edit(false);_(t.machines,a);return false}).on("mouseenter","a.list-group-item",function(){x(e(this),true)}).on("mouseleave","a.list-group-item",function(){x(e(this),false)});var v={};function m(){var s=false;var a={};e.each(v,function(e){a[e]=true});e("#dashboard-hosts .list-group-item").each(function(){var o=e(this);var r=o.attr("data-address");var i=t.machines.lookup(r);if(!i||i.state!="connected")return;delete a[r];if(!v[r]){v[r]=w(r)}v[r].forEach(function(t){e(t).off("hover").on("hover",function(e,t){x(o,t)});var a=i.color;if(t.options.color!=a){s=true;t.options.color=a}})});e.each(a,function(e){v[e].forEach(function(e){e.remove()});delete v[e]});if(s)y()}function x(e,t){e.toggleClass("highlight",t);var s=v[e.attr("data-address")];if(s){s.forEach(function(e){e.options.lines.lineWidth=t?3:2;if(t)e.move_to_front()});y()}}function k(a){var o=e("#dashboard-hosts-tmpl").html();s.parse(o);function r(){if(this.state=="failed")return"../shell/images/server-error.png";else if(this.avatar)return this.avatar;else return"../shell/images/server-small.png"}function i(){if(this.restarting)return"hidden";else return""}function d(){if(this.restarting)return"";else return"hidden"}function l(){var l=s.render(o,{machines:t.machines.list,render_avatar:r,avatar_display:i,connecting_display:d});a.html(l);e(".delete-localhost").tooltip({title:n("You are currently connected directly to this server. You cannot delete it.")});e(".delete-localhost").toggleClass("disabled",true);e(".delete-localhost").toggleClass("servers-privileged",false);p();m()}function h(){var e=null;return function(){if(e===null){e=window.setTimeout(function(){e=null;l()},500)}}}return h()}function y(){t.plots.forEach(function(e){e.refresh()})}function w(s){var a=t.machines.lookup(s);if(!a||a.state!="connected")return null;var o=[];var r=0;h.forEach(function(i){if(t.plots[r]){o.push(t.plots[r].add_metrics_sum_series(e.extend({host:s},i.plot),{color:a.color,lines:{lineWidth:2}}))}r+=1});return o}function C(){t.plots=[];h.forEach(function(s){function a(e){var t=e.getAxes();var a=s;if(s.ymax_unit){if(t.yaxis.datamax)t.yaxis.options.max=Math.ceil(t.yaxis.datamax/a.ymax_unit)*s.ymax_unit;else t.yaxis.options.max=s.ymax_unit}if(s.ymax_min){if(t.yaxis.datamax<s.ymax_min)t.yaxis.options.max=s.ymax_min;else t.yaxis.options.max=null}t.yaxis.options.min=0}if(!s.selector)return;var r=e.extend({setup_hook:a},l,s.options);var i=o.plot(e(s.selector));i.set_options(r);t.plots.push(i)});v={};m()}e(window).on("resize.dashboard",function(){t.plots.forEach(function(e){e.resize()})});f()},show:function(){p();this.plots[0].resize();this.toggle_edit(false)},enter:function(){},leave:function(){}};function f(){this._init()}b.prototype={_init:function(){this.id="dashboard_setup_server_dialog"},show:function(){e("#dashboard_setup_address").focus()},leave:function(){var t=this;e(t.local).off();t.local.close();t.local=null;t.cancel()},setup:function(){e("#dashboard_setup_cancel").on("click",e.proxy(this,"cancel"));e("#dashboard_setup_prev").on("click",e.proxy(this,"prev"));e("#dashboard_setup_next").on("click",e.proxy(this,"next"))},highlight_error:function(t){e(t).addClass("has-error")},hide_error:function(t){e(t).removeClass("has-error")},highlight_error_message:function(t,s){e(t).text(s);e(t).css("visibility","visible")},hide_error_message:function(t){e(t).css("visibility","hidden")},check_empty_address:function(){var t=e("#dashboard_setup_address").val();if(t===""){e("#dashboard_setup_next").prop("disabled",true);this.hide_error("#dashboard_setup_address_tab");this.hide_error_message("#dashboard_setup_address_error")}else if(t.search(/\s+/)===-1){e("#dashboard_setup_next").prop("disabled",false);this.hide_error("#dashboard_setup_address_tab");this.hide_error_message("#dashboard_setup_address_error")}else{e("#dashboard_setup_next").prop("disabled",true);this.highlight_error("#dashboard_setup_address_tab");this.highlight_error_message("#dashboard_setup_address_error",n("IP address or host name cannot contain whitespace."))}e("#dashboard_setup_next").text(n("Next"));e("#dashboard_setup_spinner").hide()},check_empty_name:function(){var t=e("#dashboard_setup_login_user").val();if(t===""){this.name_is_done=false;e("#dashboard_setup_next").prop("disabled",true);this.hide_error("#login_user_cell");this.hide_error_message("#dashboard_setup_login_error")}else if(t.search(/\s+/)===-1){this.name_is_done=true;e("#dashboard_setup_next").prop("disabled",false);this.hide_error("#login_user_cell");this.hide_error_message("#dashboard_setup_login_error")}else{this.name_is_done=false;e("#dashboard_setup_next").prop("disabled",true);this.highlight_error("#login_user_cell");this.highlight_error_message("#dashboard_setup_login_error",n("User name cannot contain whitespace."))}e("#dashboard_setup_next").text(n("Next"));e("#dashboard_setup_spinner").hide()},enter:function(){var s=this;s.local=t.dbus(null,{bus:"internal",host:"localhost",superuser:true});s.machines=b.machines;s.address=null;s.options={"host-key":""};s.name_is_done=false;e("#dashboard_setup_address")[0].placeholder=n("Enter IP address or host name");e("#dashboard_setup_address").on("keyup change",e.proxy(this,"update_discovered"));e("#dashboard_setup_address").on("input change focus",e.proxy(this,"check_empty_address"));e("#dashboard_setup_login_user").on("input change focus",e.proxy(this,"check_empty_name"));e("#dashboard_setup_login_password").on("input focus",function(){if(s.name_is_done)s.hide_error_message("#dashboard_setup_login_error")});e("#dashboard_setup_address").on("keyup",function(t){if(t.which===13){var a=e("#dashboard_setup_next").prop("disabled");if(!a)s.next()}});e("#dashboard_setup_login_user").on("keyup",function(t){if(t.which===13)e("#dashboard_setup_login_password").focus()});e("#dashboard_setup_login_password").on("keyup",function(t){if(t.which===13){var a=e("#dashboard_setup_next").prop("disabled");if(!a)s.next()}});e("#dashboard_setup_address").val("");e("#dashboard_setup_login_user").val("");e("#dashboard_setup_login_password").val("");e("#dashboard_setup_address_reuse_creds").prop("checked",true);s.show_tab("address");s.update_discovered();e("#dashboard_setup_next").prop("disabled",true);e("#dashboard_setup_spinner").hide()},update_discovered:function(){var t=this;var s=e("#dashboard_setup_address").val();var a=e("#dashboard_setup_address_discovered");function o(t){if(!t.trim())return null;if(!s)return e("<span/>").text(t);var a=t.indexOf(s);if(a==-1)return null;return e("<span/>").append(e("<span/>").text(t.substring(0,a)),e("<b/>").text(t.substring(a,a+s.length)),e("<span/>").text(t.substring(a+s.length)))}a.empty();var r,i;var n,d,l=t.machines.addresses;for(var h=0;h<l.length;h++){n=l[h];d=t.machines.lookup(n);if(!d.visible){r=o(n);if(r){i=e("<li>",{"class":"list-group-item",on:{click:e.proxy(this,"discovered_clicked",n)}}).html(r);a.append(i)}}}},discovered_clicked:function(t){e("#dashboard_setup_address").val(t);this.update_discovered();e("#dashboard_setup_address").focus()},show_tab:function(t){e(".cockpit-setup-tab").hide();e("#dashboard_setup_next").text(n("Next"));e("#dashboard_setup_spinner").hide();if(t=="address"){e("#dashboard_setup_address_tab").show();e("#dashboard_setup_address").focus();this.hide_error_message("#dashboard_setup_address_error");this.next_action=this.next_select;this.prev_tab=null}else if(t=="login"){e("#dashboard_setup_login_tab").show();e("#dashboard_setup_login_user").focus();this.hide_error_message("#dashboard_setup_login_error");this.next_action=this.next_login;this.prev_tab="address"}else if(t=="action"){e("#dashboard_setup_action_tab").show();e("#dashboard_setup_next").text(n("Add host"));this.next_action=this.next_setup;var s=e("#dashboard_setup_address_reuse_creds").prop("checked");if(s)this.prev_tab="address";else this.prev_tab="login"}else if(t=="close"){e("#dashboard_setup_action_tab").show();e("#dashboard_setup_next").text(n("Close"));this.next_action=this.next_close;this.prev_tab=null}if(this.next_action===this.next_login)this.check_empty_name();else e("#dashboard_setup_next").prop("disabled",false);e("#dashboard_setup_prev").prop("disabled",!this.prev_tab)},close:function(){var t=this;if(t.remote)t.remote.close();e("#dashboard_setup_server_dialog").modal("hide")},cancel:function(){this.close()},prev:function(){if(this.prev_tab)this.show_tab(this.prev_tab)},next:function(){e("#dashboard_setup_spinner").show();e("#dashboard_setup_next").prop("disabled",true);this.next_action()},connect_server:function(){var s=this;var a=e.extend({bus:"internal",host:s.address,superuser:true},s.options);var o=t.dbus(null,a);e(o).on("close",function(a,o){if(!s.options["host-key"]&&o.problem=="unknown-hostkey"){s.options["host-key"]=o["host-key"];e("#dashboard_setup_action_fingerprint").text(o["host-fingerprint"]);s.connect_server();return}else if(o.problem=="authentication-failed"){s.show_tab("login");s.highlight_error_message("#dashboard_setup_login_error",t.message(o.problem));return}var r=o.problem||"disconnected";s.highlight_error_message("#dashboard_setup_address_error",t.message(r));s.highlight_error_message("#dashboard_setup_login_error",t.message(r));e("#dashboard_setup_next").prop("disabled",false);e("#dashboard_setup_next").text(n("Next"));e("#dashboard_setup_spinner").hide()});var r=o.proxy("cockpit.Setup","/setup");var i=s.local.proxy("cockpit.Setup","/setup");r.wait(function(){if(r.valid){s.remote=o;i.wait(function(){s.prepare_setup(r,i)})}})},next_select:function(){var t=this;var s;t.hide_error_message("#dashboard_setup_address_error");t.address=e("#dashboard_setup_address").val();if(t.address.trim()!==""){e("#dashboard_setup_login_address").text(t.address);s=e("#dashboard_setup_address_reuse_creds").prop("checked");if(!s)t.show_tab("login");else{t.options.user=null;t.options.password=null;t.options["host-key"]=null;t.connect_server()}}else{e("#dashboard_setup_next").text(n("Next"));e("#dashboard_setup_spinner").hide();t.highlight_error_message("#dashboard_setup_address_error",n("IP address or host name cannot be empty."))}},next_login:function(){var t=this;var s=e("#dashboard_setup_login_user").val();var a=e("#dashboard_setup_login_password").val();t.hide_error_message("#dashboard_setup_login_error");t.options.user=s;t.options.password=a;if(s.trim()!==""){t.connect_server()}else{e("#dashboard_setup_next").text(n("Next"));e("#dashboard_setup_spinner").hide();t.highlight_error_message("#dashboard_setup_login_error",n("User name cannot be empty."))}},reset_tasks:function(){var t=e("#dashboard_setup_action_tasks");this.tasks=[];t.empty()},add_task:function(t,s){var a=e("#dashboard_setup_action_tasks");var o=e("<li/>",{"class":"list-group-item"}).append(e("<table/>",{"class":"cockpit-setup-task-table",style:"width:100%"}).append(e("<tr/>").append(e("<td/>").text(t),e('<td style="width:16px"/>').append(e("<div>",{"class":"cockpit-setup-task-spinner spinner",style:"display:none"}),e("<div>",{"class":"cockpit-setup-task-error fa fa-exclamation-triangle",style:"display:none"}),e("<div>",{"class":"cockpit-setup-task-done pficon pficon-ok",style:"display:none"})))));var r={entry:o,func:s,error:function(t){this.had_error=true;this.entry.find(".cockpit-setup-task-table").append(e("<tr/>").append(e("<td/>",{style:"color:red"}).text(t)))}};this.tasks.push(r);a.append(o)},run_tasks:function(e){var t=this;function s(a){var o;if(a<t.tasks.length){o=t.tasks[a];o.entry.find(".cockpit-setup-task-spinner").show();o.func(o,function(){o.entry.find(".cockpit-setup-task-spinner").hide();if(o.had_error)o.entry.find(".cockpit-setup-task-error").show();else o.entry.find(".cockpit-setup-task-done").show();s(a+1)})}else e()}s(0)},prepare_setup:function(t,s){var a=this;t.Prepare("passwd1").done(function(t){a.reset_tasks();a.add_task(n("Synchronize admin logins"),function(e,s){o(e,s,t)});e("#dashboard_setup_action_address").text(a.address);a.show_tab("action")}).fail(function(e){a.highlight_error_message("#dashboard_setup_address_error",e);a.highlight_error_message("#dashboard_setup_login_error",e)});function o(e,a,o){s.Transfer("passwd1",o).fail(function(t){e.error(t);a()}).done(function(s){t.Commit("passwd1",s).fail(function(t){e.error(t)}).always(function(){a()})})}},next_setup:function(){var e=this;e.machines.add(e.address,e.options["host-key"]).fail(function(t){e.highlight_error_message("#dashboard_setup_address_error",t.toString());e.show_tab("address")}).done(function(){e.run_tasks(function(){e.show_tab("close")})})},next_close:function(){this.close()}};function b(){this._init()}function g(t){b.machines=t;var s=parseInt(e(".dashboard-machine-limit").text(),10);e(".dashboard-machine-warning").toggle(s*.75<=t.list.length);e("#dashboard_setup_server_dialog").modal("show")}function v(t){t.setup();e("#"+t.id).on("show.bs.modal",function(){t.enter()}).on("shown.bs.modal",function(){t.show()}).on("hidden.bs.modal",function(){t.leave()})}function m(t,s){if(t._entered_)t.leave();t.enter(s);t._entered_=true;e("#"+t.id).show();t.show()}function x(t){e("#"+t.id).hide();if(t._entered_){t.leave();t._entered_=false}}function k(){var s;function a(){var a=t.location.path;if(a.length===0){m(s)}else{console.warn("not a dashboard location: "+a);t.location=""}e("body").removeAttr("hidden")}t.translate();s=new f;s.setup();v(new b);e(t).on("locationchanged",a);a()}return k});
