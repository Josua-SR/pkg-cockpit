define(["jquery","base1/cockpit","base1/mustache","shell/controls","shell/shell","shell/machines","./image-editor","shell/machine-dialogs","base1/patterns","shell/plot"],function(e,t,o,i,a,s,n,r){"use strict";var l=t.gettext;var d=t.gettext;e(document).on("click","a[data-address]",function(o){t.jump("/",e(this).attr("data-address"));o.preventDefault()});var c={legend:{show:false},series:{shadowSize:0},xaxis:{tickColor:"#d1d1d1",mode:"time",tickFormatter:a.format_date_tick,minTickSize:[1,"minute"]},points:{radius:0},grid:{borderWidth:1,borderColor:"#e1e6ed",hoverable:true,autoHighlight:false}};var u=[{selector:"#dashboard-plot-0",plot:{direct:["kernel.all.cpu.nice","kernel.all.cpu.user","kernel.all.cpu.sys"],internal:["cpu.basic.nice","cpu.basic.user","cpu.basic.system"],units:"millisec",derive:"rate",factor:.1},options:{yaxis:{tickColor:"#e1e6ed",tickFormatter:function(e){return e+"%"}}},ymax_unit:100},{selector:"#dashboard-plot-1",plot:{direct:["mem.util.used"],internal:["memory.used"],units:"bytes"},options:{yaxis:{ticks:a.memory_ticks,tickColor:"#e1e6ed",tickFormatter:a.format_bytes_tick}},ymax_unit:1e8},{selector:"#dashboard-plot-2",plot:{direct:["network.interface.total.bytes"],internal:["network.all.rx","network.all.tx"],units:"bytes","omit-instances":["lo"],derive:"rate"},options:{yaxis:{tickColor:"#e1e6ed",tickFormatter:a.format_bits_per_sec_tick}},ymax_min:1e5},{selector:"#dashboard-plot-3",plot:{direct:["disk.dev.total_bytes"],internal:["block.device.read","block.device.written"],units:"bytes",derive:"rate"},options:{yaxis:{ticks:a.memory_ticks,tickColor:"#e1e6ed",tickFormatter:a.format_bytes_per_sec_tick}},ymax_min:1e5}];var h;e(function(){h=n(e("#host-edit-avatar"),256,256);e("#host-edit-color").parent().on("show.bs.dropdown",function(){var t=e("#host-edit-color");var o=e("#host-edit-color-popover");var i=t.position();var a=t.width();var s=t.height();var n=o.width();var r=o.height();o.css("left",i.left+(a-n)/2);o.css("top",i.top-r+10);o.show()}).on("hide.bs.dropdown",function(){e("#host-edit-color-popover").hide()})});function f(o,i){var a=o.lookup(i);if(!a)return;var n=a.address!="localhost";var l=e("#host-edit-dialog");e("#host-edit-fail").text("").hide();e("#host-edit-name").val(a.label);e("#host-edit-name").prop("disabled",a.state=="failed");e("#host-edit-user-row").toggle(s.allow_connection_string);if(s.allow_connection_string){e("#host-edit-user").attr("placeholder",t.user.user);e("#host-edit-user").prop("disabled",!n);e("#host-edit-user").val(a.user);e("#host-edit-dialog a[data-content]").popover()}r.render_color_picker("#host-edit-colorpicker",a.address);e("#host-edit-sync-users").off("click");e("#host-edit-sync-users").on("click",function(){e("#host-edit-dialog").modal("hide");r.render_dialog("sync-users","dashboard_setup_server_dialog",a.address)});e("#host-edit-apply").off("click");e("#host-edit-apply").on("click",function(){l.dialog("failure",null);var t={avatar:h.changed?h.get_data(128,128,"image/png"):null,color:e.color.parse(e("#host-edit-color").css("background-color")).toString(),label:e("#host-edit-name").val()};if(n&&s.allow_connection_string)t.user=e("#host-edit-user").val();var i=o.change(a.key,t);l.dialog("promise",i)});e("#host-edit-avatar").off("click");e("#host-edit-avatar").on("click",function(){e("#host-edit-fail").text("").hide();h.select_file().done(function(){e("#host-edit-avatar").off("click");h.changed=true;h.start_cropping()})});l.modal("show");h.stop_cropping();h.load_data(a.avatar||"images/server-large.png").fail(function(){e("#host-edit-fail").text("Can't load image").show()})}var p=t.permission({admin:true});e(p).on("changed",m);function m(){i.update_privileged_ui(p,".servers-privileged",t.format(l("The user <b>$0</b> is not permitted to manage servers"),t.user.name))}v.prototype={_init:function(){this.id="dashboard";this.edit_enabled=false},getTitle:function(){return null},toggle_edit:function(t){var o=this;o.edit_enabled=t;e("#dashboard-enable-edit").toggleClass("active",o.edit_enabled);e(".os").toggleClass("hidden",o.edit_enabled);e("#dashboard-hosts").toggleClass("editable",o.edit_enabled)},setup:function(){var t=this;t.machines=s.instance();r.setup_machines(t.machines);var i=0;e("#dashboard-add").click(function(){r.render_dialog("add-machine","dashboard_setup_server_dialog")});e("#dashboard-enable-edit").click(function(){t.toggle_edit(!t.edit_enabled)});var n=g(e("#dashboard-hosts .list-group"));e(t.machines).on("added.dashboard",n);e(t.machines).on("removed.dashboard",n);e(t.machines).on("updated.dashboard",n);e("#dashboard .nav-tabs li").click(function(){d(parseInt(e(this).data("monitor-id"),10))});function d(t){e("#dashboard .nav-tabs li").removeClass("active");e("#dashboard .nav-tabs li[data-monitor-id="+t+"]").addClass("active");i=t;e(".dashboard-plot").hide();e(u[t].selector).show();_()}k();d(i);a.setup_plot_controls(e("#dashboard"),e("#dashboard-toolbar"),t.plots);e("#dashboard-hosts").on("click","a.list-group-item",function(){if(t.edit_enabled)return false}).on("click","button.pficon-delete",function(){var o=e(this).parent(".list-group-item");t.toggle_edit(false);var i=t.machines.lookup(o.attr("data-address"));if(i)t.machines.change(i.key,{visible:false});return false}).on("click","button.pficon-edit",function(){var o=e(this).parent(".list-group-item");var i=o.attr("data-address");t.toggle_edit(false);f(t.machines,i);return false}).on("mouseenter","a.list-group-item",function(){v(e(this),true)}).on("mouseleave","a.list-group-item",function(){v(e(this),false)});var h={};function p(){var o=false;var i={};e.each(h,function(e){i[e]=true});e("#dashboard-hosts .list-group-item").each(function(){var a=e(this);var s=a.attr("data-address");var n=t.machines.lookup(s);if(!n||n.state!="connected")return;delete i[s];if(!h[s]){h[s]=b(s)}h[s].forEach(function(t){e(t).off("hover").on("hover",function(e,t){v(a,t)});var i=n.color;if(t.options.color!=i){o=true;t.options.color=i}})});e.each(i,function(e){h[e].forEach(function(e){e.remove()});delete h[e]});if(o)_()}function v(e,t){e.toggleClass("highlight",t);var o=h[e.attr("data-address")];if(o){o.forEach(function(e){e.options.lines.lineWidth=t?3:2;if(t)e.move_to_front()});_()}}function g(i){var a=e("#dashboard-hosts-tmpl").html();o.parse(a);function s(){if(this.state=="failed")return"../shell/images/server-error.png";else if(this.avatar)return this.avatar;else return"../shell/images/server-small.png"}function n(){if(this.restarting)return"hidden";else return""}function r(){if(this.restarting)return"";else return"hidden"}function d(){var d=o.render(a,{machines:t.machines.list,render_avatar:s,avatar_display:n,connecting_display:r});i.html(d);e(".delete-localhost").tooltip({title:l("You are currently connected directly to this server. You cannot delete it.")});e(".delete-localhost").toggleClass("disabled",true);e(".delete-localhost").toggleClass("servers-privileged",false);m();p()}function c(){var e=null;return function(){if(e===null){e=window.setTimeout(function(){e=null;d()},500)}}}return c()}function _(){t.plots.forEach(function(e){e.refresh()})}function b(o){var i=t.machines.lookup(o);if(!i||i.state!="connected")return null;var a=[];var s=0;u.forEach(function(o){if(t.plots[s]){a.push(t.plots[s].add_metrics_sum_series(e.extend({host:i.connection_string},o.plot),{color:i.color,lines:{lineWidth:2}}))}s+=1});return a}function k(){t.plots=[];u.forEach(function(o){function i(e){var t=e.getAxes();var i=o;if(o.ymax_unit){if(t.yaxis.datamax)t.yaxis.options.max=Math.ceil(t.yaxis.datamax/i.ymax_unit)*o.ymax_unit;else t.yaxis.options.max=o.ymax_unit}if(o.ymax_min){if(t.yaxis.datamax<o.ymax_min)t.yaxis.options.max=o.ymax_min;else t.yaxis.options.max=null}t.yaxis.options.min=0}if(!o.selector)return;var s=e.extend({setup_hook:i},c,o.options);var n=a.plot(e(o.selector));n.set_options(s);t.plots.push(n)});h={};p()}e(window).on("resize.dashboard",function(){t.plots.forEach(function(e){e.resize()})});n()},show:function(){m();this.plots[0].resize();this.toggle_edit(false)},enter:function(){},leave:function(){}};function v(){this._init()}function g(t){t.setup();e("#"+t.id).on("show.bs.modal",function(){t.enter()}).on("shown.bs.modal",function(){t.show()}).on("hidden.bs.modal",function(){t.leave()})}function _(t,o){if(t._entered_)t.leave();t.enter(o);t._entered_=true;e("#"+t.id).show();t.show()}function b(t){e("#"+t.id).hide();if(t._entered_){t.leave();t._entered_=false}}function k(){var o;function i(){var i=t.location.path;if(i.length===0){_(o)}else{console.warn("not a dashboard location: "+i);t.location=""}e("body").removeAttr("hidden")}t.translate();o=new v;o.setup();e(t).on("locationchanged",i);i()}return k});
