define(["jquery"],function(e){function t(t,r,n){var o={load_data:_,get_data:x,start_cropping:R,stop_cropping:b,select_file:S,changed:false};var a=Math.min(r,n);var i=a;var f=20;var c,l,s;var u,d;var v,h;function g(){t.empty().css("width",r).css("height",n).css("position","relative").append(c=e("<canvas>"),l=e("<canvas>").css("position","absolute").css("top",0).css("left",0).css("z-index",10));e("body").append(s=e('<input data-role="none" type="file">').hide());u=c[0];v=u.getContext("2d");d=l[0];h=d.getContext("2d");u.width=d.width=r;u.height=d.height=n;s.on("change",I)}var p=false;var w,m,y;function R(){p=true;j((r-i)/2,(n-i)/2,i,true);l.on("mousedown",M)}function b(){p=false;h.clearRect(0,0,r,n);l.off("mousedown",M)}function j(e,t,o,i){function c(e,t,r){if(t<e)return e;if(t>r)return r;return t}e=Math.floor(e);t=Math.floor(t);o=Math.floor(o);var l=2*f;if(i){o=c(l,o,a);e=c(0,e,r-o);t=c(0,t,n-o)}else if(e<0||t<0||e+o>r||t+o>n||o<l)return;w=e;m=t;y=o;k(e,t,e+o,t+o)}function k(e,t,o,a){var i=h;function c(e,t,r,n){i.strokeStyle="black";i.strokeRect(e+.5,t+.5,r-e-1,n-t-1);i.strokeStyle="white";i.strokeRect(e+1.5,t+1.5,r-e-3,n-t-3)}i.clearRect(0,0,r,n);i.fillStyle="rgba(0,0,0,0.8)";i.fillRect(0,0,r,n);i.clearRect(e,t,o-e,a-t);var l=f;c(e,t,e+l,t+l);c(o-l,t,o,t+l);c(e,a-l,e+l,a);c(o-l,a-l,o,a);c(e,t,o,a)}function M(t){var r=l.offset();var n=t.pageX-r.left-w;var a=t.pageY-r.top-m;var i=w;var c=m;var s=y;var u,d,v,h;var g=f;function p(e){var t=e.pageX-r.left-n;var f=e.pageY-r.top-a;if(u===0)j(t,f,s,true);else{var l=Math.floor((t-i+u*(f-c))/2);j(i+d*l,c+v*l,s+h*l,false)}o.changed=true}function R(t){e("body").off("mousemove",p);e("body").off("mouseup",R)}if(n>0&&a>0&&n<y&&a<y){if(n<g&&a<g){u=1;d=1;v=1;h=-1}else if(n>y-g&&a<g){u=-1;d=0;v=-1;h=1}else if(n<g&&a>y-g){u=-1;d=1;v=0;h=-1}else if(n>y-g&&a>y-g){u=1;d=0;v=0;h=1}else{u=0}e("body").on("mousemove",p);e("body").on("mouseup",R)}}function _(t){var o=e.Deferred();var a=new window.Image;a.onerror=function(){o.reject()};a.onload=function(){var e,t;if(a.width>a.height){e=r;t=e*(a.height/a.width)}else{t=n;e=t*(a.width/a.height)}v.fillStyle="rgb(255,255,255)";v.fillRect(0,0,r,n);v.drawImage(a,(r-e)/2,(n-t)/2,e,t);i=Math.min(t,e);o.resolve()};a.src=t;return o.promise()}function x(t,r,n){var o=e("<canvas/>")[0];o.width=t;o.height=r;var i=o.getContext("2d");if(p){i.drawImage(u,w,m,y,y,0,0,t,r)}else{i.drawImage(u,0,0,a,a,0,0,t,r)}return o.toDataURL(n)}var D;function I(){var e,t,r;e=s[0].files;if(e.length!=1){D.reject();return}t=e[0];if(!t.type.match("image.*")){D.reject();return}r=new window.FileReader;r.onerror=function(){D.reject()};r.onload=function(){_(r.result).done(function(){D.resolve()}).fail(function(){D.reject()})};r.readAsDataURL(t)}function S(){D=e.Deferred();if(window.File&&window.FileReader)s.trigger("click");else D.reject();return D.promise()}g();return o}return t});
