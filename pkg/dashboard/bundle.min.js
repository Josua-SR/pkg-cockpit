
define("dashboard/list", ["jquery","base1/cockpit","base1/mustache","shell/controls","shell/shell","shell/machines","./image-editor","shell/machine-dialogs","base1/patterns","shell/plot"],function(e,t,o,i,a,s,n,r){"use strict";var l=t.gettext;var d=t.gettext;e(document).on("click","a[data-address]",function(o){t.jump("/",e(this).attr("data-address"));o.preventDefault()});var c={legend:{show:false},series:{shadowSize:0},xaxis:{tickColor:"#d1d1d1",mode:"time",tickFormatter:a.format_date_tick,minTickSize:[1,"minute"]},points:{radius:0},grid:{borderWidth:1,borderColor:"#e1e6ed",hoverable:true,autoHighlight:false}};var u=[{selector:"#dashboard-plot-0",plot:{direct:["kernel.all.cpu.nice","kernel.all.cpu.user","kernel.all.cpu.sys"],internal:["cpu.basic.nice","cpu.basic.user","cpu.basic.system"],units:"millisec",derive:"rate",factor:.1},options:{yaxis:{tickColor:"#e1e6ed",tickFormatter:function(e){return e+"%"}}},ymax_unit:100},{selector:"#dashboard-plot-1",plot:{direct:["mem.util.used"],internal:["memory.used"],units:"bytes"},options:{yaxis:{ticks:a.memory_ticks,tickColor:"#e1e6ed",tickFormatter:a.format_bytes_tick}},ymax_unit:1e8},{selector:"#dashboard-plot-2",plot:{direct:["network.interface.total.bytes"],internal:["network.all.rx","network.all.tx"],units:"bytes","omit-instances":["lo"],derive:"rate"},options:{yaxis:{tickColor:"#e1e6ed",tickFormatter:a.format_bits_per_sec_tick}},ymax_min:1e5},{selector:"#dashboard-plot-3",plot:{direct:["disk.dev.total_bytes"],internal:["block.device.read","block.device.written"],units:"bytes",derive:"rate"},options:{yaxis:{ticks:a.memory_ticks,tickColor:"#e1e6ed",tickFormatter:a.format_bytes_per_sec_tick}},ymax_min:1e5}];var h;e(function(){h=n(e("#host-edit-avatar"),256,256);e("#host-edit-color").parent().on("show.bs.dropdown",function(){var t=e("#host-edit-color");var o=e("#host-edit-color-popover");var i=t.position();var a=t.width();var s=t.height();var n=o.width();var r=o.height();o.css("left",i.left+(a-n)/2);o.css("top",i.top-r+10);o.show()}).on("hide.bs.dropdown",function(){e("#host-edit-color-popover").hide()})});function f(o,i){var a=o.lookup(i);if(!a)return;var n=a.address!="localhost";var l=e("#host-edit-dialog");e("#host-edit-fail").text("").hide();e("#host-edit-name").val(a.label);e("#host-edit-name").prop("disabled",a.state=="failed");e("#host-edit-user-row").toggle(s.allow_connection_string);if(s.allow_connection_string){e("#host-edit-user").attr("placeholder",t.user.user);e("#host-edit-user").prop("disabled",!n);e("#host-edit-user").val(a.user);e("#host-edit-dialog a[data-content]").popover()}r.render_color_picker("#host-edit-colorpicker",a.address);e("#host-edit-sync-users").off("click");e("#host-edit-sync-users").on("click",function(){e("#host-edit-dialog").modal("hide");r.render_dialog("sync-users","dashboard_setup_server_dialog",a.address)});e("#host-edit-apply").off("click");e("#host-edit-apply").on("click",function(){l.dialog("failure",null);var t={avatar:h.changed?h.get_data(128,128,"image/png"):null,color:e.color.parse(e("#host-edit-color").css("background-color")).toString(),label:e("#host-edit-name").val()};if(n&&s.allow_connection_string)t.user=e("#host-edit-user").val();var i=o.change(a.key,t);l.dialog("promise",i)});e("#host-edit-avatar").off("click");e("#host-edit-avatar").on("click",function(){e("#host-edit-fail").text("").hide();h.select_file().done(function(){e("#host-edit-avatar").off("click");h.changed=true;h.start_cropping()})});l.modal("show");h.stop_cropping();h.load_data(a.avatar||"images/server-large.png").fail(function(){e("#host-edit-fail").text("Can't load image").show()})}var p=t.permission({admin:true});e(p).on("changed",m);function m(){i.update_privileged_ui(p,".servers-privileged",t.format(l("The user <b>$0</b> is not permitted to manage servers"),t.user.name))}v.prototype={_init:function(){this.id="dashboard";this.edit_enabled=false},getTitle:function(){return null},toggle_edit:function(t){var o=this;o.edit_enabled=t;e("#dashboard-enable-edit").toggleClass("active",o.edit_enabled);e(".os").toggleClass("hidden",o.edit_enabled);e("#dashboard-hosts").toggleClass("editable",o.edit_enabled)},setup:function(){var t=this;t.machines=s.instance();r.setup_machines(t.machines);var i=0;e("#dashboard-add").click(function(){r.render_dialog("add-machine","dashboard_setup_server_dialog")});e("#dashboard-enable-edit").click(function(){t.toggle_edit(!t.edit_enabled)});var n=g(e("#dashboard-hosts .list-group"));e(t.machines).on("added.dashboard",n);e(t.machines).on("removed.dashboard",n);e(t.machines).on("updated.dashboard",n);e("#dashboard .nav-tabs li").click(function(){d(parseInt(e(this).data("monitor-id"),10))});function d(t){e("#dashboard .nav-tabs li").removeClass("active");e("#dashboard .nav-tabs li[data-monitor-id="+t+"]").addClass("active");i=t;e(".dashboard-plot").hide();e(u[t].selector).show();_()}k();d(i);a.setup_plot_controls(e("#dashboard"),e("#dashboard-toolbar"),t.plots);e("#dashboard-hosts").on("click","a.list-group-item",function(){if(t.edit_enabled)return false}).on("click","button.pficon-delete",function(){var o=e(this).parent(".list-group-item");t.toggle_edit(false);var i=t.machines.lookup(o.attr("data-address"));if(i)t.machines.change(i.key,{visible:false});return false}).on("click","button.pficon-edit",function(){var o=e(this).parent(".list-group-item");var i=o.attr("data-address");t.toggle_edit(false);f(t.machines,i);return false}).on("mouseenter","a.list-group-item",function(){v(e(this),true)}).on("mouseleave","a.list-group-item",function(){v(e(this),false)});var h={};function p(){var o=false;var i={};e.each(h,function(e){i[e]=true});e("#dashboard-hosts .list-group-item").each(function(){var a=e(this);var s=a.attr("data-address");var n=t.machines.lookup(s);if(!n||n.state!="connected")return;delete i[s];if(!h[s]){h[s]=b(s)}h[s].forEach(function(t){e(t).off("hover").on("hover",function(e,t){v(a,t)});var i=n.color;if(t.options.color!=i){o=true;t.options.color=i}})});e.each(i,function(e){h[e].forEach(function(e){e.remove()});delete h[e]});if(o)_()}function v(e,t){e.toggleClass("highlight",t);var o=h[e.attr("data-address")];if(o){o.forEach(function(e){e.options.lines.lineWidth=t?3:2;if(t)e.move_to_front()});_()}}function g(i){var a=e("#dashboard-hosts-tmpl").html();o.parse(a);function s(){if(this.state=="failed")return"../shell/images/server-error.png";else if(this.avatar)return this.avatar;else return"../shell/images/server-small.png"}function n(){if(this.restarting)return"hidden";else return""}function r(){if(this.restarting)return"";else return"hidden"}function d(){var d=o.render(a,{machines:t.machines.list,render_avatar:s,avatar_display:n,connecting_display:r});i.html(d);e(".delete-localhost").tooltip({title:l("You are currently connected directly to this server. You cannot delete it.")});e(".delete-localhost").toggleClass("disabled",true);e(".delete-localhost").toggleClass("servers-privileged",false);m();p()}function c(){var e=null;return function(){if(e===null){e=window.setTimeout(function(){e=null;d()},500)}}}return c()}function _(){t.plots.forEach(function(e){e.refresh()})}function b(o){var i=t.machines.lookup(o);if(!i||i.state!="connected")return null;var a=[];var s=0;u.forEach(function(o){if(t.plots[s]){a.push(t.plots[s].add_metrics_sum_series(e.extend({host:i.connection_string},o.plot),{color:i.color,lines:{lineWidth:2}}))}s+=1});return a}function k(){t.plots=[];u.forEach(function(o){function i(e){var t=e.getAxes();var i=o;if(o.ymax_unit){if(t.yaxis.datamax)t.yaxis.options.max=Math.ceil(t.yaxis.datamax/i.ymax_unit)*o.ymax_unit;else t.yaxis.options.max=o.ymax_unit}if(o.ymax_min){if(t.yaxis.datamax<o.ymax_min)t.yaxis.options.max=o.ymax_min;else t.yaxis.options.max=null}t.yaxis.options.min=0}if(!o.selector)return;var s=e.extend({setup_hook:i},c,o.options);var n=a.plot(e(o.selector));n.set_options(s);t.plots.push(n)});h={};p()}e(window).on("resize.dashboard",function(){t.plots.forEach(function(e){e.resize()})});n()},show:function(){m();this.plots[0].resize();this.toggle_edit(false)},enter:function(){},leave:function(){}};function v(){this._init()}function g(t){t.setup();e("#"+t.id).on("show.bs.modal",function(){t.enter()}).on("shown.bs.modal",function(){t.show()}).on("hidden.bs.modal",function(){t.leave()})}function _(t,o){if(t._entered_)t.leave();t.enter(o);t._entered_=true;e("#"+t.id).show();t.show()}function b(t){e("#"+t.id).hide();if(t._entered_){t.leave();t._entered_=false}}function k(){var o;function i(){var i=t.location.path;if(i.length===0){_(o)}else{console.warn("not a dashboard location: "+i);t.location=""}e("body").removeAttr("hidden")}t.translate();o=new v;o.setup();e(t).on("locationchanged",i);i()}return k});

//# sourceURL=dashboard/list.min.js

define("dashboard/image-editor", ["jquery"],function(e){function t(t,r,n){var o={load_data:_,get_data:x,start_cropping:R,stop_cropping:b,select_file:S,changed:false};var a=Math.min(r,n);var i=a;var f=20;var c,l,s;var u,d;var v,h;function g(){t.empty().css("width",r).css("height",n).css("position","relative").append(c=e("<canvas>"),l=e("<canvas>").css("position","absolute").css("top",0).css("left",0).css("z-index",10));e("body").append(s=e('<input data-role="none" type="file">').hide());u=c[0];v=u.getContext("2d");d=l[0];h=d.getContext("2d");u.width=d.width=r;u.height=d.height=n;s.on("change",I)}var p=false;var w,m,y;function R(){p=true;j((r-i)/2,(n-i)/2,i,true);l.on("mousedown",M)}function b(){p=false;h.clearRect(0,0,r,n);l.off("mousedown",M)}function j(e,t,o,i){function c(e,t,r){if(t<e)return e;if(t>r)return r;return t}e=Math.floor(e);t=Math.floor(t);o=Math.floor(o);var l=2*f;if(i){o=c(l,o,a);e=c(0,e,r-o);t=c(0,t,n-o)}else if(e<0||t<0||e+o>r||t+o>n||o<l)return;w=e;m=t;y=o;k(e,t,e+o,t+o)}function k(e,t,o,a){var i=h;function c(e,t,r,n){i.strokeStyle="black";i.strokeRect(e+.5,t+.5,r-e-1,n-t-1);i.strokeStyle="white";i.strokeRect(e+1.5,t+1.5,r-e-3,n-t-3)}i.clearRect(0,0,r,n);i.fillStyle="rgba(0,0,0,0.8)";i.fillRect(0,0,r,n);i.clearRect(e,t,o-e,a-t);var l=f;c(e,t,e+l,t+l);c(o-l,t,o,t+l);c(e,a-l,e+l,a);c(o-l,a-l,o,a);c(e,t,o,a)}function M(t){var r=l.offset();var n=t.pageX-r.left-w;var a=t.pageY-r.top-m;var i=w;var c=m;var s=y;var u,d,v,h;var g=f;function p(e){var t=e.pageX-r.left-n;var f=e.pageY-r.top-a;if(u===0)j(t,f,s,true);else{var l=Math.floor((t-i+u*(f-c))/2);j(i+d*l,c+v*l,s+h*l,false)}o.changed=true}function R(t){e("body").off("mousemove",p);e("body").off("mouseup",R)}if(n>0&&a>0&&n<y&&a<y){if(n<g&&a<g){u=1;d=1;v=1;h=-1}else if(n>y-g&&a<g){u=-1;d=0;v=-1;h=1}else if(n<g&&a>y-g){u=-1;d=1;v=0;h=-1}else if(n>y-g&&a>y-g){u=1;d=0;v=0;h=1}else{u=0}e("body").on("mousemove",p);e("body").on("mouseup",R)}}function _(t){var o=e.Deferred();var a=new window.Image;a.onerror=function(){o.reject()};a.onload=function(){var e,t;if(a.width>a.height){e=r;t=e*(a.height/a.width)}else{t=n;e=t*(a.width/a.height)}v.fillStyle="rgb(255,255,255)";v.fillRect(0,0,r,n);v.drawImage(a,(r-e)/2,(n-t)/2,e,t);i=Math.min(t,e);o.resolve()};a.src=t;return o.promise()}function x(t,r,n){var o=e("<canvas/>")[0];o.width=t;o.height=r;var i=o.getContext("2d");if(p){i.drawImage(u,w,m,y,y,0,0,t,r)}else{i.drawImage(u,0,0,a,a,0,0,t,r)}return o.toDataURL(n)}var D;function I(){var e,t,r;e=s[0].files;if(e.length!=1){D.reject();return}t=e[0];if(!t.type.match("image.*")){D.reject();return}r=new window.FileReader;r.onerror=function(){D.reject()};r.onload=function(){_(r.result).done(function(){D.resolve()}).fail(function(){D.reject()})};r.readAsDataURL(t)}function S(){D=e.Deferred();if(window.File&&window.FileReader)s.trigger("click");else D.reject();return D.promise()}g();return o}return t});

//# sourceURL=dashboard/image-editor.min.js
