define(["jquery","base1/cockpit"],function(e,a){"use strict";var i=a.gettext;var t=0;function n(){t+=1;return"unique"+-new Date+-t}function r(e){e.find(".dialog-error").remove();e.find(".has-error").removeClass("has-error");e.find(".dialog-wrapper").off(".dialog-error");e.off(".dialog-error")}function o(a,i){var t=a.parent();var n,r;if(!t.is(".dialog-wrapper")){t=e("<div class='dialog-wrapper'>").insertBefore(a);n=a.next();if(n.is(".bootstrap-select")&&n.selectpicker){n.remove();r=n.selectpicker}a.remove().appendTo(t);if(r)r.call(a)}var o;if(i.message){o=e("<div class='dialog-error help-block'>").text(i.message);t.addClass("has-error").append(o)}t.on("keypress.dialog-error change.dialog-error",function(){t.removeClass("has-error").find(".dialog-error.help-block").css("visibility","hidden")})}function s(a,i){var t=e("<div class='alert alert-danger dialog-error'>");t.text(i.message||i.toString());e("<span class='fa fa-exclamation-triangle'>").prependTo(t);var n=a.find(".modal-footer");if(n.length)t.prependTo(n);else t.appendTo(a)}function l(a,i){r(a);if(i.length==1&&e.isArray(i[0]))i=i[0];var t=false;i.forEach(function(e){var i;if(e){i=a.find(e.target);if(i&&i.length)o(i,e);else s(a,e);t=true}});if(!t)return;a.on("show.bs.modal.dialog-error",function(){r(a)})}function f(e,a){this.promise=e;this.disabled=[];this.handle=a}function d(e){var a=e.data("dialog-wait");e.data("dialog-wait",null);e.find(".dialog-wait").remove();e.find(".btn").off(".dialog-wait");e.off(".dialog-wait");if(a){a.disabled.forEach(function(e){e.removeAttr("disabled")})}}function c(a,i,t){d(a);if(!i){if(t)a.modal("hide");return a}if(t)l(a,[]);var n=e("<div class='dialog-wait pull-left'>");e("<div class='spinner spinner-sm'>").appendTo(n);var r=e("<span>").appendTo(n);a.find(".modal-footer button").first().before(n);var o=new f(i,t);a.data("dialog-wait",o);var s=i.cancel||i.close;var c=false;var u=a.find(".form-control").add(".btn",a);if(s)u=u.not("[data-dismiss]");u.each(function(){var a=e(this);if(!a.attr("disabled")){o.disabled.push(a);a.attr("disabled","disabled")}});a.find(".btn[data-dismiss]").on("click.dialog-wait",function(){c=true;if(s)s.apply(i);return false});a.on("show.bs.modal.dialog-wait",function(){d(a)});function p(){var e,t=a.data("dialog-wait");if(t&&t.promise===i){d(a);e=i.state();if(c||e=="resolved"&&t.handle)a.modal("hide");else if(e=="rejected"&&t.handle)l(a,[arguments[0]])}}function g(e){var t=a.data("dialog-wait");if(t&&t.promise===i){if(typeof e!=="string")e="";r.text(e)}}i.always(p).progress(g);return a}e.fn.dialog=function v(e){if(e==="failure")return l(this,Array.prototype.slice.call(arguments,1));else if(e==="wait")return c(this,arguments[1]);else if(e==="promise")return c(this,arguments[1],true);else console.warn("unknown dialog action: "+e)};function u(a){a=a.find(".btn-onoff").andSelf().filter(".btn-onoff");a.each(function(a,t){var r=e(t).attr("data-toggle","buttons").addClass("btn-group");var o=r.onoff("value");var s=r.find(".btn");var l=r.find("input").first().attr("name")||n();var f,d,c;for(f=s.length;f<2;f++){d=e('<input type="radio" autocomplete="off">');c=document.createTextNode(f===0?i("On"):i("Off"));r.append(e('<label class="btn">').append(d,c));s=null}s=s||r.find(".btn");s.find("input").attr("name",l);g(r,!!o)});return a}function p(e){return e.find(".btn").first().hasClass("active")}function g(a,i){return a.each(function(a,t){var n=e(t).find(".btn");n.first().toggleClass("active",!!i).find("input").prop("checked",!!i);n.last().toggleClass("active",!i).find("input").prop("checked",!i)})}e.fn.onoff=function h(e){if(arguments.length===0||e=="refresh"){return u(this)}else if(e==="value"){if(arguments.length===1)return p(this);else return g(this,arguments[1])}else if(e=="disabled"){return this.find(".btn").toggleClass("disabled",arguments[1])}else{console.warn("unknown switch action: "+e)}}});
