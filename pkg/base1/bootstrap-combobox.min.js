define(["jquery"],function(){!function(t){"use strict";var e=function(e,s){this.options=t.extend({},t.fn.combobox.defaults,s);this.$source=t(e);this.$container=this.setup();this.$element=this.$container.find("input[type=text]");this.$target=this.$container.find("input[type=hidden]");this.$button=this.$container.find(".dropdown-toggle");this.$menu=t(this.options.menu).appendTo("body");this.template=this.options.template||this.template;this.matcher=this.options.matcher||this.matcher;this.sorter=this.options.sorter||this.sorter;this.highlighter=this.options.highlighter||this.highlighter;this.shown=false;this.selected=false;this.refresh();this.transferAttributes();this.listen()};e.prototype={constructor:e,setup:function(){var e=t(this.template());this.$source.before(e);this.$source.hide();return e},disable:function(){this.$element.prop("disabled",true);this.$button.attr("disabled",true);this.disabled=true;this.$container.addClass("combobox-disabled")},enable:function(){this.$element.prop("disabled",false);this.$button.attr("disabled",false);this.disabled=false;this.$container.removeClass("combobox-disabled")},parse:function(){var e=this,s={},i=[],n=false,o="";this.$source.find("option").each(function(){var r=t(this);if(r.val()===""){e.options.placeholder=r.text();return}s[r.text()]=r.val();i.push(r.text());if(r.prop("selected")){n=r.text();o=r.val()}});this.map=s;if(n){this.$element.val(n);this.$target.val(o);this.$container.addClass("combobox-selected");this.selected=true}return i},transferAttributes:function(){this.options.placeholder=this.$source.attr("data-placeholder")||this.options.placeholder;this.$element.attr("placeholder",this.options.placeholder);this.$target.prop("name",this.$source.prop("name"));this.$target.val(this.$source.val());this.$source.removeAttr("name");this.$element.attr("required",this.$source.attr("required"));this.$element.attr("rel",this.$source.attr("rel"));this.$element.attr("title",this.$source.attr("title"));this.$element.attr("class",this.$source.attr("class"));this.$element.attr("tabindex",this.$source.attr("tabindex"));this.$source.removeAttr("tabindex");if(this.$source.attr("disabled")!==undefined)this.disable()},select:function(){var t=this.$menu.find(".active").attr("data-value");this.$element.val(this.updater(t)).trigger("change");this.$target.val(this.map[t]).trigger("change");this.$source.val(this.map[t]).trigger("change");this.$container.addClass("combobox-selected");this.selected=true;return this.hide()},updater:function(t){return t},show:function(){var e=t.extend({},this.$element.position(),{height:this.$element[0].offsetHeight});this.$menu.insertAfter(this.$element).css({top:e.top+e.height,left:e.left}).show();t(".dropdown-menu").on("mousedown",t.proxy(this.scrollSafety,this));this.shown=true;return this},hide:function(){this.$menu.hide();t(".dropdown-menu").off("mousedown",t.proxy(this.scrollSafety,this));this.$element.on("blur",t.proxy(this.blur,this));this.shown=false;return this},lookup:function(t){this.query=this.$element.val();return this.process(this.source)},process:function(e){var s=this;e=t.grep(e,function(t){return s.matcher(t)});e=this.sorter(e);if(!e.length){return this.shown?this.hide():this}return this.render(e.slice(0,this.options.items)).show()},template:function(){if(this.options.bsVersion=="2"){return'<div class="combobox-container"><input type="hidden" /> <div class="input-append"> <input type="text" autocomplete="off" /> <span class="add-on dropdown-toggle" data-dropdown="dropdown"> <span class="caret"/> <i class="icon-remove"/> </span> </div> </div>'}else{return'<div class="combobox-container"> <input type="hidden" /> <div class="input-group"> <input type="text" autocomplete="off" /> <span class="input-group-addon dropdown-toggle" data-dropdown="dropdown"> <span class="caret" /> <span class="glyphicon glyphicon-remove" /> </span> </div> </div>'}},matcher:function(t){return~t.toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(t){var e=[],s=[],i=[],n;while(n=t.shift()){if(!n.toLowerCase().indexOf(this.query.toLowerCase())){e.push(n)}else if(~n.indexOf(this.query)){s.push(n)}else{i.push(n)}}return e.concat(s,i)},highlighter:function(t){var e=this.query.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&");return t.replace(new RegExp("("+e+")","ig"),function(t,e){return"<strong>"+e+"</strong>"})},render:function(e){var s=this;e=t(e).map(function(e,i){e=t(s.options.item).attr("data-value",i);e.find("a").html(s.highlighter(i));return e[0]});e.first().addClass("active");this.$menu.html(e);return this},next:function(e){var s=this.$menu.find(".active").removeClass("active"),i=s.next();if(!i.length){i=t(this.$menu.find("li")[0])}i.addClass("active")},prev:function(t){var e=this.$menu.find(".active").removeClass("active"),s=e.prev();if(!s.length){s=this.$menu.find("li").last()}s.addClass("active")},toggle:function(){if(!this.disabled){if(this.$container.hasClass("combobox-selected")){this.clearTarget();this.triggerChange();this.clearElement()}else{if(this.shown){this.hide()}else{this.clearElement();this.lookup()}}}},scrollSafety:function(t){if(t.target.tagName=="UL"){this.$element.off("blur")}},clearElement:function(){this.$element.val("").focus()},clearTarget:function(){this.$source.val("");this.$target.val("");this.$container.removeClass("combobox-selected");this.selected=false},triggerChange:function(){this.$source.trigger("change")},refresh:function(){this.source=this.parse();this.options.items=this.source.length},listen:function(){this.$element.on("focus",t.proxy(this.focus,this)).on("blur",t.proxy(this.blur,this)).on("keypress",t.proxy(this.keypress,this)).on("keyup",t.proxy(this.keyup,this));if(this.eventSupported("keydown")){this.$element.on("keydown",t.proxy(this.keydown,this))}this.$menu.on("click",t.proxy(this.click,this)).on("mouseenter","li",t.proxy(this.mouseenter,this)).on("mouseleave","li",t.proxy(this.mouseleave,this));this.$button.on("click",t.proxy(this.toggle,this))},eventSupported:function(t){var e=t in this.$element;if(!e){this.$element.setAttribute(t,"return;");e=typeof this.$element[t]==="function"}return e},move:function(t){if(!this.shown){return}switch(t.keyCode){case 9:case 13:case 27:t.preventDefault();break;case 38:t.preventDefault();this.prev();break;case 40:t.preventDefault();this.next();break}t.stopPropagation()},keydown:function(e){this.suppressKeyPressRepeat=~t.inArray(e.keyCode,[40,38,9,13,27]);this.move(e)},keypress:function(t){if(this.suppressKeyPressRepeat){return}this.move(t)},keyup:function(t){switch(t.keyCode){case 40:case 39:case 38:case 37:case 36:case 35:case 16:case 17:case 18:break;case 9:case 13:if(!this.shown){return}this.select();break;case 27:if(!this.shown){return}this.hide();break;default:this.clearTarget();this.lookup()}t.stopPropagation();t.preventDefault()},focus:function(t){this.focused=true},blur:function(t){var e=this;this.focused=false;var s=this.$element.val();if(!this.selected&&s!==""){this.$element.val("");this.$source.val("").trigger("change");this.$target.val("").trigger("change")}if(!this.mousedover&&this.shown){setTimeout(function(){e.hide()},200)}},click:function(t){t.stopPropagation();t.preventDefault();this.select();this.$element.focus()},mouseenter:function(e){this.mousedover=true;this.$menu.find(".active").removeClass("active");t(e.currentTarget).addClass("active")},mouseleave:function(t){this.mousedover=false}};t.fn.combobox=function(s){return this.each(function(){var i=t(this),n=i.data("combobox"),o=typeof s=="object"&&s;if(!n){i.data("combobox",n=new e(this,o))}if(typeof s=="string"){n[s]()}})};t.fn.combobox.defaults={bsVersion:"3",menu:'<ul class="typeahead typeahead-long dropdown-menu"></ul>',item:'<li><a href="#"></a></li>'};t.fn.combobox.Constructor=e}(window.jQuery)});
