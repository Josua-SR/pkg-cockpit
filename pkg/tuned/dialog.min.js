define(["jquery","base1/cockpit","base1/mustache","system/service","data!./button.html","data!./dialog.html","base1/patterns","base1/bootstrap-select"],function(n,e,t,o,i,r){"use strict";var a={};var l=e.gettext;function d(){if(window.debugging=="all"||window.debugging=="tuned")console.debug.apply(console,arguments)}a.button=function u(){var a=o.proxy("tuned.service");var d=n(i);var u=d.find("button");var c=d.find("[data-toggle=popover]");function f(e){var t=n.Deferred();n.when(e.call("/Tuned","com.redhat.tuned.control","is_running",[]),e.call("/Tuned","com.redhat.tuned.control","active_profile",[]),e.call("/Tuned","com.redhat.tuned.control","recommend_profile",[])).done(function(n,e,o){var i=n[0][0];var r=i?e[0][0]:"none";var a=o[0][0];t.resolve("running",r,a)}).fail(function(n){a.wait(function(){if(!a.exists)t.resolve("not-installed");else if(a.state!="running")t.resolve("not-running");else t.reject(n)})});return t.promise()}function s(){var n=e.dbus("com.redhat.tuned",{superuser:true});function t(n){if(n!=c.attr("data-content")){c.attr("data-content",n);if(c.data("bs.popover").tip().hasClass("in"))c.popover("show")}}f(n).done(function(n,e,o){var i;if(n=="not-installed")i=l("Tuned is not available");else if(n=="not-running")i=l("Tuned is not running");else if(e=="none")i=l("Tuned is off");else if(e==o)i=l("This system is using the recommended profile");else i=l("This system is using a custom profile");u.text(n=="running"?e:"none");u.prop("disabled",n=="not-installed");t(i)}).fail(function(n){console.warn("failed to poll tuned",n);u.text("error");u.prop("disabled",true);t(l("Communication with tuned has failed"))})}var p=null;function h(e){if(p)p.remove();p=n(t.render(r,{Profiles:e}));p.appendTo("body");p.on("hide.bs.modal",function(){p.remove();p=null});return p}function m(){var t;function o(n){if(n=="none"){return t.call("/Tuned","com.redhat.tuned.control","stop",[])}else{return t.call("/Tuned","com.redhat.tuned.control","switch_profile",[n]).then(function(n){if(!n[0][0])return[false,n[0][1]];else return t.call("/Tuned","com.redhat.tuned.control","start",[])})}}function i(e,t,i){var r=[];i.forEach(function(n){var e,o;if(typeof n==="string"){e=n;o=""}else{e=n[0];o=n[1]}if(e!="none"){r.push({profile:e,Title:e,Description:o,recommended:e==t})}});r.unshift({profile:"none",Title:l("None"),Description:l("Disable tuned")});p=h(r);p.find('[data-profile="'+e+'"]').addClass("active");p.find("[data-profile]").on("click",function(){p.dialog("failure",null);p.find("[data-profile]").removeClass("active");n(this).addClass("active")});p.find(".cancel").on("click",function(){p.modal("hide")});p.find(".apply").on("click",function(){var n=p.find("[data-profile].active").attr("data-profile");var e=o(n).done(function(n){if(!n[0])p.dialog("failure",n[1]||"Failed to switch profile");else{s();p.modal("hide")}}).fail(function(n){p.dialog("failure",n)});p.dialog("wait",e)});p.modal("show")}function r(n){p=h([]);p.dialog("failure",n);p.find(".cancel").on("click",function(){p.modal("hide")});p.find(".apply").prop("disabled",true);p.modal("show")}function d(){return t.call("/Tuned","com.redhat.tuned.control","profiles2",[]).then(function(n){return n[0]},function(){return t.call("/Tuned","com.redhat.tuned.control","profiles",[]).then(function(n){return n[0]})})}function u(){f(t).done(function(n,e,t){if(n!="running"){r(l("Tuned has failed to start"));return}d().then(function(n){i(e,t,n)},r)}).fail(r)}a.start().done(function(){s();t=e.dbus("com.redhat.tuned",{superuser:true});u()}).fail(r);if(!a.enabled)a.enable()}u.on("click",m);c.popover().on("click",s);s();return d};return a});
