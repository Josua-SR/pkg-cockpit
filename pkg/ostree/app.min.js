define(["jquery","base1/cockpit","base1/angular","base1/moment","updates/client"],function(n,e,t,o,r){"use strict";var i=e.gettext;var c=c||function(){};function a(n){if(!n)return;var e=n.osname.v;if(n.id)e=e+n.id.v;if(n.checksum)e=e+n.checksum.v;return e}function s(n,t){n.progress(function(n){t.$applyAsync(function(){t.progressMsg=n})}).fail(function(n){t.$applyAsync(function(){t.error=e.format(e.message(n))})}).always(function(n){t.$applyAsync(function(){t.progressMsg=null})})}return t.module("ostree",["ngRoute"]).config(["$routeProvider",function(n){n.when("/",{templateUrl:"index.html",controller:"indexController"})}]).controller("mainController",["$scope","$timeout",function(t,o){function a(n){t.$applyAsync(function(){t.curtains=n;c()})}function s(n){var t=null;var o=false;if(n.problem==="access-denied"){t=i("Not authorized to update software on this system")}else if(n.problem==="not-found"){t=i("OSTree is not available on this system");o=true}else{t=e.message(n)}a({state:"failed",failure:n,message:t,"final":o})}function u(){window.clearTimeout(l);l=null;if(r.os_list&&r.os_list.length===0){a({state:"empty",message:i("No OSTree deployments found"),failure:true})}else if(t.curtains!==null){a(null)}}t.curtains={state:"silent"};var l=window.setTimeout(function(){a({state:"connecting"});n("body").show();l=null},1e3);function f(e){e.always(function(){n("body").show();window.clearTimeout(l);l=null}).done(function(n){l=window.setTimeout(u,1e3)}).fail(s)}n(r).on("connectionLost.main",function(n,e){s(e)});n(r).on("changed.main",u);f(r.connect());t.reconnect=function m(){a({state:"connecting"});f(r.connect())};t.$on("$destroy",function(){n(r).off(".main")})}]).controller("indexController",["$scope",function(e){e.track_id=a;e.$watch(function(){c()});e.knownVersions=function(n){return r.known_versions_for(n)};e.itemMatches=function(n,e){return r.item_matches(n,e)};r.connect().done(function(){n(r).on("changed.ostreeIndex",function(){e.$applyAsync(function(){e.runningMethod=r.running_method;e.os_list=r.os_list})});e.$applyAsync(function(){e.runningMethod=r.running_method;e.os_list=r.os_list})});e.$on("$destroy",function(){n(r).off(".ostreeIndex")})}]).factory("$exceptionHandler",["$log",function(n){return function(t,o){e.oops();n.error.apply(n,arguments)}}]).directive("ostreeCheck",[function(){return{restrict:"E",templateUrl:"ostree-check.html",scope:{os:"=",runningMethod:"="},link:function(n,e,t){n.error=null;n.progressMsg=null;n.isRunning=false;n.$watch("runningMethod",function(){var e="DownloadUpdateRpmDiff:"+n.os;n.isRunning=e===r.running_method});n.checkForUpgrades=function(){n.error=null;n.progressMsg=i("Checking for updates");var e=r.run_transaction("DownloadUpdateRpmDiff",null,n.os);s(e,n)}}}}]).directive("ostreeItem",[function(){return{restrict:"E",templateUrl:"ostree-item.html",scope:{item:"=",runningMethod:"="},link:function(t,o,i){function c(){var n="";if(r.item_matches(t.item,"CachedUpdate"))n="Deploy:";else if(r.item_matches(t.item,"RollbackDeployment"))n="Rollback:";if(t.item&&t.item.osname)n=n+t.item.osname.v;t.isRunning=n===r.running_method}t.error=null;t.progressMsg=null;t.id=a(t.item);t.active="tree";t.packages=r.packages(t.item);n(t.packages).on("changed",function(){t.$digest()});t.$on("$destroy",function(){n(t.packages).off()});t.isRunning=false;c();t.$watch("runningMethod",c);t.matches=function(n){return r.item_matches(t.item,n)};t.switchTab=function(n){t.active=n};t.activeTab=function(n){return t.active===n};t.doRollback=function(n){t.error=null;var o={reboot:e.variant("b",true)};var i=r.run_transaction("Rollback",[o],n);s(i,t)};t.doUpgrade=function(n,o){t.error=null;var i={reboot:e.variant("b",true)};var c=r.run_transaction("Deploy",[o,i],n);s(c,t)}}}}]).filter("packages",function(){return function(n){var t=e.ngettext(i("$0 package"),i("$0 packages"),n);return e.format(t,n)}}).filter("releaseName",function(){return function(n){var t="";if(!n||!n.osname)return;if(n.version)t=n.version.v;return e.format("$0 $1",n.osname.v,t)}}).filter("timeAgo",function(){return function(n){if(n){return o.unix(n).fromNow()}return""}}).filter("dateFormat",function(){return function(n){var e;if(n){var t=new Date(n*1e3);return t.toString()}return e}})});
