
define("updates/client", ["jquery","base1/cockpit"],function(e,r){"use strict";var n=r.gettext;var t="org.projectatomic.rpmostree1";var a="/org/projectatomic/rpmostree1";var o="org.projectatomic.rpmostree1.Sysroot";var i="/org/projectatomic/rpmostree1/Sysroot";var l="org.projectatomic.rpmostree1.OS";var s="org.projectatomic.rpmostree1.Transaction";function c(e){if(!e||e.length!=6||e[0].length!=2||e[1].length!=2||e[2].length!=3||e[3].length!=4||e[4].length!=2||e[5].length!=2){console.warn("Unknown progress data",e);return}var t;var a=e[1][0];var o=e[1][0];var i=e[2][2];var l=e[3][0];var s=e[4][0];var c=e[4][1];if(a){if(l>0){t=n("Receiving delta parts")}else if(i){t=n("Receiving metadata objects")}else{var f=s/c*100;t=r.format(n("Receiving objects: $0%"),f.toFixed(2))}}else if(o){t=n("Writing objects")}else{t=n("Scanning metadata")}return t}function f(e){var r=["adds","removes","up","down"];var n=e[0];var t={};for(var a=0;a<n.length;a++){var o=r[n[a][1]];if(!t[o])t[o]=[];var i={name:n[a][0],type:n[a][1]};if(i.type===1){i.version=n[a][2]["PreviousPackage"]["v"][1];i.arch=n[a][2]["PreviousPackage"]["v"][2]}else{i.version=n[a][2]["NewPackage"]["v"][1];i.arch=n[a][2]["NewPackage"]["v"][2]}t[o].push(i)}return t}function u(e){var r=[];e.split("\n").forEach(function(e){if(e){r.push({name:e})}});r.sort(function(e,r){var n=e.name?e.name:"";var t=r.name?r.name:"";return n.toLowerCase().localeCompare(t.toLowerCase())});if(r.length<1)return;var n=Math.floor(r.length/2);if(r.length%2)n=n+1;return{rpms1:r.slice(0,n+1),rpms2:r.slice(n+1)}}function v(n,t){var a=this;a.error=null;a.ready=false;a.empty=false;n.done(function(e){var r=true;if(t)e=t(e);for(var n in e){a[n]=e[n];r=false}a.empty=r;a.valid=true}).fail(function(e){a.error=r.message(e)}).always(function(){a.ready=true;e(a).triggerHandler("changed")})}function p(){var p=this;p.connection_error=null;p.os_list=[];var m=null;var d={};var g={};var h={};var y=null;var _=null;var w=null;var b=null;var k=null;var j=false;Object.defineProperty(this,"running_method",{enumerable:false,get:function(){if(y){return y}else if(m&&m.ActiveTransaction){var e=m.ActiveTransaction[0];var r=d[m.ActiveTransaction[2]];if(r&&e)e=e+":"+r.Name;return e}else{return null}}});function D(e,r){return r.split(".").reduce(function(e,r){if(e!==undefined)return e[r];else return e},e||{})}function x(){if(!k){e(p).triggerHandler("changed");k=window.setTimeout(function(){k=null;if(j)e(p).triggerHandler("changed");j=false},300)}else{j=true}}function P(){if(!w){p.connection_error=null;p.os_list=[];m=null;d={};g={};h={};y=null;_=null;var n=null;var s=false;b=e.Callbacks("once memory");b.add(x);w=r.dbus(t,{superuser:true,capabilities:["address"]});w.watch(a).fail(C);e(w).on("close",S);m=w.proxy(o,i);e(m).on("changed",A);m.wait(function(){if(m&&m.valid)T(m.Deployments);if(w){d=w.proxies(l,a);e(d).on("changed",x);e(d).on("added",function(e,r){if(r.Name)g[r.Name]=r.path;x()});d.wait(function(){for(var e in d){var r=d[e];g[e]=e}b.fire()})}else{b.fire()}})}return w}function C(r){w=null;p.connection_error=r;if(m){e(m).off();m=null}if(d){e(d).off();d={}}}function S(r,n){C(n);e(p).triggerHandler("connectionLost",[n])}function T(e){var r={};var n=[];if(e){for(var t=0;t<e.length;t++){var a=e[t];var o=a.id.v;var i=a.osname.v;if(!r[i])n.push(i);r[i]=true}}p.os_list=n;x()}function A(e,r){if(r["Deployments"]){T(r["Deployments"])}else if("ActiveTransaction"in r){x()}}p.connect=function(){var r=e.Deferred();P();b.add(function(){if(p.connection_error)r.reject(p.connection_error);else r.resolve(w)});return r};p.known_versions_for=function(e){var r=m?m.Deployments:[];var n=[];var t;var a=p.get_os_proxy(e);if(a)t=D(a,"CachedUpdate.checksum.v");for(var o=0;o<r.length;o++){var i=r[o];var l=D(i,"checksum.v");if(p.item_matches(i,"DefaultDeployment")){if(t&&l!==t)n.push(a.CachedUpdate);n.push(i)}else if(D(i,"checksum.v")!==t){n.push(i)}}return n};p.get_os_proxy=function(e){var r=g[e];var n=null;if(r)n=d[r];return n};p.packages=function(e){var n=D(e,"id.v");var t=D(e,"checksum.v");var a=n;if(!n&&t)a=t;if(!_){var o=d[m.Booted];if(o)_=o.BootedDeployment.id.v;else return}if(a&&!h[a]){var i=p.get_os_proxy(e.osname.v);var l;var s;if(i){if(n===_){s=r.spawn(["rpm","-qa"]);l=new v(s,u)}else if(n){s=i.call("GetDeploymentsRpmDiff",[_,n]);l=new v(s,f)}else{s=i.call("GetCachedUpdateRpmDiff",[""]);l=new v(s,f)}h[a]=l}}return h[a]};p.item_matches=function(e,r){var n=D(e,"osname.v");var t=null;var a=null;if(!n)return false;t=p.get_os_proxy(n);a=D(t,r);return D(e,"checksum.v")===D(a,"checksum.v")};p.run_transaction=function(t,a,o){y=t+":"+o;var i=null;var l=null;var f=e.Deferred();var u;var v=false;if(e.isArray(a)){for(u=0;u<a.length;u++){if(e.isPlainObject(a[u])){v=a[u].reboot;break}}}function m(r){y=null;if(i){if(l)l.remove();e(i).off();i.close()}i=null;l=null;x()}function d(e){f.reject(e);m()}p.connect().fail(d).done(function(){var u=p.get_os_proxy(o);if(!u)return d(r.format(n("OS $0 not found"),o));u.call(t,a).fail(d).done(function(n){var t={superuser:true,address:n[0],bus:"none"};if(v)r.hint("restart");i=r.dbus(null,t);e(i).on("close",function(e,r){d(r)});l=i.subscribe({path:"/"},function(e,r,n,t){if(n=="DownloadProgress"){var a=c(t);if(a)f.notify(a)}else if(n=="Message"){f.notify(t[0])}else if(n=="Finished"){if(t){if(t[0]){f.resolve(t[1]);m()}else{d(t[1])}}else{console.warn("Unexpected transaction response",t);d({problem:"protocol-error"})}}});i.call("/",s,"Start")})});return f.promise()}}return new p});

//# sourceURL=updates/client.min.js

define("updates/app", ["jquery","base1/cockpit","base1/angular","base1/moment","updates/client"],function(n,e,t,o,r){"use strict";var i=e.gettext;var c=c||function(){};function a(n){if(!n)return;var e=n.osname.v;if(n.id)e=e+n.id.v;if(n.checksum)e=e+n.checksum.v;return e}function s(n,t){n.progress(function(n){t.$applyAsync(function(){t.progressMsg=n})}).fail(function(n){t.$applyAsync(function(){t.error=e.format(e.message(n))})}).always(function(n){t.$applyAsync(function(){t.progressMsg=null})})}return t.module("ostree",["ngRoute"]).config(["$routeProvider",function(n){n.when("/",{templateUrl:"index.html",controller:"indexController"})}]).controller("mainController",["$scope","$timeout",function(t,o){function a(n){t.$applyAsync(function(){t.curtains=n;c()})}function s(n){var t=null;var o=false;if(n.problem==="access-denied"){t=i("Not authorized to update software on this system")}else if(n.problem==="not-found"){t=i("OSTree is not available on this system");o=true}else{t=e.message(n)}a({state:"failed",failure:n,message:t,"final":o})}function u(){window.clearTimeout(l);l=null;if(r.os_list&&r.os_list.length===0){a({state:"empty",message:i("No OSTree deployments found"),failure:true})}else if(t.curtains!==null){a(null)}}t.curtains={state:"silent"};var l=window.setTimeout(function(){a({state:"connecting"});n("body").show();l=null},1e3);function f(e){e.always(function(){n("body").show();window.clearTimeout(l);l=null}).done(function(n){l=window.setTimeout(u,1e3)}).fail(s)}n(r).on("connectionLost.main",function(n,e){s(e)});n(r).on("changed.main",u);f(r.connect());t.reconnect=function m(){a({state:"connecting"});f(r.connect())};t.$on("$destroy",function(){n(r).off(".main")})}]).controller("indexController",["$scope",function(e){e.track_id=a;e.$watch(function(){c()});e.knownVersions=function(n){return r.known_versions_for(n)};e.itemMatches=function(n,e){return r.item_matches(n,e)};r.connect().done(function(){n(r).on("changed.ostreeIndex",function(){e.$applyAsync(function(){e.runningMethod=r.running_method;e.os_list=r.os_list})});e.$applyAsync(function(){e.runningMethod=r.running_method;e.os_list=r.os_list})});e.$on("$destroy",function(){n(r).off(".ostreeIndex")})}]).factory("$exceptionHandler",["$log",function(n){return function(t,o){e.oops();n.error.apply(n,arguments)}}]).directive("ostreeCheck",[function(){return{restrict:"E",templateUrl:"ostree-check.html",scope:{os:"=",runningMethod:"="},link:function(n,e,t){n.error=null;n.progressMsg=null;n.isRunning=false;n.$watch("runningMethod",function(){var e="DownloadUpdateRpmDiff:"+n.os;n.isRunning=e===r.running_method});n.checkForUpgrades=function(){n.error=null;n.progressMsg=i("Checking for updates");var e=r.run_transaction("DownloadUpdateRpmDiff",null,n.os);s(e,n)}}}}]).directive("ostreeItem",[function(){return{restrict:"E",templateUrl:"ostree-item.html",scope:{item:"=",runningMethod:"="},link:function(t,o,i){function c(){var n="";if(r.item_matches(t.item,"CachedUpdate"))n="Deploy:";else if(r.item_matches(t.item,"RollbackDeployment"))n="Rollback:";if(t.item&&t.item.osname)n=n+t.item.osname.v;t.isRunning=n===r.running_method}t.error=null;t.progressMsg=null;t.id=a(t.item);t.active="tree";t.packages=r.packages(t.item);n(t.packages).on("changed",function(){t.$digest()});t.$on("$destroy",function(){n(t.packages).off()});t.isRunning=false;c();t.$watch("runningMethod",c);t.matches=function(n){return r.item_matches(t.item,n)};t.switchTab=function(n){t.active=n};t.activeTab=function(n){return t.active===n};t.doRollback=function(n){t.error=null;var o={reboot:e.variant("b",true)};var i=r.run_transaction("Rollback",[o],n);s(i,t)};t.doUpgrade=function(n,o){t.error=null;var i={reboot:e.variant("b",true)};var c=r.run_transaction("Deploy",[o,i],n);s(c,t)}}}}]).filter("packages",function(){return function(n){var t=e.ngettext(i("$0 package"),i("$0 packages"),n);return e.format(t,n)}}).filter("releaseName",function(){return function(n){var t="";if(!n||!n.osname)return;if(n.version)t=n.version.v;return e.format("$0 $1",n.osname.v,t)}}).filter("timeAgo",function(){return function(n){if(n){return o.unix(n).fromNow()}return""}}).filter("dateFormat",function(){return function(n){var e;if(n){var t=new Date(n*1e3);return t.toString()}return e}})});

//# sourceURL=updates/app.min.js
