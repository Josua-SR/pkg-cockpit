define(["jquery","base1/cockpit","docker/util","shell/shell","shell/cockpit-plot","shell/cockpit-util"],function(e,n,i,t){function r(){var r=this;var o;var a;var c;var u;var s;var f=true;var d;function g(){if(!d){d=window.setTimeout(function(){d=null;e(r).trigger("event")},300)}}function l(){o=c.get("/v1.12/events");o.stream(function(e){i.docker_debug("event:",e);if(u.state()=="pending")u.resolve();g()}).always(function(){window.setTimeout(function(){if(f&&o){l();f=false}},1e3)})}this.containers={};this.images={};this.waiting={};var m={};var p={};var h={};var v;var y;var b={};function _(e){if(!e.Name)return null;var n=e.Name;if(n[0]==="/")n=n.substring(1);return n}function k(e,n){if(n.State===undefined)n.State={};if(n.Config===undefined)n.Config={};for(var i in m[e]){if(n[i]===undefined)n[i]=m[e][i]}var t=_(n);if(t)p[t]=e;if(!n.CGroup)n.CGroup=G(e)}function C(n){var i=r.containers[n];if(i){var t=_(i);if(t&&p[t]==n)delete p[t];delete r.containers[n];e(r).trigger("container",[n,undefined])}}function w(){c.get("/v1.12/containers/json",{all:1}).done(function(n){var i=JSON.parse(n);if(u.state()=="pending")u.resolve();f=true;var t={};e(i).each(function(n,i){var o=i.Id;if(!o)return;t[o]=o;m[o]=i;c.get("/v1.12/containers/"+encodeURIComponent(o)+"/json").done(function(n){var i=JSON.parse(n);k(o,i);r.containers[o]=i;b[o]=[y.add(v,["cgroup.memory.usage",i.CGroup]),y.add(v,["cgroup.cpu.usage",i.CGroup]),y.add(v,["cgroup.memory.limit",i.CGroup]),y.add(v,["cgroup.cpu.shares",i.CGroup])];e(r).trigger("container",[o,i])})});var o=[];e.each(r.containers,function(e){if(!t[e])o.push(e)});e.each(o,function(e,n){C(n)})}).fail(function(n){if(u.state()=="pending")u.reject(n);s=true;e(r).trigger("failure",[n])})}function S(){for(var n in b){var i=r.containers[n];if(!i)continue;var t=b[n];var o=t[0][0];var a=t[2][0];if(a>1115e15)a=undefined;var c=t[1][0]/10;var u=t[3][0];if(o!=i.MemoryUsage||a!=i.MemoryLimit||c!=i.CpuUsage||u!=i.CpuPriority){i.MemoryUsage=o;i.MemoryLimit=a;i.CpuUsage=c;i.CpuPriority=u;e(r).trigger("container",[n,i])}}}function O(n,i){if(i.Config===undefined){if(i.ContainerConfig)i.Config=i.ContainerConfig;else i.Config={}}e.extend(i,h[n]);if(i.RepoTags)i.RepoTags.sort()}function T(n){if(r.images[n]){delete r.images[n];e(r).trigger("image",[n,undefined])}}function N(){c.get("/v1.12/images/json").done(function(n){var i=JSON.parse(n);if(u.state()=="pending")u.resolve();f=true;var t={};e.each(i,function(n,i){var o=i.Id;if(!o)return;t[o]=o;h[o]=i;c.get("/v1.12/images/"+encodeURIComponent(o)+"/json").done(function(n){var i=JSON.parse(n);O(o,i);r.images[o]=i;e(r).trigger("image",[o,i])})});var o=[];e.each(r.images,function(e){if(!t[e])o.push(e)});e.each(o,function(e,n){T(n)})}).fail(function(n){if(u.state()=="pending")u.reject(n);s=true;e(r).trigger("failure",[n])})}e(r).on("event",function(){w();N()});function U(){s=false;u=e.Deferred();c=n.http("/var/run/docker.sock",{superuser:"try"});l();if(a&&a.valid)a.close();c.get("/v1.12/info").done(function(i){var t=i&&JSON.parse(i);a=n.channel({payload:"fslist1",path:t["DockerRootDir"],superuser:"try"});e(a).on("message",function(e,n){g()});e(a).on("close",function(e,n){if(n.problem&&n.problem!="not-found")console.warn("monitor for docker directory failed: "+n.problem)});e(r).triggerHandler("event")}).fail(function(n){if(n!="not-found")console.warn("monitor for docker directory failed: "+n);e(r).triggerHandler("event")});v=n.metrics(1e3,{source:"internal",metrics:[{name:"cgroup.memory.usage",units:"bytes"},{name:"cgroup.cpu.usage",units:"millisec",derive:"rate"},{name:"cgroup.memory.limit",units:"bytes"},{name:"cgroup.cpu.shares",units:"count"}]});y=n.grid(1e3,-1,-0);y.walk();e(y).on("notify",function(e,n,i){S()})}var j=/docker-([A-Fa-f0-9]{64})\.scope/;var J=/.*\/ctr-(.+).service/;this.container_from_cgroup=R;function R(e){var n=j.exec(e);if(n)return n[1];n=J.exec(e);if(n)return p[n[1]];return null}this.cgroup_from_container=G;function G(e){return"system.slice/docker-"+e+".scope"}function I(n){if(n in r.containers)e(r).trigger("container",[n,r.containers[n]]);else if(n in r.images)e(r).trigger("image",[n,r.images[n]])}function q(e,n){if(e in r.waiting){r.waiting[e]++}else{r.waiting[e]=1;I(e)}}function P(e){r.waiting[e]--;if(r.waiting[e]===0){delete r.waiting[e];I(e)}}U();this.start=function x(e,n){q(e);i.docker_debug("starting:",e);return c.request({method:"POST",path:"/v1.12/containers/"+encodeURIComponent(e)+"/start",headers:{"Content-Type":"application/json"},body:JSON.stringify(n||{})}).fail(function(n){i.docker_debug("start failed:",e,n)}).done(function(n){i.docker_debug("started:",e,n)}).always(function(){P(e)})};this.stop=function D(e,n){q(e);if(n===undefined)n=10;i.docker_debug("stopping:",e,n);return c.request({method:"POST",path:"/v1.12/containers/"+encodeURIComponent(e)+"/stop",params:{t:n},body:""}).fail(function(n){i.docker_debug("stop failed:",e,n)}).done(function(n){i.docker_debug("stopped:",e,n)}).always(function(){P(e)})};this.restart=function L(e,n){q(e);if(n===undefined)n=10;i.docker_debug("restarting:",e);return c.request({method:"POST",path:"/v1.12/containers/"+encodeURIComponent(e)+"/restart",params:{t:n},body:""}).fail(function(n){i.docker_debug("restart failed:",e,n)}).done(function(n){i.docker_debug("restarted:",e,n)}).always(function(){P(e)})};this.create=function M(e,n){i.docker_debug("creating:",e);return c.request({method:"POST",path:"/v1.12/containers/create",params:{name:e},headers:{"Content-Type":"application/json"},body:JSON.stringify(n||{})}).fail(function(n){i.docker_debug("create failed:",e,n)}).done(function(n){i.docker_debug("created:",e,n)}).then(JSON.parse)};this.search=function F(e){i.docker_debug("searching:",e);return c.get("/v1.12/images/search",{term:e}).fail(function(n){i.docker_debug("search failed:",e,n)}).done(function(n){i.docker_debug("searched:",e,n)})};this.commit=function H(n,t,r,o){var a={container:n,repo:t};e.extend(a,r);q(n);i.docker_debug("committing:",n,t,r,o);return c.request({method:"POST",path:"/v1.12/commit",params:a,headers:{"Content-Type":"application/json"},body:JSON.stringify(o||{})}).fail(function(e){i.docker_debug("commit failed:",t,e)}).done(function(e){i.docker_debug("committed:",t)}).always(function(){P(n)}).then(JSON.parse)};this.rm=function A(e,n){if(n===undefined)n=false;q(e);i.docker_debug("deleting:",e);return c.request({method:"DELETE",path:"/v1.12/containers/"+encodeURIComponent(e),params:{force:n},body:""}).fail(function(n){i.docker_debug("delete failed:",e,n)}).done(function(n){i.docker_debug("deleted:",e,n);C(e)}).always(function(){P(e)})};this.rmi=function z(e){q(e);i.docker_debug("deleting:",e);return c.request({method:"DELETE",path:"/v1.12/images/"+encodeURIComponent(e),body:""}).fail(function(n){i.docker_debug("delete failed:",e,n)}).done(function(n){i.docker_debug("deleted:",e,n);T(e)}).always(function(){P(e)})};function E(e,t,r,o){var a="/sys/fs/cgroup/"+e+"/"+t+"/"+r;var c="echo '"+o.toFixed(0)+"' > "+a;i.docker_debug("changing cgroup:",c);n.spawn(["sh","-c",c]).fail(function(e){console.warn(e)})}this.change_memory_limit=function B(e,n){if(n===undefined||n<=0)n=-1;return E("memory",this.containers[e].CGroup,"memory.limit_in_bytes",n)};this.change_swap_limit=function K(e,n){if(n===undefined||n<=0)n=-1;return E("memory",this.containers[e].CGroup,"memory.memsw.limit_in_bytes",n)};this.change_cpu_priority=function Q(e,n){if(n===undefined||n<=0)n=1024;return E("cpuacct",this.containers[e].CGroup,"cpu.shares",n)};this.machine_info=function V(){return t.util.machine_info()};this.info=function W(){return c.get("/v1.12/info").fail(function(e){i.docker_debug("info failed:",e)}).done(function(e){i.docker_debug("info:",e)})};this.close=function X(){if(v){v.close();y.close()}u=null};this.connect=function Y(){if(!u)U();return u.promise()};this.maybe_reconnect=function Z(){if(s){this.close();U()}return u.promise()}}return{init:function(){return new r}}});
