define(["jquery","base1/cockpit","docker/util","shell/shell","shell/cockpit-plot","shell/cockpit-util"],function(e,n,i,t){function o(){var o=this;var r;var a;var c;var u;var s;var f=true;var d;function g(){if(!d){d=window.setTimeout(function(){d=null;e(o).trigger("event")},300)}}function l(){r=c.get("/v1.12/events");r.stream(function(e){i.docker_debug("event:",e);if(u.state()=="pending")u.resolve();g()}).always(function(){window.setTimeout(function(){if(f&&r){l();f=false}},1e3)})}this.containers={};this.images={};this.waiting={};var m={};var p={};var h={};var v;var y;var _={};function b(e){if(!e.Name)return null;var n=e.Name;if(n[0]==="/")n=n.substring(1);return n}function k(n,i){if(i.State===undefined)i.State={};if(i.Config===undefined)i.Config={};e.extend(i,m[n]);var t=b(i);if(t)p[t]=n;if(!i.CGroup)i.CGroup=G(n)}function C(n){var i=o.containers[n];if(i){var t=b(i);if(t&&p[t]==n)delete p[t];delete o.containers[n];e(o).trigger("container",[n,undefined])}}function w(){c.get("/v1.12/containers/json",{all:1}).done(function(n){var i=JSON.parse(n);if(u.state()=="pending")u.resolve();f=true;var t={};e(i).each(function(n,i){var r=i.Id;if(!r)return;t[r]=r;m[r]=i;c.get("/v1.12/containers/"+encodeURIComponent(r)+"/json").done(function(n){var i=JSON.parse(n);k(r,i);o.containers[r]=i;_[r]=[y.add(v,["cgroup.memory.usage",i.CGroup]),y.add(v,["cgroup.cpu.usage",i.CGroup]),y.add(v,["cgroup.memory.limit",i.CGroup]),y.add(v,["cgroup.cpu.shares",i.CGroup])];e(o).trigger("container",[r,i])})});var r=[];e.each(o.containers,function(e){if(!t[e])r.push(e)});e.each(r,function(e,n){C(n)})}).fail(function(n){if(u.state()=="pending")u.reject(n);s=true;e(o).trigger("failure",[n])})}function S(){for(var n in _){var i=o.containers[n];if(!i)continue;var t=_[n];var r=t[0][0];var a=t[2][0];if(a>1115e15)a=undefined;var c=t[1][0]/10;var u=t[3][0];if(r!=i.MemoryUsage||a!=i.MemoryLimit||c!=i.CpuUsage||u!=i.CpuPriority){i.MemoryUsage=r;i.MemoryLimit=a;i.CpuUsage=c;i.CpuPriority=u;e(o).trigger("container",[n,i])}}}function O(n,i){if(i.Config===undefined){if(i.ContainerConfig)i.Config=i.ContainerConfig;else i.Config={}}e.extend(i,h[n]);if(i.RepoTags)i.RepoTags.sort()}function T(n){if(o.images[n]){delete o.images[n];e(o).trigger("image",[n,undefined])}}function N(){c.get("/v1.12/images/json").done(function(n){var i=JSON.parse(n);if(u.state()=="pending")u.resolve();f=true;var t={};e.each(i,function(n,i){var r=i.Id;if(!r)return;t[r]=r;h[r]=i;c.get("/v1.12/images/"+encodeURIComponent(r)+"/json").done(function(n){var i=JSON.parse(n);O(r,i);o.images[r]=i;e(o).trigger("image",[r,i])})});var r=[];e.each(o.images,function(e){if(!t[e])r.push(e)});e.each(r,function(e,n){T(n)})}).fail(function(n){if(u.state()=="pending")u.reject(n);s=true;e(o).trigger("failure",[n])})}e(o).on("event",function(){w();N()});function U(){s=false;u=e.Deferred();c=n.http("/var/run/docker.sock",{superuser:"try"});l();if(a&&a.valid)a.close();c.get("/v1.12/info").done(function(i){var t=i&&JSON.parse(i);a=n.channel({payload:"fslist1",path:t["DockerRootDir"],superuser:"try"});e(a).on("message",function(e,n){g()});e(a).on("close",function(e,n){if(n.problem&&n.problem!="not-found")console.warn("monitor for docker directory failed: "+n.problem)});e(o).triggerHandler("event")}).fail(function(n){if(n!="not-found")console.warn("monitor for docker directory failed: "+n);e(o).triggerHandler("event")});v=n.metrics(1e3,{source:"internal",metrics:[{name:"cgroup.memory.usage",units:"bytes"},{name:"cgroup.cpu.usage",units:"millisec",derive:"rate"},{name:"cgroup.memory.limit",units:"bytes"},{name:"cgroup.cpu.shares",units:"count"}]});y=n.grid(1e3,-1,-0);y.walk();e(y).on("notify",function(e,n,i){S()})}var j=/docker-([A-Fa-f0-9]{64})\.scope/;var J=/.*\/ctr-(.+).service/;this.container_from_cgroup=R;function R(e){var n=j.exec(e);if(n)return n[1];n=J.exec(e);if(n)return p[n[1]];return null}this.cgroup_from_container=G;function G(e){return"system.slice/docker-"+e+".scope"}function I(n){if(n in o.containers)e(o).trigger("container",[n,o.containers[n]]);else if(n in o.images)e(o).trigger("image",[n,o.images[n]])}function q(e,n){if(e in o.waiting){o.waiting[e]++}else{o.waiting[e]=1;I(e)}}function x(e){o.waiting[e]--;if(o.waiting[e]===0){delete o.waiting[e];I(e)}}U();this.start=function P(e,n){q(e);i.docker_debug("starting:",e);return c.request({method:"POST",path:"/v1.12/containers/"+encodeURIComponent(e)+"/start",headers:{"Content-Type":"application/json"},body:JSON.stringify(n||{})}).fail(function(n){i.docker_debug("start failed:",e,n)}).done(function(n){i.docker_debug("started:",e,n)}).always(function(){x(e)})};this.stop=function D(e,n){q(e);if(n===undefined)n=10;i.docker_debug("stopping:",e,n);return c.request({method:"POST",path:"/v1.12/containers/"+encodeURIComponent(e)+"/stop",params:{t:n},body:""}).fail(function(n){i.docker_debug("stop failed:",e,n)}).done(function(n){i.docker_debug("stopped:",e,n)}).always(function(){x(e)})};this.restart=function L(e){q(e);i.docker_debug("restarting:",e);return c.post("/v1.12/containers/"+encodeURIComponent(e)+"/restart").fail(function(n){i.docker_debug("restart failed:",e,n)}).done(function(n){i.docker_debug("restarted:",e,n)}).always(function(){x(e)})};this.create=function M(e,n){i.docker_debug("creating:",e);return c.request({method:"POST",path:"/v1.12/containers/create",params:{name:e},headers:{"Content-Type":"application/json"},body:JSON.stringify(n||{})}).fail(function(n){i.docker_debug("create failed:",e,n)}).done(function(n){i.docker_debug("created:",e,n)}).then(JSON.parse)};this.search=function F(e){i.docker_debug("searching:",e);return c.get("/v1.12/images/search",{term:e}).fail(function(n){i.docker_debug("search failed:",e,n)}).done(function(n){i.docker_debug("searched:",e,n)})};this.commit=function H(n,t,o,r){var a={container:n,repo:t};e.extend(a,o);q(n);i.docker_debug("committing:",n,t,o,r);return c.request({method:"POST",path:"/v1.12/commit",params:a,headers:{"Content-Type":"application/json"},body:JSON.stringify(r||{})}).fail(function(e){i.docker_debug("commit failed:",t,e)}).done(function(e){i.docker_debug("committed:",t)}).always(function(){x(n)}).then(JSON.parse)};this.rm=function A(e,n){if(n===undefined)n=false;q(e);i.docker_debug("deleting:",e);return c.request({method:"DELETE",path:"/v1.12/containers/"+encodeURIComponent(e),params:{force:n},body:""}).fail(function(n){i.docker_debug("delete failed:",e,n)}).done(function(n){i.docker_debug("deleted:",e,n);C(e)}).always(function(){x(e)})};this.rmi=function z(e){q(e);i.docker_debug("deleting:",e);return c.request({method:"DELETE",path:"/v1.12/images/"+encodeURIComponent(e),body:""}).fail(function(n){i.docker_debug("delete failed:",e,n)}).done(function(n){i.docker_debug("deleted:",e,n);T(e)}).always(function(){x(e)})};function E(e,t,o,r){var a="/sys/fs/cgroup/"+e+"/"+t+"/"+o;var c="echo '"+r.toFixed(0)+"' > "+a;i.docker_debug("changing cgroup:",c);n.spawn(["sh","-c",c]).fail(function(e){console.warn(e)})}this.change_memory_limit=function B(e,n){if(n===undefined||n<=0)n=-1;return E("memory",this.containers[e].CGroup,"memory.limit_in_bytes",n)};this.change_swap_limit=function K(e,n){if(n===undefined||n<=0)n=-1;return E("memory",this.containers[e].CGroup,"memory.memsw.limit_in_bytes",n)};this.change_cpu_priority=function Q(e,n){if(n===undefined||n<=0)n=1024;return E("cpuacct",this.containers[e].CGroup,"cpu.shares",n)};this.machine_info=function V(){return t.util.machine_info()};this.info=function W(){return c.get("/v1.12/info").fail(function(e){i.docker_debug("info failed:",e)}).done(function(e){i.docker_debug("info:",e)})};this.close=function X(){if(v){v.close();y.close()}u=null};this.connect=function Y(){if(!u)U();return u.promise()};this.maybe_reconnect=function Z(){if(s){this.close();U()}return u.promise()}}return{init:function(){return new o}}});
