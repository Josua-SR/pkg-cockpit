define(["jquery","base1/cockpit","base1/mustache","docker/util","base1/bootstrap-select"],function(e,n,r,i){var t=n.gettext;var o=n.gettext;a.prototype={_init:function(){this.error_timeout=null;this.id="containers_run_image_dialog"},setup:function(){e("#containers-run-image-run").on("click",e.proxy(this,"run"));e("#containers-run-image-command").on("keydown",e.proxy(this,"update","keydown","command"));e("#containers-run-image-command").on("input",e.proxy(this,"update","input","command"));e("#containers-run-image-command").on("focusout change",e.proxy(this,"update","changeFocus","command"));this.memory_slider=new i.MemorySlider(e("#containers-run-image-memory"),10*1024*1024,2*1024*1024*1024);this.cpu_slider=new i.CpuSlider(e("#containers-run-image-cpu"),2,1e6);var n=e("#containers_run_image_dialog .modal-body table");var r=this.port_renderer();var t=this;e("#expose-ports").on("change",function(){var n=e("#select-exposed-ports");if(e(this).prop("checked")){if(n.children().length===0){r()}n.show()}else{n.hide()}t.update("changeFocus","ports")});var o=this.link_renderer();e("#link-containers").change(function(){var n=e("#select-linked-containers");if(e(this).prop("checked")){if(n.children().length===0){o()}n.show()}else{n.hide()}t.update("changeFocus","links")});this.validator=this.configuration_validator()},update:function(e,n){if(this.perform_checks!==true&&e!=="clear")return;this.validator(e,n)},enter:function(){var n=this;var r=a.image_info;i.docker_debug("run-image",r);var t;var o;a.client.machine_info().done(function(e){n.memory_slider.max=e.memory});n.containers=[];var s;for(s in a.client.containers){n.containers.push(i.render_container_name(a.client.containers[s].Name))}this.perform_checks=false;this.update("clear");e("#select-linked-containers").empty();e("#link-containers").prop("checked",false);if(r.ContainerConfig.Memory){this.memory_slider.value=r.ContainerConfig.Memory}else{this.memory_slider.value=512*1024*1024;this.memory_slider.value=undefined}if(r.ContainerConfig.CpuShares){this.cpu_slider.value=r.ContainerConfig.CpuShares}else{this.cpu_slider.value=1024;this.cpu_slider.value=undefined}var c=["happy","jolly","dreamy","sad","angry","pensive","focused","sleepy","grave","distracted","determined","stoic","stupefied","sharp","agitated","cocky","tender","goofy","furious","desperate","hopeful","compassionate","silly","lonely","condescending","naughty","kickass","drunk","boring","nostalgic","ecstatic","insane","cranky","mad","jovial","sick","hungry","thirsty","elegant","backstabbing","clever","trusting","loving","suspicious","berserk","high","romantic","prickly","evil"];var l=["lovelace","franklin","tesla","einstein","bohr","davinci","pasteur","nobel","curie","darwin","turing","ritchie","torvalds","pike","thompson","wozniak","galileo","euclid","newton","fermat","archimedes","poincare","heisenberg","feynman","hawking","fermi","pare","mccarthy","engelbart","babbage","albattani","ptolemy","bell","wright","lumiere","morse","mclean","brown","bardeen","brattain","shockley"];function u(){function e(e){return e[Math.round(Math.random()*(e.length-1))]}return e(c)+"_"+e(l)}e("#containers-run-image").text(a.image_info.RepoTags[0]);e("#containers-run-image-name").val(u());var d=e("#containers-run-image-command");d.val(i.quote_cmdline(a.image_info.Config.Cmd));var p=e("#select-exposed-ports");p.empty();var f=this.port_renderer();for(var h in a.image_info.Config.ExposedPorts)f(parseInt(h),h.slice(-3),false);if(p.children().length>0){e("#expose-ports").prop("checked",true);p.show()}else{e("#expose-ports").prop("checked",false)}},configuration_validator:function(){var n=this;function r(){e("#containers-run-image-run").prop("disabled",e("#containers_run_image_dialog").find(".has-error").length>0)}function i(n,r){if(r===undefined)return e(n.closest(".form-inline").find(".help-block"));else return e(n.closest(".form-inline").find(".help-block")[r])}function o(e){if(e===undefined)return"";else if(e===0)return t("Container")+": ";else return t("Host")+": "}function a(e,n,r,t){e.parent().addClass(n);var a=i(e,t);a.text(o(t)+r);var s=a.parent();s.addClass(n);s.show()}function s(e,n){e.parent().removeClass("has-error");var r=i(e,n).parent();r.removeClass("has-error");r.hide()}function c(e,n,r,i){var o=e[r];var c=o.val();s(o,i);if(c==="")return;if(/\D/.test(c)||c<0||c>65535){a(o,"has-error",t("Invalid port"),i);return}for(var l=0;l<e.length;++l){if(l===r)continue;var u=e[l];if(c===u.val()&&n[r]===n[l]){a(o,"has-error",t("Duplicate port"),i);return}}}function l(){e("#select-exposed-ports").children("form").each(function(){var n=e(this);var r=n.find("input");r=[e(r[0]),e(r[1])];s(r[0],0);s(r[1],1)})}function u(){if(!e("#expose-ports").prop("checked")){l();r();return}var n={container:[],host:[],protocol:[]};e("#select-exposed-ports").children("form").each(function(){var r=e(this);var i=r.find("input");i=[e(i[0]),e(i[1])];if(i[0].val()!==""||i[1].val()!==""){n.container.push(i[0]);n.host.push(i[1]);n.protocol.push(r.find("select").val().toLowerCase())}else{s(i[0],0);s(i[1],1)}});for(var i=0;i<n.container.length;++i){c(n.container,n.protocol,i,0);c(n.host,n.protocol,i,1)}r()}function d(){e("#containers-run-image-command-note").hide();e("#containers-run-image-command").parent().removeClass("has-error")}function p(){if(e("#containers-run-image-command").val()===""){e("#containers-run-image-command-note").show();e("#containers-run-image-command").parent().addClass("has-error")}else{d()}r()}function f(e,n,r,t){e.parent().addClass(n);var o=i(e,t);o.text(r);var a=o.parent();a.addClass(n);a.show()}function h(e,n){var r=e[n];var i=r.val();s(r,1);if(i===""){f(r,"has-error",t("No alias specified"),1);return}for(var o=0;o<e.length;++o){if(o===n)continue;var a=e[o];if(i===a.val()){f(r,"has-error",t("Duplicate alias"),1);return}}}function m(){e("#select-linked-containers").children("form").each(function(){var n=e(this);var r=n.find("select");var i=n.find('input[name="alias"]');s(r,0);s(i,1)})}function v(){if(!e("#link-containers").prop("checked")){m();r();return}var n=[];var i=[];e("#select-linked-containers").children("form").each(function(){var r=e(this);var i=r.find("select");var o=r.find('input[name="alias"]');if(o.val()!==""||i.val()!==""){if(i.val()==="")f(i,"has-error",t("No container specified"),0);else s(i,0);n.push(o)}else{s(i,0);s(o,1)}});for(var o=0;o<n.length;++o)h(n,o);r()}function g(e,i){window.clearTimeout(n.error_timeout);n.error_timeout=null;if(e==="clear"){d();l();m();r()}else if(e==="all"){p();u();v()}else if(e==="changeFocus"||e==="changeOption"){if(i==="command")p();else if(i==="ports")u();else if(i==="links")v()}else if(e==="input"||e==="keydown"){if(i==="command")n.error_timeout=window.setTimeout(p,2e3);else if(i==="ports")n.error_timeout=window.setTimeout(u,2e3);else if(i==="links")n.error_timeout=window.setTimeout(v,2e3);n.setTimeout=null}}return g},port_renderer:function(){var n=this;var i=e("#port-expose-tmpl").html();r.parse(i);function o(){s()}function a(r){var i=e(r.target).closest("form");i.remove();if(e("#select-exposed-ports").children().length===0){e("#expose-ports").attr("checked",false)}n.validator("changeFocus","ports")}function s(s,c,l){if(s===undefined)s="";if(c===undefined)c="TCP";if(l===undefined)l=true;var u=e(r.render(i,{host_port_label:t("to host port"),placeholder:t("none")}));u.children("button.fa-plus").on("click",o);if(l){u.children("button.pficon-close").on("click",a)}else{u.children("button.pficon-close").attr("disabled",true)}var d=u.find('input[name="container"]');d.val(s);if(l){d.on("keydown",e.proxy(n,"update","keydown","ports"));d.on("input",e.proxy(n,"update","input","ports"));d.on("focusout change",e.proxy(n,"update","changeFocus","ports"))}else{d.attr("disabled",true)}var p=u.find('input[name="host"]');p.on("keydown",e.proxy(n,"update","keydown","ports"));p.on("input",e.proxy(n,"update","input","ports"));p.on("focusout change",e.proxy(n,"update","changeFocus","ports"));var f=u.find("div select.selectpicker");if(l){f.on("change",e.proxy(n,"update","changeOption","ports"))}else{f.attr("disabled",true)}f.selectpicker("refresh");if(c.toUpperCase()===t("UDP"))f.selectpicker("val",t("UDP"));else f.selectpicker("val",t("TCP"));e("#select-exposed-ports").append(u)}return s},link_renderer:function(){var n=this;var i=e("#container-link-tmpl").html();r.parse(i);function o(){s()}function a(r){var i=e(r.target).closest("form");i.remove();if(e("#select-linked-containers").children().length===0){e("#link-containers").attr("checked",false)}n.update("changeFocus","links")}function s(){var s=e(r.render(i,{containers:n.containers,alias_label:t("alias"),placeholder:t("none")}));s.children("button.fa-plus").on("click",o);s.children("button.pficon-close").on("click",a);var c=s.find("input");c.on("keydown",e.proxy(n,"update","keydown","links"));c.on("input",e.proxy(n,"update","input","links"));c.on("focusout change",e.proxy(n,"update","changeFocus","links"));var l=s.find("div select.selectpicker");l.on("change",e.proxy(n,"update","changeOption","links"));l.selectpicker("refresh");e("#select-linked-containers").append(s)}return s},run:function(){this.perform_checks=true;this.update("all");if(e("#containers-run-image-run").prop("disabled"))return;var n=e("#containers-run-image-name").val();var r=e("#containers-run-image-command").val();var t={};var o,s;var c,l,u;var d=[];var p={};if(e("#expose-ports").prop("checked")){e("#select-exposed-ports").children("form").each(function(){var n=e(this).find("input").map(function(n,r){return e(r).val()}).get();c=n[0];l=n[1];u=e(this).find("select").val().toLowerCase();if(c===""||l==="")return;t[c+"/"+u]=[{HostPort:l}];p[c+"/"+u]={}})}if(e("#link-containers").prop("checked")){e("#select-linked-containers form").each(function(){var n=e(this);var r=n.find('select[name="container"]').val();var i=n.find('input[name="alias"]').val();if(!r||!i){return}d.push(r+":"+i)})}e("#containers_run_image_dialog").modal("hide");var f=e("#containers-run-image-with-terminal").prop("checked");var h={Cmd:i.unquote_cmdline(r),Image:a.image_info.Id,Memory:this.memory_slider.value||0,MemorySwap:this.memory_slider.value*2||0,CpuShares:this.cpu_slider.value||0,Tty:f,ExposedPorts:p,HostConfig:{Links:d}};if(f){e.extend(h,{AttachStderr:true,AttachStdin:true,AttachStdout:true,OpenStdin:true,StdinOnce:true})}a.client.create(n,h).fail(function(e){i.show_unexpected_error(e)}).done(function(e){a.client.start(e.Id,{PortBindings:t}).fail(function(e){i.show_unexpected_error(e)})})}};function a(){this._init()}var s=new a;s.setup();function c(n,r){a.image_info=n.images[r];a.client=n;s.enter();e("#containers_run_image_dialog").modal("show")}return c});
