define(["jquery","base1/cockpit","base1/mustache","docker/util"],function(e,n,r,t){var i=n.gettext;o.prototype={_init:function(){this.error_timeout=null;this.id="containers_run_image_dialog"},setup:function(){e("#containers-run-image-run").on("click",e.proxy(this,"run"));e("#containers-run-image-command").on("keydown",e.proxy(this,"update","keydown","command"));e("#containers-run-image-command").on("input",e.proxy(this,"update","input","command"));e("#containers-run-image-command").on("focusout change",e.proxy(this,"update","changeFocus","command"));this.memory_slider=new t.MemorySlider(e("#containers-run-image-memory"),10*1024*1024,2*1024*1024*1024);this.cpu_slider=new t.CpuSlider(e("#containers-run-image-cpu"),2,1e6);var n=e("#containers_run_image_dialog .modal-body table");var r=this.port_renderer();var i=this;e("#expose-ports").on("change",function(){var n=e("#select-exposed-ports");if(e(this).prop("checked")){if(n.children().length===0){r()}n.show()}else{n.hide()}i.update("changeFocus","ports")});var o=this.link_renderer();e("#link-containers").change(function(){var n=e("#select-linked-containers");if(e(this).prop("checked")){if(n.children().length===0){o()}n.show()}else{n.hide()}i.update("changeFocus","links")});this.validator=this.configuration_validator()},update:function(e,n){if(this.perform_checks!==true&&e!=="clear")return;this.validator(e,n)},enter:function(){var n=this;var r=o.image_info;t.docker_debug("run-image",r);var i;var a;o.client.machine_info().done(function(e){n.memory_slider.max=e.memory});n.containers=[];var s;for(s in o.client.containers){n.containers.push(t.render_container_name(o.client.containers[s].Name))}this.perform_checks=false;this.update("clear");e("#select-linked-containers").empty();e("#link-containers").prop("checked",false);if(r.ContainerConfig.Memory){this.memory_slider.value=r.ContainerConfig.Memory}else{this.memory_slider.value=512*1024*1024;this.memory_slider.value=undefined}if(r.ContainerConfig.CpuShares){this.cpu_slider.value=r.ContainerConfig.CpuShares}else{this.cpu_slider.value=1024;this.cpu_slider.value=undefined}var c=["happy","jolly","dreamy","sad","angry","pensive","focused","sleepy","grave","distracted","determined","stoic","stupefied","sharp","agitated","cocky","tender","goofy","furious","desperate","hopeful","compassionate","silly","lonely","condescending","naughty","kickass","drunk","boring","nostalgic","ecstatic","insane","cranky","mad","jovial","sick","hungry","thirsty","elegant","backstabbing","clever","trusting","loving","suspicious","berserk","high","romantic","prickly","evil"];var l=["lovelace","franklin","tesla","einstein","bohr","davinci","pasteur","nobel","curie","darwin","turing","ritchie","torvalds","pike","thompson","wozniak","galileo","euclid","newton","fermat","archimedes","poincare","heisenberg","feynman","hawking","fermi","pare","mccarthy","engelbart","babbage","albattani","ptolemy","bell","wright","lumiere","morse","mclean","brown","bardeen","brattain","shockley"];function u(){function e(e){return e[Math.round(Math.random()*(e.length-1))]}return e(c)+"_"+e(l)}e("#containers-run-image").text(o.image_info.RepoTags[0]);e("#containers-run-image-name").val(u());var d=e("#containers-run-image-command");d.val(t.quote_cmdline(o.image_info.Config.Cmd));var p=e("#select-exposed-ports");p.empty();var f=this.port_renderer();for(var h in o.image_info.Config.ExposedPorts)f(parseInt(h),h.slice(-3),false);if(p.children().length>0){e("#expose-ports").prop("checked",true);p.show()}else{e("#expose-ports").prop("checked",false)}},configuration_validator:function(){var n=this;function r(){e("#containers-run-image-run").prop("disabled",e("#containers_run_image_dialog").find(".has-error").length>0)}function t(n,r){if(r===undefined)return e(n.closest(".form-inline").find(".help-block"));else return e(n.closest(".form-inline").find(".help-block")[r])}function o(e){if(e===undefined)return"";else if(e===0)return i("Container")+": ";else return i("Host")+": "}function a(e,n,r,i){e.parent().addClass(n);var a=t(e,i);a.text(o(i)+r);var s=a.parent();s.addClass(n);s.show()}function s(e,n){e.parent().removeClass("has-error");var r=t(e,n).parent();r.removeClass("has-error");r.hide()}function c(e,n,r,t){var o=e[r];var c=o.val();s(o,t);if(c==="")return;if(/\D/.test(c)||c<0||c>65535){a(o,"has-error",i("Invalid port"),t);return}for(var l=0;l<e.length;++l){if(l===r)continue;var u=e[l];if(c===u.val()&&n[r]===n[l]){a(o,"has-error",i("Duplicate port"),t);return}}}function l(){e("#select-exposed-ports").children("form").each(function(){var n=e(this);var r=n.find("input");r=[e(r[0]),e(r[1])];s(r[0],0);s(r[1],1)})}function u(){if(!e("#expose-ports").prop("checked")){l();r();return}var n={container:[],host:[],protocol:[]};e("#select-exposed-ports").children("form").each(function(){var r=e(this);var t=r.find("input");t=[e(t[0]),e(t[1])];if(t[0].val()!==""||t[1].val()!==""){n.container.push(t[0]);n.host.push(t[1]);n.protocol.push(r.find("button span").text().toLowerCase())}else{s(t[0],0);s(t[1],1)}});for(var t=0;t<n.container.length;++t){c(n.container,n.protocol,t,0);c(n.host,n.protocol,t,1)}r()}function d(){e("#containers-run-image-command-note").hide();e("#containers-run-image-command").parent().removeClass("has-error")}function p(){if(e("#containers-run-image-command").val()===""){e("#containers-run-image-command-note").show();e("#containers-run-image-command").parent().addClass("has-error")}else{d()}r()}function f(e,n,r,i){e.parent().addClass(n);var o=t(e,i);o.text(r);var a=o.parent();a.addClass(n);a.show()}function h(e,n){var r=e[n];var t=r.val();s(r,1);if(t===""){f(r,"has-error",i("No alias specified"),1);return}for(var o=0;o<e.length;++o){if(o===n)continue;var a=e[o];if(t===a.val()){f(r,"has-error",i("Duplicate alias"),1);return}}}function m(){e("#select-linked-containers").children("form").each(function(){var n=e(this);var r=n.find("select");var t=n.find('input[name="alias"]');s(r,0);s(t,1)})}function v(){if(!e("#link-containers").prop("checked")){m();r();return}var n=[];var t=[];e("#select-linked-containers").children("form").each(function(){var r=e(this);var t=r.find("button span");var o=t[0].nodeValue;var a=r.find('input[name="alias"]');if(a.val()!==""||o!==""){if(o==="")f(t,"has-error",i("No container specified"),0);else s(t,0);n.push(a)}else{s(t,0);s(a,1)}});for(var o=0;o<n.length;++o)h(n,o);r()}function g(e,t){window.clearTimeout(n.error_timeout);n.error_timeout=null;if(e==="clear"){d();l();m();r()}else if(e==="all"){p();u();v()}else if(e==="changeFocus"||e==="changeOption"){if(t==="command")p();else if(t==="ports")u();else if(t==="links")v()}else if(e==="input"||e==="keydown"){if(t==="command")n.error_timeout=window.setTimeout(p,2e3);else if(t==="ports")n.error_timeout=window.setTimeout(u,2e3);else if(t==="links")n.error_timeout=window.setTimeout(v,2e3);n.setTimeout=null}}return g},port_renderer:function(){var n=this;var t=e("#port-expose-tmpl").html();r.parse(t);function o(){s()}function a(r){var t=e(r.target).closest("form");t.remove();if(e("#select-exposed-ports").children().length===0){e("#expose-ports").attr("checked",false)}n.validator("changeFocus","ports")}function s(s,c,l){if(s===undefined)s="";if(c===undefined)c="TCP";if(l===undefined)l=true;var u=e(r.render(t,{host_port_label:i("to host port"),placeholder:i("none")}));u.children("button.fa-plus").on("click",o);if(l){u.children("button.pficon-close").on("click",a)}else{u.children("button.pficon-close").attr("disabled",true)}var d=u.find('input[name="container"]');d.val(s);if(l){d.on("keydown",e.proxy(n,"update","keydown","ports"));d.on("input",e.proxy(n,"update","input","ports"));d.on("focusout change",e.proxy(n,"update","changeFocus","ports"))}else{d.attr("disabled",true)}var p=u.find('input[name="host"]');p.on("keydown",e.proxy(n,"update","keydown","ports"));p.on("input",e.proxy(n,"update","input","ports"));p.on("focusout change",e.proxy(n,"update","changeFocus","ports"));var f=u.find("div .port-expose-protocol");if(l){f.find("a").on("click",function(){f.find("button span").text(e(this).text());n.update("changeOption","ports")})}else{f.attr("disabled",true)}f.find("button span").text(c.toUpperCase());e("#select-exposed-ports").append(u)}return s},link_renderer:function(){var n=this;var t=e("#container-link-tmpl").html();r.parse(t);function o(){s()}function a(r){var t=e(r.target).closest("form");t.remove();if(e("#select-linked-containers").children().length===0){e("#link-containers").attr("checked",false)}n.update("changeFocus","links")}function s(){var s=e(r.render(t,{containers:n.containers,alias_label:i("alias"),placeholder:i("none")}));s.children("button.fa-plus").on("click",o);s.children("button.pficon-close").on("click",a);var c=s.find("input");c.on("keydown",e.proxy(n,"update","keydown","links"));c.on("input",e.proxy(n,"update","input","links"));c.on("focusout change",e.proxy(n,"update","changeFocus","links"));var l=s.find("div .link-container");l.find("a").on("click",function(){l.find("button span").text(e(this).text());n.update("changeOption","links")});e("#select-linked-containers").append(s)}return s},run:function(){this.perform_checks=true;this.update("all");if(e("#containers-run-image-run").prop("disabled"))return;var n=e("#containers-run-image-name").val();var r=e("#containers-run-image-command").val();var i={};var a,s;var c,l,u;var d=[];var p={};if(e("#expose-ports").prop("checked")){e("#select-exposed-ports").children("form").each(function(){var n=e(this).find("input").map(function(n,r){return e(r).val()}).get();c=n[0];l=n[1];u=e(this).find("button span").text().toLowerCase();if(c===""||l==="")return;i[c+"/"+u]=[{HostPort:l}];p[c+"/"+u]={}})}if(e("#link-containers").prop("checked")){e("#select-linked-containers form").each(function(){var n=e(this);var r=n.find("button span").text();var t=n.find('input[name="alias"]').val();if(!r||!t){return}d.push(r+":"+t)})}e("#containers_run_image_dialog").modal("hide");var f=e("#containers-run-image-with-terminal").prop("checked");var h={Cmd:t.unquote_cmdline(r),Image:o.image_info.Id,Memory:this.memory_slider.value||0,MemorySwap:this.memory_slider.value*2||0,CpuShares:this.cpu_slider.value||0,Tty:f,ExposedPorts:p,HostConfig:{Links:d}};if(f){e.extend(h,{AttachStderr:true,AttachStdin:true,AttachStdout:true,OpenStdin:true,StdinOnce:true})}o.client.create(n,h).fail(function(e){t.show_unexpected_error(e)}).done(function(e){o.client.start(e.Id,{PortBindings:i}).fail(function(e){t.show_unexpected_error(e)})})}};function o(){this._init()}var a=new o;a.setup();function s(n,r){o.image_info=n.images[r];o.client=n;a.enter();e("#containers_run_image_dialog").modal("show")}return s});
