define(["jquery","base1/cockpit","base1/mustache","docker/docker","docker/util"],function(t,n,e,i,a){var r=n.gettext;var o=n.gettext;c.prototype={_init:function(t){this.client=t;this.terminal=null},getTitle:function(){return o("page-title","Containers")},setup:function(){var e=this;t("#container-details .breadcrumb a").on("click",function(){n.location.go("/")});t("#container-details-start").on("click",t.proxy(this,"start_container"));t("#container-details-stop").on("click",t.proxy(this,"stop_container"));t("#container-details-restart").on("click",t.proxy(this,"restart_container"));t("#container-details-delete").on("click",t.proxy(this,"delete_container"));e.memory_limit=new a.MemorySlider(t("#container-resources-dialog .memory-slider"),10*1024*1024,2*1024*1024*1024);e.cpu_priority=new a.CpuSlider(t("#container-resources-dialog .cpu-slider"),2,1e6);e.memory_usage=t("#container-details-memory .bar-row");t("#container-resources-dialog").on("show.bs.modal",function(){var n=e.client.containers[e.container_id];t(this).find(".container-name").text(e.name);e.memory_limit.value=n.MemoryLimit||undefined;e.cpu_priority.value=n.CpuPriority||undefined}).find(".btn-primary").on("click",function(){e.client.change_memory_limit(e.container_id,e.memory_limit.value);var t=e.memory_limit.value;if(!isNaN(t))t*=2;e.client.change_swap_limit(e.container_id,t);e.client.change_cpu_priority(e.container_id,e.cpu_priority.value)});var i=t("#container-commit-dialog")[0];t(i).on("show.bs.modal",function(){var r=e.client.containers[e.container_id];t(i).find(".container-name").text(e.name);var o=e.client.images[r.Config.Image];var c="";if(o&&o.RepoTags)c=o.RepoTags[0].split(":",1)[0];t(i).find(".container-repository").attr("value",c);t(i).find(".container-tag").attr("value","");var s=n.user["name"]||n.user["user"];t(i).find(".container-author").attr("value",s);var l="";if(r.Config)l=a.quote_cmdline(r.Config.Cmd);if(!l)l=r.Command;t(i).find(".container-command").attr("value",l)}).find(".btn-primary").on("click",function(){var r=n.location;var o={Cmd:a.unquote_cmdline(t(i).find(".container-command").val())};var c={author:t(i).find(".container-author").val()};var s=t(i).find(".container-tag").val();if(s)c["tag"]=s;var l=t(i).find(".container-repository").val();e.client.commit(e.container_id,l,c,o).fail(function(t){a.show_unexpected_error(t)}).done(function(){r.go("/")})})},enter:function(n){var e=this;t(this.client).off(".container-details");if(this.terminal){this.terminal.close();this.terminal=null}t("#container-terminal").hide();this.container_id=n;this.name=this.container_id.slice(0,12);this.client.machine_info().done(function(t){e.memory_limit.max=t.memory});t(this.client).on("container.container-details",function(t,n,i){if(n==e.container_id)e.update()});this.update()},maybe_show_terminal:function(n){if(!this.terminal){this.terminal=i.console(this.container_id,{tty:n.Config.Tty});t("#container-terminal").empty().append(this.terminal);this.terminal.connect()}this.terminal.typeable(n.State.Running);t("#container-terminal").show()},maybe_reconnect_terminal:function(){if(this.terminal&&!this.terminal.connected){this.terminal.connect();this.terminal.typeable(true)}},add_bindings:function(t,e){for(var i in e){var a=e[i];if(!a)continue;for(var o=0;o<a.length;o++){var c=a[o].HostIp;if(c==="")c="0.0.0.0";var s=n.format(r("${hip}:${hport} -> $cport"),{hip:c,hport:a[o].HostPort,cport:i});if(t.indexOf(s)===-1)t.push(s)}}return t},update:function(){t("#container-details-names").text("");t("#container-details-id").text("");t("#container-details-created").text("");t("#container-details-image").text("");t("#container-details-command").text("");t("#container-details-state").text("");t("#container-details-ports-row").hide();t("#container-details-links-row").hide();t("#container-details-resource-row").hide();var n=this.client.containers[this.container_id];a.docker_debug("container-details",this.container_id,n);if(!n){t("#container-details-names").text(r("Not found"));return}var e=!!this.client.waiting[this.container_id];t("#container-details div.spinner").toggle(e);t("#container-details button").toggle(!e);t("#container-details-start").prop("disabled",n.State.Running);t("#container-details-stop").prop("disabled",!n.State.Running);t("#container-details-restart").prop("disabled",!n.State.Running);t("#container-details-commit").prop("disabled",!!n.State.Running);t("#container-details-memory-row").toggle(!!n.State.Running);t("#container-details-cpu-row").toggle(!!n.State.Running);t("#container-details-resource-row").toggle(!!n.State.Running);this.name=a.render_container_name(n.Name);t("#container-details .breadcrumb .active").text(this.name);var i=[];if(n.NetworkSettings)this.add_bindings(i,n.NetworkSettings.Ports);if(n.HostConfig)this.add_bindings(i,n.HostConfig.PortBindings);t("#container-details-id").text(n.Id);t("#container-details-names").text(a.render_container_name(n.Name));t("#container-details-created").text(n.Created);t("#container-details-image").text(n.Image);t("#container-details-command").text(a.render_container_cmdline(n));t("#container-details-state").text(a.render_container_state(n.State));t("#container-details-ports-row").toggle(i.length>0);t("#container-details-ports").html(a.multi_line(i));this.update_links(n);a.update_memory_bar(this.memory_usage,n.MemoryUsage,n.MemoryLimit);t("#container-details-memory-text").text(a.format_memory_and_limit(n.MemoryUsage,n.MemoryLimit));t("#container-details .cpu-usage").text(a.format_cpu_usage(n.CpuUsage));t("#container-details .cpu-shares").text(a.format_cpu_shares(n.CpuPriority));this.maybe_show_terminal(n)},update_links:function(n){t("#container-details-links").empty();var e=n.HostConfig.Links;if(e){t("#container-details-links-row").toggle(true);t("#container-details-links").html(e.join("<br/>"))}},start_container:function(){var t=this;var n=this.container_id;this.client.start(this.container_id).fail(function(e){a.handle_scope_start_container(t.client,n,e.message,function(){t.maybe_reconnect_terminal()},null)}).done(function(){t.maybe_reconnect_terminal()})},stop_container:function(){this.client.stop(this.container_id).fail(function(t){a.show_unexpected_error(t)})},restart_container:function(){var t=this;this.client.restart(this.container_id).fail(function(t){a.show_unexpected_error(t)}).done(function(){t.maybe_reconnect_terminal()})},delete_container:function(){var t=this;var e=n.location;a.confirm(n.format(r("Please confirm deletion of $0"),t.name),r("Deleting a container will erase all data in it."),r("Delete")).done(function(){a.docker_container_delete(t.client,t.container_id,function(){e.go("/")},function(){})})}};function c(t){this._init(t)}function s(n){var e=new c(n);e.setup();function i(){t("#container-details").hide()}function a(n){e.enter(n);t("#container-details").show()}return{show:a,hide:i}}return{init:s}});
