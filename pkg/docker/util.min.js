define(["jquery","base1/cockpit","base1/mustache","docker/docker","shell/controls"],function(e,n,t,r,i){var o=n.gettext;var a=n.gettext;var c={};c.resource_debug=function l(){if(window.debugging=="all"||window.debugging=="resource")console.debug.apply(console,arguments)};c.docker_debug=function d(){if(window.debugging=="all"||window.debugging=="docker")console.debug.apply(console,arguments)};c.quote_cmdline=function s(e){return r.quote_cmdline(e||[])};c.unquote_cmdline=function u(e){return r.unquote_cmdline(e)};c.render_container_cmdline=function f(e){if(e.Config)return c.quote_cmdline((e.Config.Entrypoint||[]).concat(e.Config.Cmd||[]));else return e.Command};c.render_container_name=function g(e){if(e.length>0&&e[0]=="/")return e.slice(1);else return e};c.render_container_state=function m(e){if(e.Running)return n.format(o("Up since $StartedAt"),e);else return n.format(o("Exited $ExitCode"),e)};c.multi_line=function p(e){return e.map(function(e){return t.render("{{.}}",e)}).join("<br/>")};c.format_cpu_shares=function h(e){if(!e)return o("default");return n.format(o("$0 shares"),Math.round(e))};c.format_cpu_usage=function b(e){if(e===undefined||isNaN(e))return"";return Math.round(e)+"%"};c.update_memory_bar=function _(n,t,r){var i=[t];if(r)i.push(r);e(n).attr("value",i.join("/")).toggleClass("bar-row-danger",!!(r&&t>.9*r))};c.format_memory_and_limit=function v(e,t){var r="";var i=1024;var o;if(t){o=n.format_bytes(t,i,true);r=" / "+o.join(" ");i=o[1]}if(e){o=n.format_bytes(e,i,true);if(r)return o[0]+r;else return o.join(" ")}else{return"?"+r}};c.insert_table_sorted=function y(e,n){c.insert_table_sorted_generic(e,n,function(e,n){return e.text().localeCompare(n.text())})};c.insert_table_sorted_generic=function x(n,t,r){var i=e(n).find("tbody tr");for(var o=0;o<i.length;o++){if(r(e(i[o]),t)>0){e(t).insertBefore(i[o]);t=null;break}}if(t!==null)e(n).find("tbody").append(t)};c.setup_danger_button=function k(n,t,r){var i=e('<button class="btn btn-default btn-control fa fa-check enable-danger">').toggle(false).on("click",r);e(n+" th.container-col-actions").append(i);e(t)[0].addEventListener("click",function(t){if(e(t.target).parents(n).length===0&&e(n+" button.enable-danger").hasClass("active"))r()},true)};c.render_container=function w(t,r,a,l,d,s){var u=e(document.getElementById(a+l));if(!d){u.remove();if(!r.find("table > tbody > tr").length){r.find("button.enable-danger").toggle(false)}return}var f;var g,m;var p,h,b;var _;if(d.State&&d.State.Running){f=c.format_cpu_usage(d.CpuUsage);g=d.MemoryUsage;m=d.MemoryLimit;h=c.format_memory_and_limit(g,m);p=true;b={color:"inherit"}}else{f="";p=false;h=o("Stopped");b={color:"grey","text-align":"right"}}var v=false;if(!u.length){r.find("button.enable-danger").toggle(true);var y=e('<div class="spinner">');var x=e('<button class="btn btn-danger pficon pficon-delete btn-delete">').on("click",function(){var n=this;e(n).hide().siblings("div.spinner").show();c.docker_container_delete(t,l,function(){},function(){e(n).show().siblings("div.spinner").hide()});return false});var k=e('<button class="btn btn-default btn-control fa fa-play">').on("click",function(){e(this).hide().siblings("div.spinner").show();t.start(l).fail(function(e){c.handle_scope_start_container(t,l,e.message)});return false});var w=e('<button class="btn btn-default btn-control fa fa-stop">').on("click",function(){e(this).hide().siblings("div.spinner").show();t.stop(l).fail(function(e){c.show_unexpected_error(e)});return false});u=e("<tr>",{id:a+l}).append(e('<td class="container-col-name">'),e('<td class="container-col-image">'),e('<td class="container-col-command">'),e('<td class="container-col-cpu">'),e('<td class="container-col-memory-graph">').append(i.BarRow("containers-containers")),e('<td class="container-col-memory-text">'),e('<td class="container-col-danger cell-buttons">').append(x,y),e('<td class="container-col-actions cell-buttons">').append(k,w,y.clone()));u.on("click",function(e){n.location.go([l])});v=true}var C=u.children("td");e(C[0]).text(c.render_container_name(d.Name));e(C[1]).text(d.Image);e(C[2]).text(c.render_container_cmdline(d));e(C[3]).text(f);c.update_memory_bar(e(C[4]).children("div").toggle(p),g,m);e(C[5]).css(b).text(h);var S=l in t.waiting;e(C[6]).children("div.spinner").toggle(S);e(C[6]).children("button.btn-delete").toggle(!S).toggleClass("disabled",d.State.Running);var M=S||d.State.Running?"You can only delete<br/> stopped containers":"Delete immediately";e(C[6]).children("button.btn-delete").tooltip("destroy").attr("title",M).tooltip({html:true});e(C[7]).children("div.spinner").toggle(S);e(C[7]).children("button.fa-play").toggle(!S&&!d.State.Running);e(C[7]).children("button.fa-stop").toggle(!S&&d.State.Running);e(C[6]).toggle(s);e(C[7]).toggle(!s);u.toggleClass("unimportant",!d.State.Running);if(v)c.insert_table_sorted(r.find("table"),u)};c.MemorySlider=function C(t,r,i){var a=this;var c,l;var d;function s(){if(c.disabled){d=undefined;return o("unlimited")}d=Math.round(c.value*i);if(d<r)d=r;return n.format_bytes(d,1024)}c=t.find("div.slider").on("change",function(){e(l).text(s())})[0];l=t.find("span")[0];var u=t.find("input[type='checkbox']").on("change",function(){e(c).attr("disabled",!this.checked);e(l).toggleClass("disabled",!this.checked);e(l).text(s())})[0];Object.defineProperty(this,"value",{get:function(){return d},set:function(n){if(n!==undefined){e(c).prop("value",n/i).trigger("change")}e(u).prop("checked",n!==undefined).trigger("change")}});Object.defineProperty(this,"max",{get:function(){return i},set:function(n){var t=i;i=n;e(c).prop("value",c.value*t/i).trigger("change")}});return this};c.CpuSlider=function S(n,t,r){var i=this;var o,a;var l;var d=Math.log(t);var s=Math.log(r);var u=s-d;function f(){if(o.disabled)l=undefined;else l=Math.round(Math.exp(d+u*o.value));return c.format_cpu_shares(l)}o=n.find("div.slider").on("change",function(){e(a).text(f())})[0];a=n.find("span")[0];var g=n.find("input[type='checkbox']").on("change",function(){e(o).attr("disabled",!this.checked);e(a).toggleClass("disabled",!this.checked);e(a).text(f())});Object.defineProperty(this,"value",{get:function(){return l},set:function(n){if(n!==undefined){e(o).prop("value",(Math.log(n)-d)/u).trigger("change")}e(g).prop("checked",n!==undefined).trigger("change")}});return this};c.docker_container_delete=function M(e,t,r,i){e.rm(t).fail(function(a){if(a.message.indexOf("remove a running container")>-1){var l=e.containers[t];var d;if(l.State.Running){d=o("Container is currently running.")}else{d=o("Container is currently marked as not running, but regular stopping failed.")+" "+o("Error message from Docker:")+" '"+a.message+"'"}var s;if(l.Name)s=l.Name;else s=t;if(s.charAt(0)==="/")s=s.substring(1);c.confirm(n.format(o("Please confirm forced deletion of $0"),s),d,o("Force Delete")).done(function(){e.rm(t,true).fail(function(e){c.show_unexpected_error(e);i()}).done(r)}).fail(i);return}c.show_unexpected_error(a);i()}).done(r)};c.handle_scope_start_container=function j(e,t,r,i,a){var l=".scope already exists";var d=r.indexOf(l);if(d>-1){var s="Unit docker-";var u=r.indexOf(s)+s.length;var f=r.substring(u,d);n.spawn(["systemctl","stop","docker-"+f+".scope"],{superuser:"try"}).done(function(){e.start(t).fail(function(e){if(a)a()}).done(function(){if(i)i()});return}).fail(function(e){c.show_unexpected_error(n.format(o("Failed to stop Docker scope: $0"),e));if(a)a()});return}c.show_unexpected_error(r);if(a)a()};c.show_unexpected_error=function R(n){e("#error-popup-message").text(n.message||n||"???");e('.modal[role="dialog"]').modal("hide");e("#error-popup").modal("show")};c.confirm=function q(n,t,r){var i=e.Deferred();e("#confirmation-dialog-title").text(n);if(typeof t=="string")e("#confirmation-dialog-body").text(t);else e("#confirmation-dialog-body").html(t);e("#confirmation-dialog-confirm").text(r);function o(){e("#confirmation-dialog button").off("click");e("#confirmation-dialog").modal("hide")}e("#confirmation-dialog-confirm").click(function(){o();i.resolve()});e("#confirmation-dialog-cancel").click(function(){o();i.reject()});e("#confirmation-dialog").modal("show");return i.promise()};return c});
