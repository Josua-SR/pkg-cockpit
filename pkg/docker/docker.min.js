define(["jquery","base1/cockpit","base1/term"],function(e,n,r){"use strict";var t={};function a(){if(window.debugging=="all"||window.debugging=="docker")console.debug.apply(console,arguments)}var o=n.http("/var/run/docker.sock",{superuser:true});t.pull=function l(n,r,i){var s=e.Deferred();if(!r)r="latest";if(i)n=i+"/"+n;a("pulling: "+n+":"+r);var c={method:"POST",path:"/v1.12/images/create",body:"",params:{fromImage:n,tag:r}};var u;var l="";var f=o.request(c).stream(function(e){l+=e;var n=t.json_skip(l,0);if(n===0)return;var r=JSON.parse(l.substring(0,n));l=l.substring(n);if(r.error)u=r.error;else if(r.status)s.notify(r.status,r)}).fail(function(e){s.reject(e)}).done(function(){if(u)s.reject(new Error(u));else s.resolve()});var d=s.promise();d.cancel=function v(){f.close("cancelled");return d};return d};t.inspect_image=function f(n){var r=e.Deferred();o.get("/v1.12/images/"+encodeURIComponent(n)+"/json").done(function(e){r.resolve(JSON.parse(e))}).fail(function(e){r.reject(e)});var t=r.promise();t.cancel=function a(){return t};return t};function i(t,a){var o=this;var i=new r({cols:80,rows:24,screenKeys:true});var s=true;var c=n.utf8_decoder();var u=n.utf8_encoder();t.empty();i.open(t[0]);o.typeable=function l(e){i.cursorHidden=!e;if(e)i.showCursor();i.refresh(i.y,i.y);s=e};o.close=function f(){i.destroy()};if(typeof a=="string"){i.write("[31m"+a+"[m\r\n");o.close=function(){};o.typeable(false);return o}e(a).on("close",function(n,r){o.connected=false;var t=r.problem||"disconnected";i.write("[31m"+t+"[m\r\n");o.typeable(false);e(a).off("message");a=null});o.process=function d(e){i.write(c.decode(e));return e.length};i.on("data",function(e){if(s&&a)a.send(u.encode(e))});return o}function s(r,t){var a=this;var o=e("<pre>").addClass("logs");r.empty();r.append(o);var i;var s=[];function c(n){s.push(n);if(!i){i=window.setTimeout(function(){i=null;var n=o[0].scrollHeight-o.scrollTop()<=o.outerHeight();var r=e("<span>").text(s.join(""));s.length=0;o.append(r);if(n)o.scrollTop(o.prop("scrollHeight"))},50)}}if(typeof t=="string"){c(t);a.close=function(){};return a}t.control({batch:16384,latency:50});var u=n.utf8_decoder(false);a.process=function l(e){var n=0;var r,t;var a=e.length;while(true){if(a<n+8)return n;r=(e[n+4]&255)<<24|(e[n+5]&255)<<16|(e[n+6]&255)<<8|e[n+7]&255;if(a<n+8+r)return n;if(e.subarray)t=e.subarray(n+8,n+8+r);else t=e.slice(n+8,n+8+r);c(u.decode(t,{stream:true}));n+=8+r}return n};e(t).on("close",function(n,r){c(r.reason||"disconnected");a.connected=false;e(t).off();t=null});return a}function c(e,n){var r,t=n.length;var a,o=e.length-t+1;for(a=0;a<o;a++){for(r=0;r<t;r++){if(e[a+r]!==n[r])break}if(r==t)return a}return-1}t.console=function d(r,t,u){var l=e("<div>").addClass("console");var f=false;var d=false;var v=null;var p=null;var h;var g;if(Array.isArray(t)){if(!u)u={};g=u.tty;if(g===undefined||g===null)g=true;h={method:"POST",path:"/v1.15/containers/"+encodeURIComponent(r)+"/exec",headers:{"Content-Type":"application/json"},body:JSON.stringify({AttachStdin:g,AttachStdout:true,AttachStderr:true,Tty:g,Cmd:t})};a("preparing to exec:",t)}else{a("preparing to attach");u=t||{};g=u.tty}delete u.tty;var y=null;function b(e){l.connected=false;if(g)p=new i(l,e);else p=new s(l,e)}function m(){if(!h){return w("POST /v1.15/containers/"+encodeURIComponent(r)+"/attach?logs=1&stream=1&stdin=1&stdout=1&stderr=1 HTTP/1.0\r\n"+"Content-Length: 0\r\n\r\n")}var n=o.request(e.extend({},u,h)).always(function(){n=null}).done(function(e){var n=JSON.parse(e);var r=JSON.stringify({Detach:false,Tty:g});return w("POST /v1.15/exec/"+encodeURIComponent(n.Id)+"/start HTTP/1.0\r\n"+"Content-Length: "+r.length+"\r\n\r\n"+r)}).fail(function(e){b(e.message)})}function w(t){l.connected=true;if(p)p.close();p=null;var o=e.extend({},u,{payload:"stream",unix:"/var/run/docker.sock",superuser:true,binary:true});v=n.channel(o);a(t);v.send(t);e(v).on("close.attach",function(n,t){a(r+": console close: ",t);l.connected=false;e(v).off(".attach");v=null});var d=null;var h=v.buffer();h.callback=function(e){var t=0;var o=0;var u;if(d===null){o=c(e,[13,10,13,10]);if(o==-1)return t;if(e.subarray)d=n.utf8_decoder().decode(e.subarray(0,o));else d=n.utf8_decoder().decode(e.slice(0,o));a(r+": console headers: ",d);u=d.split("\r\n",1)[0].split(" ");if(u[1]!="200"){b(u.slice(2).join(" "));h.callback=null;return}else if(e.subarray){e=e.subarray(o+4);t+=o+4}else{e=e.slice(o+4);t+=o+4}}if(g===undefined||g===null){if(e.length<2)return t;g=!((e[0]===0||e[0]===1||e[0]===2)&&e[1]===0);a(r+": mode tty: "+g)}if(g)p=new i(l,v);else p=new s(l,v);l.typeable(f);h.callback=p.process;var y=p.process(e);return t+y}}l.close=function T(e){if(y)y.close(e);if(l.connected)v.close(e);if(p){if(p.close)p.close();p=null}};l.connect=function C(){l.close("disconnected");m()};function k(){if(p&&p.typeable)p.typeable(f&&d)}e(l).on("focusin",function(){d=true;k()}).on("focusout",function(){d=false;k()});l.typeable=function O(e){f=e;k()};return l};t.json_skip=function(e,n){var r=false;var t=e.length;var a=0;var o=false;var i=false;var s=' 	\n\r[{}]"';var c=" 	\n\r";var u;if(n===undefined)n=0;for(t=e.length;n!=t;n++){if(r&&a<=0)break;u=e[n];if(o){if(s.indexOf(u)!=-1){o=false;a--;n--}continue}if(c.indexOf(u)!=-1)continue;if(i){switch(u){case"\\":if(n+1==t)continue;n++;break;case'"':i=false;a--;break;default:break}continue}r=true;switch(u){case"[":case"{":a++;break;case"]":case"}":a--;break;case'"':i=true;a++;break;default:o=true;a++;break}}if(o&&a==1)a=0;if(!r||a>0)return 0;return n};t.quote_cmdline=function v(e){var n;e=e||[];function r(e){return e==" "}function t(e){var n="";var t="";var a;for(a=0;a<e.length;a++){if(e[a]=="\\"||e[a]==t)n+="\\";else if(t===""){if(e[a]=="'"||r(e[a]))t='"';else if(e[a]=='"')t="'"}n+=e[a]}return t+n+t}return e.map(t).join(" ")};t.unquote_cmdline=function p(e){var n=[];var r;function t(e){return e==" "}function a(){while(r<e.length&&t(e[r]))r++}function o(){var n="";var a=null;while(r<e.length){if(e[r]=="\\"){r++;if(r<e.length){n+=e[r]}}else if(e[r]==a){a=null}else if(a){n+=e[r]}else if(e[r]=='"'||e[r]=="'"){a=e[r]}else if(t(e[r])){break}else n+=e[r];r++}return n}r=0;a();while(r<e.length){n.push(o());a()}return n};var u=[null,"KB","MB","GB","TB","PB","EB","ZB"];t.bytes_from_format=function h(e,n){var r=1024;if(n===undefined)n=" ";var t=e.split(n).pop().toUpperCase();var a=u.indexOf(t);var o=parseFloat(e);if(a>0&&!isNaN(o))return o*Math.pow(r,a);return o};return t});
