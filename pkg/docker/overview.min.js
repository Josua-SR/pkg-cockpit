define(["jquery","base1/cockpit","base1/mustache","docker/util","docker/run","docker/search","docker/docker","shell/controls","shell/shell","shell/plot","base1/bootstrap-select"],function(e,t,a,n,o,i,r,s,c){var l=t.gettext;var u=t.gettext;function g(a){var u=false;function g(t){u=t;e("#containers-containers button.enable-danger").toggleClass("active",u);e("#containers-containers td.container-col-actions").toggle(!u);e("#containers-containers td.container-col-danger").toggle(u)}n.setup_danger_button("#containers-containers","#containers",function(){g(!u)});e("#containers-containers-filter").on("change",function(){var t=e(this).val();e("#containers-containers table").toggleClass("filter-unimportant",t==="running")});e("#containers-images-search").on("click",function(){i(a);return false});e(".selectpicker").selectpicker();function f(t,n){n=a.container_from_cgroup(n)||n;e("#containers-containers tr").removeClass("highlight");e("#"+n).addClass("highlight")}var d={internal:"cgroup.cpu.usage",units:"millisec",derive:"rate",factor:.1};var m=c.plot_simple_template();e.extend(m.yaxis,{tickFormatter:function(e){return e.toFixed(0)}});e.extend(m.grid,{hoverable:true,autoHighlight:false});m.setup_hook=function(e){var t=e.getAxes();if(t.yaxis.datamax)t.yaxis.options.max=Math.ceil(t.yaxis.datamax/100)*100;else t.yaxis.options.max=100;t.yaxis.options.min=0};var p=c.plot(e("#containers-cpu-graph"),300);p.set_options(m);var v=p.add_metrics_stacked_instances_series(d,{});e(v).on("value",function(t,a){e("#containers-cpu-text").text(n.format_cpu_usage(a))});p.start_walking();e(v).on("hover",f);var h={internal:"cgroup.memory.usage",units:"bytes"};var _=c.plot_simple_template();e.extend(_.yaxis,{ticks:c.memory_ticks,tickFormatter:c.format_bytes_tick_no_unit});e.extend(_.grid,{hoverable:true,autoHighlight:false});_.setup_hook=function(t){var a=t.getAxes();if(a.yaxis.datamax<1.5*1024*1024)a.yaxis.options.max=1.5*1024*1024;else a.yaxis.options.max=null;a.yaxis.options.min=0;e("#containers-mem-unit").text(c.bytes_tick_unit(a.yaxis))};var b=c.plot(e("#containers-mem-graph"),300);b.set_options(_);var x=b.add_metrics_stacked_instances_series(h,{});e(x).on("value",function(a,n){e("#containers-mem-text").text(t.format_bytes(n,1024))});b.start_walking();e(x).on("hover",f);e(window).on("resize",function(){p.resize();b.resize()});function y(t,o){if(o&&o.CGroup){v.add_instance(o.CGroup);x.add_instance(o.CGroup)}n.render_container(a,e("#containers-containers"),"",t,o,u)}function k(i,r){var s=e("#"+i);if(!r||!r.RepoTags||r.RepoTags[0]=="<none>:<none>"){s.remove();return}var c=false;if(!s.length){var u=e('<button class="btn btn-default btn-control fa fa-play">').attr("title",l("Run image")).on("click",function(){o(a,i);return false});s=e('<tr id="'+i+'">').append(e('<td class="image-col-tags">'),e('<td class="image-col-created">'),e('<td class="image-col-size-graph">'),e('<td class="image-col-size-text">'),e('<td class="cell-buttons">').append(u));s.on("click",function(e){t.location.go(["image",i])});c=true}var g=s.children("td");e(g[0]).html(n.multi_line(r.RepoTags));var f=new Date(r.Created*1e3);f.setDate(f.getDate()+2);if(f>new Date){e(g[1]).text(new Date(r.Created*1e3).toLocaleString())}else{var d=new Date(r.Created*1e3);e(g[1]).text(d.toLocaleDateString()).attr("title",d.toLocaleString())}e(g[2]).children("div").attr("value",r.VirtualSize);e(g[3]).text(t.format_bytes(r.VirtualSize,1024));if(c){n.insert_table_sorted(e("#containers-images table"),s)}}e("#containers-containers table tbody tr").remove();e("#containers-images table tbody tr").remove();e(a).on("container.containers",function(e,t,a){y(t,a)});e(a).on("image.containers",function(e,t,a){k(t,a)});var w;e("#containers-containers button.enable-danger").toggle(false);for(w in a.containers){y(w,a.containers[w])}for(w in a.images){k(w,a.images[w])}function D(){a.info().done(function(a){var n=a&&JSON.parse(a);if(n["Driver"]!=="devicemapper"){e("#containers-storage .bar").html();e("#containers-storage .data").html("Unknown")}var o;var i;var c;e.each(n["DriverStatus"],function(e,t){if(t&&t[0]=="Data Space Total")i=t[1];else if(t&&t[0]=="Data Space Used")o=t[1];else if(t&&t[0]=="Data Space Available")c=t[1]});if(o&&i&&r){var u=r.bytes_from_format(o);var g=r.bytes_from_format(i);if(c){e("#containers-storage").tooltip("destroy");g=r.bytes_from_format(c);i=t.format_bytes(u+g)}else{var f=l("WARNING: Docker may be reporting the size it has allocated to it's storage pool using sparse files, not the actual space available to the underlying storage device.");e("#containers-storage").tooltip({title:f})}var d=o+" / "+i;var m=s.BarRow();m.attr("value",u+"/"+g);m.toggleClass("bar-row-danger",o>.95*i);e("#containers-storage .bar").html(m);e("#containers-storage .data").html(d)}else{e("#containers-storage .bar").html();e("#containers-storage .data").html("Unknown")}})}function C(){var e=this;var t=null;var n=false;var o=function(){if(!t){D();t=window.setTimeout(function(){var e=n;n=false;t=null;if(e&&a)o()},1e4)}else{n=true}};return o}D();e(a).on("event.containers",C());function z(){e("#containers").hide()}function S(){e("#containers").show();p.resize();b.resize()}return{show:S,hide:z}}return{init:g}});
