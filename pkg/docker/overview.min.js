define(["jquery","base1/cockpit","base1/mustache","docker/util","docker/run","docker/search","docker/docker","shell/controls","shell/shell","shell/plot"],function(t,e,a,n,o,i,r,s,c){var l=e.gettext;var u=e.gettext;function g(a){var u=false;function g(e){u=e;t("#containers-containers button.enable-danger").toggleClass("active",u);t("#containers-containers td.container-col-actions").toggle(!u);t("#containers-containers td.container-col-danger").toggle(u)}n.setup_danger_button("#containers-containers","#containers",function(){g(!u)});t("#containers-containers-filter a").on("click",function(){var e=t(this);t("#containers-containers-filter button span").text(e.text());t("#containers-containers table").toggleClass("filter-unimportant",e.attr("value")==="running")});t("#containers-images-search").on("click",function(){i(a);return false});function f(e,n){n=a.container_from_cgroup(n)||n;t("#containers-containers tr").removeClass("highlight");t("#"+n).addClass("highlight")}var d={internal:"cgroup.cpu.usage",units:"millisec",derive:"rate",factor:.1};var m=c.plot_simple_template();t.extend(m.yaxis,{tickFormatter:function(t){return t.toFixed(0)}});t.extend(m.grid,{hoverable:true,autoHighlight:false});m.setup_hook=function(t){var e=t.getAxes();if(e.yaxis.datamax)e.yaxis.options.max=Math.ceil(e.yaxis.datamax/100)*100;else e.yaxis.options.max=100;e.yaxis.options.min=0};var v=c.plot(t("#containers-cpu-graph"),300);v.set_options(m);var p=v.add_metrics_stacked_instances_series(d,{});t(p).on("value",function(e,a){t("#containers-cpu-text").text(n.format_cpu_usage(a))});v.start_walking();t(p).on("hover",f);var h={internal:"cgroup.memory.usage",units:"bytes"};var _=c.plot_simple_template();t.extend(_.yaxis,{ticks:c.memory_ticks,tickFormatter:c.format_bytes_tick_no_unit});t.extend(_.grid,{hoverable:true,autoHighlight:false});_.setup_hook=function(e){var a=e.getAxes();if(a.yaxis.datamax<1.5*1024*1024)a.yaxis.options.max=1.5*1024*1024;else a.yaxis.options.max=null;a.yaxis.options.min=0;t("#containers-mem-unit").text(c.bytes_tick_unit(a.yaxis))};var x=c.plot(t("#containers-mem-graph"),300);x.set_options(_);var b=x.add_metrics_stacked_instances_series(h,{});t(b).on("value",function(a,n){t("#containers-mem-text").text(e.format_bytes(n,1024))});x.start_walking();t(b).on("hover",f);t(window).on("resize",function(){v.resize();x.resize()});function y(e,o){if(o&&o.CGroup){p.add_instance(o.CGroup);b.add_instance(o.CGroup)}n.render_container(a,t("#containers-containers"),"",e,o,u)}function k(i,r){var s=t(document.getElementById(i));if(!r||!r.RepoTags||r.RepoTags[0]=="<none>:<none>"){s.remove();return}var c=false;if(!s.length){var u=t('<button class="btn btn-default btn-control fa fa-play">').attr("title",l("Run image")).on("click",function(){o(a,i);return false});s=t("<tr>",{id:i}).append(t('<td class="image-col-tags">'),t('<td class="image-col-created">'),t('<td class="image-col-size-graph">'),t('<td class="image-col-size-text">'),t('<td class="cell-buttons">').append(u));s.on("click",function(t){e.location.go(["image",i])});c=true}var g=s.children("td");t(g[0]).html(n.multi_line(r.RepoTags));var f=new Date(r.Created*1e3);f.setDate(f.getDate()+2);if(f>new Date){t(g[1]).text(new Date(r.Created*1e3).toLocaleString())}else{var d=new Date(r.Created*1e3);t(g[1]).text(d.toLocaleDateString()).attr("title",d.toLocaleString())}t(g[2]).children("div").attr("value",r.VirtualSize);t(g[3]).text(e.format_bytes(r.VirtualSize,1024));if(c){n.insert_table_sorted(t("#containers-images table"),s)}}t("#containers-containers table tbody tr").remove();t("#containers-images table tbody tr").remove();t(a).on("container.containers",function(t,e,a){y(e,a)});t(a).on("image.containers",function(t,e,a){k(e,a)});var w;t("#containers-containers button.enable-danger").toggle(false);for(w in a.containers){y(w,a.containers[w])}for(w in a.images){k(w,a.images[w])}function D(){a.info().done(function(a){var n=a&&JSON.parse(a);if(n["Driver"]!=="devicemapper"){t("#containers-storage .bar").html();t("#containers-storage .data").html("Unknown")}var o;var i;var c;t.each(n["DriverStatus"],function(t,e){if(e&&e[0]=="Data Space Total")i=e[1];else if(e&&e[0]=="Data Space Used")o=e[1];else if(e&&e[0]=="Data Space Available")c=e[1]});if(o&&i&&r){var u=r.bytes_from_format(o);var g=r.bytes_from_format(i);if(c){t("#containers-storage").tooltip("destroy");g=r.bytes_from_format(c);i=e.format_bytes(u+g)}else{var f=l("WARNING: Docker may be reporting the size it has allocated to it's storage pool using sparse files, not the actual space available to the underlying storage device.");t("#containers-storage").tooltip({title:f,placement:"auto"})}var d=o+" / "+i;var m=s.BarRow();m.attr("value",u+"/"+g);m.toggleClass("bar-row-danger",o>.95*i);t("#containers-storage .bar").html(m);t("#containers-storage .data").html(d)}else{t("#containers-storage .bar").html();t("#containers-storage .data").html("Unknown")}})}function C(){var t=this;var e=null;var n=false;var o=function(){if(!e){D();e=window.setTimeout(function(){var t=n;n=false;e=null;if(t&&a)o()},1e4)}else{n=true}};return o}D();t(a).on("event.containers",C());function z(){t("#containers").hide()}function S(){t("#containers").show();v.resize();x.resize()}return{show:S,hide:z}}return{init:g}});
