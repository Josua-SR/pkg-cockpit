define(["jquery","base1/cockpit","docker/util","docker/docker"],function(e,a,t,r){var s=a.gettext;var n=a.gettext;i.prototype={_init:function(){this.id="containers-search-image-dialog"},show:function(){e("#containers-search-image-search").focus()},leave:function(){this.cancel_search();e(this.client).off(".containers-search-image-dialog");this.client=null},setup:function(){e("#containers-search-image-search").on("keypress",e.proxy(this,"input"));e("#containers-search-image-search").attr("placeholder","search by name, namespace or description");e("#containers-search-download").on("click",e.proxy(this,"start_download"));e("#containers-search-tag").prop("disabled",true);e("#containers-search-download").prop("disabled",true);this.search_timeout=null;this.search_request=null},enter:function(){this.client=i.client;e("#containers-search-image-results tbody tr").remove();e("#containers-search-image-results").hide();e("#containers-search-image-no-results").hide();e("#containers-search-image-search")[0].value=""},input:function(e){this.cancel_search();if(e.target.value.length<3&&e.which!=13)return;var a=this;this.search_timeout=window.setTimeout(function(){a.perform_search(a.client)},e.which==13?0:2e3)},start_download:function(a){var n=e("#containers-search-download").data("repo");var i=e("#containers-search-download").data("registry")||undefined;var o=e("#containers-search-tag").val();e("#containers-search-tag").prop("disabled",true);e("#containers-search-download").data("repo","");e("#containers-search-download").prop("disabled",true);var c=e('<tr id="imagedl_'+n.replace("/","_")+'">').append(e('<td class="container-col-tags">').text(n+":"+o),e('<td class="container-col-created">').text("Downloading"),e('<td class="image-col-size-graph">').append(e('<div class="progress progress-striped active">').append(e('<div class="progress-bar" role="progressbar" aria-valuenow="1" aria-valuemin="0" aria-valuemax="1" style="width: 100%">'))),e('<td class="image-col-size-text">'),e('<td class="cell-buttons">'));t.insert_table_sorted(e("#containers-images table"),c);var l=c.children("td.container-col-created");var d=c.children("td.image-col-size-text");var h=false;var u={};r.pull(n,o,i).progress(function(e,a){if("id"in a){var t=a["status"];if(a["status"]=="Downloading"){t+=": "+a["progressDetail"]["current"]+"/"+a["progressDetail"]["total"]}u[a["id"]]=t;if(a["status"]=="Download complete"){delete u[a["id"]]}}var r="";for(var s in u){r+=s+": "+u[s]+"&nbsp;&nbsp;&nbsp;&nbsp;"}d.html(r)}).fail(function(e){console.warn("pull failed:",e);h=true;l.text(s("Error downloading"));d.text(e.message).attr("title",e.message);c.on("click",function(){c.remove()})}).always(function(){if(!h)c.remove()});e("#containers-search-image-dialog").modal("hide")},perform_search:function(a){var r=e("#containers-search-image-search")[0].value;e("#containers-search-image-waiting").addClass("spinner");e("#containers-search-image-no-results").hide();e("#containers-search-image-results").hide();e("#containers-search-image-results tbody tr").remove();this.search_request=a.search(r).done(function(a){var s=a&&JSON.parse(a);e("#containers-search-image-waiting").removeClass("spinner");if(s&&s.length>0){e("#containers-search-image-results").show();s.forEach(function(a){var r=e("<tr>").append(e("<td>").text(a.name),e("<td>").text(a.description));r.on("click",function(t){e("#containers-search-image-results tr").each(function(){e(this).removeClass("active")});r.addClass("active");e("#containers-search-tag").val("latest");e("#containers-search-tag").prop("disabled",false);e("#containers-search-download").data("repo",a.name);e("#containers-search-download").data("registry",a.registry_name);e("#containers-search-download").prop("disabled",false)});r.data("entry",a);t.insert_table_sorted_generic(e("#containers-search-image-results"),r,function(e,a){if(e.data("entry").is_official&&!a.data("entry").is_official)return-1;if(!e.data("entry").is_official&&a.data("entry").is_official)return 1;if(e.data("entry").is_automated&&!a.data("entry").is_automated)return-1;if(!e.data("entry").is_automated&&a.data("entry").is_automated)return 1;if(e.data("entry").star_count!=a.data("entry").star_count)return a.data("entry").star_count-e.data("entry").star_count;return e.data("entry").name.localeCompare(a.data("entry").name)})})}else{e("#containers-search-image-no-results").html("No results for "+r+"<br />Please try another term");e("#containers-search-image-no-results").show()}})},cancel_search:function(){window.clearTimeout(this.search_timeout);e("#containers-search-image-no-results").hide();e("#containers-search-image-results").hide();e("#containers-search-image-results tbody tr").remove();if(this.search_request!==null){this.search_request.close();this.search_request=null}e("#containers-search-image-waiting").removeClass("waiting");e("#containers-search-tag").prop("disabled",true);e("#containers-search-download").prop("disabled",true)}};function i(){this._init()}var o=new i;o.setup();e("#containers-search-image-dialog").on("show.bs.modal",function(){o.enter()}).on("shown.bs.modal",function(){o.show()}).on("hidden.bs.modal",function(){o.leave()});function c(a){i.client=a;e("#containers-search-image-dialog").modal("show")}return c});
